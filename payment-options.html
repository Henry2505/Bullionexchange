<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Options – CBE</title>
  <link rel="stylesheet" href="theme.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet"/>
  <script>
    // Initialize theme
    const saved = localStorage.getItem('theme');
    document.documentElement.setAttribute('data-theme', saved || 'dark');
  </script>
  <script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>
  <style>
    /* (all your original CSS here, unchanged) */
    /* … */
  </style>
</head>
<body>
  <!-- Logo -->
  <div class="logo">
    <a href="index.html"><img src="CBE_logo.PNG" alt="CBE Logo"></a>
  </div>

  <!-- Theme Toggle -->
  <button id="theme-toggle" aria-label="Toggle light/dark">🌞</button>

  <!-- Main Content -->
  <div class="container slide-in">
    <h1>Your Plan</h1>
    <div class="divider"></div>

    <div class="details-panel">
      <ul>
        <li><span>Plan:</span><span id="plan-name">—</span></li>
        <li><span>Price:</span><span id="plan-price">—</span></li>
        <li><span>You Save:</span><span id="plan-save">—</span></li>
      </ul>
    </div>

    <!-- Buttons will be injected here -->
    <button class="btn-pay slide-in" id="paystackBtn" style="transition-delay:.3s;">Loading…</button>
    <button class="btn-crypto slide-in" id="cryptoBtn" style="transition-delay:.5s;">I’ll Transfer Crypto</button>

    <!-- Crypto Grid -->
    <div class="crypto-section slide-in" id="cryptoSection" style="transition-delay:.7s; display:none;">
      <div class="crypto-grid" id="cryptoGrid"></div>
    </div>

    <!-- Email Form -->
    <div class="form-wrapper slide-in" id="emailSection" style="transition-delay:.9s; display:none;">
      <form id="paymentForm">
        <label for="emailInput">Your Email (must match registration)</label>
        <input type="email" id="emailInput" placeholder="you@example.com" required/>
        <button type="submit">Submit Payment</button>
      </form>
      <div id="successMessage" style="display:none; text-align:center; margin-top:1rem; color:var(--gold); font-weight:600;">
        Your payment is pending verification!
      </div>
    </div>

    <a href="vip-subscription.html" class="back-link slide-in" style="transition-delay:1.1s;">← Change Plan</a>
  </div>

  <footer class="slide-in" style="transition-delay:1.3s;">
    © 2025 Chukwuemeka Bullion Exchange. All rights reserved.
  </footer>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Activate slide-ins
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.slide-in').forEach(el => {
        const d = parseFloat(el.style.transitionDelay) * 1000 + 100;
        setTimeout(() => el.classList.add('visible'), d);
      });
      initPage();
    });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const curr = document.documentElement.getAttribute('data-theme');
      const next = curr === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.getElementById('theme-toggle').textContent = next === 'dark' ? '🌞' : '🌜';
    });

    // Read plan from URL
    const params = new URLSearchParams(location.search);
    const key = params.get('plan') || 'weekly';
    const cfg = {
      weekly:  {n:'Weekly Plan',  p:50,  s:0},
      monthly: {n:'Monthly Plan', p:150, s:50},
      yearly:  {n:'Yearly Plan',  p:1500, s:300}
    };
    const ch = cfg[key];
    document.getElementById('plan-name').textContent  = ch.n;
    document.getElementById('plan-price').textContent = `$${ch.p}`;
    document.getElementById('plan-save').textContent  = `$${ch.s}`;

    // Initialize Supabase
    const supabase = supabase.createClient(
      'https://dapwpgvnfjcfqqhrpxla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhZ3Nl...'
      + 'yPhABpEMsQ'
    );

    let cardMethod = null;

    async function initPage() {
      // Fetch payment methods
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*')
        .order('id');
      if (error) return console.error('Load methods error:', error);

      // Card/Bank button
      cardMethod = data.find(m => m.type === 'card');
      const payBtn = document.getElementById('paystackBtn');
      if (cardMethod) {
        payBtn.textContent = cardMethod.name;
        payBtn.onclick = () => window.location.href = cardMethod.details.link;
      } else {
        payBtn.textContent = 'No card method';
        payBtn.disabled = true;
      }

      // Crypto button & grid
      const cryptoBtn = document.getElementById('cryptoBtn');
      cryptoBtn.onclick = () => {
        const sec = document.getElementById('cryptoSection');
        const form = document.getElementById('emailSection');
        sec.style.display = sec.style.display === 'block' ? 'none' : 'block';
        form.style.display = sec.style.display; 
      };

      const grid = document.getElementById('cryptoGrid');
      data.filter(m => m.type === 'crypto').forEach(c => {
        const card = document.createElement('div');
        card.className = 'crypto-card';
        card.innerHTML = `
          <div class="label">${c.name}</div>
          <div class="address">${c.details.address}</div>
          <button class="copy-btn">Copy</button>`;
        grid.appendChild(card);

        // Copy handler
        card.querySelector('.copy-btn').onclick = () => {
          navigator.clipboard.writeText(c.details.address).then(() => {
            const btn = event.currentTarget;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 1500);
          });
        };
      });

      // Payment form submit
      document.getElementById('paymentForm').onsubmit = async e => {
        e.preventDefault();
        const email = document.getElementById('emailInput').value.trim();
        if (!email) return alert('Enter your registered email.');

        // insert payment
        const { error:insErr } = await supabase
          .from('payments')
          .insert([{ email, plan: ch.n, method_id: cardMethod ? cardMethod.id : null }]);
        if (insErr) return alert('Submit failed: ' + insErr.message);

        document.getElementById('successMessage').style.display = 'block';
        setTimeout(() => location.href = 'index.html', 3000);
      };
    }
  </script>
</body>
</html>
