<!-- … head as before … -->

<body>
  <!-- … logo, theme toggle, header … -->

  <div class="container slide-in">
    <!-- Plan details -->
    <h1>Your Plan</h1>
    <div class="divider"></div>
    <div class="details-panel">
      <ul>
        <li><span>Plan:</span><span id="plan-name">—</span></li>
        <li><span>Price:</span><span id="plan-price">—</span></li>
        <li><span>You Save:</span><span id="plan-save">—</span></li>
      </ul>
    </div>

    <!-- Payment buttons -->
    <button id="paystackBtn" class="btn-pay">Loading…</button>
    <button id="cryptoBtn" class="btn-crypto">I’ll Transfer Crypto</button>

    <!-- Crypto addresses + copy -->
    <div class="crypto-section" id="cryptoSection">
      <div class="crypto-grid" id="cryptoGrid"></div>
    </div>

    <!-- Email capture after “Paid” -->
    <div class="form-wrapper" id="emailSection">
      <form id="paymentForm">
        <label for="emailInput">Your Email (must match registration)</label>
        <input type="email" id="emailInput" placeholder="you@example.com" required/>
        <button type="submit" id="paidBtn">I’ve Paid</button>
      </form>
      <div id="successMessage">
        Your payment is pending verification!
      </div>
    </div>

    <!-- Change package link -->
    <a href="vip-subscription.html" class="back-link">← Change Plan</a>
  </div>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // 1. Init theme + slide-in
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.slide-in').forEach((el,i)=>{
        setTimeout(()=>el.classList.add('visible'), (i+1)*150 );
      });
      // 2. Read plan from URL
      const params = new URLSearchParams(location.search);
      const key    = params.get('plan') || 'weekly';
      const cfg = {
        weekly:  {n:'Weekly Plan',  p:50,   s:0},
        monthly: {n:'Monthly Plan', p:150,  s:50},
        yearly:  {n:'Yearly Plan',  p:1500, s:300}
      };
      const ch = cfg[key];
      document.getElementById('plan-name').textContent  = ch.n;
      document.getElementById('plan-price').textContent = `$${ch.p}`;
      document.getElementById('plan-save').textContent  = `$${ch.s}`;

      // 3. Supabase client
      const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
      const SUPABASE_KEY = 'PASTE_YOUR_FULL_ANON_KEY_HERE';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let selectedMethodId = null;

      // 4. Fetch payment methods
      supabase
        .from('payment_methods')
        .select('*')
        .order('id', { ascending: true })
        .then(({ data, error })=>{
          if(error) {
            console.error(error);
            document.getElementById('paystackBtn').textContent = 'Error loading payments';
            return;
          }

          // Card / bank button
          const card = data.find(m=>m.type==='card');
          const payBtn = document.getElementById('paystackBtn');
          if(card) {
            payBtn.textContent = card.name;
            payBtn.onclick = ()=>{
              selectedMethodId = card.id;
              // redirect to the link
              window.location.href = card.details.link;
            };
          } else {
            payBtn.textContent = 'No Card Available';
            payBtn.disabled = true;
          }

          // Crypto toggle
          document.getElementById('cryptoBtn').onclick = ()=>{
            const sec = document.getElementById('cryptoSection');
            const frm = document.getElementById('emailSection');
            const show = sec.style.display !== 'block';
            sec.style.display = show ? 'block' : 'none';
            frm.style.display = show ? 'block' : 'none';
          };

          // Render crypto cards
          const grid = document.getElementById('cryptoGrid');
          data.filter(m=>m.type==='crypto').forEach(c=>{
            const div = document.createElement('div');
            div.className = 'crypto-card';
            div.innerHTML = `
              <div class="label">${c.name}</div>
              <div class="address">${c.details.address}</div>
              <button class="copy-btn">Copy</button>`;
            grid.append(div);
            div.querySelector('.copy-btn').onclick = ()=>{
              navigator.clipboard.writeText(c.details.address).then(()=>{
                const b = div.querySelector('.copy-btn');
                b.textContent = 'Copied!';
                setTimeout(()=> b.textContent = 'Copy', 1500);
              });
              selectedMethodId = c.id;
            };
          });
        });

      // 5. Handle “I’ve Paid” submission
      document.getElementById('paymentForm').onsubmit = async e => {
        e.preventDefault();
        const email = document.getElementById('emailInput').value.trim();
        if(!email) return alert('Please enter your registered email');
        if(!selectedMethodId) return alert('Select a payment method first');
        const { error } = await supabase
          .from('payments')
          .insert([{ email, plan: ch.n, method_id: selectedMethodId }]);
        if(error) {
          alert('Submission failed: ' + error.message);
        } else {
          document.getElementById('successMessage').style.display = 'block';
          // redirect or let them stay until admin picks it up
          setTimeout(()=> window.location.href='index.html', 3000);
        }
      };
    });
  </script>
</body>
</html>
