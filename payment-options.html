<!-- (HEAD remains unchanged) -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Load settings from Admin Panel
    let settings = {};
    try {
      settings = JSON.parse(localStorage.getItem('settings')) || {};
    } catch (e) {
      console.warn('Error loading admin settings:', e);
      settings = {};
    }

    const walletMap = {
      Bitcoin: settings.btc || 'BTC not set',
      Ethereum: settings.eth || 'ETH not set',
      USDT: settings.usdt || 'USDT not set'
    };
    const paystackKey = settings.paystackKey || '';

    // 2. Display selected plan
    const selectedPackage = sessionStorage.getItem('selectedPackage') || '';
    const planNames = {
      weekly: 'Weekly VIP Plan – $50',
      monthly: 'Monthly VIP Plan – $150',
      yearly: 'Yearly VIP Plan – $1500'
    };
    const amountMap = {
      weekly: 50, monthly: 150, yearly: 1500
    };
    document.getElementById('selectedPlanInfo').textContent =
      planNames[selectedPackage] || 'No valid package selected.';

    // 3. Handle crypto reveal
    document.getElementById('cryptoBtn').addEventListener('click', () => {
      document.getElementById('cryptoOptions').style.display = 'block';
    });

    // 4. Update wallet address on crypto type change
    document.getElementById('cryptoType').addEventListener('change', function () {
      const addr = walletMap[this.value] || 'Not set';
      document.getElementById('walletAddress').textContent = addr;
    });

    // 5. Copy wallet button
    document.getElementById('copyWalletBtn').addEventListener('click', () => {
      const w = document.getElementById('walletAddress').textContent;
      if (w && w !== 'Not set') {
        navigator.clipboard.writeText(w).then(() => alert('Wallet address copied!'));
      } else {
        alert('No wallet address to copy');
      }
    });

    // 6. Simulate Paystack
    document.getElementById('paystackBtn').addEventListener('click', () => {
      if (!paystackKey) {
        return alert('Paystack key not set in Admin Settings');
      }
      alert('Simulated Paystack payment. After payment, press Submit.');
    });

    // 7. Submit Payment
    document.getElementById('paymentForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const email = document.getElementById('userEmail').value.trim().toLowerCase();
      const cryptoType = document.getElementById('cryptoType').value;
      const wallet = walletMap[cryptoType] || '';
      const method = wallet ? cryptoType : 'Paystack';
      const amount = amountMap[selectedPackage] || 0;

      if (!email || !email.includes('@')) return alert('Enter a valid email.');
      if (document.getElementById('cryptoOptions').style.display === 'block' && !cryptoType) {
        return alert('Please select a cryptocurrency.');
      }
      if (!selectedPackage || !planNames[selectedPackage]) {
        return alert('No valid package selected.');
      }

      let records = [];
      try {
        records = JSON.parse(localStorage.getItem('paymentRecords')) || [];
      } catch {
        records = [];
      }

      // Prevent duplicates
      const alreadyExists = records.some(r => r.email === email && r.status !== 'expired');
      if (alreadyExists) {
        return alert('You already submitted a payment. Please wait for approval.');
      }

      const newRecord = {
        name: email.split('@')[0],
        email,
        username: email.split('@')[0],
        amount,
        method,
        walletType: cryptoType || 'Paystack',
        proof: '',
        status: 'pending',
        submittedAt: new Date().toISOString()
      };

      records.push(newRecord);
      localStorage.setItem('paymentRecords', JSON.stringify(records));
      sessionStorage.setItem('paymentApproved', 'false');

      alert('Payment submitted successfully! Awaiting admin approval.');
      window.location.href = 'index.html';
    });
  });
</script>
