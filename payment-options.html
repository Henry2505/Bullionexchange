<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment Options – CBE</title>
  <link rel="stylesheet" href="theme.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>
  <style>
    /* (Keep your existing CSS here) */
    /* Hide proof form until a method is chosen */
    #proof-section { display:none; }
  </style>
</head>
<body>
  <!-- Logo & Theme Toggle (as before) -->

  <div class="container slide-in">
    <h1>Your Plan</h1>
    <div class="divider"></div>
    <div class="details-panel">
      <ul>
        <li><span>Plan:</span><span id="plan-name">—</span></li>
        <li><span>Price:</span><span id="plan-price">—</span></li>
        <li><span>You Save:</span><span id="plan-save">—</span></li>
      </ul>
    </div>

    <!-- Methods will be injected here -->
    <div id="methods-container" class="slide-in"></div>

    <!-- Proof Upload -->
    <div class="form-wrapper slide-in" id="proof-section">
      <form id="proofForm">
        <input type="hidden" id="selectedMethodId"/>
        <label for="emailInput">Your Email</label>
        <input type="email" id="emailInput" placeholder="you@example.com" required/>

        <label for="proofInput">Upload Payment Proof</label>
        <input type="file" id="proofInput" accept="image/*,application/pdf" required/>

        <button type="submit">Submit Payment</button>
      </form>
      <div id="successMessage" style="display:none; text-align:center; margin-top:1rem; color:var(--gold); font-weight:600;">
        Your payment is pending verification!
      </div>
    </div>

    <a href="vip-subscription.html" class="back-link slide-in">← Change Plan</a>
  </div>

  <footer>© 2025 Chukwuemeka Bullion Exchange. All rights reserved.</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // VIP plan details (unchanged)
    const params = new URLSearchParams(location.search),
          key    = params.get('plan')||'weekly',
          cfg    = {
            weekly:  {n:'Weekly Plan',  p:50,  s:0},
            monthly: {n:'Monthly Plan', p:150, s:50},
            yearly:  {n:'Yearly Plan',  p:1500, s:300},
          },
          ch = cfg[key];
    document.getElementById('plan-name').textContent  = ch.n;
    document.getElementById('plan-price').textContent = `$${ch.p}`;
    document.getElementById('plan-save').textContent  = `$${ch.s}`;

    // Supabase
    const URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co',
          KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(URL, KEY);

    // Load and render methods
    async function loadMethods() {
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*')
        .order('id');
      if (error) return console.error(error);

      const container = document.getElementById('methods-container');
      container.innerHTML = '';
      data.forEach(m => {
        const btn = document.createElement('button');
        btn.className = m.type==='card'?'btn-pay slide-in':'btn-crypto slide-in';
        btn.textContent = m.name;
        btn.onclick = () => onSelectMethod(m);
        container.appendChild(btn);
      });
    }

    // When a method is clicked…
    async function onSelectMethod(m) {
      document.getElementById('selectedMethodId').value = m.id;

      if (m.type === 'card') {
        // redirect immediately
        const { link } = m.details;
        return window.location.href = link;
      }

      // crypto: show addresses + proof form
      renderCryptoGrid(m);
      document.getElementById('proof-section').style.display = 'block';
    }

    function renderCryptoGrid(m) {
      // find all crypto methods
      supabase
        .from('payment_methods')
        .select('*')
        .eq('type','crypto')
        .order('id')
        .then(({ data }) => {
          const grid = document.getElementById('cryptoGrid');
          if (!grid) {
            const sec = document.createElement('div');
            sec.id = 'cryptoGrid';
            sec.className = 'crypto-grid slide-in';
            document.getElementById('proof-section').before(sec);
          }
          document.getElementById('cryptoGrid').innerHTML = '';
          data.forEach(c => {
            const { code, address } = c.details;
            const card = document.createElement('div');
            card.className = 'crypto-card';
            card.innerHTML = `
              <div class="label">${c.name}</div>
              <div class="address">${address}</div>
              <button class="copy-btn">Copy</button>`;
            document.getElementById('cryptoGrid').appendChild(card);
          });
        });
    }

    // Copy handler
    document.addEventListener('click', e => {
      if (e.target.matches('.copy-btn')) {
        const addr = e.target.closest('.crypto-card').querySelector('.address').textContent;
        navigator.clipboard.writeText(addr).then(()=>{
          e.target.textContent = 'Copied!';
          setTimeout(()=> e.target.textContent = 'Copy',1500);
        });
      }
    });

    // Proof form submission
    document.getElementById('proofForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fileEl = document.getElementById('proofInput');
      const file   = fileEl.files[0];
      const method_id = +document.getElementById('selectedMethodId').value;
      const email  = document.getElementById('emailInput').value;

      // 1) upload proof
      const fileName = `${Date.now()}_${file.name}`;
      let { error:upErr } = await supabase
        .storage.from('payment-proofs')
        .upload(fileName, file);
      if (upErr) return alert(upErr.message);

      // 2) get URL
      const { data:urlData, error:urlErr } = await supabase
        .storage.from('payment-proofs')
        .getPublicUrl(fileName);
      if (urlErr) return alert(urlErr.message);

      // 3) insert payment record
      const { error:insErr } = await supabase
        .from('payments')
        .insert([{
          email, plan: ch.n,
          method_id, proof_url: urlData.publicUrl
        }]);
      if (insErr) return alert(insErr.message);

      // success
      document.getElementById('successMessage').style.display = 'block';
      e.target.reset();
      setTimeout(()=>window.location.href='index.html',3000);
    });

    document.addEventListener('DOMContentLoaded', loadMethods);
  </script>
</body>
</html>
