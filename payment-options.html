<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Payment page initialized');

    // 1) Load admin settings
    let settings = {};
    try {
      settings = JSON.parse(localStorage.getItem('paymentSettings')) || {};
    } catch (e) {
      console.error('Error parsing paymentSettings:', e);
    }

    const walletMap = { Bitcoin: settings.btc, Ethereum: settings.eth, USDT: settings.usdt };
    const paystackKey = settings.paystackKey || '';

    // 2) Show selected plan
    const pkg = sessionStorage.getItem('selectedPackage') || '';
    const planNames = {
      weekly: 'Weekly VIP Plan – $50',
      monthly: 'Monthly VIP Plan – $150',
      yearly: 'Yearly VIP Plan – $1500'
    };
    document.getElementById('selectedPlanInfo').textContent = planNames[pkg] || 'No valid package selected.';

    // 3) Crypto reveal
    document.getElementById('cryptoBtn').addEventListener('click', () => {
      console.log('Crypto reveal');
      document.getElementById('cryptoOptions').style.display = 'block';
    });

    // 4) Update wallet address
    document.getElementById('cryptoType').addEventListener('change', function () {
      const addr = walletMap[this.value] || 'Not set';
      console.log('Crypto type:', this.value, 'Address:', addr);
      document.getElementById('walletAddress').textContent = addr;
    });

    // 5) Copy wallet
    document.getElementById('copyWalletBtn').addEventListener('click', () => {
      const w = document.getElementById('walletAddress').textContent;
      if (w && w !== 'Not set') {
        navigator.clipboard.writeText(w).then(() => alert('Wallet copied'));
      } else {
        alert('No wallet to copy');
      }
    });

    // 6) Simulate Paystack
    document.getElementById('paystackBtn').addEventListener('click', () => {
      if (!paystackKey) {
        return alert('Paystack key missing in Admin Settings');
      }
      console.log('Simulated Paystack flow');
      alert('Simulated Paystack – upload proof & submit');
    });

    // 7) Form submit — always fires
    document.getElementById('paymentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      console.log('Form submission triggered');

      const email = document.getElementById('userEmail').value.trim().toLowerCase();
      const proofFile = document.getElementById('proof').files[0];
      const cryptoType = document.getElementById('cryptoType').value;
      const wallet = walletMap[cryptoType] || '';
      let records = JSON.parse(localStorage.getItem('paymentRecords') || '[]');

      // Validations
      if (!pkg || !planNames[pkg]) {
        console.warn('Validation failed: No plan selected');
        return alert('No plan selected. Please select a plan.');
      }
      if (!email || !email.includes('@')) {
        console.warn('Validation failed: Invalid email');
        return alert('Enter a valid email address.');
      }
      if (!proofFile) {
        console.warn('Validation failed: No proof file');
        return alert('Please upload proof of payment.');
      }
      if (document.getElementById('cryptoOptions').style.display === 'block' && !cryptoType) {
        console.warn('Validation failed: No crypto type selected');
        return alert('Please select a crypto type.');
      }
      if (proofFile.size > 5 * 1024 * 1024) {
        console.warn('Validation failed: Proof file too large');
        return alert('Proof file must be under 5MB.');
      }
      if (records.some((r) => r.email === email && r.status !== 'expired')) {
        console.warn('Validation failed: Duplicate payment');
        return alert('A payment for this email is already submitted.');
      }

      // Read & save
      const reader = new FileReader();
      reader.onload = function (ev) {
        try {
          console.log('Proof read, saving record');
          records.push({
            name: email.split('@')[0],
            email,
            username: email.split('@')[0],
            amount: pkg === 'weekly' ? 50 : pkg === 'monthly' ? 150 : pkg === 'yearly' ? 1500 : 0,
            method: wallet ? cryptoType : 'Paystack',
            walletType: cryptoType || 'Paystack',
            proof: ev.target.result,
            status: 'pending',
            submittedAt: new Date().toISOString()
          });
          localStorage.setItem('paymentRecords', JSON.stringify(records));
          sessionStorage.setItem('paymentApproved', 'false');
          alert('Payment submitted! Awaiting approval.');
          
          // Attempt navigation with fallback
          try {
            window.location.href = 'CBE_login.html';
          } catch (navError) {
            console.error('Navigation failed:', navError);
            alert('Submission successful, but redirect failed. Please navigate to the login page manually.');
          }
        } catch (error) {
          console.error('Error saving record:', error);
          alert('Error saving payment. Please try again.');
        }
      };
      reader.onerror = () => {
        console.error('FileReader error:', reader.error);
        alert('Error reading proof file. Please try a different file.');
      };
      reader.readAsDataURL(proofFile);
    });
  });
</script>
