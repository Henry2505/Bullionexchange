<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Options – CBE</title>
  <link rel="stylesheet" href="theme.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet"/>
  <script>
    // initialize theme
    document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
  </script>
  <script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>
  <style>
    /* (Your existing CSS from the last version, unchanged) */
    /* … */
  </style>
</head>
<body>
  <div class="logo"><a href="index.html"><img src="CBE_logo.PNG" alt="CBE Logo"></a></div>
  <button id="theme-toggle" aria-label="Toggle theme">🌞</button>

  <div class="container">
    <h1 class="slide-in" data-delay="0.2">Your Plan</h1>
    <div class="divider slide-in" data-delay="0.4"></div>

    <div class="details-panel slide-in" data-delay="0.6">
      <ul>
        <li><span>Plan:</span><span id="plan-name">—</span></li>
        <li><span>Price:</span><span id="plan-price">—</span></li>
        <li><span>You Save:</span><span id="plan-save">—</span></li>
      </ul>
    </div>

    <button id="paystackBtn" class="btn-pay slide-in" data-delay="0.8">Loading…</button>
    <button id="cryptoBtn" class="btn-crypto slide-in" data-delay="1.0">I’ll Transfer Crypto</button>

    <div class="crypto-section slide-in" id="cryptoSection" data-delay="1.2" style="display:none;">
      <div class="crypto-grid" id="cryptoGrid"></div>
    </div>

    <div class="form-wrapper slide-in" id="emailSection" data-delay="1.4" style="display:none;">
      <form id="paymentForm">
        <label for="emailInput">Your Email (must match registration)</label>
        <input type="email" id="emailInput" placeholder="you@example.com" required/>
        <button type="submit">Submit Payment</button>
      </form>
      <div id="successMessage" style="display:none; text-align:center; margin-top:1rem; color:var(--gold); font-weight:600;">
        Your payment is pending verification!
      </div>
    </div>

    <a href="vip-subscription.html" class="back-link slide-in" data-delay="1.6">← Change Subscription Package</a>
  </div>

  <footer class="slide-in" data-delay="1.8">© 2025 Chukwuemeka Bullion Exchange. All rights reserved.</footer>

  <!-- 1) Use the UMD build so supabase.createClient works -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // IntersectionObserver for slide-ins
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.slide-in').forEach(el => {
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              setTimeout(() => e.target.classList.add('visible'),
                         parseFloat(e.target.dataset.delay)*1000);
              obs.unobserve(e.target);
            }
          });
        }, { threshold: 0.2 });
        observer.observe(el);
      });
      initPage();
    });

    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.addEventListener('click', () => {
      const curr = document.documentElement.getAttribute('data-theme');
      const next = curr === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeBtn.textContent = next === 'dark' ? '🌞' : '🌜';
    });
    themeBtn.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '🌞' : '🌜';

    // Read plan
    const params = new URLSearchParams(location.search);
    const key = params.get('plan') || 'weekly';
    const cfg = {
      weekly:  {n:'Weekly Plan',  p:50,  s:0},
      monthly: {n:'Monthly Plan', p:150, s:50},
      yearly:  {n:'Yearly Plan',  p:1500, s:300}
    };
    const ch = cfg[key];
    document.getElementById('plan-name').textContent  = ch.n;
    document.getElementById('plan-price').textContent = `$${ch.p}`;
    document.getElementById('plan-save').textContent  = `$${ch.s}`;

    // Init Supabase
    const supabase = supabase.createClient(
      'https://dapwpgvnfjcfqqhrpxla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhZ3Nl...ICC0UsQ'
    );

    let cardMethod;
    async function initPage() {
      // Fetch methods
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*')
        .order('id');
      if (error) {
        console.error('Error loading methods:', error);
        document.getElementById('paystackBtn').textContent = 'Error';
        return;
      }

      // Card button
      cardMethod = data.find(m => m.type === 'card');
      const payBtn = document.getElementById('paystackBtn');
      if (cardMethod) {
        payBtn.textContent = cardMethod.name;
        payBtn.onclick    = () => window.location.href = cardMethod.details.link;
      } else {
        payBtn.textContent = 'No Card Method';
        payBtn.disabled    = true;
      }

      // Crypto toggle
      document.getElementById('cryptoBtn').onclick = () => {
        const sec = document.getElementById('cryptoSection'),
              frm = document.getElementById('emailSection');
        const show = sec.style.display !== 'block';
        sec.style.display = frm.style.display = show ? 'block' : 'none';
        if (show) sec.classList.add('visible'), frm.classList.add('visible');
      };

      // Render crypto grid
      const grid = document.getElementById('cryptoGrid');
      data.filter(m => m.type === 'crypto').forEach(c => {
        const card = document.createElement('div');
        card.className = 'crypto-card slide-in';
        card.dataset.delay = '1.2';
        card.innerHTML = `
          <div class="label">${c.name}</div>
          <div class="address">${c.details.address}</div>
          <button class="copy-btn">Copy</button>`;
        grid.append(card);

        // Copy handler
        card.querySelector('.copy-btn').onclick = () => {
          navigator.clipboard.writeText(c.details.address).then(() => {
            const btn = event.currentTarget;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 1500);
          });
        };
      });

      // Submit payment
      document.getElementById('paymentForm').onsubmit = async e => {
        e.preventDefault();
        const email = document.getElementById('emailInput').value.trim();
        if (!email) return alert('Enter your registered email.');

        const { error: insErr } = await supabase
          .from('payments')
          .insert([{ email, plan: ch.n, method_id: cardMethod?.id ?? null }]);
        if (insErr) {
          return alert('Submit failed: ' + insErr.message);
        }

        document.getElementById('successMessage').style.display = 'block';
        setTimeout(() => location.href = 'index.html', 3000);
      };
    }
  </script>
</body>
</html>
