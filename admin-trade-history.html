<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBE Admin – Trade History</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif; background:#000; color:#fff; }
    .glass { background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); border:1px solid rgba(255,215,0,0.2); padding:1rem; border-radius:8px; }
    .form-section { margin-bottom:2rem; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="text-center text-warning mb-4">CBE Admin – Trade History (Debug Mode)</h1>

    <div class="glass form-section">
      <h2 class="text-gold">Add New Trade</h2>
      <form id="trade-upload-form">
        <div class="mb-3">
          <label class="form-label text-light">Date</label>
          <input type="date" id="trade-date" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label text-light">Asset</label>
          <input type="text" id="trade-pair" class="form-control" value="EUR/USD" required>
        </div>
        <div class="mb-3">
          <label class="form-label text-light">Notes</label>
          <input type="text" id="trade-notes" class="form-control" value="Test trade">
        </div>
        <div class="mb-3">
          <label class="form-label text-light">Screenshot</label>
          <input type="file" id="trade-file" class="form-control" accept="image/*" required>
        </div>
        <button type="submit" class="btn btn-success">Submit Trade</button>
      </form>
    </div>

    <hr class="border-secondary">

    <h2 class="text-warning">Existing Trades</h2>
    <table id="history-table" class="table table-striped table-dark">
      <thead>
        <tr><th>Date</th><th>Asset</th><th>Notes</th><th>Screenshot</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // — Admin-only page must protect this key!
    const supabase = supabase.createClient(
      'https://dapwpgvnfjcfqqhrpxla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlcnZpY2VjZV9yb2xlIiwiaWF0IjoxNzQ3MDQwODg4LCJleHAiOjIwNjI2MTY4ODh9.Xe1EO_BbF0Rtmp2QpM5L-dwCCvXvcfMu5A_ieRCyp5U'
    );

    // Simple load function
    async function loadTrades() {
      const { data, error } = await supabase
        .from('trade_history')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) {
        alert('❌ Load error: ' + error.message);
        return;
      }
      const tbody = document.querySelector('#history-table tbody');
      tbody.innerHTML = '';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.date).toLocaleDateString()}</td>
          <td>${r.asset}</td>
          <td>${r.notes}</td>
          <td>${r.screenshot ? `<img src="${r.screenshot}" height="50">` : ''}</td>
        `;
        tbody.appendChild(tr);
      });
      alert(`✅ Loaded ${data.length} trades`);
    }

    document.getElementById('trade-upload-form').addEventListener('submit', async e => {
      e.preventDefault();
      const date  = document.getElementById('trade-date').value;
      const asset = document.getElementById('trade-pair').value;
      const notes = document.getElementById('trade-notes').value;
      const file  = document.getElementById('trade-file').files[0];
      if (!file) return alert('Please select a file first');

      // 1) Upload
      alert('1️⃣ Starting upload...');
      const filename = `trade_${Date.now()}_${file.name}`;
      const { error: upErr } = await supabase
        .storage.from('screenshots').upload(filename, file);
      if (upErr) {
        return alert('❌ Upload error: ' + upErr.message);
      }
      alert('2️⃣ File uploaded');

      // 2) Get public URL
      alert('3️⃣ Getting public URL...');
      const { data: pu, error: urlErr } = supabase
        .storage.from('screenshots').getPublicUrl(filename);
      if (urlErr) {
        return alert('❌ URL error: ' + urlErr.message);
      }
      alert('4️⃣ URL is: ' + pu.publicUrl);

      // 3) Insert row
      alert('5️⃣ Inserting row into trade_history...');
      const { data: ins, error: insErr } = await supabase
        .from('trade_history')
        .insert([{ date, asset, notes, screenshot: pu.publicUrl }]);
      if (insErr) {
        return alert('❌ Insert error: ' + insErr.message);
      }
      alert('6️⃣ Insert succeeded! Row ID: ' + ins[0].id);

      // Finally reload
      loadTrades();
    });

    // initial load
    loadTrades();
  </script>
</body>
</html>
