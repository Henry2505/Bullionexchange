<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Testimonials â€“ CBE</title>
    <meta
      name="description"
      content="Real feedback from traders whoâ€™ve grown with Chukwuemeka Bullion Exchange."
    />
    <meta name="keywords" content="CBE, testimonials, forex trading, feedback" />

    <!-- Theme CSS -->
    <link rel="stylesheet" href="theme.css" />

    <!-- Playfair & Roboto -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* RESET & BASE */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "Roboto", sans-serif;
        color: var(--text);
        background: var(--bg);
        overflow-x: hidden;
        line-height: 1.6;
      }
      a {
        color: var(--gold);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      /* LOGO & THEME TOGGLE */
      .logo {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 10;
      }
      .logo img {
        width: 160px;
        cursor: pointer;
        transition: transform 0.3s;
      }
      .logo img:hover {
        transform: scale(1.05);
      }
      #theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text);
        cursor: pointer;
        transition: transform 0.3s;
      }
      #theme-toggle:hover {
        transform: scale(1.2);
      }

      /* SLIDE-IN */
      .slide-in {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.7s ease-out, transform 0.7s ease-out;
      }
      .slide-in.visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* MAIN WRAPPER */
      main {
        max-width: 900px;
        margin: 0 auto;
        padding: 140px 20px 60px;
      }

      /* HEADER CARD */
      .header-card {
        background: var(--glass-bg);
        backdrop-filter: blur(8px);
        padding: 60px 20px;
        text-align: center;
        border-radius: 12px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        margin-bottom: 40px;
      }
      .header-card h1 {
        font-family: "Playfair Display", serif;
        font-size: 3rem;
        color: var(--gold);
        margin-bottom: 10px;
      }
      .header-card p {
        font-size: 1.1rem;
        color: var(--text-light);
      }

      /* FORM & PROGRESS BAR */
      .form-card {
        background: var(--glass-bg);
        backdrop-filter: blur(8px);
        padding: 40px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        margin-bottom: 60px;
      }
      .form-card h2 {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        color: var(--gold);
        margin-bottom: 20px;
        text-align: center;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-light);
      }
      .form-group input[type="text"],
      .form-group textarea {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: var(--text);
        font-size: 1rem;
      }
      .form-group input[type="file"] {
        color: var(--text-light);
      }
      .form-card button {
        display: block;
        margin: 20px auto 0;
        padding: 12px 30px;
        background: var(--gold);
        color: #000;
        font-family: "Playfair Display", serif;
        font-size: 1.1rem;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .form-card button:hover:enabled {
        transform: scale(1.05);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      }
      .form-card button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Progress bar container & fill */
      #progressContainer {
        width: 100%;
        height: 8px;
        background: #fff;
        border-radius: 4px;
        margin-top: 10px;
        overflow: hidden;
        display: none;
      }
      #progressBar {
        width: 0;
        height: 100%;
        background: #4caf50;
        transition: width 0.2s ease;
      }

      /* TESTIMONIAL GRID */
      .testimonials-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .testimonial-card {
        background: var(--glass-bg);
        backdrop-filter: blur(6px);
        padding: 30px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
      }
      .testimonial-card.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .testimonial-card blockquote {
        font-style: italic;
        margin-bottom: 15px;
        color: var(--text-light);
        line-height: 1.4;
      }
      .testimonial-card .byline {
        text-align: right;
        font-weight: 500;
        color: var(--text-muted);
      }
      .testimonial-card img,
      .testimonial-card video {
        display: block;
        max-width: 100%;
        margin: 15px auto 0;
        border-radius: 6px;
      }
      .company-response {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
      }
      .company-response strong {
        display: block;
        margin-bottom: 8px;
        color: var(--gold);
      }

      /* FOOTER */
      footer {
        text-align: center;
        padding: 20px 0;
        margin-top: 60px;
        color: var(--text-muted);
      }

      /* RESPONSIVE */
      @media (max-width: 768px) {
        main {
          padding: 120px 15px 40px;
        }
        .logo img {
          width: 120px;
        }
        .header-card h1 {
          font-size: 2.4rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="logo slide-in">
      <a href="index.html"><img src="CBE_logo.PNG" alt="CBE Logo" /></a>
    </div>
    <button id="theme-toggle" aria-label="Toggle light/dark" class="slide-in">
      ðŸŒž
    </button>

    <main>
      <div class="header-card slide-in">
        <h1>What Our Members Are Saying</h1>
        <p>Real feedback from traders whoâ€™ve grown with CBE.</p>
      </div>

      <div class="form-card slide-in" style="transition-delay: 0.3s;">
        <h2>Share Your Experience</h2>
        <form id="testimonialForm">
          <div class="form-group">
            <label for="name">Your Name<span style="color: red;">*</span></label>
            <input
              type="text"
              id="name"
              name="name"
              required
              maxlength="255"
            />
          </div>
          <div class="form-group">
            <label for="testimonial"
              >Your Testimonial<span style="color: red;">*</span></label
            >
            <textarea
              id="testimonial"
              name="testimonial_text"
              rows="4"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="media">Upload Photo or Video (optional)</label>
            <input
              type="file"
              id="media"
              name="media"
              accept="image/*,video/*"
            />
            <small style="color: var(--text-muted);">
              Max. 5 MB (images), no limit (videos)
            </small>
          </div>

          <div id="progressContainer">
            <div id="progressBar"></div>
          </div>

          <button type="submit" id="submitBtn">Submit for Review</button>
        </form>
        <div
          id="submitAlert"
          style="text-align: center; margin-top: 15px; font-weight: 600;"
        ></div>
      </div>

      <section
        id="testimonialsSection"
        class="slide-in"
        style="transition-delay: 0.6s;"
      >
        <h2
          style="
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            margin-bottom: 20px;
          "
        >
          Approved Testimonials
        </h2>
        <div class="testimonials-grid" id="testimonialsGrid"></div>
      </section>
    </main>

    <footer class="slide-in" style="transition-delay: 0.9s;">
      Â© 2025 Chukwuemeka Bullion Exchange. All rights reserved.
    </footer>

    <!-- Supabase & Main Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script defer>
      document.addEventListener("DOMContentLoaded", () => {
        // SLIDE-IN OBSERVER
        document.querySelectorAll(".slide-in").forEach((el) => {
          new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((e) => {
                if (e.isIntersecting) {
                  e.target.classList.add("visible");
                  obs.unobserve(e.target);
                }
              });
            },
            { threshold: 0.2, rootMargin: "0px 0px -50px 0px" }
          ).observe(el);
        });

        // THEME TOGGLE LOGIC
        const toggle = document.getElementById("theme-toggle");
        const setTheme = (t) => {
          document.documentElement.setAttribute("data-theme", t);
          localStorage.setItem("theme", t);
          toggle.textContent = t === "dark" ? "ðŸŒž" : "ðŸŒœ";
        };
        toggle.addEventListener("click", () =>
          setTheme(
            document.documentElement.getAttribute("data-theme") === "dark"
              ? "light"
              : "dark"
          )
        );
        setTheme(localStorage.getItem("theme") || "dark");

        // INITIALIZE SUPABASE CLIENT
        const SUPABASE_URL = "https://dapwpgvnfjcfqqhrpxla.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ";
        const supabase = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY
        );

        // LOAD APPROVED TESTIMONIALS
        async function loadTestimonials() {
          const { data, error } = await supabase
            .from("testimonials")
            .select(
              "name,testimonial_text,screenshot_url,video_url,company_response"
            )
            .eq("status", "approved")
            .order("created_at", { ascending: false });
          if (error) return console.error("Fetch error:", error);
          const grid = document.getElementById("testimonialsGrid");
          grid.innerHTML = "";
          data.forEach((t) => {
            const card = document.createElement("div");
            card.className = "testimonial-card";
            let html = `<blockquote>${t.testimonial_text}</blockquote>`;
            html += `<div class="byline">â€” ${t.name}</div>`;
            if (t.screenshot_url) {
              html += `<img src="${t.screenshot_url}" alt="testimonial image"/>`;
            } else if (t.video_url) {
              html += `<video controls><source src="${t.video_url}" type="video/mp4"/></video>`;
            }
            if (t.company_response) {
              html += `<div class="company-response"><strong>Our Response:</strong><p>${t.company_response}</p></div>`;
            }
            card.innerHTML = html;
            grid.appendChild(card);
            new IntersectionObserver(
              (entries, obs) => {
                entries.forEach((e) => {
                  if (e.isIntersecting) {
                    e.target.classList.add("visible");
                    obs.unobserve(e.target);
                  }
                });
              },
              { threshold: 0.2 }
            ).observe(card);
          });
        }
        loadTestimonials();

        // FORM SUBMISSION: UPLOAD + INSERT + EMAIL NOTIFICATION
        const form = document.getElementById("testimonialForm");
        const alertDiv = document.getElementById("submitAlert");
        const submitBtn = document.getElementById("submitBtn");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          alertDiv.textContent = "";
          submitBtn.disabled = true;
          progressBar.style.width = "0%";
          progressContainer.style.display = "block";
          alertDiv.style.color = "var(--text)";
          alertDiv.textContent = "Uploadingâ€¦";

          // READ FORM VALUES
          const name = form.name.value.trim();
          const text = form.testimonial_text.value.trim(); // use testimonial_text
          if (!name || !text) {
            alertDiv.style.color = "crimson";
            alertDiv.textContent = "Please fill both name & testimonial.";
            submitBtn.disabled = false;
            progressContainer.style.display = "none";
            return;
          }

          let screenshot_url = null,
            video_url = null;
          const file = form.media.files[0];
          if (file) {
            if (file.type.startsWith("image/") && file.size > 5 * 1024 * 1024) {
              alertDiv.style.color = "crimson";
              alertDiv.textContent = "Image must be under 5 MB.";
              submitBtn.disabled = false;
              progressContainer.style.display = "none";
              return;
            }

            const bucket = file.type.startsWith("image/")
              ? "testimonial-screenshots"
              : "testimonial-videos";
            const path = `${bucket}/${Date.now()}_${file.name}`;

            // UPLOAD WITH PROGRESS
            const { error: uploadErr } = await supabase.storage
              .from(bucket)
              .upload(
                path,
                file,
                {
                  onProgress: (evt) => {
                    const pct = Math.round((evt.loaded / evt.total) * 100);
                    progressBar.style.width = pct + "%";
                    alertDiv.textContent = `Uploadingâ€¦ ${pct}%`;
                  },
                }
              );
            if (uploadErr) {
              console.error("Upload Error â†’", uploadErr);
              alertDiv.style.color = "crimson";
              alertDiv.textContent = `Upload failed: ${uploadErr.message}`;
              submitBtn.disabled = false;
              progressContainer.style.display = "none";
              return;
            }

            // GET PUBLIC URL
            const { data: urlData, error: urlErr } = await supabase.storage
              .from(bucket)
              .getPublicUrl(path);
            if (urlErr) {
              console.error("GetPublicUrl Error â†’", urlErr);
              alertDiv.style.color = "crimson";
              alertDiv.textContent = `Couldnâ€™t get URL: ${urlErr.message}`;
              submitBtn.disabled = false;
              progressContainer.style.display = "none";
              return;
            }

            if (file.type.startsWith("image/")) screenshot_url = urlData.publicUrl;
            else video_url = urlData.publicUrl;
          }

          // If no file was selected, hide progress bar immediately
          if (!file) {
            progressContainer.style.display = "none";
          }

          // INSERT NEW TESTIMONIAL (status: "pending")
          const { error: insertErr } = await supabase
            .from("testimonials")
            .insert([
              {
                name,
                testimonial_text: text,
                screenshot_url,
                video_url,
                status: "pending",
              },
            ]);
          if (insertErr) {
            console.error("Insert Error â†’", insertErr);
            alertDiv.style.color = "crimson";
            alertDiv.textContent = `Submit failed: ${insertErr.message}`;
            submitBtn.disabled = false;
            progressContainer.style.display = "none";
            return;
          }

          // FETCH ALL USERS TO NOTIFY
          const { data: users, error: usersErr } = await supabase
            .from("users")
            .select("name,email")
            .neq("email", null); // get every user with a non-null email
          if (usersErr) {
            console.error("Fetch Users Error â†’", usersErr);
            alertDiv.style.color = "crimson";
            alertDiv.textContent = `Error notifying users: ${usersErr.message}`;
            submitBtn.disabled = false;
            progressContainer.style.display = "none";
            return;
          }

          // SEND EMAIL TO EACH USER VIA REPLIT ENDPOINT
          // Replace with your exact Replit App URL (no trailing slash)
          const replitUrl =
            "https://834c7be3-c24e-4a91-a376-0b7d0349031f-00-4lqbyrciqbxn.janeway.replit.dev/resend-email";

          // Build array of Promises for sending emails
          const emailPromises = users.map((u) => {
            const emailPayload = {
              email: u.email,
              templateId: 2, // your Brevo template ID #2
              params: {
                contact: {
                  FIRSTNAME: u.name,
                  EMAIL: u.email,
                },
                testimonial_author: name,
                testimonial_text: text,
                unsubscribe: "https://apexincomeoptions.com.ng/unsubscribe-link",
              },
            };
            return fetch(replitUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(emailPayload),
            }).then((res) => res.json().catch(() => ({ error: "Invalid JSON" })));
          });

          // Wait for all email Promises to resolve
          const emailResults = await Promise.all(emailPromises);

          // Check for failures
          const failedSends = emailResults.filter(
            (r) => r.success === false || r.error
          );
          if (failedSends.length) {
            console.error("Some emails failed â†’", failedSends);
            alertDiv.style.color = "orange";
            alertDiv.textContent =
              "Testimonial submitted, but notification emails encountered errors.\n" +
              JSON.stringify(failedSends, null, 2);
          } else {
            alertDiv.style.color = "lightgreen";
            alertDiv.textContent =
              "Thank youâ€”awaiting approval! All users have been notified of your new testimonial.";
          }

          // Reset form & state
          form.reset();
          submitBtn.disabled = false;
          progressContainer.style.display = "none";

          // Reload testimonials after 5 seconds in case admin approves
          setTimeout(loadTestimonials, 5000);
        });
      });
    </script>

    <!-- Smartsupp Live Chat script -->
    <script type="text/javascript">
      var _smartsupp = _smartsupp || {};
      _smartsupp.key = "018a8bbd868518221e725341a7b2601231ec7ce8";
      window.smartsupp ||
        (function (d) {
          var s,
            c,
            o = (smartsupp = function () {
              o._.push(arguments);
            });
          o._ = [];
          s = d.getElementsByTagName("script")[0];
          c = d.createElement("script");
          c.type = "text/javascript";
          c.charset = "utf-8";
          c.async = true;
          c.src = "https://www.smartsuppchat.com/loader.js?";
          s.parentNode.insertBefore(c, s);
        })(document);
    </script>
  </body>
</html>
