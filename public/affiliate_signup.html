<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Register as an affiliate and get your unique referral code." />
  <title>Affiliate Signup • CBE Global</title>

  <!-- Google Fonts (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap 5.3 CSS & Icons (for basic styling) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <style>
    :root[data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --accent-bg: rgba(30, 30, 30, 0.7);
      --gold: #ffd700;
      --gold-dark: #cca300;
      --text-light: #bbbbbb;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
      --border-color: #333;
    }
    :root[data-theme="light"] {
      --bg: #fafafa;
      --text: #222222;
      --accent-bg: rgba(255, 255, 255, 0.7);
      --gold: #cca300;
      --gold-dark: #b58900;
      --text-light: #555;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
      --border-color: #ddd;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Roboto", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    a { color: var(--gold); text-decoration: none; }
    a:hover { color: var(--gold-dark); text-decoration: underline; }
    .signup-card {
      width: 100%;
      max-width: 450px;
      background: var(--accent-bg);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 30px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .signup-card.visible { opacity: 1; transform: translateY(0); }
    .signup-card h1 { font-size: 1.75rem; color: var(--gold); text-align: center; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    label { font-size: 0.95rem; margin-bottom: 5px; color: var(--text-light); font-weight: 500; }
    input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gold);
      border-radius: 6px;
      background: rgba(28,28,28,0.8);
      color: var(--text);
      font-size: 1rem;
      transition: box-shadow 0.3s ease;
    }
    input:focus { outline: none; box-shadow: 0 0 8px var(--gold); }
    .terms-container {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .terms-container input { width: 20px; height: 20px; accent-color: var(--gold); }
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      background: var(--gold);
      color: #000;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      opacity: 0.6;
      pointer-events: none;
      transition: background 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
    }
    button.enabled { opacity: 1; pointer-events: auto; box-shadow: 0 0 8px var(--gold); }
    button.enabled:hover { background: var(--gold-dark); color: #000; }
    #signup-alert { margin-top: 15px; font-size: 0.9rem; text-align: center; min-height: 24px; white-space: pre-wrap; }
    footer { margin-top: 20px; font-size: 0.85rem; color: var(--text-light); text-align: center; }
  </style>
</head>
<body>
  <div class="signup-card" id="signup-card">
    <h1>Affiliate Signup</h1>

    <!-- Data Collection Notice -->
    <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 20px; text-align: center;">
      By signing up, you agree to our <a href="https://apexincomeoptions.com.ng/terms" target="_blank" rel="noopener">Terms & Conditions</a> and <a href="https://apexincomeoptions.com.ng/privacy" target="_blank" rel="noopener">Privacy Policy</a>. We collect your username, email, and password to create your account and provide affiliate services. Your data may be processed internationally.
    </p>

    <form id="signup-form" novalidate>
      <div class="form-group">
        <label for="aff-username">Username</label>
        <input type="text" id="aff-username" placeholder="Choose a username" required />
      </div>
      <div class="form-group">
        <label for="aff-email">Email Address</label>
        <input type="email" id="aff-email" placeholder="you@example.com" required />
      </div>
      <div class="form-group">
        <label for="aff-password">Password</label>
        <input type="password" id="aff-password" placeholder="Create a password (min 8 chars)" required minlength="8" />
      </div>
      <div class="form-group">
        <label for="aff-password-confirm">Confirm Password</label>
        <input type="password" id="aff-password-confirm" placeholder="Re-enter your password" required />
      </div>
      <div class="terms-container">
        <input type="checkbox" id="confirm-age-terms" />
        <label for="confirm-age-terms">
          I am at least 18 years old and agree to the
          <a href="https://apexincomeoptions.com.ng/terms" target="_blank" rel="noopener">Terms & Conditions</a>
          and
          <a href="https://apexincomeoptions.com.ng/privacy" target="_blank" rel="noopener">Privacy Policy</a>.
        </label>
      </div>
      <button type="submit" id="signup-button" disabled>Sign Up</button>
      <div id="signup-alert" role="alert"></div>
    </form>
  </div>
  <footer>© 2025 Chukwuemeka Bullion Exchange</footer>

  <script>
    const SUPA_URL = "https://dapwpgvnfjcfqqhrpxla.supabase.co";
    const SUPA_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ";
    const supabaseClient = supabase.createClient(SUPA_URL, SUPA_ANON_KEY);

    function generateReferralCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let code = "";
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    async function generateUniqueReferralCode() {
      let code;
      let isUnique = false;
      let attempts = 0;
      const maxAttempts = 5;
      while (!isUnique && attempts < maxAttempts) {
        code = generateReferralCode();
        const { data, error } = await supabaseClient
          .from("affiliates")
          .select("referral_code")
          .eq("referral_code", code)
          .single();
        if (error || !data) {
          isUnique = true;
        }
        attempts++;
      }
      if (!isUnique) {
        throw new Error("Failed to generate unique referral code.");
      }
      return code;
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const card = document.getElementById("signup-card");
      setTimeout(() => card.classList.add("visible"), 100);

      const confirmAgeTerms = document.getElementById("confirm-age-terms");
      const signupBtn = document.getElementById("signup-button");
      const alertDiv = document.getElementById("signup-alert");

      confirmAgeTerms.addEventListener("change", () => {
        signupBtn.disabled = !confirmAgeTerms.checked;
        signupBtn.classList.toggle("enabled", confirmAgeTerms.checked);
      });

      document.getElementById("signup-form").addEventListener("submit", async (evt) => {
        evt.preventDefault();
        alertDiv.textContent = "";
        alertDiv.style.color = "";

        const username = document.getElementById("aff-username").value.trim();
        const email = document.getElementById("aff-email").value.trim().toLowerCase();
        const password = document.getElementById("aff-password").value;
        const confirmPw = document.getElementById("aff-password-confirm").value;

        if (!username || !email || !password || !confirmPw) {
          alertDiv.style.color = "var(--error-color)";
          alertDiv.textContent = "All fields are required.";
          return;
        }
        if (!isValidEmail(email)) {
          alertDiv.style.color = "var(--error-color)";
          alertDiv.textContent = "Please enter a valid email address.";
          return;
        }
        if (password.length < 8) {
          alertDiv.style.color = "var(--error-color)";
          alertDiv.textContent = "Password must be at least 8 characters.";
          return;
        }
        if (password !== confirmPw) {
          alertDiv.style.color = "var(--error-color)";
          alertDiv.textContent = "Passwords do not match.";
          return;
        }

        signupBtn.disabled = true;
        signupBtn.textContent = "Registering…";

        try {
          const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
          if (authError) throw authError;

          const userId = authData.user.id;
          const referralCode = await generateUniqueReferralCode();

          const { error: insertError } = await supabaseClient
            .from("affiliates")
            .insert([{ user_id: userId, username, referral_code: referralCode }]);

          if (insertError) {
            if (insertError.code === "23505") {
              throw new Error("Username already taken.");
            }
            throw insertError;
          }

          alertDiv.style.color = "var(--success-color)";
          alertDiv.textContent = `Signup successful! Your referral code is: ${referralCode}\nPlease log in with your new credentials.`;
          document.getElementById("signup-form").reset();
          confirmAgeTerms.checked = false;
        } catch (err) {
          alertDiv.style.color = "var(--error-color)";
          if (err.message === "User already registered") {
            alertDiv.textContent = "This email is already registered.";
          } else if (err.message === "Username already taken.") {
            alertDiv.textContent = "Username already taken.";
          } else {
            alertDiv.textContent = "An error occurred: " + err.message;
          }
        } finally {
          signupBtn.disabled = true;
          signupBtn.textContent = "Sign Up";
        }
      });
    });
  </script>
</body>
</html>
