<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affiliate Signup - Apex Income Options</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    /* your existing CSS… */
  </style>
</head>
<body>
  <div class="auth-container">
    <!-- your existing form markup… -->
    <form id="signup-form">
      <!-- …fields… -->
      <button type="submit" class="btn btn-primary w-100 mt-3" id="signup-btn">
        <span id="signup-text">Create Account</span>
        <span id="signup-spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
      </button>
    </form>
    <!-- toast container… -->
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_KEY = 'YOUR_ANON_OR_SERVICE_ROLE_KEY_HERE';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM Elements
    const signupForm = document.getElementById('signup-form');
    const signupBtn  = document.getElementById('signup-btn');
    const signupText = document.getElementById('signup-text');
    const signupSpinner = document.getElementById('signup-spinner');

    // Toast helper
    function showToast(message) {
      const toastEl = document.getElementById('liveToast');
      document.getElementById('toast-body').textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    // Referral code generator
    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupBtn.disabled = true;
      signupText.textContent = 'Creating account...';
      signupSpinner.classList.remove('d-none');

      const fullName       = document.getElementById('full-name').value.trim();
      const email          = document.getElementById('email').value.trim();
      const password       = document.getElementById('password').value;
      const confirmPassword= document.getElementById('confirm-password').value;
      const referralCode   = document.getElementById('referral-code').value.trim();

      // Basic validation
      if (!fullName || !email || password.length < 6 || password !== confirmPassword) {
        showToast('Please fill all fields correctly.');
        signupBtn.disabled = false;
        signupText.textContent = 'Create Account';
        signupSpinner.classList.add('d-none');
        return;
      }

      try {
        // 1) Validate referral code if provided
        let referrerId = null;
        if (referralCode) {
          const { data: ref, error: refErr } = await supabase
            .from('affiliates')
            .select('user_id')
            .eq('referral_code', referralCode)
            .single();
          if (refErr || !ref) {
            showToast('Invalid referral code.');
            throw refErr || new Error('No such referral');
          }
          referrerId = ref.user_id;
        }

        // 2) Sign up in Auth
        const { data: authUser, error: authError } = await supabase.auth.signUp({ email, password });
        if (authError) throw authError;

        // 3) Wait for the session (so we have a valid JWT for RLS)
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !sessionData.session) {
          console.warn('No session yet, pausing briefly…');
          // small delay to allow email confirmation flow, if enabled
          await new Promise(r => setTimeout(r, 1500));
        }

        // 4) Insert into public.users
        const { data: userData, error: userError } = await supabase
          .from('users')
          .insert([{
            id: authUser.user.id,
            full_name: fullName,
            email,
            password,
            referred_by: referrerId
          }]);
        if (userError) {
          console.error('❌ insert(users) failed:', userError);
          console.error('  message:', userError.message);
          console.error('  code:   ', userError.code);
          console.error('  details:', userError.details);
          console.error('  hint:   ', userError.hint);
          console.error('  params: ', userError.params);
          throw userError;
        }

        // 5) Create affiliate record
        const newReferralCode = generateReferralCode();
        const { error: affError } = await supabase.from('affiliates').insert([{
          user_id: authUser.user.id,
          referral_code: newReferralCode
        }]);
        if (affError) throw affError;

        showToast('Account created! Redirecting…');
        setTimeout(() => window.location.href = 'affiliate_login.html', 2000);

      } catch (error) {
        console.error('Signup error:', error);
        showToast(error.message || 'Failed to create account.');
      } finally {
        signupBtn.disabled = false;
        signupText.textContent = 'Create Account';
        signupSpinner.classList.add('d-none');
      }
    });
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
</body>
</html>
