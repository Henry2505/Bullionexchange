<!-- …everything above stays the same… -->
<script>
  // ─── SUPABASE CLIENT SETUP ──────────────────────────────────────────────────────
  const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPA_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.' +
    'eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6IkFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.' +
    'ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
  const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

  // ─── ELEMENT REFERENCES ────────────────────────────────────────────────────────
  const emailInput  = document.getElementById('signup-email');
  const pwdInput    = document.getElementById('signup-password');
  const signupBtn   = document.getElementById('signup-btn');
  const signupAlert = document.getElementById('signup-alert');
  const themeBtn    = document.getElementById('toggle-theme');
  const themeIcon   = document.getElementById('theme-icon');

  // ─── ENABLE “SIGN UP” BUTTON WHEN FORM IS VALID ────────────────────────────────
  function validateForm() {
    const email = emailInput.value.trim();
    const pwd   = pwdInput.value;
    const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    const isValidPwd   = pwd.length >= 8;
    signupBtn.disabled = !(isValidEmail && isValidPwd);
  }
  emailInput.addEventListener('input', validateForm);
  pwdInput.addEventListener('input', validateForm);
  document.addEventListener('DOMContentLoaded', validateForm);

  // ─── GENERATE AN 8‑CHAR REFERRAL CODE ───────────────────────────────────────────
  function generateReferralCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let code = '';
    for (let i = 0; i < 8; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // ─── SHOW FEEDBACK MESSAGE ───────────────────────────────────────────────────────
  function showAlert(message, isError = false) {
    signupAlert.textContent = message;
    signupAlert.style.color = isError ? 'var(--error-color)' : 'var(--success-color)';
  }

  // ─── HANDLE FORM SUBMISSION ─────────────────────────────────────────────────────
  document.getElementById('signup-form').addEventListener('submit', async (evt) => {
    evt.preventDefault();
    showAlert(''); // clear any previous message

    const email    = emailInput.value.trim().toLowerCase();
    const password = pwdInput.value;

    signupBtn.disabled = true;
    signupBtn.textContent = 'Signing Up…';

    try {
      // 1) Create Supabase Auth user
      const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
        email,
        password
      });

      if (signUpError) {
        // Log full error to console, show user‐friendly text
        console.error('Supabase signUp error:', signUpError);
        throw new Error(signUpError.message);
      }

      const user = signUpData.user;
      if (!user) {
        throw new Error('No user object returned from signUp.');
      }

      // 2) Insert affiliate row with new referral code (RLS is disabled)
      const newCode = generateReferralCode();
      const { error: insertError } = await supabase
        .from('affiliates')
        .insert([{ user_id: user.id, referral_code: newCode }]);

      if (insertError) {
        // Log full error before throwing
        console.error('Supabase insert into affiliates error:', insertError);
        throw new Error(insertError.message);
      }

      // 3) Success! Inform & redirect
      showAlert('Sign‑up successful! Redirecting…');
      setTimeout(() => {
        window.location.href = 'affiliate_dashboard.html';
      }, 1000);

    } catch (error) {
      console.error('Sign‑up caught exception:', error);
      showAlert(error.message || 'Unknown error – see console', true);
      signupBtn.disabled = false;
      signupBtn.textContent = 'Sign Up';
    }
  });

  // ─── THEME TOGGLE (OPTIONAL) ────────────────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('dashboardTheme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    themeIcon.className = saved === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
  });
  themeBtn.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next    = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('dashboardTheme', next);
    themeIcon.className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
  });
</script>
