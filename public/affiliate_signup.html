<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Signup • CBE Global</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    /* (your existing dark/light theme CSS here) */
    body { font-family: Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; align-items: center; justify-content: center; height:100vh; margin:0; }
    .card { background: var(--accent-bg); backdrop-filter: blur(10px); padding:2rem; border-radius:8px; width:100%; max-width:400px; }
    .card h1 { color: var(--gold); text-align:center; margin-bottom:1rem; }
    .form-group { margin-bottom:1rem; }
    label { color: var(--text-light); }
    input { width:100%; padding:.5rem; border:1px solid var(--gold); border-radius:4px; background:rgba(28,28,28,.8); color: var(--text); }
    button { width:100%; padding:.75rem; background:var(--gold); color:#000; border:none; border-radius:4px; font-weight:600; cursor:pointer; opacity:.6; pointer-events:none; }
    button.enabled { opacity:1; pointer-events:auto; }
    #alert { margin-top:1rem; min-height:1.5rem; text-align:center; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Affiliate Signup</h1>
    <form id="signup-form">
      <div class="form-group">
        <label for="username">Username</label>
        <input id="username" type="text" required placeholder="Choose a username"/>
      </div>
      <div class="form-group">
        <label for="email">Email address</label>
        <input id="email" type="email" required placeholder="you@example.com"/>
      </div>
      <div class="form-group">
        <label for="password">Password (min 8 chars)</label>
        <input id="password" type="password" required minlength="8"/>
      </div>
      <div class="form-group">
        <label for="confirm">Confirm Password</label>
        <input id="confirm" type="password" required/>
      </div>
      <div class="form-group form-check">
        <input id="agree" class="form-check-input" type="checkbox"/>
        <label class="form-check-label" for="agree">
          I agree to the <a href="#" target="_blank">Terms &amp; Privacy</a>
        </label>
      </div>
      <button id="btn" type="submit">Sign Up</button>
      <div id="alert"></div>
    </form>
  </div>

  <script>
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    // Helpers
    const alertEl = document.getElementById('alert');
    const btn = document.getElementById('btn');
    const agree = document.getElementById('agree');
    const form = document.getElementById('signup-form');

    // Enable button only when terms are agreed
    agree.addEventListener('change', () => {
      btn.classList.toggle('enabled', agree.checked);
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      alertEl.textContent = '';
      const username = document.getElementById('username').value.trim();
      const email    = document.getElementById('email').value.trim().toLowerCase();
      const pw       = document.getElementById('password').value;
      const confirm  = document.getElementById('confirm').value;
      if (!username || !email || !pw || !confirm) {
        return alertEl.textContent = 'All fields are required.';
      }
      if (pw !== confirm) {
        return alertEl.textContent = 'Passwords do not match.';
      }
      if (pw.length < 8) {
        return alertEl.textContent = 'Password must be at least 8 characters.';
      }
      // Disable UI while we talk to Supabase
      btn.disabled = true;
      btn.textContent = 'Signing up…';

      // Sign up with metadata `{ username }`
      const { data, error } = await supabase.auth.signUp({
        email,
        password: pw,
        options: {
          data: { username }
        }
      });

      if (error) {
        console.error(error);
        alertEl.textContent = error.message;
        btn.disabled = false;
        btn.textContent = 'Sign Up';
        return;
      }

      // Success!
      alertEl.style.color = 'var(--success-color)';
      alertEl.textContent = data.user?.confirmation_sent_at
        ? 'Check your email to confirm your account.'
        : 'Signup successful! Redirecting…';

      // Optionally auto‑redirect to login/dashboard
      setTimeout(() => {
        window.location.href = '/affiliate_login.html';
      }, 2000);
    });
  </script>
</body>
</html>
