import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  "https://dapwpgvnfjcfqqhrpxla.supabase.co",
  "YOUR_SUPABASE_ANON_KEY"
);

async function handleAffiliateSignup(event) {
  event.preventDefault();

  // 1) Collect form data:
  const email     = document.getElementById("email-input").value;
  const password  = document.getElementById("password-input").value;
  const firstName = document.getElementById("firstname-input").value;

  // 2) Sign up with Supabase
  const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
    email: email,
    password: password,
    options: {
      data: { firstName: firstName } // store firstName in user_metadata
    }
  });

  if (signUpError) {
    console.error("Supabase signUp error:", signUpError);
    // Show error to user…
    return;
  }

  // 3) Supabase returns a user object. The confirmation token is in signUpData (depending on your Supabase settings).
  //    Sometimes you get signUpData.user.confirmation_token; if not, generate it via a RLS trigger or read from DB.
  const confirmationToken = signUpData.user.confirmation_token || "";

  // 4) Generate (or fetch) the referral code you store in your "affiliates" table:
  //    (Assume you’ve run a Supabase RLS trigger that auto‑inserts into "affiliates" and returns referral_code.)
  //    For now, maybe you know the code: e.g. "ABCD1234".
  const referralCode = "ABCD1234"; // replace with actual

  // 5) Call your Netlify Function to send the email:
  try {
    const resp = await fetch("/.netlify/functions/sendAffiliateSignupEmail", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: email,
        firstName: firstName,
        token: confirmationToken,
        referralCode: referralCode
      })
    });

    const result = await resp.json();
    if (!resp.ok) {
      console.error("Netlify function returned error:", result);
    } else {
      console.log("Signup email queued:", result);
    }

  } catch (fetchErr) {
    console.error("Failed to call Netlify Function:", fetchErr);
  }

  // 6) Show a success message to the user:
  alert("Signup successful! Check your email to confirm your account.");
}
