<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBE Admin â€“ Premium Payment Management</title>
  
  <!-- Fonts, Bootstrap & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    :root {
      --bg: #000; 
      --text: #fff; 
      --gold: #ffd700;
      --gold-light: #ffec8e;
      --gold-dark: #b8860b;
      --glass-bg: rgba(30, 30, 30, 0.7);
      --overlay: rgba(0,0,0,0.8);
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    [data-theme="light"] {
      --bg: #f5f5f5; 
      --text: #333; 
      --gold: #b8860b;
      --gold-light: #d4af37;
      --gold-dark: #8b6914;
      --glass-bg: rgba(255,255,255,0.85);
      --overlay: rgba(245,245,245,0.85);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Poppins',sans-serif;
      background: var(--bg); 
      color: var(--text);
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="black"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="rgba(184,134,11,0.1)" stroke-width="2"/></svg>');
      min-height: 100vh;
      padding-bottom: 3rem;
    }
    .overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background: var(--overlay); 
      z-index:-1;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--gold);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .glass:hover {
      box-shadow: 0 12px 40px rgba(184, 134, 11, 0.4);
    }
    a { 
      color: var(--gold-light); 
      text-decoration: none;
      transition: color 0.2s;
    }
    a:hover {
      color: var(--gold);
    }
    header.admin-header {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 1rem 2rem; 
      background: rgba(0, 0, 0, 0.8);
      border-bottom: 2px solid var(--gold);
      position: sticky; 
      top: 0; 
      z-index: 100;
    }
    .logo { 
      display: flex; 
      align-items: center; 
      gap: 1rem;
    }
    .logo img { 
      height: 45px; 
      filter: drop-shadow(0 0 5px var(--gold));
    }
    .logo-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    #theme-toggle {
      background: none; 
      border: 1px solid var(--gold);
      color: var(--gold);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    #theme-toggle:hover {
      background: rgba(255, 215, 0, 0.1);
      transform: rotate(15deg);
    }
    .section-title { 
      color: var(--gold); 
      text-align: center; 
      margin: 2rem 0 1.5rem;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      letter-spacing: 1px;
      position: relative;
      padding-bottom: 0.5rem;
    }
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: var(--gold);
      border-radius: 3px;
    }
    .panel { 
      margin-bottom: 2.5rem; 
    }
    form.glass { 
      border-radius: 10px; 
      padding: 2rem; 
      margin-bottom: 1.5rem; 
    }
    .form-row { 
      display: flex; 
      gap: 1.5rem; 
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .form-row > div { 
      flex: 1; 
      min-width: 200px; 
    }
    .form-label {
      color: var(--gold-light);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .form-control, .form-select {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 215, 0, 0.3);
      color: var(--text);
      padding: 0.75rem 1rem;
      transition: all 0.3s;
    }
    .form-control:focus, .form-select:focus {
      background: rgba(0, 0, 0, 0.5);
      border-color: var(--gold);
      box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
      color: var(--text);
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn-primary {
      background: var(--gold);
      border-color: var(--gold);
      color: #000;
    }
    .btn-primary:hover {
      background: var(--gold-dark);
      border-color: var(--gold-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(184, 134, 11, 0.4);
    }
    .btn-outline-gold {
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
    }
    .btn-outline-gold:hover {
      background: var(--gold);
      color: #000;
    }
    #methods-list .list-group-item {
      background: var(--glass-bg); 
      border: 1px solid rgba(255,215,0,0.3);
      color: var(--text); 
      margin-bottom: 0.75rem; 
      border-radius: 8px;
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 1.25rem;
      transition: all 0.3s;
    }
    #methods-list .list-group-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(184, 134, 11, 0.2);
    }
    .method-info { 
      flex-grow: 1; 
    }
    .method-actions button { 
      margin-left: 0.75rem; 
    }
    .payments-table {
      background: var(--glass-bg);
      color: var(--text);
      border-radius: 12px;
      overflow: hidden;
      padding: 1.5rem;
    }
    .payments-table table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .payments-table th {
      background: rgba(184, 134, 11, 0.2);
      color: var(--gold);
      padding: 1rem 1.25rem;
      font-weight: 600;
      text-align: left;
      border-bottom: 2px solid var(--gold);
    }
    .payments-table td {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }
    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }
    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }
    .status-approved {
      background: rgba(40, 167, 69, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }
    .status-rejected {
      background: rgba(220, 53, 69, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    .toast { 
      z-index:99999 !important; 
      border: 1px solid var(--gold);
    }
    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      min-width: 300px;
      position: relative;
    }
    .search-box i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gold);
    }
    .stats-container {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1;
      min-width: 200px;
      padding: 1.5rem;
      text-align: center;
      border-radius: 12px;
      background: rgba(184, 134, 11, 0.15);
      border: 1px solid var(--gold);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--gold);
      margin: 0.5rem 0;
    }
    .stat-label {
      color: var(--gold-light);
      font-size: 1rem;
    }
    .chart-container {
      height: 250px;
      margin: 1.5rem 0;
    }
    .admin-footer {
      background: rgba(0, 0, 0, 0.8);
      padding: 1.5rem;
      margin-top: 3rem;
      text-align: center;
      border-top: 2px solid var(--gold);
      display: flex;
      justify-content: space-between;
    }
    @media (max-width: 768px) {
      .form-row > div {
        min-width: 100%;
      }
      .search-box {
        min-width: 100%;
      }
      .stats-container {
        flex-direction: column;
      }
      .admin-footer {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="overlay"></div>

  <!-- Header -->
  <header class="admin-header glass">
    <div class="logo" id="logo">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZmZkNzAwIiBkPSJNMjU2IDQ4QzE0MS4xIDQ4IDQ4IDE0MS4xIDQ4IDI1NnM5My4xIDIwOCAyMDggMjA4IDIwOC05My4xIDIwOC0yMDhTMzcwLjkgNDggMjU2IDQ4em0wIDM4NGMtOTcuMiAwLTE3Ni03OC44LTE3Ni0xNzZTMTU4LjggODAgMjU2IDgwczE3NiA3OC44IDE3NiAxNzYtNzguOCAxNzYtMTc2IDE3NnptMC0zMDRjLTcwLjcgMC0xMjggNTcuMy0xMjggMTI4czU3LjMgMTI4IDEyOCAxMjggMTI4LTU3LjMgMTI4LTEyOC01Ny4zLTEyOC0xMjgtMTI4em0wIDIyNGMtNTMgMC05Ni00My05Ni05NnM0My05NiA5Ni05NiA5NiA0MyA5NiA5Ni00MyA5Ni05NiA5NnptMC0xNjBjLTM1LjMgMC02NCAyOC43LTY0IDY0czI4LjcgNjQgNjQgNjQgNjQtMjguNyA2NC02NC0yOC43LTY0LTY0LTY0eiIvPjwvc3ZnPg==" alt="CBE Logo">
      <div class="logo-text">Admin Portal</div>
    </div>
    <button id="theme-toggle" aria-label="Toggle theme">ðŸŒž</button>
  </header>

  <main class="container py-4">
    <!-- Dashboard Stats -->
    <div class="stats-container">
      <div class="stat-card glass">
        <div class="stat-label">Total Payments</div>
        <div class="stat-value" id="total-payments">0</div>
        <div><span class="text-success" id="payment-change">+0%</span> this month</div>
      </div>
      <div class="stat-card glass">
        <div class="stat-label">Pending Approvals</div>
        <div class="stat-value" id="pending-payments">0</div>
        <div>Requires attention</div>
      </div>
      <div class="stat-card glass">
        <div class="stat-label">Payment Methods</div>
        <div class="stat-value" id="total-methods">0</div>
        <div>Available options</div>
      </div>
      <div class="stat-card glass">
        <div class="stat-label">Revenue</div>
        <div class="stat-value">â‚¦<span id="total-revenue">0</span></div>
        <div>Last 30 days</div>
      </div>
    </div>

    <!-- Payment Methods Panel -->
    <h2 class="section-title">Payment Methods</h2>
    <div class="panel">
      <form id="method-form" class="glass">
        <div class="form-row">
          <div>
            <label class="form-label">Name</label>
            <input type="text" id="pm-name" class="form-control" placeholder="e.g. Pay â‚¦ via Card/Bank" required>
          </div>
          <div>
            <label class="form-label">Type</label>
            <select id="pm-type" class="form-select" required>
              <option value="">-- Select --</option>
              <option value="card">Card/Bank</option>
              <option value="crypto">Crypto</option>
              <option value="mobile">Mobile Money</option>
              <option value="wallet">Digital Wallet</option>
            </select>
          </div>
          <div>
            <label class="form-label">Details</label>
            <input type="text" id="pm-details" class="form-control"
              placeholder="card â†’ https://â€¦  |  crypto â†’ address" required>
          </div>
          <div class="d-flex align-items-end">
            <button type="button" id="save-btn" class="btn btn-primary w-100">
              <i class="bi bi-save"></i> Save Method
            </button>
          </div>
        </div>
      </form>
      <ul class="list-group" id="methods-list"></ul>
    </div>

    <!-- User Payments Panel -->
    <h2 class="section-title">User Payments</h2>
    
    <!-- Search and Filters -->
    <div class="search-container">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" id="search-input" class="form-control ps-4" placeholder="Search payments...">
      </div>
      <div>
        <select id="status-filter" class="form-select">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <div>
        <select id="method-filter" class="form-select">
          <option value="">All Methods</option>
          <option value="card">Card/Bank</option>
          <option value="crypto">Crypto</option>
          <option value="mobile">Mobile Money</option>
          <option value="wallet">Digital Wallet</option>
        </select>
      </div>
      <div>
        <button id="filter-btn" class="btn btn-outline-gold">
          <i class="bi bi-funnel"></i> Filter
        </button>
      </div>
    </div>
    
    <div class="payments-table glass">
      <table class="table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Plan</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Proof</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="payments-list"></tbody>
      </table>
    </div>

    <!-- Payment Activity Chart -->
    <div class="panel mt-5">
      <h2 class="section-title">Payment Activity</h2>
      <div class="glass p-4">
        <div class="chart-container" id="paymentChart"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="admin-footer glass">
    <div>Â© 2023 CBE Payment Management System</div>
    <div>Premium Admin Dashboard v3.0</div>
  </footer>

  <!-- Modals -->
  <div class="modal fade" id="proofModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Payment Proof</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="proof-image" src="" class="img-fluid rounded" alt="Payment proof">
          <div class="mt-3">
            <a id="download-link" class="btn btn-outline-gold" href="#" download>
              <i class="bi bi-download"></i> Download Proof
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Payment Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="payment-details">
          <!-- Payment details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Payment
          </button>
          <button type="button" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Edit Details
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Supabase initialization
    const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM references
    const form = document.getElementById('method-form');
    const nameInp = document.getElementById('pm-name');
    const typeInp = document.getElementById('pm-type');
    const detailsInp = document.getElementById('pm-details');
    const saveBtn = document.getElementById('save-btn');
    const listGroup = document.getElementById('methods-list');
    const paymentsTbody = document.getElementById('payments-list');
    const logo = document.getElementById('logo');
    const themeBtn = document.getElementById('theme-toggle');
    const totalPayments = document.getElementById('total-payments');
    const pendingPayments = document.getElementById('pending-payments');
    const totalMethods = document.getElementById('total-methods');
    const totalRevenue = document.getElementById('total-revenue');
    const paymentChange = document.getElementById('payment-change');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const methodFilter = document.getElementById('method-filter');
    const filterBtn = document.getElementById('filter-btn');
    const proofImage = document.getElementById('proof-image');
    const downloadLink = document.getElementById('download-link');
    const paymentDetails = document.getElementById('payment-details');
    
    let editId = null;
    let paymentChart;
    let allPayments = [];

    // Toast helper
    function showToast(msg, success = true) {
      const t = document.createElement('div');
      t.className = `toast align-items-center text-white ${success?'bg-success':'bg-danger'} border-0 position-fixed top-0 end-0 m-3`;
      t.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center">
            <i class="bi ${success ? 'bi-check-circle' : 'bi-exclamation-circle'} me-2"></i>
            ${msg}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      document.body.append(t);
      setTimeout(() => t.remove(), 3000);
    }

    // Authentication check
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.replace('admin-login.html?redirect=' + encodeURIComponent(window.location.pathname));
      }
    }

    // Chart utilities
    function generateWeeks(n) {
      const today = new Date();
      const weeks = [];
      for (let i = n - 1; i >= 0; i--) {
        const weekStart = new Date(today);
        weekStart.setDate(weekStart.getDate() - i * 7);
        weeks.push(weekStart);
      }
      return weeks;
    }

    function updatePaymentChart(data) {
      const weeks = generateWeeks(6);
      const labels = weeks.map(w => w.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      const approvedData = weeks.map((weekStart) => {
        const nextWeekStart = new Date(weekStart);
        nextWeekStart.setDate(nextWeekStart.getDate() + 7);
        return data.filter(p => {
          const paymentDate = new Date(p.created_at);
          return p.status === 'approved' && paymentDate >= weekStart && paymentDate < nextWeekStart;
        }).length;
      });
      const pendingData = weeks.map((weekStart) => {
        const nextWeekStart = new Date(weekStart);
        nextWeekStart.setDate(nextWeekStart.getDate() + 7);
        return data.filter(p => {
          const paymentDate = new Date(p.created_at);
          return p.status === 'pending' && paymentDate >= weekStart && paymentDate < nextWeekStart;
        }).length;
      });
      
      if (!paymentChart) {
        initChart();
      }
      
      paymentChart.data.labels = labels;
      paymentChart.data.datasets[0].data = approvedData;
      paymentChart.data.datasets[1].data = pendingData;
      paymentChart.update();
    }

    function updateStats(paymentsData) {
      totalPayments.textContent = paymentsData.length;
      pendingPayments.textContent = paymentsData.filter(p => p.status === 'pending').length;
      const revenue = paymentsData
        .filter(p => p.status === 'approved')
        .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
      totalRevenue.textContent = revenue.toLocaleString();
      const growth = Math.floor(Math.random() * 15) + 5;
      paymentChange.textContent = `+${growth}%`;
    }

    // Rendering functions
    function renderPaymentRow(p, methodMap) {
      const tr = document.createElement('tr');
      tr.id = `payment-row-${p.id}`;
      const paymentDate = new Date(p.created_at);
      const formattedDate = paymentDate.toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      tr.innerHTML = `
        <td>${p.email}</td>
        <td>${p.plan}</td>
        <td>â‚¦${parseInt(p.amount).toLocaleString()}</td>
        <td>${methodMap[p.method_id] || p.method_id}</td>
        <td>
          ${p.proof_url
            ? `<button class="btn btn-sm btn-info" onclick="viewProof('${p.proof_url}')">
                <i class="bi bi-eye"></i> View
              </button>`
            : 'â€”'}
        </td>
        <td>${formattedDate}</td>
        <td><span class="status-badge status-${p.status}">${p.status}</span></td>
        <td>
          <button class="btn btn-sm btn-success btn-approve" aria-label="Approve payment" onclick="updatePayment(${p.id},'approved')">
            <i class="bi bi-check-circle"></i>
          </button>
          <button class="btn btn-sm btn-danger" aria-label="Reject payment" onclick="updatePayment(${p.id},'rejected')">
            <i class="bi bi-x-circle"></i>
          </button>
          <button class="btn btn-sm btn-secondary" onclick="showPaymentDetails(${p.id})">
            <i class="bi bi-three-dots"></i>
          </button>
        </td>`;
      return tr;
    }

    function renderMethodsList(data) {
      listGroup.innerHTML = '';
      data.forEach(m => {
        const li = document.createElement('li');
        li.className = 'list-group-item glass';
        li.id = `method-item-${m.id}`;
        const detTxt = m.type === 'card' ? m.details.link : m.details.address;
        li.innerHTML = `
          <div class="method-info">
            <strong>${m.name}</strong> <em>(${m.type})</em><br><small>${detTxt}</small>
          </div>
          <div class="method-actions">
            <button class="btn btn-sm btn-warning" onclick="onEdit(${m.id})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="onDelete(${m.id})">
              <i class="bi bi-trash"></i>
            </button>
          </div>`;
        listGroup.append(li);
      });
    }

    // Data loading functions
    async function loadMethods() {
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*')
        .order('id', { ascending: true });
      if (error) return showToast('Failed to load methods', false);
      renderMethodsList(data);
      totalMethods.textContent = data.length;
    }

    async function loadPayments() {
      const { data: methods } = await supabase.from('payment_methods').select('id,name');
      const methodMap = methods.reduce((acc, m) => { acc[m.id] = m.name; return acc; }, {});
      const { data, error } = await supabase
        .from('payments')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) return showToast('Failed to load payments', false);
      
      allPayments = data;
      renderPaymentsTable(allPayments, methodMap);
      updateStats(allPayments);
      updatePaymentChart(allPayments);
    }

    function renderPaymentsTable(data, methodMap) {
      paymentsTbody.innerHTML = '';
      data.forEach(p => paymentsTbody.append(renderPaymentRow(p, methodMap)));
    }

    // Filter and search
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    async function loadFilteredPayments() {
      const searchTerm = searchInput.value.trim().toLowerCase();
      const status = statusFilter.value;
      const methodType = methodFilter.value;
      
      let filtered = [...allPayments];
      
      if (searchTerm) {
        filtered = filtered.filter(p => 
          p.email.toLowerCase().includes(searchTerm) || 
          p.plan.toLowerCase().includes(searchTerm)
        );
      }
      
      if (status) {
        filtered = filtered.filter(p => p.status === status);
      }
      
      if (methodType) {
        const { data: methods } = await supabase.from('payment_methods').select('id').eq('type', methodType);
        const methodIds = methods.map(m => m.id);
        filtered = filtered.filter(p => methodIds.includes(p.method_id));
      }
      
      const { data: methods } = await supabase.from('payment_methods').select('id,name');
      const methodMap = methods.reduce((acc, m) => { acc[m.id] = m.name; return acc; }, {});
      renderPaymentsTable(filtered, methodMap);
    }

    // Payment actions
    async function updatePayment(id, newStatus) {
      const { error } = await supabase
        .from('payments')
        .update({ status: newStatus })
        .eq('id', id);
      if (error) return showToast('Update failed', false);
      showToast(`Payment ${newStatus}`);
      loadPayments();
    }

    function viewProof(url) {
      proofImage.src = url;
      downloadLink.href = url;
      new bootstrap.Modal(document.getElementById('proofModal')).show();
    }

    async function showPaymentDetails(id) {
      const { data, error } = await supabase
        .from('payments')
        .select('*')
        .eq('id', id)
        .single();
      
      if (error) return showToast('Failed to load payment details', false);
      
      const paymentDate = new Date(data.created_at);
      const formattedDate = paymentDate.toLocaleString();
      
      paymentDetails.innerHTML = `
        <div class="mb-3">
          <strong>Transaction ID:</strong> TX-${data.id.toString().padStart(6, '0')}
        </div>
        <div class="mb-3">
          <strong>User Email:</strong> ${data.email}
        </div>
        <div class="mb-3">
          <strong>Plan:</strong> ${data.plan}
        </div>
        <div class="mb-3">
          <strong>Amount:</strong> â‚¦${parseInt(data.amount).toLocaleString()}
        </div>
        <div class="mb-3">
          <strong>Date:</strong> ${formattedDate}
        </div>
        <div class="mb-3">
          <strong>Status:</strong> <span class="status-badge status-${data.status}">${data.status}</span>
        </div>
        <div>
          <strong>Notes:</strong> ${data.notes || 'No additional notes'}
        </div>
      `;
      
      new bootstrap.Modal(document.getElementById('paymentModal')).show();
    }

    // Payment method actions
    saveBtn.addEventListener('click', async () => {
      saveBtn.disabled = true;
      const name = nameInp.value.trim();
      const type = typeInp.value;
      const raw = detailsInp.value.trim();
      if (!name || !type || !raw) {
        showToast('All fields required', false);
        saveBtn.disabled = false;
        return;
      }
      
      let details = {};
      if (type === 'card') details.link = raw;
      else details.address = raw;
      
      try {
        let res;
        if (editId) {
          res = await supabase.from('payment_methods').update({ name, type, details }).eq('id', editId);
        } else {
          res = await supabase.from('payment_methods').insert([{ name, type, details }]);
        }
        if (res.error) throw res.error;
        showToast(editId ? 'Updated' : 'Added');
        form.reset();
        editId = null;
        saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Method';
        loadMethods();
      } catch (err) {
        showToast(err.message, false);
      } finally {
        saveBtn.disabled = false;
      }
    });

    window.onEdit = async id => {
      const { data, error } = await supabase.from('payment_methods').select('*').eq('id', id).single();
      if (error) return showToast('Failed to load method', false);
      editId = id;
      nameInp.value = data.name;
      typeInp.value = data.type;
      detailsInp.value = data.type === 'card' ? data.details.link : data.details.address;
      saveBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Update Method';
    };

    window.onDelete = async id => {
      if (!confirm('Are you sure you want to delete this payment method?')) return;
      const { error } = await supabase.from('payment_methods').delete().eq('id', id);
      if (error) return showToast('Delete failed', false);
      showToast('Method deleted');
      form.reset();
      editId = null;
      saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Method';
      loadMethods();
    };

    // Theme toggling
    const applyTheme = t => {
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      themeBtn.innerHTML = t === 'dark' ? 'ðŸŒž' : 'ðŸŒœ';
    };
    
    themeBtn.onclick = () => applyTheme(
      document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'
    );

    // Chart initialization
    function initChart() {
      const ctx = document.getElementById('paymentChart').getContext('2d');
      paymentChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Approved Payments',
            data: [],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'Pending Payments',
            data: [],
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              labels: { 
                color: '#ffd700',
                font: {
                  family: 'Poppins'
                }
              } 
            } 
          },
          scales: {
            y: { 
              beginAtZero: true, 
              grid: { color: 'rgba(255, 215, 0, 0.1)' }, 
              ticks: { color: '#ffec8e' } 
            },
            x: { 
              grid: { color: 'rgba(255, 215, 0, 0.1)' }, 
              ticks: { color: '#ffec8e' } 
            }
          }
        }
      });
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', async () => {
      // Apply saved theme
      const savedTheme = localStorage.getItem('theme') || 'dark';
      applyTheme(savedTheme);
      
      // Initialize chart
      initChart();
      
      // Load data
      await loadMethods();
      await loadPayments();
      
      // Set up event listeners
      searchInput.addEventListener('input', debounce(loadFilteredPayments, 300));
      filterBtn.addEventListener('click', loadFilteredPayments);
      logo.addEventListener('click', () => location.href = 'admin-dashboard.html');
      
      // Simulate authentication (in real app, call checkAuth())
      setTimeout(() => {
        showToast('Dashboard loaded successfully!');
      }, 1000);
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
