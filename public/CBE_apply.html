<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Join the Chukwuemeka Bullion Exchange VIP trading community." />
  <title>Apply • Chukwuemeka Bullion Exchange</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    /* … your existing CSS … */
  </style>
</head>
<body>

  <div class="header-bar">
    <!-- … header markup … -->
  </div>

  <main>
    <section class="apply-card slide-in" id="apply-card">
      <h1>Apply to Join CBE</h1>

      <!-- Quote box… -->

      <!-- Referral Note -->
      <p class="referral-note" id="referral-note"></p>

      <form id="apply-form" novalidate>
        <!-- … your existing form fields … -->

        <div class="form-group optional">
          <label for="apply-referral">Referral Code (optional)</label>
          <i class="fas fa-user-friends input-icon"></i>
          <input type="text" id="apply-referral" placeholder="Enter code if you have one" readonly />
        </div>

        <!-- … terms, submit button, alert div … -->
      </form>
    </section>
  </main>

  <footer>© 2025 Chukwuemeka Bullion Exchange. All rights reserved.</footer>

  <script>
    // — initialize Supabase client
    const SUPA_URL = "https://dapwpgvnfjcfqqhrpxla.supabase.co";
    const SUPA_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    // Grab DOM elements
    const noteEl     = document.getElementById('referral-note');
    const refInput   = document.getElementById('apply-referral');
    const form       = document.getElementById('apply-form');
    const submitBtn  = document.getElementById('submit-btn');
    const alertDiv   = document.getElementById('apply-alert');

    // Utility: show error
    function showError(msg) {
      alertDiv.className = 'alert-error';
      alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${msg}`;
      alertDiv.style.display = 'block';
      submitBtn.disabled = false;
    }

    // Utility: show success
    function showSuccess(msg) {
      alertDiv.className = 'alert-success';
      alertDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
      alertDiv.style.display = 'block';
    }

    // On page load…
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Check URL param
      const params = new URLSearchParams(window.location.search);
      const code   = params.get('ref')?.trim();

      if (code) {
        // 2) Verify against affiliate_accounts table
        const { data: aff, error } = await supabase
          .from('affiliate_accounts')
          .select('id')
          .eq('referral_code', code)
          .maybeSingle();

        if (error) {
          console.error('Referral lookup error', error);
          noteEl.textContent = 'Error verifying referral; please try again.';
        }
        else if (!aff) {
          noteEl.textContent = 'Invalid referral code.';
          // keep the field blank and block submission if you like:
          // submitBtn.disabled = true;
        }
        else {
          // valid code!
          noteEl.textContent = `Referred by: ${code}`;
          refInput.value    = code;
        }
      }

      // …rest of your initialization (quotes, theme toggle, local time, etc.)…
    });

    // Form submission
    form.addEventListener('submit', async e => {
      e.preventDefault();
      alertDiv.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting…';

      // collect & validate other fields…
      // …

      // include referral code if present and valid
      const referredBy = refInput.value ? refInput.value : null;

      // your payload
      const payload = {
        /* name, email, password, phone, experience, */
        referral_code: referredBy
      };

      try {
        // send to your Netlify function (or Supabase directly)
        const res    = await fetch('/.netlify/functions/send-application', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();

        if (!res.ok) {
          showError(result.error || 'Submission failed.');
        } else {
          showSuccess('Application submitted! Redirecting…');
          setTimeout(() => window.location.href = 'vip-subscription', 2000);
        }
      } catch (err) {
        console.error(err);
        showError('Network error. Please try again.');
      }
    });
  </script>
</body>
</html>
