<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Join the Chukwuemeka Bullion Exchange VIP trading community." />
  <title>Apply â€¢ Chukwuemeka Bullion Exchange</title>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <style>
    /* Existing CSS remains unchanged */
    
    /* Enhanced Alert Styles */
    #apply-alert {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.4s ease-out;
      max-height: 0;
      overflow: hidden;
    }
    
    #apply-alert.show {
      opacity: 1;
      transform: translateY(0);
      max-height: 200px;
    }
    
    .alert-success {
      background: rgba(46, 204, 113, 0.15);
      border: 1px solid var(--success);
      color: var(--success);
    }
    
    .alert-error {
      background: rgba(231, 76, 60, 0.15);
      border: 1px solid var(--error);
      color: var(--error);
    }
    
    .alert-icon {
      margin-right: 12px;
      font-size: 1.4rem;
    }
    
    .alert-content {
      flex: 1;
    }
    
    .alert-title {
      font-weight: 700;
      margin-bottom: 5px;
      display: block;
    }
    
    /* Input validation states */
    .form-group.invalid input,
    .form-group.invalid textarea {
      border-color: var(--error);
      background: rgba(231, 76, 60, 0.05);
    }
    
    .form-group.valid input,
    .form-group.valid textarea {
      border-color: var(--success);
      background: rgba(46, 204, 113, 0.05);
    }
    
    .input-error {
      color: var(--error);
      font-size: 0.85rem;
      margin-top: 6px;
      display: block;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
    }
    
    .input-error.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: #000;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header remains unchanged -->
  
  <main>
    <section class="apply-card slide-in" id="apply-card">
      <h1>Apply to Join CBE</h1>
      
      <!-- Forex Quote Section -->
      <div class="quote-section">
        <!-- Content remains unchanged -->
      </div>
      
      <p class="referral-note" id="referral-note"></p>

      <form id="apply-form" novalidate>
        <!-- Form fields remain unchanged -->
        
        <!-- Enhanced Alert Container -->
        <div id="apply-alert" role="alert">
          <i class="alert-icon"></i>
          <div class="alert-content">
            <span class="alert-title"></span>
            <span class="alert-message"></span>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- Footer remains unchanged -->

  <script>
    // Forex quotes array remains unchanged

    // DOMContentLoaded remains unchanged

    // Show alert function
    function showAlert(type, title, message, duration = 5000) {
      const alert = document.getElementById('apply-alert');
      const icon = alert.querySelector('.alert-icon');
      const alertTitle = alert.querySelector('.alert-title');
      const alertMessage = alert.querySelector('.alert-message');
      
      alert.className = `show alert-${type}`;
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      
      // Set icon based on type
      if (type === 'success') {
        icon.className = 'alert-icon fas fa-check-circle';
      } else {
        icon.className = 'alert-icon fas fa-exclamation-triangle';
      }
      
      // Auto-hide for success messages
      if (type === 'success') {
        setTimeout(() => {
          alert.classList.remove('show');
        }, duration);
      }
    }

    // Hide alert function
    function hideAlert() {
      const alert = document.getElementById('apply-alert');
      alert.classList.remove('show');
    }

    // Show input error
    function showInputError(inputId, message) {
      const input = document.getElementById(inputId);
      const formGroup = input.closest('.form-group');
      let errorElement = formGroup.querySelector('.input-error');
      
      if (!errorElement) {
        errorElement = document.createElement('span');
        errorElement.className = 'input-error';
        formGroup.appendChild(errorElement);
      }
      
      errorElement.textContent = message;
      formGroup.classList.add('invalid');
      errorElement.classList.add('show');
    }

    // Clear input error
    function clearInputError(inputId) {
      const input = document.getElementById(inputId);
      const formGroup = input.closest('.form-group');
      const errorElement = formGroup.querySelector('.input-error');
      
      if (errorElement) {
        errorElement.classList.remove('show');
        setTimeout(() => {
          if (errorElement && !errorElement.classList.contains('show')) {
            errorElement.remove();
          }
        }, 300);
      }
      
      formGroup.classList.remove('invalid', 'valid');
    }

    // Validate individual field
    function validateField(fieldId) {
      const input = document.getElementById(fieldId);
      const value = input.value.trim();
      
      clearInputError(fieldId);
      
      if (!value) {
        showInputError(fieldId, 'This field is required');
        return false;
      }
      
      // Specific validations
      if (fieldId === 'apply-email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          showInputError(fieldId, 'Please enter a valid email address');
          return false;
        }
      }
      
      if (fieldId === 'apply-password' && value.length < 8) {
        showInputError(fieldId, 'Password must be at least 8 characters');
        return false;
      }
      
      if (fieldId === 'apply-phone') {
        const phoneRegex = /^[0-9+()\-\s]{8,20}$/;
        if (!phoneRegex.test(value)) {
          showInputError(fieldId, 'Please enter a valid phone number');
          return false;
        }
      }
      
      input.closest('.form-group').classList.add('valid');
      return true;
    }

    // Validate entire form
    function validateForm() {
      const fields = [
        'apply-name',
        'apply-email',
        'apply-password',
        'apply-phone',
        'apply-message'
      ];
      
      let isValid = true;
      
      fields.forEach(field => {
        if (!validateField(field)) {
          isValid = false;
        }
      });
      
      if (!document.getElementById('agree-terms').checked) {
        showAlert('error', 'Terms Required', 'You must agree to the Privacy Policy and Terms & Conditions');
        isValid = false;
      }
      
      return isValid;
    }

    // Form submission handler
    form.addEventListener('submit', async e => {
      e.preventDefault();
      hideAlert();
      
      // Clear all previous validations
      document.querySelectorAll('.form-group').forEach(group => {
        group.classList.remove('valid', 'invalid');
        const error = group.querySelector('.input-error');
        if (error) error.remove();
      });
      
      if (!validateForm()) {
        showAlert('error', 'Validation Error', 'Please correct the highlighted fields');
        return;
      }
      
      // Get form values
      const name = document.getElementById('apply-name').value.trim();
      const email = document.getElementById('apply-email').value.trim().toLowerCase();
      const password = document.getElementById('apply-password').value;
      const phone = document.getElementById('apply-phone').value.trim();
      const experience = document.getElementById('apply-message').value.trim();
      const manualRef = document.getElementById('apply-referral').value.trim();
      
      // Update button to show loading state
      submitBtn.innerHTML = '<span class="spinner"></span> Processing Application...';
      submitBtn.disabled = true;
      
      try {
        // Check if user already exists
        const { data: existingUser, error: userError } = await supabaseClient
          .from('users')
          .select('id')
          .eq('email', email)
          .single();
        
        if (existingUser) {
          showAlert('error', 'Account Exists', 'This email is already registered. Please sign in or use a different email.');
          return;
        }
        
        // Handle referral code if exists
        let referredBy = null;
        const urlRef = new URLSearchParams(location.search).get('ref');
        const code = manualRef || urlRef || null;
        
        if (code) {
          const { data: aff, error: refError } = await supabaseClient
            .from('affiliate_accounts')
            .select('id')
            .eq('referral_code', code)
            .single();
          
          if (refError || !aff) {
            showAlert('error', 'Invalid Referral', 'The referral code you entered is invalid. Please check and try again.');
            return;
          }
          referredBy = aff.id;
        }
        
        // Submit application
        const payload = { 
          name, 
          email, 
          password, 
          phone, 
          experience, 
          referral_code: code, 
          referred_by: referredBy 
        };
        
        const res = await fetch('/.netlify/functions/send-application', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const result = await res.json();
        
        if (!res.ok) {
          throw new Error(result.error || JSON.stringify(result));
        }
        
        // Success handling
        showAlert('success', 'Success!', `Your application has been submitted successfully. Welcome to CBE!`);
        
        // Form reset with delay to show success message
        setTimeout(() => {
          form.reset();
          agree.checked = false;
          submitBtn.classList.remove('enabled');
          
          // Redirect to VIP subscription
          window.location.href = 'vip-subscription';
        }, 3000);
        
      } catch (err) {
        console.error('Submission error:', err);
        
        // User-friendly error messages
        let errorMessage = 'We encountered an issue processing your application. ';
        
        if (err.message.includes('email')) {
          errorMessage = 'This email is already registered. Please use a different email address.';
        } else if (err.message.includes('network')) {
          errorMessage = 'Network error. Please check your connection and try again.';
        } else {
          errorMessage += 'Please try again or contact support if the problem persists.';
        }
        
        showAlert('error', 'Application Error', errorMessage);
        
      } finally {
        // Reset button state
        submitBtn.textContent = 'Submit Application';
        submitBtn.disabled = false;
        submitBtn.classList.toggle('enabled', agree.checked);
      }
    });

    // Add real-time validation as users type
    const validationFields = [
      'apply-name',
      'apply-email',
      'apply-password',
      'apply-phone',
      'apply-message'
    ];
    
    validationFields.forEach(field => {
      const input = document.getElementById(field);
      
      input.addEventListener('blur', () => validateField(field));
      
      input.addEventListener('input', () => {
        clearInputError(field);
        input.closest('.form-group').classList.remove('invalid', 'valid');
      });
    });
  </script>
</body>
</html>
