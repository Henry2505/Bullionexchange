<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Join the Chukwuemeka Bullion Exchange VIP trading community." />
  <title>Apply ‚Ä¢ Chukwuemeka Bullion Exchange</title>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <style>
    /* ... (existing styles remain unchanged) ... */
  </style>
</head>
<body>

  <!-- ... (existing header/main/footer structure remains unchanged) ... -->

  <script>
    // Forex motivational quotes
    const forexQuotes = [
      // ... (existing quotes array) ...
    ];

    // Function to get a random forex quote
    function getRandomQuote() {
      const randomIndex = Math.floor(Math.random() * forexQuotes.length);
      return forexQuotes[randomIndex];
    }

    // Update quote on page
    function updateQuote() {
      const quote = getRandomQuote();
      document.getElementById('forex-quote').textContent = quote.text;
      document.getElementById('quote-author').textContent = `- ${quote.author}`;
    }

    // Local time
    function updateLocalTime() {
      const now = new Date();
      document.getElementById('local-time').textContent =
        now.toLocaleString('en-US', {
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: true,
          timeZone: 'Africa/Lagos'
        }) + ' WAT';
    }
    setInterval(updateLocalTime, 1000);
    updateLocalTime();

    // Slide in and referral handling
    document.addEventListener('DOMContentLoaded', () => {
      const card = document.getElementById('apply-card');
      card.classList.add('visible');
      // Referral from URL, converted to uppercase
      const params = new URLSearchParams(location.search),
            ref = params.get('ref')?.toUpperCase() || '';
      if (ref) {
        document.getElementById('referral-note').textContent = `Referred by: ${ref}`;
        document.getElementById('apply-referral').value = ref;
      }
      // Initialize quote
      updateQuote();
    });

    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.addEventListener('click', () => {
      const curr = document.documentElement.getAttribute('data-theme');
      const next = curr === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeBtn.textContent = next === 'dark' ? 'üåû' : 'üåú';
    });
    (() => {
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      themeBtn.textContent = saved === 'dark' ? 'üåû' : 'üåú';
    })();

    // Voice toggle
    const voiceBtn = document.getElementById('voice-toggle');
    const audio = document.getElementById('page-audio');
    voiceBtn.addEventListener('click', () => {
      if (audio.paused) {
        audio.play();
        voiceBtn.textContent = '‚è∏Ô∏è';
      } else {
        audio.pause();
        voiceBtn.textContent = '‚ñ∂Ô∏è';
      }
    });
    audio.addEventListener('ended', () => voiceBtn.textContent = '‚ñ∂Ô∏è');

    // Quote refresh
    document.getElementById('refresh-quote').addEventListener('click', updateQuote);

    // Form handling
    const SUPA_URL = "https://dapwpgvnfjcfqqhrpxla.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ";
    const supabaseClient = supabase.createClient(SUPA_URL, SUPA_KEY);

    const form = document.getElementById('apply-form'),
          agree = document.getElementById('agree-terms'),
          submitBtn = document.getElementById('submit-btn'),
          alertDiv = document.getElementById('apply-alert'),
          inputs = {
            name: document.getElementById('apply-name'),
            email: document.getElementById('apply-email'),
            password: document.getElementById('apply-password'),
            phone: document.getElementById('apply-phone'),
            experience: document.getElementById('apply-message'),
            referral: document.getElementById('apply-referral')
          };

    // Convert referral code to uppercase as user types
    inputs.referral.addEventListener('input', function() {
      this.value = this.value.toUpperCase();
    });

    // Real-time validation
    function validateField(field, value) {
      switch (field) {
        case 'name':
          if (!value.trim()) return 'Full name is required.';
          if (!/^[A-Za-z\s]{2,}\s[A-Za-z\s]{2,}$/.test(value)) return 'Please enter a valid full name (first and last name).';
          return '';
        case 'email':
          if (!value.trim()) return 'Email address is required.';
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Please enter a valid email address.';
          return '';
        case 'password':
          if (!value) return 'Password is required.';
          if (value.length < 8) return 'Password must be at least 8 characters long.';
          return '';
        case 'phone':
          if (!value.trim()) return 'Contact number is required.';
          if (!/^[0-9+()\-\s]{10,}$/.test(value)) return 'Please enter a valid phone number (at least 10 digits).';
          return '';
        case 'experience':
          if (!value.trim()) return 'Trading experience is required.';
          if (value.length < 20) return 'Please provide more details about your trading experience (at least 20 characters).';
          return '';
        default:
          return '';
      }
    }

    // Real-time input validation
    Object.keys(inputs).forEach(key => {
      if (key !== 'referral') {
        inputs[key].addEventListener('input', () => {
          const error = validateField(key, inputs[key].value);
          const formGroup = inputs[key].parentElement;
          const errorDiv = formGroup.querySelector('.field-error') || document.createElement('div');
          errorDiv.className = 'field-error';
          errorDiv.style.color = 'var(--error)';
          errorDiv.style.fontSize = '0.85rem';
          errorDiv.style.marginTop = '5px';
          errorDiv.textContent = error;
          if (!formGroup.querySelector('.field-error')) formGroup.appendChild(errorDiv);
          checkFormValidity();
        });
      }
    });

    // Check form validity for enabling submit button
    function checkFormValidity() {
      const allValid = agree.checked &&
        !validateField('name', inputs.name.value) &&
        !validateField('email', inputs.email.value) &&
        !validateField('password', inputs.password.value) &&
        !validateField('phone', inputs.phone.value) &&
        !validateField('experience', inputs.experience.value);
      submitBtn.disabled = !allValid;
      submitBtn.classList.toggle('enabled', allValid);
    }

    // Terms checkbox
    agree.addEventListener('change', checkFormValidity);

    // Show error message
    function showError(message) {
      alertDiv.className = 'alert-error';
      alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      alertDiv.setAttribute('aria-live', 'assertive');
      alertDiv.style.display = 'block';
      // Re-enable the submit button so user can retry
      submitBtn.disabled = false;
      submitBtn.classList.add('enabled');
      submitBtn.innerHTML = 'Submit Application';
    }

    // Show success message
    function showSuccess(message) {
      alertDiv.className = 'alert-success';
      alertDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      alertDiv.setAttribute('aria-live', 'polite');
      alertDiv.style.display = 'block';
    }

    // Form submission
    form.addEventListener('submit', async e => {
      e.preventDefault();
      // Hide any previous alert
      alertDiv.style.display = 'none';
      alertDiv.textContent = '';
      alertDiv.className = '';

      // Collect & trim values, convert referral code to uppercase
      const name       = inputs.name.value.trim(),
            email      = inputs.email.value.trim().toLowerCase(),
            password   = inputs.password.value,
            phone      = inputs.phone.value.trim(),
            experience = inputs.experience.value.trim(),
            manualRef  = inputs.referral.value.trim().toUpperCase(),
            urlRef     = new URLSearchParams(location.search).get('ref')?.trim().toUpperCase() || '',
            code       = manualRef || urlRef;

      // 1) Client-side validation
      for (const [key, input] of Object.entries(inputs)) {
        if (key !== 'referral') {
          const err = validateField(key, input.value);
          if (err) { showError(err); return; }
        }
      }
      if (!agree.checked) {
        showError('You must agree to the terms and privacy policy before applying.');
        return;
      }

      // 2) Disable button & show spinner
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting‚Ä¶';

      try {
        // A) Check for duplicate email in applications table
        const { data: existingUser, error: userError } = await supabaseClient
          .from('applications').select('email').eq('email', email).single();

        if (existingUser) {
          showError('This email is already registered. Please log in or use a different email.');
          return;
        }
        if (userError && userError.code !== 'PGRST116') throw userError;

        // B) Validate referral code if provided
        let referredBy = null;
        if (code) {
          // Case-insensitive check using ilike
          const { data: aff, error: refErr } = await supabaseClient
            .from('affiliate_accounts')
            .select('id')
            .ilike('referral_code', code)  // Case-insensitive match
            .single();

          if (refErr || !aff) {
            showError('Invalid referral code. Please check and try again, or leave it blank.');
            return;
          }
          referredBy = aff.id;
        }

        // C) Insert application data directly into Supabase
        const { error: insertError } = await supabaseClient
          .from('applications')
          .insert([
            {
              name,
              email,
              phone,
              experience,
              referral_code: code || null,
              referred_by: referredBy || null,
              created_at: new Date().toISOString()
            }
          ]);

        if (insertError) {
          throw insertError;
        }

        // D) Send email using Netlify function
        const payload = { name, email, password, phone, experience, referral_code: code, referred_by: referredBy };
        const res = await fetch('/.netlify/functions/send-application', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (!res.ok) {
          throw new Error(result.error || 'Email sending failed');
        }

        // E) Success!
        showSuccess(`
          <strong>Application Submitted Successfully!</strong><br>
          Thank you for applying. A confirmation email has been sent to ${email}.<br>
          Redirecting to subscription options shortly.
        `);
        form.reset();
        agree.checked = false;
        Object.values(inputs).forEach(i => {
          const fe = i.parentElement.querySelector('.field-error');
          if (fe) fe.remove();
        });
        setTimeout(() => window.location.href = 'vip-subscription', 5000);

      } catch (err) {
        console.error('Submission error:', err);
        if (err.message.includes('NetworkError') || err.message.includes('Failed to fetch')) {
          showError('Network issue detected. Please check your connection and try again.');
        } else {
          showError('An unexpected error occurred. Please try again later or contact support at support@apexincomeoptions.com.ng.');
        }
      }
    });
  </script>
</body>
</html>
