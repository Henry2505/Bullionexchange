<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Join the Chukwuemeka Bullion Exchange VIP trading community." />
  <title>Apply ‚Ä¢ Chukwuemeka Bullion Exchange</title>

  <!-- Fonts & Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <style>
    :root[data-theme="dark"] {
      --bg: #121212; --text: #f0f0f0;
      --gold: #d4af37; --gold-dark: #b3932b;
      --glass-bg: rgba(30,30,30,0.6);
      --text-light: #bbbbbb; --border: #333;
      --success: #2ecc71; --error: #e74c3c;
    }
    :root[data-theme="light"] {
      --bg: #fafafa; --text: #222;
      --gold: #d4af37; --gold-dark: #b3932b;
      --glass-bg: rgba(255,255,255,0.6);
      --text-light: #555; --border: #ddd;
      --success: #27ae60; --error: #c0392b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Roboto',sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; position:relative;
      background-image: linear-gradient(135deg, #1a1a1a 0%, #121212 100%);
    }
    a { color:var(--gold); text-decoration:none; }
    a:hover { text-decoration:underline; }

    /* Header */
    .header-bar {
      position:fixed; top:0; left:0; right:0; height:70px;
      background:rgba(0,0,0,0.8); display:flex;
      align-items:center; justify-content:space-between;
      padding:0 20px; z-index:1000;
      border-bottom:1px solid var(--gold);
    }
    .header-left { display:flex; align-items:center; gap:20px; }
    .logo img { width:140px; margin-top:15px; cursor:pointer; }
    #local-time {
      font-size:1rem; color:var(--gold);
      background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:20px;
    }
    #theme-toggle,#voice-toggle {
      background:none;border:none;font-size:1.5rem;color:var(--gold);
      cursor:pointer;margin-left:10px;padding:0.5rem;
      border-radius:50%;
      background:rgba(212,175,55,0.1);
    }

    /* Main */
    main { padding:100px 20px 60px; display:flex; justify-content:center; }
    .apply-card {
      max-width:450px;width:100%;background:var(--glass-bg);
      padding:30px;border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      border:1px solid rgba(212,175,55,0.3);
    }
    .apply-card h1 {
      font-family:'Playfair Display',serif;font-size:2rem;
      color:var(--gold);text-align:center;margin-bottom:25px;
      position:relative;
    }
    .apply-card h1::after {
      content:"";display:block;width:80px;height:3px;
      background:var(--gold);margin:10px auto 0;border-radius:3px;
    }

    /* Quote */
    .quote-section {
      background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(180,149,43,0.1));
      border-radius:12px;padding:20px;margin-bottom:20px;
      position:relative;overflow:hidden;text-align:center;
    }
    .quote-text { font-style:italic;color:var(--gold);margin-bottom:8px; }
    .quote-author { color:var(--text-light);font-size:0.9rem; }
    .quote-refresh {
      position:absolute;top:10px;right:10px;border:none;
      background:none;color:var(--gold);cursor:pointer;
    }

    /* Form */
    .form-group { margin-bottom:20px; position:relative; }
    .form-group label { display:block;margin-bottom:6px; color:var(--text-light); }
    .form-group input,
    .form-group textarea {
      width:100%; padding:12px 12px 12px 40px;
      border:1px solid var(--border); border-radius:8px;
      background:rgba(28,28,28,0.8); color:var(--text);
    }
    .form-group .input-icon {
      position:absolute;left:12px;top:50%;transform:translateY(-50%);
      color:var(--gold);font-size:1.2rem;
    }
    textarea { resize:vertical; min-height:100px; }
    .terms-container {
      display:flex;align-items:center;padding:12px;
      border:1px solid var(--gold);border-radius:8px;
      margin-bottom:20px;
    }
    .terms-container input { width:20px;height:20px; accent-color:var(--gold); }
    button {
      width:100%;padding:14px;border:none;border-radius:8px;
      background:var(--gold);color:#000;font-weight:700;
      cursor:pointer;opacity:.6;pointer-events:none;
    }
    button.enabled { opacity:1;pointer-events:auto; }

    .alert-success { background:rgba(46,204,113,0.15);border:1px solid var(--success);color:var(--success); }
    .alert-error   { background:rgba(231,76,60,0.15);border:1px solid var(--error);  color:var(--error); }

    footer { text-align:center;padding:20px 0;color:var(--text-light);font-size:.85rem; }

  </style>
</head>
<body>

  <div class="header-bar">
    <div class="header-left">
      <a href="index.html" class="logo"><img src="CBE_logo.PNG" alt="CBE Logo"></a>
      <span id="local-time"></span>
    </div>
    <div>
      <button id="theme-toggle">üåû</button>
      <button id="voice-toggle">‚ñ∂Ô∏è</button>
      <audio id="page-audio" src="apply.mp3" preload="auto"></audio>
    </div>
  </div>

  <main>
    <div class="apply-card" id="apply-card">
      <h1>Apply to Join CBE</h1>

      <!-- Forex Quote -->
      <div class="quote-section">
        <p class="quote-text" id="forex-quote">The market is always right. Trade what you see, not what you think.</p>
        <p class="quote-author" id="quote-author">- Market Wisdom</p>
        <button class="quote-refresh" id="refresh-quote"><i class="fas fa-sync-alt"></i></button>
      </div>

      <!-- Referral Note -->
      <p class="referral-note" id="referral-note"></p>

      <!-- Alert -->
      <div id="apply-alert" role="alert"></div>

      <form id="apply-form" novalidate>
        <!-- Full Name -->
        <div class="form-group">
          <label for="apply-name">Full Name</label>
          <i class="fas fa-user input-icon"></i>
          <input type="text" id="apply-name" required />
        </div>

        <!-- Email -->
        <div class="form-group">
          <label for="apply-email">Email Address</label>
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" id="apply-email" required />
        </div>

        <!-- Password -->
        <div class="form-group">
          <label for="apply-password">Password</label>
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="apply-password" required />
        </div>

        <!-- Phone -->
        <div class="form-group">
          <label for="apply-phone">Contact Number</label>
          <i class="fas fa-phone input-icon"></i>
          <input type="tel" id="apply-phone" required />
        </div>

        <!-- Experience -->
        <div class="form-group">
          <label for="apply-message">Trading Experience</label>
          <textarea id="apply-message" required></textarea>
        </div>

        <!-- Referral Code -->
        <div class="form-group">
          <label for="apply-referral">Referral Code (optional)</label>
          <i class="fas fa-user-friends input-icon"></i>
          <input type="text" id="apply-referral" />
        </div>

        <!-- Terms -->
        <div class="terms-container">
          <input type="checkbox" id="agree-terms" />
          <label for="agree-terms">I agree to the <a href="https://apexincomeoptions.com.ng/privacy" target="_blank">Privacy Policy</a> and <a href="https://apexincomeoptions.com.ng/terms" target="_blank">Terms & Conditions</a></label>
        </div>

        <button type="submit" id="submit-btn">Submit Application</button>
      </form>
    </div>
  </main>

  <footer>¬© 2025 Chukwuemeka Bullion Exchange. All rights reserved.</footer>

  <script>
    // ---- UTILITY/INITIALIZATION ----
    // Supabase client
    const SUPA_URL = "https://dapwpgvnfjcfqqhrpxla.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ";
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Elements
    const quoteEl      = document.getElementById('forex-quote');
    const authorEl     = document.getElementById('quote-author');
    const localTimeEl  = document.getElementById('local-time');
    const referralNote = document.getElementById('referral-note');
    const form         = document.getElementById('apply-form');
    const submitBtn    = document.getElementById('submit-btn');
    const alertDiv     = document.getElementById('apply-alert');
    const agreeCheck   = document.getElementById('agree-terms');
    const inputs       = {
      name:       document.getElementById('apply-name'),
      email:      document.getElementById('apply-email'),
      password:   document.getElementById('apply-password'),
      phone:      document.getElementById('apply-phone'),
      experience: document.getElementById('apply-message'),
      referral:   document.getElementById('apply-referral')
    };

    // Quotes array
    const forexQuotes = [
      { text: "The market is always right. Trade what you see, not what you think.", author: "Market Wisdom" },
      { text: "Risk comes from not knowing what you're doing. Master your strategy before trading.", author: "Warren Buffett" },
      { text: "Success in trading is not about being right all the time; it's about risk management and consistency.", author: "Alexander Elder" },
      { text: "In trading, discipline is the bridge between goals and accomplishment.", author: "Jim Rohn" },
      { text: "Patience is not the ability to wait, but the ability to keep a good attitude while waiting.", author: "Unknown" }
    ];

    // Utility
    function showAlert(msg, type) {
      alertDiv.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }
    function clearAlert() {
      alertDiv.innerHTML = '';
    }
    function toUpper(val){ return val?.toUpperCase()||''; }

    // ---- INITIAL RENDER ----
    // Random quote
    function pickQuote(){
      const q = forexQuotes[Math.floor(Math.random()*forexQuotes.length)];
      quoteEl.textContent  = q.text;
      authorEl.textContent = `- ${q.author}`;
    }
    document.getElementById('refresh-quote').onclick = pickQuote;
    pickQuote();

    // Local time
    function updateTime(){
      const now = new Date();
      localTimeEl.textContent = now.toLocaleTimeString('en-US',{ hour12:true, timeZone:'Africa/Lagos' }) + ' WAT';
    }
    setInterval(updateTime,1000);
    updateTime();

    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.onclick = () => {
      const t = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme', t);
      themeBtn.textContent = t==='dark'?'üåû':'üåú';
      localStorage.setItem('theme', t);
    };
    (()=>{
      const saved = localStorage.getItem('theme')||'dark';
      document.documentElement.setAttribute('data-theme', saved);
      themeBtn.textContent = saved==='dark'?'üåû':'üåú';
    })();

    // Voice toggle
    const voiceBtn = document.getElementById('voice-toggle');
    const audio    = document.getElementById('page-audio');
    voiceBtn.onclick = ()=>{
      if(audio.paused){ audio.play(); voiceBtn.textContent='‚è∏Ô∏è'; }
      else           { audio.pause(); voiceBtn.textContent='‚ñ∂Ô∏è'; }
    };
    audio.onended = ()=> voiceBtn.textContent='‚ñ∂Ô∏è';

    // Referral from URL
    const urlRef = toUpper(new URLSearchParams(location.search).get('ref'));
    if(urlRef){
      referralNote.textContent = `Referred by: ${urlRef}`;
      inputs.referral.value    = urlRef;
    }

    // Enable submit only once valid
    function checkValid(){
      const ok = agreeCheck.checked
        && inputs.name.value.trim()
        && inputs.email.value.trim()
        && inputs.password.value.length>=8
        && inputs.phone.value.trim()
        && inputs.experience.value.trim().length>=20;
      submitBtn.disabled = !ok;
      submitBtn.classList.toggle('enabled', ok);
    }
    agreeCheck.onchange = checkValid;
    Object.values(inputs).forEach(i => i.oninput = checkValid);

    // ---- FORM SUBMISSION ----
    form.onsubmit = async e => {
      e.preventDefault();
      clearAlert();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting‚Ä¶';

      // Gather
      const name       = inputs.name.value.trim();
      const email      = inputs.email.value.trim().toLowerCase();
      const password   = inputs.password.value;
      const phone      = inputs.phone.value.trim();
      const experience = inputs.experience.value.trim();
      const manualRef  = toUpper(inputs.referral.value.trim());
      const code       = manualRef || urlRef || null;

      try {
        // Prevent duplicate email
        let { data:dupe } = await supabase
          .from('affiliate_accounts')
          .select('id').eq('email',email).single();
        if(dupe) throw new Error('DUPLICATE_EMAIL');

        // Referral lookup
        let referredBy = null;
        if(code){
          let { data:aff, error:refErr } = await supabase
            .from('affiliate_accounts')
            .select('id')
            .ilike('referral_code', code)
            .single();
          if(refErr||!aff) throw new Error('INVALID_REF');
          referredBy = aff.id;
        }

        // Send to your function
        const payload = { name,email,password,phone,experience,referral_code:code, referred_by:referredBy };
        const res = await fetch('/.netlify/functions/send-application',{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
        });
        const body = await res.json();
        if(!res.ok) throw new Error(body.error||'SERVER_FAIL');

        showAlert('Application submitted! Redirecting‚Ä¶','success');
        setTimeout(()=>window.location.href='vip-subscription',3000);

      } catch(err) {
        if(err.message==='DUPLICATE_EMAIL') {
          showAlert('Email already registered.','danger');
        } else if(err.message==='INVALID_REF') {
          showAlert('Invalid referral code.','danger');
        } else {
          showAlert('An error occurred. Please try again.','danger');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
      }
    };
  </script>

</body>
</html>
