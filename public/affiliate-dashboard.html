<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 1rem; background: #f5f7fa; }
    h1 { text-align: center; color: #0070f3; }
    section { background: white; padding: 1rem; margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 0.5rem; font-weight: 600; }
    input, button { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #0070f3; color: white; border: none; cursor: pointer; margin-top: 1rem; }
    button:hover { background: #005bb5; }
    .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .copy-btn { background: #00b894; color: white; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; cursor: pointer; }
    .copy-btn:hover { background: #019870; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #ddd; text-align: left; }
    th { background: #0070f3; color: white; }
    #logout-btn { background: #e74c3c; color: white; width: 100%; margin-top: 1rem; }
    #settings-message { margin-top: 0.5rem; font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>Your Affiliate Dashboard</h1>

  <!-- 1) User Info & Referral Code -->
  <section id="user-info">
    <div class="info-row">
      <div><strong>Name:</strong> <span id="user-name">Loading...</span></div>
      <div><strong>Email:</strong> <span id="user-email">Loading...</span></div>
    </div>
    <div class="info-row">
      <div><strong>Referral Code:</strong> <span id="referral-code">Loading...</span></div>
      <button class="copy-btn" id="copy-code-btn">Copy</button>
    </div>
    <div class="info-row">
      <div><strong>Referrals:</strong> <span id="referral-count">0</span></div>
    </div>
  </section>

  <!-- 2) Referral List -->
  <section id="referrals-list">
    <h2>Your Referrals</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>Email</th><th>Joined On</th></tr>
      </thead>
      <tbody id="referral-table-body">
        <tr><td colspan="3">Loading referrals...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- 3) Earnings Summary -->
  <section id="earnings-summary">
    <h2>Earnings Summary</h2>
    <div class="info-row">
      <div><strong>Total Earned:</strong> ₦<span id="total-earnings">0.00</span></div>
      <div><strong>Last Updated:</strong> <span id="earnings-updated">–</span></div>
    </div>
    <p><em>Each referral adds ₦1000 to your total automatically.</em></p>
  </section>

  <!-- 4) Profile Settings (Wallet/Bank/Phone) -->
  <section id="profile-settings">
    <h2>Update Payment Details</h2>
    <form id="settings-form">
      <label for="wallet-btc">BTC Wallet Address</label>
      <input type="text" id="wallet-btc" placeholder="e.g. 1A1zP1..." />

      <label for="wallet-usdt">USDT (TRC20) Wallet Address</label>
      <input type="text" id="wallet-usdt" placeholder="e.g. TX1234..." />

      <label for="wallet-eth">Ethereum Wallet Address</label>
      <input type="text" id="wallet-eth" placeholder="e.g. 0xAbc..." />

      <label for="bank-name">Bank Name</label>
      <input type="text" id="bank-name" placeholder="e.g. Access Bank" />

      <label for="bank-account">Bank Account Number</label>
      <input type="text" id="bank-account" placeholder="e.g. 1234567890" />

      <label for="bank-account-name">Account Holder Name</label>
      <input type="text" id="bank-account-name" placeholder="e.g. John Doe" />

      <label for="phone-number">Phone Number</label>
      <input type="tel" id="phone-number" placeholder="e.g. +2348012345678" />

      <button type="submit">Save Details</button>
      <p id="settings-message"></p>
    </form>
  </section>

  <!-- 5) Logout -->
  <button id="logout-btn">Logout</button>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Your exact Supabase credentials:
    const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentAffiliate = null;

    // 1) Load current affiliate data from localStorage & refresh from Supabase
    async function loadAffiliateData() {
      const stored = localStorage.getItem('affiliate_user');
      if (!stored) {
        window.location.href = 'affiliate-login.html';
        return;
      }

      const parsed = JSON.parse(stored);
      currentAffiliate = parsed;

      // Fetch up-to-date affiliate_user record by ID
      const { data: af, error } = await supabase
        .from('affiliate_user')
        .select('*')
        .eq('id', currentAffiliate.id)
        .single();

      if (error || !af) {
        alert('Failed to load affiliate data. Please log in again.');
        localStorage.removeItem('affiliate_user');
        window.location.href = 'affiliate-login.html';
        return;
      }

      currentAffiliate = af;
      localStorage.setItem('affiliate_user', JSON.stringify(af));

      document.getElementById('user-name').textContent = af.name;
      document.getElementById('user-email').textContent = af.email;
      document.getElementById('referral-code').textContent = af.referral_code;

      // Load referrals
      await loadReferrals(af.referral_code);

      // Load earnings
      await loadEarnings(af.id);

      // Fill payment fields
      document.getElementById('wallet-btc').value = af.wallet_btc || '';
      document.getElementById('wallet-usdt').value = af.wallet_usdt || '';
      document.getElementById('wallet-eth').value = af.wallet_eth || '';
      document.getElementById('bank-name').value = af.bank_name || '';
      document.getElementById('bank-account').value = af.bank_account || '';
      document.getElementById('bank-account-name').value = af.bank_account_name || '';
      document.getElementById('phone-number').value = af.phone_number || '';
    }

    // 2) Fetch and render referrals list
    async function loadReferrals(referralCode) {
      if (!referralCode) {
        document.getElementById('referral-count').textContent = '0';
        document.getElementById('referral-table-body').innerHTML =
          '<tr><td colspan="3">No referral code assigned.</td></tr>';
        return;
      }

      const { data: referrals, error } = await supabase
        .from('affiliate_user')
        .select('name,email,created_at')
        .eq('referred_by', referralCode)
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('referral-count').textContent = '0';
        document.getElementById('referral-table-body').innerHTML =
          '<tr><td colspan="3">Error loading referrals.</td></tr>';
        return;
      }

      document.getElementById('referral-count').textContent = referrals.length;

      if (referrals.length === 0) {
        document.getElementById('referral-table-body').innerHTML =
          '<tr><td colspan="3">No referrals yet.</td></tr>';
        return;
      }

      const tbody = document.getElementById('referral-table-body');
      tbody.innerHTML = '';
      referrals.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.email}</td>
          <td>${new Date(r.created_at).toLocaleDateString()}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 3) Fetch and render earnings summary
    async function loadEarnings(affiliateId) {
      const { data: e, error } = await supabase
        .from('earnings')
        .select('total_earnings, last_updated')
        .eq('affiliate_id', affiliateId)
        .single();

      if (error || !e) {
        document.getElementById('total-earnings').textContent = '0.00';
        document.getElementById('earnings-updated').textContent = '–';
        return;
      }

      document.getElementById('total-earnings').textContent = Number(e.total_earnings).toLocaleString();
      document.getElementById('earnings-updated').textContent = new Date(e.last_updated).toLocaleString();
    }

    // 4) Save profile (wallet/bank/phone) changes
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const updates = {
        wallet_btc: document.getElementById('wallet-btc').value.trim(),
        wallet_usdt: document.getElementById('wallet-usdt').value.trim(),
        wallet_eth: document.getElementById('wallet-eth').value.trim(),
        bank_name: document.getElementById('bank-name').value.trim(),
        bank_account: document.getElementById('bank-account').value.trim(),
        bank_account_name: document.getElementById('bank-account-name').value.trim(),
        phone_number: document.getElementById('phone-number').value.trim(),
        updated_at: new Date().toISOString(),
      };

      const { error } = await supabase
        .from('affiliate_user')
        .update(updates)
        .eq('id', currentAffiliate.id);

      const msgEl = document.getElementById('settings-message');
      if (error) {
        msgEl.style.color = 'red';
        msgEl.textContent = 'Failed to save details.';
      } else {
        msgEl.style.color = 'green';
        msgEl.textContent = 'Details saved successfully.';
      }
      setTimeout(() => { msgEl.textContent = ''; }, 3000);
    });

    // 5) Copy referral code
    document.getElementById('copy-code-btn').addEventListener('click', () => {
      const code = document.getElementById('referral-code').textContent;
      navigator.clipboard.writeText(code)
        .then(() => alert('Referral code copied to clipboard!'))
        .catch(() => alert('Failed to copy code.'));
    });

    // 6) Logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('affiliate_user');
      window.location.href = 'affiliate-login.html';
    });

    // Initialize on page load
    window.onload = () => {
      loadAffiliateData();
    };
  </script>
</body>
</html>
