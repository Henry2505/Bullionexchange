<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Referral Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 1rem; }
  h2 { margin-top: 2rem; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
  button { padding: 0.5rem 1rem; margin-top: 1rem; }
  #settings-form input { display: block; margin-bottom: 0.5rem; padding: 0.4rem; width: 300px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Welcome to Your Referral Dashboard</h1>
  <div id="user-info">
    <p><strong>Name:</strong> <span id="user-name"></span></p>
    <p><strong>Email:</strong> <span id="user-email"></span></p>
    <p><strong>Your Referral Code:</strong> <span id="referral-code"></span> <button id="copy-code-btn">Copy Code</button></p>
  </div>

  <h2>Your Referrals (<span id="referral-count">0</span>)</h2>
  <table>
    <thead>
      <tr><th>Name</th><th>Email</th><th>Joined On</th></tr>
    </thead>
    <tbody id="referral-table-body">
      <tr><td colspan="3">Loading referrals...</td></tr>
    </tbody>
  </table>

  <h2>Earnings Summary</h2>
  <p>Total Commissions Earned: ₦<span id="total-commissions">0</span></p>
  <p>Pending Payouts: ₦<span id="pending-payouts">0</span></p>

  <h2>Update Your Payment Details</h2>
  <form id="settings-form">
    <input type="text" id="wallet-btc" placeholder="BTC Wallet Address" />
    <input type="text" id="wallet-usdt" placeholder="USDT Wallet Address" />
    <input type="text" id="wallet-eth" placeholder="ETH Wallet Address" />
    <input type="text" id="bank-name" placeholder="Bank Name" />
    <input type="text" id="bank-account" placeholder="Bank Account Number" />
    <input type="text" id="bank-account-name" placeholder="Bank Account Name" />
    <input type="text" id="phone-number" placeholder="Phone Number" />
    <button type="submit">Save Details</button>
    <p id="settings-message" style="color:green;"></p>
  </form>

  <button id="logout-btn" style="background:#e74c3c; color:#fff;">Logout</button>

<script>
  // Initialize Supabase - replace with your own project URL and anon key
  const supabaseUrl = 'https://YOUR_SUPABASE_PROJECT_URL.supabase.co';
  const supabaseAnonKey = 'YOUR_SUPABASE_ANON_KEY';
  const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

  let currentUser = null;

  async function loadUserData() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if(error || !user) {
      alert('You must be logged in to view this page.');
      window.location.href = '/login.html';
      return;
    }
    currentUser = user;

    // Fetch full user profile from 'users' table by user id (auth id)
    const { data: profile, error: profileError } = await supabase
      .from('users')
      .select('*')
      .eq('id', user.id)
      .single();

    if(profileError || !profile) {
      alert('Failed to load user profile.');
      return;
    }

    document.getElementById('user-name').textContent = profile.full_name || 'No name set';
    document.getElementById('user-email').textContent = profile.email;
    document.getElementById('referral-code').textContent = profile.referral_code || 'No code';

    // Load referral list
    await loadReferrals(profile.referral_code);

    // Load earnings
    await loadEarnings(profile.id);

    // Fill payment details fields
    document.getElementById('wallet-btc').value = profile.wallet_btc || '';
    document.getElementById('wallet-usdt').value = profile.wallet_usdt || '';
    document.getElementById('wallet-eth').value = profile.wallet_eth || '';
    document.getElementById('bank-name').value = profile.bank_name || '';
    document.getElementById('bank-account').value = profile.bank_account || '';
    document.getElementById('bank-account-name').value = profile.bank_account_name || '';
    document.getElementById('phone-number').value = profile.phone_number || '';
  }

  async function loadReferrals(referralCode) {
    if(!referralCode) {
      document.getElementById('referral-table-body').innerHTML = '<tr><td colspan="3">You have no referral code assigned yet.</td></tr>';
      return;
    }
    // Fetch users where referred_by = referralCode
    const { data: referrals, error } = await supabase
      .from('users')
      .select('full_name,email,created_at')
      .eq('referred_by', referralCode)
      .order('created_at', { ascending: false });

    if(error) {
      document.getElementById('referral-table-body').innerHTML = `<tr><td colspan="3">Failed to load referrals.</td></tr>`;
      return;
    }

    document.getElementById('referral-count').textContent = referrals.length;

    if(referrals.length === 0) {
      document.getElementById('referral-table-body').innerHTML = `<tr><td colspan="3">No referrals yet.</td></tr>`;
      return;
    }

    const tbody = document.getElementById('referral-table-body');
    tbody.innerHTML = '';
    referrals.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.full_name || '-'}</td>
        <td>${r.email}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function loadEarnings(userId) {
    // Fetch sum of earnings for this user where status = 'paid'
    const { data: paidEarnings, error: paidError } = await supabase
      .from('earnings')
      .select('amount')
      .eq('user_id', userId)
      .eq('status', 'paid');

    // Fetch sum of earnings pending payout
    const { data: pendingEarnings, error: pendingError } = await supabase
      .from('earnings')
      .select('amount')
      .eq('user_id', userId)
      .eq('status', 'pending');

    if(paidError || pendingError) {
      document.getElementById('total-commissions').textContent = 'Error';
      document.getElementById('pending-payouts').textContent = 'Error';
      return;
    }

    const totalPaid = paidEarnings.reduce((acc, curr) => acc + Number(curr.amount), 0);
    const totalPending = pendingEarnings.reduce((acc, curr) => acc + Number(curr.amount), 0);

    document.getElementById('total-commissions').textContent = totalPaid.toLocaleString();
    document.getElementById('pending-payouts').textContent = totalPending.toLocaleString();
  }

  // Save payment details handler
  document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const updates = {
      wallet_btc: document.getElementById('wallet-btc').value.trim(),
      wallet_usdt: document.getElementById('wallet-usdt').value.trim(),
      wallet_eth: document.getElementById('wallet-eth').value.trim(),
      bank_name: document.getElementById('bank-name').value.trim(),
      bank_account: document.getElementById('bank-account').value.trim(),
      bank_account_name: document.getElementById('bank-account-name').value.trim(),
      phone_number: document.getElementById('phone-number').value.trim(),
      updated_at: new Date().toISOString(),
    };

    const { error } = await supabase
      .from('users')
      .update(updates)
      .eq('id', currentUser.id);

    const msgEl = document.getElementById('settings-message');
    if(error) {
      msgEl.style.color = 'red';
      msgEl.textContent = 'Failed to save details.';
    } else {
      msgEl.style.color = 'green';
      msgEl.textContent = 'Details saved successfully.';
    }
    setTimeout(() => { msgEl.textContent = ''; }, 3000);
  });

  // Copy referral code button
  document.getElementById('copy-code-btn').addEventListener('click', () => {
    const code = document.getElementById('referral-code').textContent;
    navigator.clipboard.writeText(code).then(() => {
      alert('Referral code copied to clipboard!');
    }).catch(() => {
      alert('Failed to copy referral code.');
    });
  });

  // Logout
  document.getElementById('logout-btn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login.html';
  });

  // On page load
  window.onload = () => {
    loadUserData();
  };
</script>
</body>
</html>
