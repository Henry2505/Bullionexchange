<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CBE Admin â€“ Affiliates</title>

  <!-- â”€â”€ 1) AUTH GUARD: Redirect if not logged in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.replace(
        'admin-login.html?redirect=' + encodeURIComponent(window.location.pathname)
      );
    }
  </script>

  <!-- â”€â”€ 2) STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root {
      --bg: #000; --text: #fff; --gold: #ffd700;
      --glass-bg: rgba(255,255,255,0.05); --overlay: rgba(0,0,0,0.6);
    }
    [data-theme="light"] {
      --bg: #f5f5f5; --text: #333; --gold: #cca300;
      --glass-bg: rgba(0,0,0,0.05); --overlay: rgba(255,255,255,0.15);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Poppins',sans-serif; background:var(--bg); color:var(--text); }
    .overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:var(--overlay); z-index:-1;
    }
    .glass {
      background:var(--glass-bg); backdrop-filter:blur(10px);
      border:1px solid rgba(255,215,0,0.2); border-radius:8px;
      padding:1rem;
    }
    header.admin-header {
      display:flex; align-items:center; justify-content:space-between;
      padding:1rem 2rem; background:rgba(0,0,0,0.6);
      border-bottom:1px solid var(--gold); position:sticky; top:0; z-index:10;
    }
    .logo { cursor:pointer; }
    .logo img { height:40px; }
    #theme-toggle { background:none; border:none; font-size:1.25rem; cursor:pointer; color:var(--text); }
    h2#section-title { color:var(--gold); text-align:center; margin:2rem 0 1rem; }
    table thead { background:var(--gold); color:var(--bg); }
    table td, table th { vertical-align:middle; }
  </style>
</head>
<body>
  <div class="overlay"></div>

  <!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="admin-header glass">
    <div class="logo" id="logo">
      <img src="CBE_logo.PNG" alt="CBE Logo"/>
    </div>
    <button id="theme-toggle" aria-label="Toggle theme">ðŸŒž</button>
  </header>

  <!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="container py-4">
    <h2 id="section-title">Affiliates</h2>
    <div class="glass">
      <table class="table table-hover table-responsive w-100 text-white" id="affiliates-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Referral Code</th>
            <th>Joined On</th>
            <th>Total Refs</th>
            <th>Converted</th>
            <th>Conversion Rate</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="text-center text-muted py-5">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- â”€â”€ SCRIPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script>
    // 1) Logo â†’ Dashboard
    document.getElementById('logo').onclick = () => {
      location.href = 'admin-dashboard.html';
    };

    // 2) Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    const applyTheme = t => {
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      themeBtn.textContent = t==='dark' ? 'ðŸŒž' : 'ðŸŒœ';
    };
    themeBtn.onclick = () => {
      applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    };
    applyTheme(localStorage.getItem('theme') || 'dark');

    // 3) Supabase init
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'YOUR_SERVICE_ROLE_OR_ANON_KEY';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // 4) Load & render affiliates
    async function loadAffiliates() {
      const tbody = document.querySelector('#affiliates-table tbody');
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-gold" role="status"></div></td></tr>`;

      // Fetch all affiliates
      const { data: affs, error: affErr } = await supabase
        .from('affiliate_accounts')
        .select('id,email,referral_code,created_at')
        .order('created_at', { ascending: false });

      if (affErr) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Error loading affiliates: ${affErr.message}</td></tr>`;
        return;
      }

      if (!affs.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No affiliates found.</td></tr>`;
        return;
      }

      // For each affiliate, fetch referral counts
      const rows = await Promise.all(affs.map(async a => {
        // total referrals
        const { count: total } = await supabase
          .from('referrals')
          .select('*', { count: 'exact', head: true })
          .eq('affiliate_id', a.id);

        // converted referrals
        const { count: conv } = await supabase
          .from('referrals')
          .select('*', { count: 'exact', head: true })
          .eq('affiliate_id', a.id)
          .eq('converted', true);

        const rate = total
          ? ((conv / total) * 100).toFixed(2) + '%'
          : '0%';

        return `
          <tr>
            <td>${a.email}</td>
            <td>${a.referral_code || 'â€”'}</td>
            <td>${new Date(a.created_at).toLocaleDateString()}</td>
            <td>${total}</td>
            <td>${conv}</td>
            <td>${rate}</td>
          </tr>
        `;
      }));

      tbody.innerHTML = rows.join('');
    }

    // 5) Kick it off
    loadAffiliates();
  </script>
</body>
</html>
