<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Affiliates</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root {
      --bg: #000;
      --text: #fff;
      --accent: #ffd700;
      --glass: rgba(255,255,255,0.05);
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; }
    .glass { background: var(--glass); backdrop-filter: blur(8px); border: 1px solid var(--accent); }
    table thead { background: var(--accent); color: var(--bg); }
  </style>
</head>
<body>
  <!-- 0) Auth guard -->
  <script>
    if (localStorage.getItem('isAdminLoggedIn') !== 'true') {
      window.location.replace('admin-login.html');
      throw new Error('Not logged in');
    }
  </script>

  <div class="container py-4">
    <h1 class="mb-4">üßë‚Äçüíº Affiliates</h1>
    <table class="table table-striped glass text-white">
      <thead>
        <tr>
          <th>Email</th>
          <th>Code</th>
          <th>Joined On</th>
          <th># Referrals</th>
          <th># Banks</th>
          <th># Wallets</th>
          <th># Payouts</th>
        </tr>
      </thead>
      <tbody id="affiliates-body">
        <tr><td colspan="7" class="text-center"><div class="spinner-border text-warning"></div> Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    (async function(){
      // 1) Init
      const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
      const SUPA_KEY = 'YOUR_SERVICE_ROLE_KEY'; // or anon key if policies allow
      const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

      // 2) Fetch all affiliates
      const { data: affs, error: affErr } = await supabase
        .from('affiliate_accounts')
        .select('id,email,referral_code,created_at')
        .order('created_at',{ascending:false});
      if (affErr) return showError('Failed to load affiliates');

      // 3) Fetch counts for each table
      const affiliateIds = affs.map(a=>a.id);
      // parallel count queries
      const [{ count: refCount }, { count: bankCount }, { count: walletCount }, { count: payoutCount }] =
        await Promise.all([
          supabase.from('referrals').select('affiliate_id',{head:true, count:'exact'}).in('affiliate_id',affiliateIds),
          supabase.from('affiliate_bank_accounts').select('affiliate_id',{head:true, count:'exact'}).in('affiliate_id',affiliateIds),
          supabase.from('affiliate_wallets').select('affiliate_id',{head:true, count:'exact'}).in('affiliate_id',affiliateIds),
          supabase.from('affiliate_payouts').select('affiliate_id',{head:true, count:'exact'}).in('affiliate_id',affiliateIds)
        ]);
      // but above gives totals across all affiliates; instead we need per-affiliate.  
      // Let's fetch raw arrays and count in JS:
      const [{ data: refs }, { data: banks }, { data: wallets }, { data: payouts }] =
        await Promise.all([
          supabase.from('referrals').select('affiliate_id'),
          supabase.from('affiliate_bank_accounts').select('affiliate_id'),
          supabase.from('affiliate_wallets').select('affiliate_id'),
          supabase.from('affiliate_payouts').select('affiliate_id')
        ]);
      const refMap = refs.reduce((m,r)=>(m[r.affiliate_id]=(m[r.affiliate_id]||0)+1,m),{});
      const bankMap = banks.reduce((m,b)=>(m[b.affiliate_id]=(m[b.affiliate_id]||0)+1,m),{});
      const walletMap = wallets.reduce((m,w)=>(m[w.affiliate_id]=(m[w.affiliate_id]||0)+1,m),{});
      const payoutMap = payouts.reduce((m,p)=>(m[p.affiliate_id]=(m[p.affiliate_id]||0)+1,m),{});

      // 4) Render
      const tbody = document.getElementById('affiliates-body');
      tbody.innerHTML = affs.map(a=>`
        <tr>
          <td>${a.email}</td>
          <td>${a.referral_code||'‚Äî'}</td>
          <td>${new Date(a.created_at).toLocaleDateString()}</td>
          <td>${refMap[a.id]||0}</td>
          <td>${bankMap[a.id]||0}</td>
          <td>${walletMap[a.id]||0}</td>
          <td>${payoutMap[a.id]||0}</td>
        </tr>
      `).join('');

      function showError(msg) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${msg}</td></tr>`;
      }
    })();
  </script>
</body>
</html>
