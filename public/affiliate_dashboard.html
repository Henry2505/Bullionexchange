<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard ‚Ä¢ CBE Global</title>

  <!-- DEPENDENCIES: Bootstrap CSS & Icons, Supabase JS, Chart.js -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    /* ===================== Dark Theme Variables ===================== */
    :root[data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --text-light: #bbbbbb;
      --accent: #1e1e1e;
      --gold: #ffd700;
      --gold-dark: #cca300;
      --glass: rgba(30, 30, 30, 0.7);
      --shadow: rgba(0, 0, 0, 0.5);
    }
    :root[data-theme="light"] {
      --bg: #f5f5f5;
      --text: #333;
      --text-light: #666666;
      --accent: #ffffff;
      --gold: #cca300;
      --gold-dark: #b58900;
      --glass: rgba(255, 255, 255, 0.7);
      --shadow: rgba(0, 0, 0, 0.2);
    }

    html {
      scroll-behavior: smooth;
    }
    body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: var(--bg);
      color: var(--text);
      height: 100%;
      font-family: 'Poppins', sans-serif;
      overflow-x: hidden;
    }
    a {
      color: var(--gold);
      text-decoration: none;
    }
    a:hover {
      color: var(--gold-dark);
    }

    /* ===================== Collapsible Sidebar ===================== */
    .sidebar {
      background: var(--accent);
      min-height: 100vh;
      padding-top: 1rem;
      border-right: 1px solid var(--gold-dark);
      color: var(--text);
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      transform: translateX(-260px);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .sidebar.expanded {
      transform: translateX(0);
    }
    .sidebar .nav-link {
      color: var(--text) !important;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      transition: background 0.3s ease;
    }
    .sidebar .nav-link.active,
    .sidebar .nav-link:hover {
      background: var(--gold-dark);
      color: #000 !important;
    }
    .sidebar .sidebar-title {
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1rem;
      color: var(--gold);
    }

    /* ===================== Sidebar Toggle Button ===================== */
    #sidebar-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      border-radius: 6px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1100;
      transition: background 0.3s ease;
    }
    #sidebar-toggle:hover {
      background: var(--glass);
    }
    #sidebar-toggle i {
      color: var(--gold);
      font-size: 1.25rem;
    }

    /* ===================== Main Content ===================== */
    .main-content {
      margin-left: 0; /* Will shift when sidebar expands */
      transition: margin-left 0.3s ease;
      padding: 1rem 1.5rem 1rem 1.5rem;
      overflow-y: auto;
      height: 100vh;
    }
    .sidebar.expanded ~ .main-content {
      margin-left: 260px;
    }
    @media (max-width: 992px) {
      .sidebar {
        top: 0;
        left: -260px;
      }
      .sidebar.expanded {
        transform: translateX(0);
      }
      .sidebar.expanded ~ .main-content {
        margin-left: 260px;
      }
    }

    /* ===================== Cards & Sections ===================== */
    .card {
      background: var(--glass);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      box-shadow: 0 2px 8px var(--shadow);
      margin-bottom: 1.5rem;
      color: var(--text);
    }
    .card-header {
      background: var(--accent);
      border-bottom: 1px solid var(--gold-dark);
      font-weight: 600;
      color: var(--gold);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-header .header-icon {
      margin-right: 0.5rem;
      font-size: 1.25rem;
    }
    .card-body {
      padding: 1rem;
      color: var(--text);
    }

    /* ===================== Form Controls ===================== */
    .form-control,
    .form-select {
      background: var(--accent) !important;
      color: var(--text) !important;
      border: 1px solid var(--gold-dark) !important;
    }
    .form-control::placeholder {
      color: var(--text-light) !important;
    }
    .form-control:focus,
    .form-select:focus {
      background: var(--accent) !important;
      color: var(--text) !important;
      border: 1px solid var(--gold) !important;
      box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25) !important;
    }
    .btn-primary {
      background: linear-gradient(45deg, var(--gold), var(--gold-dark));
      border: none;
      transition: background 0.3s ease;
      color: #000;
    }
    .btn-primary:hover {
      background: linear-gradient(45deg, var(--gold-dark), var(--gold));
    }
    .btn-outline-danger {
      border-color: var(--gold-dark) !important;
      color: var(--gold) !important;
    }
    .btn-outline-danger:hover {
      background: var(--gold-dark);
      color: #000 !important;
      border-color: var(--gold-dark) !important;
    }

    /* ===================== Tables ===================== */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      color: var(--text);
    }
    th {
      background: linear-gradient(45deg, var(--gold-dark), var(--gold));
      color: #000 !important;
      padding: 0.8rem;
      border-radius: 6px;
      position: sticky;
      top: 0;
      z-index: 2;
      font-size: 0.9rem;
    }
    td {
      background: var(--accent);
      padding: 0.8rem;
      border-radius: 6px;
      text-align: center;
      color: var(--text);
      font-size: 0.9rem;
    }
    .spinner-border {
      color: var(--gold);
    }

    /* ===================== Utility ===================== */
    .copy-btn {
      background: var(--gold);
      color: #000 !important;
      border: none;
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    .copy-btn:hover {
      background: var(--gold-dark);
      color: #000 !important;
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
    }
    .section-title i {
      margin-right: 0.5rem;
      font-size: 1.25rem;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 2000;
    }

    /* ===================== Overview Cards ===================== */
    .overview-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .overview-card {
      flex: 1 1 220px;
      background: var(--glass);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      box-shadow: 0 2px 8px var(--shadow);
      padding: 1rem;
      text-align: center;
      color: var(--text);
      transition: transform 0.3s ease;
    }
    .overview-card:hover {
      transform: translateY(-4px);
    }
    .overview-card .title {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-light);
    }
    .overview-card .value {
      font-size: 1.75rem;
      font-weight: 700;
      margin-top: 0.5rem;
      color: var(--gold);
    }

    /* ===================== Canvas Chart Container ===================== */
    .chart-container {
      background: var(--glass);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      box-shadow: 0 2px 8px var(--shadow);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .chart-container canvas {
      width: 100% !important;
      max-height: 300px;
    }

    /* ===================== Leaderboard ===================== */
    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      align-items: center;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .leaderboard-item:hover {
      background: var(--glass);
      transform: translateY(-2px);
    }
    .leader-name {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text);
    }
    .leader-count {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--gold);
    }

    /* ===================== Withdrawals / Payout Requests ===================== */
    .withdraw-card {
      background: var(--glass);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      box-shadow: 0 2px 8px var(--shadow);
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: var(--text);
    }
    .withdraw-card label {
      color: var(--text);
    }
    .withdraw-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .withdraw-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      align-items: center;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .withdraw-item:hover {
      background: var(--glass);
      transform: translateY(-2px);
    }
    .withdraw-status {
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* ===================== Dark/Light Toggle ===================== */
    .theme-toggle-btn {
      position: fixed;
      bottom: 1rem;
      left: calc(50% - 25px);
      background: var(--glass);
      border: 1px solid var(--gold-dark);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2000;
      transition: background 0.3s ease;
    }
    .theme-toggle-btn:hover {
      background: var(--accent);
    }
    .theme-toggle-btn i {
      color: var(--gold);
      font-size: 1.25rem;
    }

    /* ===================== ‚ÄúEarn $5 per Referral‚Äù Banner ===================== */
    .earn-banner {
      background: var(--gold-dark);
      color: #000;
      text-align: center;
      padding: 0.5rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-weight: 500;
      font-size: 0.95rem;
    }

    /* ===================== Referral QR Code ===================== */
    .qr-code {
      margin-top: 0.75rem;
      text-align: center;
    }
    .qr-code img {
      width: 120px;
      height: 120px;
      border: 2px solid var(--gold-dark);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- ===================== AUTH GUARD: Redirect if not logged in ===================== -->
  <script>
    const SUPA_URL =
      'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.' +
      'eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3Zu' +
      'ZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOj' +
      'E3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.' +
      'ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabaseClient = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Immediately check auth; if no user, redirect to login page
    supabaseClient.auth.getUser().then(({ data: { user }, error }) => {
      if (error || !user) {
        window.location.replace('affiliate_login.html');
      }
    });
  </script>

  <!-- ===================== Sidebar Toggle ===================== -->
  <div id="sidebar-toggle" title="Toggle Menu">
    <i class="bi bi-list"></i>
  </div>

  <!-- ===================== PAGE LAYOUT: Sidebar & Main Content ===================== -->
  <div class="sidebar" id="sidebar">
    <div class="px-3 pb-3">
      <h4 class="sidebar-title">Affiliate Dashboard</h4>
      <!-- Referral Code Card -->
      <div id="referral-section" class="card">
        <div class="card-header">
          <div><i class="bi bi-people-fill header-icon"></i>Referral Code</div>
        </div>
        <div class="card-body text-center">
          <span id="referral-code" class="h5">Loading‚Ä¶</span>
          <button id="copy-referral" class="copy-btn ms-2">
            <i class="bi bi-clipboard"></i>
          </button>
          <div class="mt-2">
            <small>Share your link:</small><br />
            <input
              type="text"
              id="referral-link"
              readonly
              class="form-control form-control-sm text-center"
              style="background: var(--accent); color: var(--text);"
            />
            <button id="copy-link" class="copy-btn mt-1">
              <i class="bi bi-link-45deg"></i> Copy
            </button>
          </div>
          <!-- ‚ÄúEarn $5‚Äù Banner -->
          <div class="earn-banner">
            üéâ Earn <strong>$5</strong> for each successful referral!
          </div>
          <!-- QR Code for Referral Link -->
          <div class="qr-code" id="qr-code-container">
            <!-- QR will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <nav class="nav flex-column px-3 pb-3">
      <a class="nav-link active" href="#overview-section">üè† Overview</a>
      <a class="nav-link" href="#referral-activity-section">üìà Referral Activity</a>
      <a class="nav-link" href="#leaderboard-section">üèÜ Leaderboard</a>
      <a class="nav-link" href="#bank-accounts-section">üè¶ Bank Accounts</a>
      <a class="nav-link" href="#crypto-wallets-section">üí∞ Crypto Wallets</a>
      <a class="nav-link" href="#currency-converter-section">üí± Converter</a>
      <a class="nav-link" href="#withdrawals-section">üíµ Payouts</a>
      <a class="nav-link" href="#profile-section">üë§ Profile</a>
      <button id="logout-btn" class="btn btn-outline-danger mt-3 w-100">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </nav>
  </div>

  <!-- ===================== Main Content ===================== -->
  <div class="main-content" id="main-content">
    <div class="container-fluid">
      <!-- ===================== Overview Section ===================== -->
      <section id="overview-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-speedometer2"></i> Overview
        </div>
        <div class="overview-cards">
          <!-- Total Referrals -->
          <div class="overview-card" id="card-total-referrals">
            <div class="title">Total Referrals</div>
            <div class="value" id="overview-total-referrals">0</div>
          </div>
          <!-- Estimated Earnings (USD) -->
          <div class="overview-card" id="card-estimated-earnings-usd">
            <div class="title">Est. Earnings (USD)</div>
            <div class="value" id="overview-est-earn-usd">$0.00</div>
          </div>
          <!-- Conversion Rate -->
          <div class="overview-card" id="card-conversion-rate">
            <div class="title">Conversion Rate</div>
            <div class="value" id="overview-conversion-rate">0%</div>
          </div>
          <!-- Convert Earnings Widget -->
          <div class="overview-card" id="card-convert-earnings">
            <div class="title">Convert Earnings</div>
            <div class="mb-2">
              <select id="convert-target-currency" class="form-select form-select-sm">
                <option value="NGN" selected>NGN</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
                <option value="BTC">BTC</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <button id="convert-earn-btn" class="btn btn-primary btn-sm mb-2">
              Convert
            </button>
            <div>
              <span id="convert-earn-result" class="text-light">--</span>
            </div>
          </div>
        </div>
      </section>

      <!-- ===================== Referral Activity (Chart) ===================== -->
      <section id="referral-activity-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-graph-up"></i> Referral Activity Over Time
        </div>
        <div class="chart-container">
          <canvas id="referralChart" height="100"></canvas>
        </div>
      </section>

      <!-- ===================== Leaderboard Section ===================== -->
      <section id="leaderboard-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-trophy-fill"></i> Leaderboard: Top Affiliates
        </div>
        <ul class="leaderboard-list" id="leaderboard-list">
          <li class="text-center text-muted">Loading leaderboard‚Ä¶</li>
        </ul>
      </section>

      <!-- ===================== Bank Accounts Section ===================== -->
      <section id="bank-accounts-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-bank2"></i> Manage Bank Accounts
        </div>
        <!-- Add Bank Account Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div><i class="bi bi-plus-circle header-icon"></i>Add New Bank Account</div>
          </div>
          <div class="card-body">
            <form id="bank-form" class="row g-3">
              <div class="col-md-6">
                <label for="bank-name" class="form-label">Bank Name</label>
                <input
                  type="text"
                  id="bank-name"
                  class="form-control"
                  placeholder="e.g. First Bank"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="bank-code" class="form-label">Bank Code/Branch</label>
                <input
                  type="text"
                  id="bank-code"
                  class="form-control"
                  placeholder="e.g. 011"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="account-number" class="form-label">Account Number</label>
                <input
                  type="text"
                  id="account-number"
                  class="form-control"
                  placeholder="e.g. 0123456789"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="account-name" class="form-label">Account Name</label>
                <input
                  type="text"
                  id="account-name"
                  class="form-control"
                  placeholder="e.g. John Doe"
                  required
                />
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary" id="add-bank-btn">
                  <span id="bank-btn-text">Add Account</span>
                  <span id="bank-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Existing Bank Accounts Table -->
        <div class="card">
          <div class="card-header">
            <div><i class="bi bi-file-earmark-text header-icon"></i>Your Saved Bank Accounts</div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table align-middle text-center mb-0">
                <thead>
                  <tr>
                    <th>Bank Name</th>
                    <th>Bank Code</th>
                    <th>Account Number</th>
                    <th>Account Name</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="bank-accounts-body">
                  <tr>
                    <td colspan="5">
                      <div class="text-center spinner-border"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ===================== Crypto Wallets Section ===================== -->
      <section id="crypto-wallets-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-currency-bitcoin"></i> Manage Crypto Wallets
        </div>
        <!-- Add Crypto Wallet Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div><i class="bi bi-plus-circle header-icon"></i>Add New Crypto Wallet</div>
          </div>
          <div class="card-body">
            <form id="wallet-form" class="row g-3">
              <div class="col-md-6">
                <label for="crypto-currency" class="form-label">Currency</label>
                <select id="crypto-currency" class="form-select" required>
                  <option value="">Select Currency</option>
                  <option value="BTC">Bitcoin (BTC)</option>
                  <option value="ETH">Ethereum (ETH)</option>
                  <option value="USDT">Tether (USDT)</option>
                  <option value="BCH">Bitcoin Cash (BCH)</option>
                  <option value="LTC">Litecoin (LTC)</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="crypto-address" class="form-label">Wallet Address</label>
                <input
                  type="text"
                  id="crypto-address"
                  class="form-control"
                  placeholder="e.g. 1BoatSLRHtKNngkdXEeobR76b53LETtpyT"
                  required
                />
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary" id="add-wallet-btn">
                  <span id="wallet-btn-text">Add Wallet</span>
                  <span id="wallet-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Existing Crypto Wallets Table -->
        <div class="card">
          <div class="card-header">
            <div><i class="bi bi-wallet-fill header-icon"></i>Your Saved Crypto Wallets</div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table align-middle text-center mb-0">
                <thead>
                  <tr>
                    <th>Currency</th>
                    <th>Wallet Address</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="wallets-body">
                  <tr>
                    <td colspan="3">
                      <div class="text-center spinner-border"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ===================== Currency Converter Section ===================== -->
      <section id="currency-converter-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-currency-exchange"></i> Currency Converter
        </div>
        <div class="card">
          <div class="card-header">
            <div><i class="bi bi-arrow-left-right header-icon"></i>Convert Between Currencies</div>
          </div>
          <div class="card-body">
            <form id="converter-form" class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="convert-from" class="form-label">From</label>
                <select id="convert-from" class="form-select">
                  <option value="USD" selected>USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="NGN">NGN</option>
                  <option value="BTC">BTC</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="convert-to" class="form-label">To</label>
                <select id="convert-to" class="form-select">
                  <option value="NGN" selected>NGN</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="BTC">BTC</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="convert-amount" class="form-label">Amount</label>
                <input type="number" id="convert-amount" class="form-control" value="1" min="0" />
              </div>
              <div class="col-md-3 text-end">
                <button type="submit" class="btn btn-primary" id="convert-btn">
                  <span id="convert-text">Convert</span>
                  <span id="convert-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
              <div class="col-12 text-center mt-3">
                <h5 id="convert-result">--</h5>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- ===================== Withdrawals / Payout Requests ===================== -->
      <section id="withdrawals-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-cash-stack"></i> Payout Requests
        </div>
        <!-- Request Payout Card -->
        <div class="withdraw-card mb-3">
          <div class="mb-2" style="font-size: 0.95rem; color: var(--text-light);">
            You earn <strong>$5</strong> per referral. Request in USD, NGN or receive via crypto.
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <label for="withdraw-amount" class="form-label">Request Amount (USD)</label>
              <input
                type="number"
                id="withdraw-amount"
                class="form-control"
                placeholder="e.g. 100.00"
                min="1"
                step="0.01"
              />
            </div>
            <div class="col-md-4">
              <label for="withdraw-method" class="form-label">Payout Method</label>
              <select id="withdraw-method" class="form-select">
                <option value="">Select Method</option>
                <option value="bank">Bank Transfer</option>
                <option value="crypto">Crypto Wallet</option>
                <option value="ngn">Naira (NGN Bank)</option>
              </select>
            </div>
            <div class="col-md-4 align-self-end text-end">
              <button id="request-withdraw-btn" class="btn btn-primary">
                <span id="withdraw-btn-text">Request Payout</span>
                <span id="withdraw-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
              </button>
            </div>
          </div>
        </div>

        <!-- Past Payouts List -->
        <div class="withdraw-card">
          <div class="section-title"><i class="bi bi-list-check"></i> Past Payouts</div>
          <ul class="withdraw-list" id="withdrawals-list">
            <li class="text-center text-muted">Loading payout history‚Ä¶</li>
          </ul>
        </div>
      </section>

      <!-- ===================== Profile Section ===================== -->
      <section id="profile-section" class="mb-5">
        <div class="section-title">
          <i class="bi bi-person-circle"></i> Your Profile
        </div>
        <div class="card">
          <div class="card-body">
            <p><strong>Email:</strong> <span id="user-email">Loading‚Ä¶</span></p>
            <p><strong>Joined On:</strong> <span id="joined-date">--</span></p>
            <p><strong>Total Referrals:</strong> <span id="total-referrals">0</span></p>
            <p>
              <strong>Est. Earnings (USD):</strong>
              <span id="overview-est-earn-usd-inline">$0.00</span>
            </p>
            <p>
              <strong>Conversion Rate:</strong>
              <span id="overview-conversion-rate-inline">0%</span>
            </p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ===================== Toast Container ===================== -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div
      id="liveToast"
      class="toast align-items-center text-bg-dark border-0"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div class="d-flex">
        <div class="toast-body" id="toast-body" style="color: var(--text);"></div>
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
    </div>
  </div>

  <!-- ===================== Dark/Light Toggle Button ===================== -->
  <div class="theme-toggle-btn" id="theme-toggle-btn">
    <i class="bi bi-sun-fill" id="theme-icon"></i>
  </div>

  <!-- ===================== Bootstrap JS Bundle ===================== -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <script>
    // -----------------------------------------
    // GLOBAL VARIABLES & UTILITY FUNCTIONS
    // -----------------------------------------
    let currentUser = null;
    let currentUserId = null;
    const supabase = supabaseClient;

    // Show a Bootstrap Toast message
    function showToast(message) {
      const toastEl = document.getElementById('liveToast');
      document.getElementById('toast-body').textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    // Copy text to clipboard with feedback
    function copyTextToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showToast('Copied to clipboard'))
        .catch(() => showToast('Copy failed'));
    }

    // Generate a random 8-character alphanumeric referral code
    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Convert a number to USD currency string
    function toUSD(value) {
      return parseFloat(value).toLocaleString(undefined, {
        style: 'currency',
        currency: 'USD',
      });
    }

    // Format number as NGN currency string
    function toNGN(value) {
      return parseFloat(value).toLocaleString('en-NG', {
        style: 'currency',
        currency: 'NGN',
      });
    }

    // Format number for EUR, GBP, BTC
    function toCurrency(value, curr) {
      if (curr === 'BTC') {
        return parseFloat(value).toFixed(8) + ' BTC';
      }
      return parseFloat(value).toLocaleString(undefined, {
        style: 'currency',
        currency: curr,
      });
    }

    // Helper to get CSS variable value
    function varGet(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name);
    }

    // ON DOM CONTENT LOADED: Fetch user, then initialize all sections
    document.addEventListener('DOMContentLoaded', async () => {
      // FETCH CURRENT USER & IDs
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr || !user) {
        window.location.replace('affiliate_login.html');
        return;
      }
      currentUser = user;
      currentUserId = user.id;

      // DISPLAY USER PROFILE (email, joined date)
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('joined-date').textContent =
        new Date(user.created_at).toLocaleDateString();

      // FETCH & DISPLAY REFERRAL CODE + LINK
      await fetchReferralCode();

      // FETCH & DISPLAY TOTAL REFERRALS (for overview & profile)
      await fetchTotalReferrals();

      // CALCULATE & DISPLAY ESTIMATED EARNINGS (USD)
      calculateAndDisplayUSDEarnings();

      // FETCH & DISPLAY CONVERSION RATE (overview & inline)
      await fetchConversionRate();

      // SETUP LOGOUT BUTTON
      document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'affiliate_login.html';
      });

      // COPY REFERRAL CODE & LINK
      document.getElementById('copy-referral').addEventListener('click', () => {
        const code = document.getElementById('referral-code').textContent;
        if (code && code !== '‚Äî') copyTextToClipboard(code);
      });
      document.getElementById('copy-link').addEventListener('click', () => {
        const link = document.getElementById('referral-link').value;
        if (link) copyTextToClipboard(link);
      });

      // LOAD BANK ACCOUNTS
      await loadBankAccounts();

      // LOAD CRYPTO WALLETS
      await loadWallets();

      // SETUP ADD BANK ACCOUNT Form Handler
      document.getElementById('bank-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bankName = document.getElementById('bank-name').value.trim();
        const bankCode = document.getElementById('bank-code').value.trim();
        const accountNumber = document.getElementById('account-number').value.trim();
        const accountName = document.getElementById('account-name').value.trim();
        if (!bankName || !bankCode || !accountNumber || !accountName) {
          showToast('Please fill in all bank fields.');
          return;
        }
        const bankBtn = document.getElementById('add-bank-btn');
        const bankText = document.getElementById('bank-btn-text');
        const bankSpinner = document.getElementById('bank-spinner');
        bankBtn.setAttribute('disabled', true);
        bankText.textContent = 'Adding‚Ä¶';
        bankSpinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_bank_accounts')
            .insert([{
              user_id: currentUserId,
              bank_name: bankName,
              bank_code: bankCode,
              account_number: accountNumber,
              account_name: accountName
            }]);
          if (error) throw error;
          showToast('Bank account added!');
          document.getElementById('bank-form').reset();
          await loadBankAccounts();
        } catch (err) {
          console.error('Bank insert error:', err);
          showToast('Failed to add bank account.');
        } finally {
          bankBtn.removeAttribute('disabled');
          bankText.textContent = 'Add Account';
          bankSpinner.style.display = 'none';
        }
      });

      // SETUP ADD WALLET Form Handler
      document.getElementById('wallet-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currency = document.getElementById('crypto-currency').value;
        const address = document.getElementById('crypto-address').value.trim();
        if (!currency || !address) {
          showToast('Please select currency and enter address.');
          return;
        }
        const walletBtn = document.getElementById('add-wallet-btn');
        const walletText = document.getElementById('wallet-btn-text');
        const walletSpinner = document.getElementById('wallet-spinner');
        walletBtn.setAttribute('disabled', true);
        walletText.textContent = 'Adding‚Ä¶';
        walletSpinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_wallets')
            .insert([{
              user_id: currentUserId,
              currency: currency,
              address: address
            }]);
          if (error) throw error;
          showToast('Wallet added!');
          document.getElementById('wallet-form').reset();
          await loadWallets();
        } catch (err) {
          console.error('Wallet insert error:', err);
          showToast('Failed to add wallet.');
        } finally {
          walletBtn.removeAttribute('disabled');
          walletText.textContent = 'Add Wallet';
          walletSpinner.style.display = 'none';
        }
      });

      // SETUP CONVERTER Form Handler
      document.getElementById('converter-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const from = document.getElementById('convert-from').value;
        const to = document.getElementById('convert-to').value;
        const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
        const convertText = document.getElementById('convert-text');
        const convertSpinner = document.getElementById('convert-spinner');
        convertText.textContent = 'Converting‚Ä¶';
        convertSpinner.style.display = 'inline-block';
        try {
          const response = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/${from}`);
          const data = await response.json();
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          const rate = data.conversion_rates[to];
          if (!rate) {
            showToast(`Rate ${from}‚Üí${to} not available.`);
            document.getElementById('convert-result').textContent = '--';
          } else {
            const converted = (amount * rate).toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 8
            });
            document.getElementById('convert-result').textContent = `${amount} ${from} = ${converted} ${to}`;
          }
        } catch (err) {
          console.error('Conversion error:', err);
          showToast('Currency conversion failed.');
          document.getElementById('convert-result').textContent = '--';
        } finally {
          convertText.textContent = 'Convert';
          convertSpinner.style.display = 'none';
        }
      });

      // SETUP REQUEST WITHDRAWAL Handler
      document.getElementById('request-withdraw-btn').addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const method = document.getElementById('withdraw-method').value;
        if (!amount || amount <= 0) {
          showToast('Enter a valid withdrawal amount.');
          return;
        }
        if (!method) {
          showToast('Select payout method.');
          return;
        }
        const btnText = document.getElementById('withdraw-btn-text');
        const spinner = document.getElementById('withdraw-spinner');
        btnText.textContent = 'Requesting‚Ä¶';
        spinner.style.display = 'inline-block';
        try {
          // Insert into a new table affiliate_payouts (assumes it exists):
          const { error } = await supabase
            .from('affiliate_payouts')
            .insert([{
              user_id: currentUserId,
              amount: amount,
              method: method,
              status: 'pending',
              requested_at: new Date()
            }]);
          if (error) throw error;
          showToast('Payout requested successfully.');
          document.getElementById('withdraw-amount').value = '';
          document.getElementById('withdraw-method').value = '';
          await loadPayouts();
        } catch (err) {
          console.error('Payout request error:', err);
          showToast('Failed to request payout.');
        } finally {
          btnText.textContent = 'Request Payout';
          spinner.style.display = 'none';
        }
      });

      // LOAD INITIAL SECTIONS
      await loadBankAccounts();
      await loadWallets();
      await loadPayouts();
      await renderReferralChart();
      await loadLeaderboard();

      // SETUP DARK/LIGHT TOGGLE
      setupThemeToggle();

      // SETUP SIDEBAR TOGGLE
      setupSidebarToggle();
    });

    // -----------------------------------------
    // FETCH OR GENERATE REFERRAL CODE & SET LINK + QR
    // -----------------------------------------
    async function fetchReferralCode() {
      const refSpan = document.getElementById('referral-code');
      const linkInput = document.getElementById('referral-link');
      refSpan.textContent = 'Loading‚Ä¶';

      // 1) Try to load existing code
      const { data, error } = await supabase
        .from('affiliates')
        .select('referral_code')
        .eq('user_id', currentUserId)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error('Failed to load affiliate data:', error);
        refSpan.textContent = '‚Äî';
        linkInput.value = '';
        return;
      }

      let code;
      if (!data) {
        // 2) No existing affiliate row ‚Üí generate a new code
        code = generateReferralCode();
        try {
          const { data: inserted, error: insertErr } = await supabase
            .from('affiliates')
            .insert([{ user_id: currentUserId, referral_code: code }])
            .select('referral_code')
            .single();
          if (insertErr) throw insertErr;
          code = inserted.referral_code;
        } catch (err) {
          console.error('Error creating new affiliate row:', err);
          refSpan.textContent = '‚Äî';
          linkInput.value = '';
          return;
        }
      } else {
        code = data.referral_code;
      }

      // 3) Show code + link + QR after ensuring we have a valid code
      refSpan.textContent = code;
      const fullLink = `${window.location.origin}/CBE_apply.html?ref=${code}`;
      linkInput.value = fullLink;

      // Generate QR code using Google Chart API
      const qrContainer = document.getElementById('qr-code-container');
      qrContainer.innerHTML = ''; // clear previous
      const qrImg = document.createElement('img');
      qrImg.src = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${encodeURIComponent(fullLink)}`;
      qrImg.alt = 'Referral QR Code';
      qrContainer.appendChild(qrImg);
    }

    // -----------------------------------------
    // FETCH TOTAL REFERRALS (for overview & profile)
    // -----------------------------------------
    async function fetchTotalReferrals() {
      const { count, error } = await supabase
        .from('users')
        .select('*', { count: 'exact', head: true })
        .eq('referred_by', currentUserId);

      if (error) {
        console.error('Failed to fetch total referrals:', error);
        document.getElementById('total-referrals').textContent = '‚Äî';
        document.getElementById('overview-total-referrals').textContent = '‚Äî';
      } else {
        const total = count || 0;
        document.getElementById('total-referrals').textContent = total;
        document.getElementById('overview-total-referrals').textContent = total;
      }
    }

    // -----------------------------------------
    // CALCULATE & DISPLAY ESTIMATED EARNINGS (USD)
    // -----------------------------------------
    function calculateAndDisplayUSDEarnings() {
      const totalRefs = parseInt(document.getElementById('overview-total-referrals').textContent) || 0;
      const usdEarnings = totalRefs * 5;
      document.getElementById('overview-est-earn-usd').textContent = toUSD(usdEarnings);
      document.getElementById('overview-est-earn-usd-inline').textContent = toUSD(usdEarnings);

      // Prepare the Convert Earnings button to know current USD earnings
      window.currentEarningsUSD = usdEarnings; 
    }

    // -----------------------------------------
    // FETCH CONVERSION RATE & DISPLAY (overview & inline)
    // -----------------------------------------
    async function fetchConversionRate() {
      const { count: totalRefCount, error: totErr } = await supabase
        .from('users')
        .select('*', { count: 'exact', head: true })
        .eq('referred_by', currentUserId);

      const { count: convertedCount, error: convErr } = await supabase
        .from('users')
        .select('converted', { count: 'exact', head: true })
        .eq('referred_by', currentUserId)
        .eq('converted', true);

      let rateText = '0%';
      if (!totErr && !convErr && totalRefCount > 0) {
        const conversionRate = ((convertedCount / totalRefCount) * 100).toFixed(2);
        rateText = `${conversionRate}%`;
      }
      document.getElementById('overview-conversion-rate').textContent = rateText;
      document.getElementById('overview-conversion-rate-inline').textContent = rateText;
    }

    // -----------------------------------------
    // LOAD BANK ACCOUNTS: Fetch & Render
    // -----------------------------------------
    async function loadBankAccounts() {
      const tbody = document.getElementById('bank-accounts-body');
      tbody.innerHTML = `<tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr>`;

      const { data, error } = await supabase
        .from('affiliate_bank_accounts')
        .select('*')
        .eq('user_id', currentUserId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Fetch bank accounts error:', error);
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--gold);">Failed to load bank accounts.</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--text);">No bank accounts added yet.</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      data.forEach((acct) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${acct.bank_name}</td>
          <td>${acct.bank_code}</td>
          <td>${acct.account_number}</td>
          <td>${acct.account_name}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteBankAccount('${acct.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // -----------------------------------------
    // DELETE BANK ACCOUNT
    // -----------------------------------------
    async function deleteBankAccount(id) {
      if (!confirm('Delete this bank account?')) return;
      const { error } = await supabase
        .from('affiliate_bank_accounts')
        .delete()
        .eq('id', id);
      if (error) {
        console.error('Delete bank error:', error);
        showToast('Failed to delete bank account.');
      } else {
        showToast('Bank account deleted.');
        await loadBankAccounts();
      }
    }

    // -----------------------------------------
    // LOAD CRYPTO WALLETS: Fetch & Render
    // -----------------------------------------
    async function loadWallets() {
      const tbody = document.getElementById('wallets-body');
      tbody.innerHTML = `<tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr>`;

      const { data, error } = await supabase
        .from('affiliate_wallets')
        .select('*')
        .eq('user_id', currentUserId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Fetch wallets error:', error);
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--gold);">Failed to load wallets.</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--text);">No wallets added yet.</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      data.forEach((w) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${w.currency}</td>
          <td>${w.address}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteWallet('${w.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // -----------------------------------------
    // DELETE WALLET
    // -----------------------------------------
    async function deleteWallet(id) {
      if (!confirm('Delete this wallet?')) return;
      const { error } = await supabase
        .from('affiliate_wallets')
        .delete()
        .eq('id', id);
      if (error) {
        console.error('Delete wallet error:', error);
        showToast('Failed to delete wallet.');
      } else {
        showToast('Wallet deleted.');
        await loadWallets();
      }
    }

    // -----------------------------------------
    // LOAD PAYOUTS: Fetch & Render
    // -----------------------------------------
    async function loadPayouts() {
      const listEl = document.getElementById('withdrawals-list');
      listEl.innerHTML = `<li class="text-center"><div class="spinner-border"></div></li>`;

      const { data, error } = await supabase
        .from('affiliate_payouts')
        .select('*')
        .eq('user_id', currentUserId)
        .order('requested_at', { ascending: false });

      if (error) {
        console.error('Fetch payouts error:', error);
        listEl.innerHTML = `<li style="color: var(--gold);">Failed to load payouts.</li>`;
        return;
      }
      if (!data || data.length === 0) {
        listEl.innerHTML = `<li style="color: var(--text);">No payout history.</li>`;
        return;
      }

      listEl.innerHTML = '';
      data.forEach((p) => {
        const li = document.createElement('li');
        const date = new Date(p.requested_at).toLocaleDateString();
        li.className = 'withdraw-item';
        li.innerHTML = `
          <div>
            <strong>${toUSD(p.amount)}</strong> via <em>${p.method.toUpperCase()}</em><br/>
            <small>${date}</small>
          </div>
          <div class="withdraw-status ${
            p.status === 'completed' ? 'text-success' : 'text-warning'
          }">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</div>
        `;
        listEl.appendChild(li);
      });
    }

    // -----------------------------------------
    // RENDER REFERRAL CHART
    // -----------------------------------------
    async function renderReferralChart() {
      // Fetch referral counts grouped by date, last 30 days
      const { data, error } = await supabase.rpc('referrals_by_date', {
        p_user_id: currentUserId,
        p_days: 30
      });
      // Assumes a stored procedure 'referrals_by_date' that returns [{ date, count }]
      // If no such RPC, fallback to client grouping:

      let labels = [];
      let counts = [];

      if (error || !data) {
        // Fallback: fetch raw users and manually group
        const { data: raw, error: rawErr } = await supabase
          .from('users')
          .select('created_at')
          .eq('referred_by', currentUserId);
        if (rawErr) {
          console.error('Fallback referrals fetch error:', rawErr);
          labels = [];
          counts = [];
        } else {
          // Build a date ‚Üí count map for last 30 days
          const map = {};
          const now = new Date();
          for (let i = 29; i >= 0; i--) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            const key = d.toISOString().split('T')[0];
            map[key] = 0;
          }
          raw.forEach((u) => {
            const dKey = new Date(u.created_at).toISOString().split('T')[0];
            if (map[dKey] !== undefined) map[dKey]++;
          });
          labels = Object.keys(map);
          counts = Object.values(map);
        }
      } else {
        // Use RPC data directly
        data.sort((a, b) => new Date(a.date) - new Date(b.date));
        labels = data.map((row) => row.date);
        counts = data.map((row) => row.count);
      }

      const ctx = document.getElementById('referralChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'New Referrals',
              data: counts,
              backgroundColor: 'rgba(255, 215, 0, 0.3)',
              borderColor: 'rgba(255, 215, 0, 1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3,
            },
          ],
        },
        options: {
          scales: {
            x: {
              ticks: { color: varGet('--text') },
              grid: { color: varGet('--shadow') },
            },
            y: {
              ticks: { color: varGet('--text') },
              grid: { color: varGet('--shadow') },
            },
          },
          plugins: {
            legend: {
              labels: { color: varGet('--text') },
            },
          },
          maintainAspectRatio: false,
        },
      });
    }

    // -----------------------------------------
    // LOAD LEADERBOARD: Top Affiliates by Referrals
    // -----------------------------------------
    async function loadLeaderboard() {
      // Query top affiliates by count of referrals
      const { data, error } = await supabase
        .from('users')
        .select('referred_by ( referral_code ), id', { count: 'exact' })
        .neq('referred_by', null);

      if (error) {
        console.error('Leaderboard fetch error:', error);
        document.getElementById('leaderboard-list').innerHTML =
          `<li style="color: var(--gold);">Failed to load leaderboard.</li>`;
        return;
      }

      // Build map: affiliate_user_id ‚Üí count
      const map = {};
      data.forEach((u) => {
        const affId = u.referred_by;
        if (!map[affId]) map[affId] = 0;
        map[affId]++;
      });

      // Convert map to array of { user_id, count }, sort descending
      const arr = Object.entries(map).map(([userId, cnt]) => ({ userId, cnt }));
      arr.sort((a, b) => b.cnt - a.cnt);

      // Take top 5
      const top5 = arr.slice(0, 5);

      // For each, fetch affiliate‚Äôs referral_code and email
      const listEl = document.getElementById('leaderboard-list');
      listEl.innerHTML = '';
      if (top5.length === 0) {
        listEl.innerHTML = `<li style="color: var(--text);">No referrals yet.</li>`;
        return;
      }
      for (const item of top5) {
        const { data: affiliateData, error: affErr } = await supabase
          .from('affiliates')
          .select('referral_code')
          .eq('user_id', item.userId)
          .single();
        const { data: userData, error: userErr } = await supabase
          .from('users')
          .select('email')
          .eq('id', item.userId)
          .single();
        const code = (!affErr && affiliateData) ? affiliateData.referral_code : '(unknown)';
        const email = (!userErr && userData) ? userData.email : '(unknown)';
        const li = document.createElement('li');
        li.className = 'leaderboard-item';
        li.innerHTML = `
          <div class="leader-name">${email} <small style="color: var(--text-light);">(${code})</small></div>
          <div class="leader-count">${item.cnt}</div>
        `;
        listEl.appendChild(li);
      }
    }

    // -----------------------------------------
    // THEME TOGGLE: Dark ‚Üî Light
    // -----------------------------------------
    function setupThemeToggle() {
      const btn = document.getElementById('theme-toggle-btn');
      const icon = document.getElementById('theme-icon');
      // Initialize from localStorage (or default dark)
      const saved = localStorage.getItem('dashboardTheme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      icon.className = saved === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';

      btn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('dashboardTheme', next);
        icon.className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
      });
    }

    // -----------------------------------------
    // SIDEBAR TOGGLE
    // -----------------------------------------
    function setupSidebarToggle() {
      const toggleBtn = document.getElementById('sidebar-toggle');
      const sidebar = document.getElementById('sidebar');
      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('expanded');
      });
    }

    // -----------------------------------------
    // LIVE ‚ÄúConvert Earnings‚Äù BUTTON
    // -----------------------------------------
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'convert-earn-btn') {
        const targetCurr = document.getElementById('convert-target-currency').value;
        const usdAmount = window.currentEarningsUSD || 0;
        if (usdAmount <= 0) {
          showToast('You have no earnings to convert.');
          return;
        }
        const resultEl = document.getElementById('convert-earn-result');
        resultEl.textContent = 'Converting‚Ä¶';
        try {
          // If target is USD, just show USD
          if (targetCurr === 'USD') {
            resultEl.textContent = toUSD(usdAmount);
            return;
          }
          const response = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/USD`);
          const data = await response.json();
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          const rate = data.conversion_rates[targetCurr];
          if (!rate) {
            showToast(`Rate USD‚Üí${targetCurr} not available.`);
            resultEl.textContent = '--';
          } else {
            const converted = usdAmount * rate;
            resultEl.textContent = toCurrency(converted, targetCurr);
          }
        } catch (err) {
          console.error('Convert earnings error:', err);
          showToast('Conversion failed.');
          resultEl.textContent = '--';
        }
      }
    });
  </script>
</body>
</html>
