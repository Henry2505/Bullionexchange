<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard ‚Ä¢ Apex Income Options</title>

  <!-- Dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Custom Styles -->
  <style>
    :root {
      --background: #000000; /* Black background */
      --accent: #FFD700; /* Gold accent */
      --text: #FFFFFF; /* Pure white text */
      --text-light: #F0F0F0; /* Brighter light gray for secondary text */
      --shadow: rgba(255, 215, 0, 0.1); /* Subtle gold shadow */
    }

    body {
      background-color: var(--background);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Improved text visibility */
    .text-white {
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }

    .sidebar {
      background-color: var(--background);
      color: var(--text);
      height: 100vh;
      position: fixed;
      width: 250px;
      transform: translateX(-250px);
      transition: transform 0.3s ease;
    }

    .sidebar.expanded {
      transform: translateX(0);
    }

    .main-content {
      background-color: var(--background);
      margin-left: 0;
      transition: margin-left 0.3s ease;
    }

    .sidebar.expanded ~ .main-content {
      margin-left: 250px;
    }

    .card {
      background-color: var(--background);
      border: 1px solid var(--accent);
    }

    .card-header {
      background-color: var(--accent);
      color: var(--background);
    }

    .btn-primary {
      background-color: var(--accent);
      border-color: var(--accent);
      color: var(--background);
    }

    .btn-outline-secondary {
      color: var(--accent);
      border-color: var(--accent);
    }

    .nav-link {
      color: var(--text);
    }

    .nav-link:hover {
      color: var(--accent);
    }

    .section-title {
      color: var(--accent);
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .overview-card {
      background-color: var(--background);
      border: 1px solid var(--accent);
      padding: 1rem;
      text-align: center;
    }

    .earn-banner {
      background-color: var(--accent);
      color: var(--background);
      padding: 0.5rem;
    }

    .container-fluid {
      padding: 20px;
    }

    .chart-container {
      background-color: var(--background);
      border: 1px solid var(--accent);
      padding: 10px;
    }

    .table {
      color: var(--text);
    }

    .table thead th {
      background-color: var(--accent);
      color: var(--background);
    }

    .form-control, .form-select {
      background-color: var(--background);
      color: var(--text);
      border: 1px solid var(--accent);
    }

    .text-muted {
      color: var(--text-light) !important;
    }

    .spinner-border {
      color: var(--accent);
    }

    .toast {
      background-color: var(--background);
      color: var(--text);
      border: 1px solid var(--accent);
    }

    /* Improved Sidebar Toggle Button */
    #sidebar-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      background-color: var(--accent);
      color: var(--background);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      transition: background-color 0.3s ease;
    }

    #sidebar-toggle:hover {
      background-color: #E5C200; /* Slightly darker gold on hover */
    }

    /* QR Code Styling */
    .qr-code {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #FFFFFF; /* White background for contrast */
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--accent);
      max-width: 220px; /* Constrain for small screens */
      margin: 0 auto;
    }

    .qr-code canvas, .qr-code img {
      max-width: 100%;
      height: auto;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
      }
      .qr-code {
        max-width: 180px; /* Smaller on mobile */
      }
    }
  </style>
</head>
<body>
  <!-- Auth Guard -->
  <script>
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabaseClient = window.supabase.createClient(SUPA_URL, SUPA_KEY);
    const affiliateId = localStorage.getItem('affiliateId');
    if (!affiliateId) {
      window.location.replace('affiliate_login.html');
      throw new Error('No affiliateId in localStorage');
    }
  </script>

  <!-- Sidebar Toggle -->
  <div id="sidebar-toggle" title="Toggle Menu">
    <i class="bi bi-list"></i>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="px-3 pb-3">
      <h4 class="sidebar-title">Affiliate Dashboard</h4>
    </div>
    <nav class="nav flex-column px-3 pb-3">
      <a class="nav-link active" href="#overview-section">üè† Overview</a>
      <a class="nav-link" href="#referral-section-main">üóÇÔ∏è Referral Dashboard</a>
      <a class="nav-link" href="#referral-activity-section">üìà Referral Activity</a>
      <a class="nav-link" href="#leaderboard-section">üèÜ Leaderboard</a>
      <a class="nav-link" href="#bank-accounts-section">üè¶ Bank Accounts</a>
      <a class="nav-link" href="#crypto-wallets-section">üí∞ Crypto Wallets</a>
      <a class="nav-link" href="#currency-converter-section">üí± Converter</a>
      <a class="nav-link" href="#withdrawals-section">üíµ Payouts</a>
      <a class="nav-link" href="#profile-section">üë§ Profile</a>
      <button id="logout-btn" class="btn btn-outline-danger mt-3 w-100">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <div class="container-fluid">
      <!-- Date and Time -->
      <div id="date-time" class="text-center mb-3 text-white"></div>

      <!-- Referral Dashboard -->
      <section id="referral-section-main" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-people-fill"></i> Your Referral Dashboard</div>
        <div class="row g-3">
          <div class="col-lg-4 col-md-6">
            <div class="card text-center">
              <div class="card-header"><i class="bi bi-people-fill"></i> Referral Code</div>
              <div class="card-body">
                <h5 id="referral-code" class="mb-2 text-white">Loading‚Ä¶</h5>
                <button id="copy-referral" class="btn btn-primary btn-sm mb-2"><i class="bi bi-clipboard"></i> Copy Code</button>
                <div class="mt-2">
                  <small class="text-white">Share your link:</small><br />
                  <input type="text" id="referral-link" readonly class="form-control form-control-sm text-center text-white" />
                  <button id="copy-link" class="btn btn-primary btn-sm mt-1"><i class="bi bi-link-45deg"></i> Copy Link</button>
                </div>
                <div class="earn-banner mt-3">üéâ Earn <strong>$5</strong> per successful referral!</div>
                <div class="qr-code mt-3" id="qr-code-container"></div>
                <button id="download-qr" class="btn btn-primary btn-sm mt-2"><i class="bi bi-download"></i> Download QR Code</button>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <div class="card">
              <div class="card-header"><i class="bi bi-cash-stack"></i> Earnings Summary</div>
              <div class="card-body text-white">
                <div class="mb-3"><div class="title">Weekly Earnings</div><div class="value" id="weekly-earnings">$0.00</div></div>
                <div class="mb-3"><div class="title">Monthly Earnings</div><div class="value" id="monthly-earnings">$0.00</div></div>
                <div><div class="title">All-Time Earnings</div><div class="value" id="alltime-earnings">$0.00</div></div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-12">
            <div class="card text-center">
              <div class="card-header"><i class="bi bi-arrow-repeat"></i> Convert Earnings</div>
              <div class="card-body">
                <select id="convert-target-currency" class="form-select form-select-sm mb-2 text-white">
                  <option value="NGN" selected>NGN</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="BTC">BTC</option>
                  <option value="USD">USD</option>
                </select>
                <button id="convert-earn-btn" class="btn btn-primary btn-sm mb-2">Convert</button>
                <div><span id="convert-earn-result" class="text-light">--</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Overview -->
      <section id="overview-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-speedometer2"></i> Overview</div>
        <div class="row g-3">
          <div class="col-md-4"><div class="overview-card text-white"><div class="title">Total Referrals</div><div class="value" id="overview-total-referrals">0</div></div></div>
          <div class="col-md-4"><div class="overview-card text-white"><div class="title">Est. Earnings (USD)</div><div class="value" id="overview-est-earn-usd">$0.00</div></div></div>
          <div class="col-md-4"><div class="overview-card text-white"><div class="title">Conversion Rate</div><div class="value" id="overview-conversion-rate">0%</div></div></div>
        </div>
      </section>

      <!-- Referral Activity -->
      <section id="referral-activity-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="section-title text-white"><i class="bi bi-graph-up"></i> Referral Activity</div>
          <button id="toggle-referral-range" class="btn btn-outline-secondary btn-sm text-white">Show All Time</button>
        </div>
        <div class="chart-container"><canvas id="referralChart" height="100"></canvas></div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboard-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-trophy-fill"></i> Leaderboard: Top Affiliates</div>
        <ul class="leaderboard-list list-unstyled text-white" id="leaderboard-list">
          <li class="text-center text-muted">Loading leaderboard‚Ä¶</li>
        </ul>
      </section>

      <!-- Bank Accounts -->
      <section id="bank-accounts-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-bank2"></i> Manage Bank Accounts</div>
        <div class="card mb-3">
          <div class="card-header"><i class="bi bi-plus-circle"></i> Add New Bank Account</div>
          <div class="card-body">
            <form id="bank-form" class="row g-3">
              <div class="col-md-6"><label for="bank-name" class="form-label text-white">Bank Name</label><input type="text" id="bank-name" class="form-control" placeholder="e.g. First Bank" required /></div>
              <div class="col-md-6"><label for="bank-code" class="form-label text-white">Bank Code/Branch</label><input type="text" id="bank-code" class="form-control" placeholder="e.g. 011" required /></div>
              <div class="col-md-6"><label for="account-number" class="form-label text-white">Account Number</label><input type="text" id="account-number" class="form-control" placeholder="e.g. 0123456789" required /></div>
              <div class="col-md-6"><label for="account-name" class="form-label text-white">Account Name</label><input type="text" id="account-name" class="form-control" placeholder="e.g. John Doe" required /></div>
              <div class="col-12 text-end"><button type="submit" class="btn btn-primary" id="add-bank-btn"><span id="bank-btn-text">Add Account</span><span id="bank-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><i class="bi bi-file-earmark-text"></i> Your Saved Bank Accounts</div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle text-center mb-0 text-white"><thead><tr><th>Bank Name</th><th>Bank Code</th><th>Account Number</th><th>Account Name</th><th>Action</th></tr></thead><tbody id="bank-accounts-body"><tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr></tbody></table></div></div>
        </div>
      </section>

      <!-- Crypto Wallets -->
      <section id="crypto-wallets-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-currency-bitcoin"></i> Manage Crypto Wallets</div>
        <div class="card mb-3">
          <div class="card-header"><i class="bi bi-plus-circle"></i> Add New Crypto Wallet</div>
          <div class="card-body">
            <form id="wallet-form" class="row g-3">
              <div class="col-md-6"><label for="crypto-currency" class="form-label text-white">Currency</label><select id="crypto-currency" class="form-select" required><option value="">Select Currency</option><option value="BTC">Bitcoin (BTC)</option><option value="ETH">Ethereum (ETH)</option><option value="USDT">Tether (USDT)</option><option value="BCH">Bitcoin Cash (BCH)</option><option value="LTC">Litecoin (LTC)</option></select></div>
              <div class="col-md-6"><label for="crypto-address" class="form-label text-white">Wallet Address</label><input type="text" id="crypto-address" class="form-control" placeholder="e.g. 1BoatSLRHtKNngkdXEeobR76b53LETtpyT" required /></div>
              <div class="col-12 text-end"><button type="submit" class="btn btn-primary" id="add-wallet-btn"><span id="wallet-btn-text">Add Wallet</span><span id="wallet-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><i class="bi bi-wallet-fill"></i> Your Saved Crypto Wallets</div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle text-center mb-0 text-white"><thead><tr><th>Currency</th><th>Wallet Address</th><th>Action</th></tr></thead><tbody id="wallets-body"><tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr></tbody></table></div></div>
        </div>
      </section>

      <!-- Currency Converter -->
      <section id="currency-converter-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-currency-exchange"></i> Currency Converter</div>
        <div class="card">
          <div class="card-header"><i class="bi bi-arrow-left-right"></i> Convert Between Currencies</div>
          <div class="card-body">
            <form id="converter-form" class="row g-3 align-items-end">
              <div class="col-md-3"><label for="convert-from" class="form-label text-white">From</label><select id="convert-from" class="form-select text-white"><option value="USD" selected>USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="NGN">NGN</option><option value="BTC">BTC</option></select></div>
              <div class="col-md-3"><label for="convert-to" class="form-label text-white">To</label><select id="convert-to" class="form-select text-white"><option value="NGN" selected>NGN</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="BTC">BTC</option></select></div>
              <div class="col-md-3"><label for="convert-amount" class="form-label text-white">Amount</label><input type="number" id="convert-amount" class="form-control text-white" value="1" min="0" /></div>
              <div class="col-md-3 text-end"><button type="submit" class="btn btn-primary" id="convert-btn"><span id="convert-text">Convert</span><span id="convert-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
              <div class="col-12 text-center mt-3"><h5 id="convert-result" class="text-white">--</h5></div>
            </form>
          </div>
        </div>
      </section>

      <!-- Payout Requests -->
      <section id="withdrawals-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-cash-stack"></i> Payout Requests</div>
        <div class="card mb-3">
          <div class="card-body">
            <div class="mb-2 text-white" style="font-size: 0.95rem; color: var(--text-light);">You earn <strong>$5</strong> per referral. Request in USD, NGN, or crypto.</div>
            <div class="row g-3">
              <div class="col-md-4"><label for="withdraw-amount" class="form-label text-white">Request Amount (USD)</label><input type="number" id="withdraw-amount" class="form-control text-white" placeholder="e.g. 100.00" min="1" step="0.01" /></div>
              <div class="col-md-4"><label for="withdraw-method" class="form-label text-white">Payout Method</label><select id="withdraw-method" class="form-select text-white"><option value="">Select Method</option><option value="bank">Bank Transfer</option><option value="crypto">Crypto Wallet</option><option value="ngn">Naira (NGN Bank)</option></select></div>
              <div class="col-md-4 align-self-end text-end"><button id="request-withdraw-btn" class="btn btn-primary"><span id="withdraw-btn-text">Request Payout</span><span id="withdraw-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><i class="bi bi-list-check"></i> Past Payouts</div>
          <div class="card-body"><ul class="list-unstyled text-white" id="withdrawals-list"><li class="text-center text-muted">Loading payout history‚Ä¶</li></ul></div>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile-section" class="mb-5">
        <div class="section-title text-white"><i class="bi bi-person-circle"></i> Your Profile</div>
        <div class="card">
          <div class="card-body text-white">
            <p><strong>Email:</strong> <span id="user-email">Loading‚Ä¶</span></p>
            <p><strong>Joined On:</strong> <span id="joined-date">--</span></p>
            <p><strong>Total Referrals:</strong> <span id="total-referrals">0</span></p>
            <p><strong>Est. Earnings (USD):</strong> <span id="overview-est-earn-usd-inline">$0.00</span></p>
            <p><strong>Conversion Rate:</strong> <span id="overview-conversion-rate-inline">0%</span></p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body text-white" id="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- JavaScript -->
  <script>
    const supabase = supabaseClient;
    let referralChart = null;
    let chartDataAllTime = { labels: [], counts: [] };
    let chartData30Days = { labels: [], counts: [] };

    function showToast(message) {
      const toastEl = document.getElementById('liveToast');
      document.getElementById('toast-body').textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    function copyTextToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard')).catch(() => showToast('Copy failed'));
    }

    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';  // drop lowercase altogether
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;  // already uppercase
    }

    function toUSD(value) {
      return parseFloat(value).toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    function toCurrency(value, curr) {
      if (curr === 'BTC') return parseFloat(value).toFixed(8) + ' BTC';
      return parseFloat(value).toLocaleString(undefined, { style: 'currency', currency: curr });
    }

    function getDateNDaysAgo(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return d;
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('date-time').textContent = now.toLocaleString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', timeZoneName: 'short'
      });
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: affiliate, error } = await supabase.from('affiliate_accounts').select('email, created_at').eq('id', affiliateId).single();
      if (error || !affiliate) {
        window.location.replace('affiliate_login.html');
        return;
      }
      document.getElementById('user-email').textContent = affiliate.email;
      document.getElementById('joined-date').textContent = new Date(affiliate.created_at).toLocaleDateString();

      await fetchReferralCode();
      await fetchTotalReferrals();
      await calculateAndDisplayEarnings();
      await fetchConversionRate();
      await loadBankAccounts();
      await loadWallets();
      await loadPayouts();
      await loadReferralChartData();
      await renderReferralChart('30days');
      await loadLeaderboard();

      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('affiliateId');
        window.location.href = 'affiliate_login.html';
      });

      document.getElementById('copy-referral').addEventListener('click', () => copyTextToClipboard(document.getElementById('referral-code').textContent));
      document.getElementById('copy-link').addEventListener('click', () => copyTextToClipboard(document.getElementById('referral-link').value));

      document.getElementById('download-qr').addEventListener('click', () => {
        const qrCanvas = document.querySelector('#qr-code-container canvas');
        if (!qrCanvas) return showToast('QR code not available.');
        const link = document.createElement('a');
        link.href = qrCanvas.toDataURL('image/png');
        link.download = `referral-qr-${document.getElementById('referral-code').textContent}.png`;
        link.click();
        showToast('QR code downloaded.');
      });

      document.getElementById('bank-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bankName = document.getElementById('bank-name').value.trim();
        const bankCode = document.getElementById('bank-code').value.trim();
        const accountNumber = document.getElementById('account-number').value.trim();
        const accountName = document.getElementById('account-name').value.trim();
        if (!bankName || !bankCode || !accountNumber || !accountName) return showToast('Please fill in all bank fields.');
        const btn = document.getElementById('add-bank-btn');
        btn.disabled = true;
        document.getElementById('bank-btn-text').textContent = 'Adding‚Ä¶';
        document.getElementById('bank-spinner').style.display = 'inline-block';
        try {
          const { error } = await supabase.from('affiliate_bank_accounts').insert([{ affiliate_id: affiliateId, bank_name: bankName, bank_code: bankCode, account_number: accountNumber, account_name: accountName }]);
          if (error) throw error;
          showToast('Bank account added!');
          document.getElementById('bank-form').reset();
          await loadBankAccounts();
        } catch (err) {
          showToast('Failed to add bank account.');
        } finally {
          btn.disabled = false;
          document.getElementById('bank-btn-text').textContent = 'Add Account';
          document.getElementById('bank-spinner').style.display = 'none';
        }
      });

      document.getElementById('wallet-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currency = document.getElementById('crypto-currency').value;
        const address = document.getElementById('crypto-address').value.trim();
        if (!currency || !address) return showToast('Please select currency and enter address.');
        const btn = document.getElementById('add-wallet-btn');
        btn.disabled = true;
        document.getElementById('wallet-btn-text').textContent = 'Adding‚Ä¶';
        document.getElementById('wallet-spinner').style.display = 'inline-block';
        try {
          const { error } = await supabase.from('affiliate_wallets').insert([{ affiliate_id: affiliateId, currency, address }]);
          if (error) throw error;
          showToast('Wallet added!');
          document.getElementById('wallet-form').reset();
          await loadWallets();
        } catch (err) {
          showToast('Failed to add wallet.');
        } finally {
          btn.disabled = false;
          document.getElementById('wallet-btn-text').textContent = 'Add Wallet';
          document.getElementById('wallet-spinner').style.display = 'none';
        }
      });

      document.getElementById('converter-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const from = document.getElementById('convert-from').value;
        const to = document.getElementById('convert-to').value;
        const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
        document.getElementById('convert-text').textContent = 'Converting‚Ä¶';
        document.getElementById('convert-spinner').style.display = 'inline-block';
        try {
          const response = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/${from}`);
          const data = await response.json();
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          const rate = data.conversion_rates[to];
          if (!rate) {
            showToast(`Rate ${from}‚Üí${to} not available.`);
            document.getElementById('convert-result').textContent = '--';
          } else {
            const converted = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 });
            document.getElementById('convert-result').textContent = `${amount} ${from} = ${converted} ${to}`;
          }
        } catch (err) {
          showToast('Currency conversion failed.');
          document.getElementById('convert-result').textContent = '--';
        } finally {
          document.getElementById('convert-text').textContent = 'Convert';
          document.getElementById('convert-spinner').style.display = 'none';
        }
      });

      document.getElementById('request-withdraw-btn').addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const method = document.getElementById('withdraw-method').value;
        const currentBalance = window.currentEarningsUSD || 0;

        if (currentBalance <= 0) {
          showToast('No funds available for withdrawal.');
          return;
        }

        if (amount > currentBalance) {
          showToast(`Requested amount exceeds your balance of ${toUSD(currentBalance)}.`);
          return;
        }

        if (!amount || amount <= 0) {
          showToast('Enter a valid withdrawal amount.');
          return;
        }
        if (!method) {
          showToast('Select payout method.');
          return;
        }

        document.getElementById('withdraw-btn-text').textContent = 'Requesting‚Ä¶';
        document.getElementById('withdraw-spinner').style.display = 'inline-block';
        try {
          const { error } = await supabase.from('affiliate_payouts').insert([{ affiliate_id: affiliateId, amount, method, status: 'pending', requested_at: new Date() }]);
          if (error) throw error;
          showToast('Payout requested successfully.');
          document.getElementById('withdraw-amount').value = '';
          document.getElementById('withdraw-method').value = '';
          await loadPayouts();
        } catch (err) {
          showToast('Failed to request payout.');
        } finally {
          document.getElementById('withdraw-btn-text').textContent = 'Request Payout';
          document.getElementById('withdraw-spinner').style.display = 'none';
        }
      });

      document.getElementById('toggle-referral-range').addEventListener('click', () => {
        const btn = document.getElementById('toggle-referral-range');
        if (btn.textContent.includes('All Time')) {
          renderReferralChart('alltime');
          btn.textContent = 'Show Last 30 Days';
        } else {
          renderReferralChart('30days');
          btn.textContent = 'Show All Time';
        }
      });

      document.getElementById('convert-earn-btn').addEventListener('click', async () => {
        const targetCurr = document.getElementById('convert-target-currency').value;
        const usdAmount = window.currentEarningsUSD || 0;
        if (usdAmount <= 0) return showToast('No earnings to convert.');
        const resultEl = document.getElementById('convert-earn-result');
        resultEl.textContent = 'Converting‚Ä¶';
        try {
          if (targetCurr === 'USD') {
            resultEl.textContent = toUSD(usdAmount);
            return;
          }
          const resp = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/USD`);
          const data = await resp.json();
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          const rate = data.conversion_rates[targetCurr];
          if (!rate) {
            showToast(`Rate USD‚Üí${targetCurr} not available.`);
            resultEl.textContent = '--';
          } else {
            resultEl.textContent = toCurrency(usdAmount * rate, targetCurr);
          }
        } catch (err) {
          showToast('Conversion failed.');
          resultEl.textContent = '--';
        }
      });

      setupSidebarToggle();
    });

    async function fetchReferralCode() {
      const refSpan = document.getElementById('referral-code');
      const linkInput = document.getElementById('referral-link');
      const qrContainer = document.getElementById('qr-code-container');
      refSpan.textContent = 'Loading‚Ä¶';
      qrContainer.innerHTML = '<div class="text-muted">Generating QR code‚Ä¶</div>';

      try {
        const { data, error } = await supabase.from('affiliate_accounts').select('referral_code').eq('id', affiliateId).single();
        if (error) throw new Error('Failed to fetch referral code');

        let code = data?.referral_code;
        if (!code) {
          code = generateReferralCode();
          const { error: updateErr } = await supabase.from('affiliate_accounts').update({ referral_code: code }).eq('id', affiliateId);
          if (updateErr) throw new Error('Failed to generate referral code');
        }

        refSpan.textContent = code;
        const fullLink = `${window.location.origin}/CBE_apply.html?ref=${code}`;
        linkInput.value = fullLink;
        console.log('Referral Link:', fullLink); // Debug log

        qrContainer.innerHTML = ''; // Clear loading message
        const qr = document.createElement('div');
        qrContainer.appendChild(qr);

        new QRCode(qr, {
          text: fullLink,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#FFFFFF',
          correctLevel: QRCode.CorrectLevel.Q // 25% error correction
        });

        // Verify QR code rendering
        setTimeout(() => {
          if (!qr.querySelector('canvas')) {
            throw new Error('QR code failed to render');
          }
        }, 100);
      } catch (err) {
        console.error('QR Code Error:', err);
        refSpan.textContent = '‚Äî';
        qrContainer.innerHTML = '<div class="text-danger">Failed to generate QR code.</div>';
        showToast('Unable to load referral QR code. Please try again.');
      }
    }

    async function fetchTotalReferrals() {
      const { count, error } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId);
      if (error) {
        document.getElementById('total-referrals').textContent = '‚Äî';
        document.getElementById('overview-total-referrals').textContent = '‚Äî';
      } else {
        const total = count || 0;
        document.getElementById('total-referrals').textContent = total;
        document.getElementById('overview-total-referrals').textContent = total;
      }
    }

    async function calculateAndDisplayEarnings() {
      const totalRefs = parseInt(document.getElementById('overview-total-referrals').textContent) || 0;
      const usdEarnings = totalRefs * 5;
      document.getElementById('overview-est-earn-usd').textContent = toUSD(usdEarnings);
      document.getElementById('overview-est-earn-usd-inline').textContent = toUSD(usdEarnings);
      window.currentEarningsUSD = usdEarnings;
      document.getElementById('alltime-earnings').textContent = toUSD(usdEarnings);

      const { count: wCount } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId).gt('created_at', getDateNDaysAgo(7).toISOString());
      document.getElementById('weekly-earnings').textContent = toUSD((wCount || 0) * 5);

      const { count: mCount } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId).gt('created_at', getDateNDaysAgo(30).toISOString());
      document.getElementById('monthly-earnings').textContent = toUSD((mCount || 0) * 5);
    }

    async function fetchConversionRate() {
      const { count: totalRefCount } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId);
      const { count: convertedCount } = await supabase.from('referrals').select('converted', { count: 'exact', head: true }).eq('affiliate_id', affiliateId).eq('converted', true);
      const rateText = totalRefCount > 0 ? `${((convertedCount / totalRefCount) * 100).toFixed(2)}%` : '0%';
      document.getElementById('overview-conversion-rate').textContent = rateText;
      document.getElementById('overview-conversion-rate-inline').textContent = rateText;
    }

    async function loadReferralChartData() {
      const { data: rawReferrals, error } = await supabase.from('referrals').select('created_at').eq('affiliate_id', affiliateId);
      if (error) return;
      const allMap = {}, last30Map = {};
      rawReferrals.forEach(r => {
        const key = new Date(r.created_at).toISOString().split('T')[0];
        allMap[key] = (allMap[key] || 0) + 1;
        if (new Date(r.created_at) >= getDateNDaysAgo(30)) last30Map[key] = (last30Map[key] || 0) + 1;
      });
      chartDataAllTime.labels = Object.keys(allMap).sort((a, b) => new Date(a) - new Date(b));
      chartDataAllTime.counts = chartDataAllTime.labels.map(d => allMap[d]);
      chartData30Days.labels = Array.from({ length: 30 }, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (29 - i));
        return d.toISOString().split('T')[0];
      });
      chartData30Days.counts = chartData30Days.labels.map(k => last30Map[k] || 0);
    }

    async function renderReferralChart(range) {
      const ctx = document.getElementById('referralChart').getContext('2d');
      if (referralChart) referralChart.destroy();
      const src = range === 'alltime' ? chartDataAllTime : chartData30Days;
      referralChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: src.labels,
          datasets: [{ label: 'New Referrals', data: src.counts, backgroundColor: 'rgba(255,215,0,0.3)', borderColor: '#FFD700', borderWidth: 2, fill: true, tension: 0.3 }]
        },
        options: { scales: { x: { ticks: { color: '#FFFFFF' } }, y: { ticks: { color: '#FFFFFF' } } }, plugins: { legend: { labels: { color: '#FFFFFF' } } }, maintainAspectRatio: false }
      });
    }

    async function loadLeaderboard() {
      const listEl = document.getElementById('leaderboard-list');
      const { data: allReferred, error } = await supabase.from('referrals').select('affiliate_id');
      if (error) {
        listEl.innerHTML = `<li style="color: var(--accent);">Failed to load leaderboard.</li>`;
        return;
      }
      const map = {};
      allReferred.forEach(r => { if (r.affiliate_id) map[r.affiliate_id] = (map[r.affiliate_id] || 0) + 1; });
      const arr = Object.entries(map).map(([affiliateId, cnt]) => ({ affiliateId, cnt })).sort((a, b) => b.cnt - a.cnt).slice(0, 5);
      if (!arr.length) {
        listEl.innerHTML = `<li style="color: var(--text);">No referrals yet.</li>`;
        return;
      }
      listEl.innerHTML = '';
      for (const item of arr) {
        const { data: aData } = await supabase.from('affiliate_accounts').select('email, referral_code').eq('id', item.affiliateId).single();
        const li = document.createElement('li');
        li.className = 'd-flex justify-content-between text-white';
        li.innerHTML = `<span>${aData?.email || '(unknown)'} <small style="color: var(--text-light);">(${aData?.referral_code || '(unknown)'})</small></span><span>${item.cnt}</span>`;
        listEl.appendChild(li);
      }
    }

    async function loadBankAccounts() {
      const tbody = document.getElementById('bank-accounts-body');
      const { data, error } = await supabase.from('affiliate_bank_accounts').select('*').eq('affiliate_id', affiliateId).order('created_at', { ascending: false });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--accent);">Failed to load bank accounts.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.length ? data.map(acct => `
        <tr class="text-white">
          <td>${acct.bank_name}</td>
          <td>${acct.bank_code}</td>
          <td>${acct.account_number}</td>
          <td>${acct.account_name}</td>
          <td><button class="btn btn-outline-danger btn-sm" onclick="deleteBankAccount('${acct.id}')"><i class="bi bi-trash"></i></button></td>
        </tr>
      `).join('') : `<tr><td colspan="5" style="color: var(--text);">No bank accounts added yet.</td></tr>`;
    }

    async function deleteBankAccount(id) {
      if (!confirm('Delete this bank account?')) return;
      const { error } = await supabase.from('affiliate_bank_accounts').delete().eq('id', id);
      if (error) return showToast('Failed to delete bank account.');
      showToast('Bank account deleted.');
      await loadBankAccounts();
    }

    async function loadWallets() {
      const tbody = document.getElementById('wallets-body');
      const { data, error } = await supabase.from('affiliate_wallets').select('*').eq('affiliate_id', affiliateId).order('created_at', { ascending: false });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--accent);">Failed to load wallets.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.length ? data.map(w => `
        <tr class="text-white">
          <td>${w.currency}</td>
          <td>${w.address}</td>
          <td><button class="btn btn-outline-danger btn-sm" onclick="deleteWallet('${w.id}')"><i class="bi bi-trash"></i></button></td>
        </tr>
      `).join('') : `<tr><td colspan="3" style="color: var(--text);">No wallets added yet.</td></tr>`;
    }

    async function deleteWallet(id) {
      if (!confirm('Delete this wallet?')) return;
      const { error } = await supabase.from('affiliate_wallets').delete().eq('id', id);
      if (error) return showToast('Failed to delete wallet.');
      showToast('Wallet deleted.');
      await loadWallets();
    }

    async function loadPayouts() {
      const listEl = document.getElementById('withdrawals-list');
      const { data, error } = await supabase.from('affiliate_payouts').select('*').eq('affiliate_id', affiliateId).order('requested_at', { ascending: false });
      if (error) {
        listEl.innerHTML = `<li style="color: var(--accent);">Failed to load payouts.</li>`;
        return;
      }
      listEl.innerHTML = data.length ? data.map(p => `
        <li class="d-flex justify-content-between text-white">
          <div><strong>${toUSD(p.amount)}</strong> via <em>${p.method.toUpperCase()}</em><br/><small>${new Date(p.requested_at).toLocaleDateString()}</small></div>
          <div class="${p.status === 'completed' ? 'text-success' : 'text-warning'}">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</div>
        </li>
      `).join('') : `<li style="color: var(--text);">No payout history.</li>`;
    }

    function setupSidebarToggle() {
      document.getElementById('sidebar-toggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('expanded');
      });
    }
  </script>
</body>
</html>
