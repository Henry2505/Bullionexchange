<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Affiliate Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    body { background: #121212; color: #eee; }
    .error { background: #800; padding: .5rem; margin:1rem 0; border-radius:4px; }
  </style>
</head>
<body class="p-4">

  <h1>Affiliate Dashboard</h1>
  <div id="error-box"></div>

  <div class="card mb-3 p-3">
    <strong>Referral Code:</strong> <span id="code">â€¦</span>
    <button id="copy" class="btn btn-sm btn-outline-light">Copy</button><br>
    <small>Joined: <span id="joined">â€¦</span></small>
  </div>

  <script>
  (async ()=>{
    const showError = msg=>{
      document.getElementById('error-box').innerHTML =
        `<div class="error">ðŸš¨ ${msg}</div>`;
    };

    // 1) Check storage
    const id    = localStorage.getItem('affiliateId');
    const email = localStorage.getItem('affiliateEmail');
    if(!id) return showError('No affiliateId in localStorageâ€”did you log in?');

    // 2) Init Supabase
    const supabase = supabase.createClient(
      'https://dapwpgvnfjcfqqhrpxla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ'
    );

    // 3) Fetch affiliate record
    const { data, error } = await supabase
      .from('affiliate_accounts')
      .select('referral_code, created_at')
      .eq('id', id)
      .single();

    if (error) {
      return showError('Supabase error: ' + error.message);
    }

    // 4) Populate UI
    document.getElementById('code').textContent   = data.referral_code;
    document.getElementById('joined').textContent = new Date(data.created_at).toLocaleDateString();

    // 5) Copy button
    document.getElementById('copy').onclick = ()=>{
      navigator.clipboard.writeText(data.referral_code)
        .then(()=> alert('Copied!'))
        .catch(e=> showError('Copy failed: '+e.message));
    };
  })();
  </script>

</body>
</html>
