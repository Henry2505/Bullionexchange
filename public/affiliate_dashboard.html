<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Affiliate Dashboard • Apex Income Options</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    body { background: #121212; color: #eee; }
    .card { background: #1e1e1e; border: none; }
    .section-title { color: #ffd700; margin: 1rem 0 .5rem; }
    .copy-btn { background: none; border: none; color: #ffd700; cursor: pointer; }
  </style>
</head>
<body>

  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Affiliate Dashboard</h2>
      <button id="logout-btn" class="btn btn-outline-light btn-sm">Logout</button>
    </div>

    <!-- Referral Code Card -->
    <div class="card mb-4 p-3 text-center">
      <h5>Your Referral Code</h5>
      <div class="d-flex justify-content-center align-items-center">
        <span id="referral-code" class="h4 me-2">…</span>
        <button id="copy-code" class="copy-btn" title="Copy code"><i class="bi bi-clipboard"></i></button>
      </div>
      <small class="text-muted">Joined: <span id="joined-at">…</span></small>
    </div>

    <!-- Earnings Summary -->
    <div class="row text-center mb-4">
      <div class="col">
        <div class="card p-3">
          <div>Total Referrals</div>
          <div class="h3" id="total-referrals">0</div>
        </div>
      </div>
      <div class="col">
        <div class="card p-3">
          <div>Est. Earnings (USD)</div>
          <div class="h3" id="est-earnings">$0.00</div>
        </div>
      </div>
      <div class="col">
        <div class="card p-3">
          <div>Last 30d Earnings</div>
          <div class="h3" id="monthly-earnings">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Referral Activity Chart -->
    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="section-title">Referral Activity</h5>
        <button id="toggle-range" class="btn btn-sm btn-outline-secondary">Show All Time</button>
      </div>
      <canvas id="activityChart" height="100"></canvas>
    </div>

    <!-- Leaderboard -->
    <h5 class="section-title">Top Affiliates</h5>
    <ul class="list-group mb-4" id="leaderboard">
      <li class="list-group-item bg-dark text-center text-muted">Loading…</li>
    </ul>

    <!-- Profile Panel -->
    <div class="card p-3">
      <h5>Profile</h5>
      <p><strong>Email:</strong> <span id="profile-email">…</span></p>
      <p><strong>Affiliate ID:</strong> <span id="profile-id">…</span></p>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (async ()=>{
    // 1) Read session
    const affiliateId    = localStorage.getItem('affiliateId');
    const affiliateEmail = localStorage.getItem('affiliateEmail');
    if (!affiliateId) {
      return window.location.replace('affiliate_login.html');
    }

    // 2) Init Supabase
    const supabase = window.supabase.createClient(
      'https://dapwpgvnfjcfqqhrpxla.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…' // your anon key
    );

    // 3) Utility
    const toUSD = c=> c.toLocaleString('en-US',{style:'currency',currency:'USD'});

    // 4) Fetch your affiliate record
    let { data: aff, error } = await supabase
      .from('affiliate_accounts')
      .select('referral_code, created_at')
      .eq('id', affiliateId)
      .single();
    if (error) console.error(error);
    else {
      document.getElementById('referral-code').textContent = aff.referral_code;
      document.getElementById('joined-at').textContent    = new Date(aff.created_at).toLocaleDateString();
      document.getElementById('profile-email').textContent = affiliateEmail;
      document.getElementById('profile-id').textContent    = affiliateId;
    }

    // Copy code
    document.getElementById('copy-code').onclick = ()=> {
      navigator.clipboard.writeText(aff.referral_code);
      alert('Copied!');
    };

    // 5) Fetch referral counts
    let { count: total } = await supabase
      .from('referrals')
      .select('*', { head: true, count: 'exact' })
      .eq('affiliate_id', affiliateId);

    let { count: last30 } = await supabase
      .from('referrals')
      .select('*', { head: true, count: 'exact' })
      .eq('affiliate_id', affiliateId)
      .gt('created_at', new Date(Date.now()-30*24*3600*1000).toISOString());

    document.getElementById('total-referrals').textContent = total;
    document.getElementById('est-earnings').textContent   = toUSD(total*5);
    document.getElementById('monthly-earnings').textContent = toUSD(last30*5);

    // 6) Build chart data
    let { data: rows } = await supabase
      .from('referrals')
      .select('created_at')
      .eq('affiliate_id', affiliateId);

    const allMap={}, lastMap={};
    rows.forEach(r=>{
      const d = r.created_at.slice(0,10);
      allMap[d] = (allMap[d]||0)+1;
      if (new Date(r.created_at) > Date.now()-30*24*3600*1000)
        lastMap[d] = (lastMap[d]||0)+1;
    });

    const allDates = Object.keys(allMap).sort();
    const chartAll = allDates.map(d=>allMap[d]);
    const last30Dates = Array.from({length:30},(_,i)=>{
      let dt=new Date(); dt.setDate(dt.getDate() - (29-i));
      return dt.toISOString().slice(0,10);
    });
    const chart30 = last30Dates.map(d=> lastMap[d]||0 );

    // 7) Render chart
    const ctx = document.getElementById('activityChart').getContext('2d');
    let chart = new Chart(ctx,{
      type:'line',
      data:{
        labels:last30Dates,
        datasets:[{
          label:'New referrals',
          data:chart30,
          borderColor:'#ffd700',
          backgroundColor:'rgba(255,215,0,0.3)',
          fill:true
        }]
      },
      options:{scales:{x:{ticks:{color:'#eee'}},y:{ticks:{color:'#eee'}}}}
    });

    // Toggle range
    document.getElementById('toggle-range').onclick=()=>{
      const showingAll = chart.data.labels===allDates;
      chart.data.labels   = showingAll ? last30Dates : allDates;
      chart.data.datasets[0].data = showingAll ? chart30 : chartAll;
      chart.update();
      document.getElementById('toggle-range').textContent = showingAll? 'Show All Time' : 'Show Last 30d';
    };

    // 8) Leaderboard
    let { data: allRefs } = await supabase
      .from('referrals')
      .select('affiliate_id');
    const freq = allRefs.reduce((m, r)=> (m[r.affiliate_id] = (m[r.affiliate_id]||0)+1, m), {});
    const top5 = Object.entries(freq)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,5);

    const lb = document.getElementById('leaderboard');
    lb.innerHTML = '';
    for (let [id,cnt] of top5) {
      let { data:u } = await supabase
        .from('affiliate_accounts')
        .select('email, referral_code')
        .eq('id', id)
        .single();
      let li = document.createElement('li');
      li.className = 'list-group-item bg-dark text-light d-flex justify-content-between';
      li.innerHTML = `<span>${u.email} (${u.referral_code})</span><span>${cnt}</span>`;
      lb.append(li);
    }
    if (!top5.length) {
      lb.innerHTML = `<li class="list-group-item bg-dark text-muted">No referrals yet.</li>`;
    }

    // 9) Logout
    document.getElementById('logout-btn').onclick = ()=>{
      localStorage.removeItem('affiliateId');
      localStorage.removeItem('affiliateEmail');
      window.location.replace('affiliate_login.html');
    };

  })();
  </script>
</body>
</html>
