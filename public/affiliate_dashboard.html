<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard • Apex Income Options</title>

  <!-- Dependencies -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <!-- Custom Styles (unchanged) -->
  <style>
    /* [Your existing CSS styles remain unchanged] */
    /* I've kept all your existing styles intact */
  </style>
</head>
<body>
  <!-- Sidebar Toggle -->
  <div id="sidebar-toggle" title="Toggle Menu">
    <i class="bi bi-list"></i>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="px-3 pb-3">
      <h4 class="sidebar-title">Affiliate Dashboard</h4>

      <!-- Referral Code (mobile) -->
      <div id="referral-section-sidebar" class="card mb-3">
        <div class="card-header">
          <div><i class="bi bi-people-fill header-icon"></i>Referral Code</div>
        </div>
        <div class="card-body text-center">
          <span id="referral-code-sidebar" class="h5">Loading…</span>
          <button id="copy-referral-sidebar" class="copy-btn ms-2"><i class="bi bi-clipboard"></i></button>
          <div class="mt-2">
            <small>Share your link:</small><br />
            <input type="text" id="referral-link-sidebar" readonly class="form-control form-control-sm text-center" style="background: var(--accent); color: var(--text);" />
            <button id="copy-link-sidebar" class="copy-btn mt-1"><i class="bi bi-link-45deg"></i> Copy</button>
          </div>
          <div class="earn-banner">🎉 Earn <strong>$5</strong> for each successful referral!</div>
        </div>
      </div>
    </div>

    <nav class="nav flex-column px-3 pb-3">
      <a class="nav-link active" href="#overview-section">🏠 Overview</a>
      <a class="nav-link" href="#referral-section-main">🗂️ Referral Dashboard</a>
      <a class="nav-link" href="#referral-activity-section">📈 Referral Activity</a>
      <a class="nav-link" href="#leaderboard-section">🏆 Leaderboard</a>
      <a class="nav-link" href="#bank-accounts-section">🏦 Bank Accounts</a>
      <a class="nav-link" href="#crypto-wallets-section">💰 Crypto Wallets</a>
      <a class="nav-link" href="#currency-converter-section">💱 Converter</a>
      <a class="nav-link" href="#withdrawals-section">💵 Payouts</a>
      <a class="nav-link" href="#profile-section">👤 Profile</a>
      <button id="logout-btn" class="btn btn-outline-danger mt-3 w-100">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <div class="container-fluid">

      <!-- Referral Section -->
      <section id="referral-section-main" class="mb-5">
        <div class="section-title"><i class="bi bi-people-fill"></i> Your Referral Dashboard</div>
        <div class="row g-3">
          <!-- Referral Code Card -->
          <div class="col-lg-4 col-md-6">
            <div class="card text-center">
              <div class="card-header"><div><i class="bi bi-people-fill header-icon"></i>Referral Code</div></div>
              <div class="card-body">
                <h5 id="referral-code" class="mb-2">Loading…</h5>
                <button id="copy-referral" class="copy-btn mb-2"><i class="bi bi-clipboard"></i> Copy Code</button>
                <div class="mt-2">
                  <small>Share your link:</small><br />
                  <input type="text" id="referral-link" readonly class="form-control form-control-sm text-center" style="background: var(--accent); color: var(--text);" />
                  <button id="copy-link" class="copy-btn mt-1"><i class="bi bi-link-45deg"></i> Copy Link</button>
                </div>
                <div class="earn-banner mt-3">🎉 Earn <strong>$5</strong> for each successful referral!</div>
                <div class="qr-code mt-3" id="qr-code-container"></div>
              </div>
            </div>
          </div>

          <!-- Earnings Summary Card -->
          <div class="col-lg-4 col-md-6">
            <div class="card">
              <div class="card-header"><div><i class="bi bi-cash-stack header-icon"></i>Earnings Summary</div></div>
              <div class="card-body">
                <div class="mb-3"><div class="title">Weekly Earnings</div><div class="value" id="weekly-earnings">$0.00</div></div>
                <div class="mb-3"><div class="title">Monthly Earnings</div><div class="value" id="monthly-earnings">$0.00</div></div>
                <div class="mb-3"><div class="title">All‑Time Earnings</div><div class="value" id="alltime-earnings">$0.00</div></div>
              </div>
            </div>
          </div>

          <!-- Convert Earnings -->
          <div class="col-lg-4 col-md-12">
            <div class="card text-center">
              <div class="card-header"><div><i class="bi bi-arrow-repeat header-icon"></i>Convert Earnings</div></div>
              <div class="card-body">
                <div class="mb-2">
                  <select id="convert-target-currency" class="form-select form-select-sm">
                    <option value="NGN" selected>NGN</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="BTC">BTC</option>
                    <option value="USD">USD</option>
                  </select>
                </div>
                <button id="convert-earn-btn" class="btn btn-primary btn-sm mb-2">Convert</button>
                <div><span id="convert-earn-result" class="text-light">--</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Overview -->
      <section id="overview-section" class="mb-5">
        <div class="section-title"><i class="bi bi-speedometer2"></i> Overview</div>
        <div class="overview-cards">
          <div class="overview-card" id="card-total-referrals"><div class="title">Total Referrals</div><div class="value" id="overview-total-referrals">0</div></div>
          <div class="overview-card" id="card-estimated-earnings-usd"><div class="title">Est. Earnings (USD)</div><div class="value" id="overview-est-earn-usd">$0.00</div></div>
        </div>
      </section>

      <!-- Referral Activity -->
      <section id="referral-activity-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="section-title"><i class="bi bi-graph-up"></i> Referral Activity</div>
          <button id="toggle-referral-range" class="btn btn-outline-secondary btn-sm">Show All Time</button>
        </div>
        <div class="chart-container"><canvas id="referralChart" height="100"></canvas></div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboard-section" class="mb-5">
        <div class="section-title"><i class="bi bi-trophy-fill"></i> Leaderboard: Top Affiliates</div>
        <ul class="leaderboard-list" id="leaderboard-list">
          <li class="text-center text-muted">Loading leaderboard…</li>
        </ul>
      </section>

      <!-- Bank Accounts -->
      <section id="bank-accounts-section" class="mb-5">
        <div class="section-title"><i class="bi bi-bank2"></i> Manage Bank Accounts</div>
        <div class="card mb-3">
          <div class="card-header"><div><i class="bi bi-plus-circle header-icon"></i>Add New Bank Account</div></div>
          <div class="card-body">
            <form id="bank-form" class="row g-3">
              <div class="col-md-6"><label for="bank-name" class="form-label">Bank Name</label><input type="text" id="bank-name" class="form-control" placeholder="e.g. First Bank" required /></div>
              <div class="col-md-6"><label for="bank-code" class="form-label">Bank Code/Branch</label><input type="text" id="bank-code" class="form-control" placeholder="e.g. 011" required /></div>
              <div class="col-md-6"><label for="account-number" class="form-label">Account Number</label><input type="text" id="account-number" class="form-control" placeholder="e.g. 0123456789" required /></div>
              <div class="col-md-6"><label for="account-name" class="form-label">Account Name</label><input type="text" id="account-name" class="form-control" placeholder="e.g. John Doe" required /></div>
              <div class="col-12 text-end"><button type="submit" class="btn btn-primary" id="add-bank-btn"><span id="bank-btn-text">Add Account</span><span id="bank-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div><i class="bi bi-file-earmark-text header-icon"></i>Your Saved Bank Accounts</div></div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle text-center mb-0"><thead><tr><th>Bank Name</th><th>Bank Code</th><th>Account Number</th><th>Account Name</th><th>Action</th></tr></thead><tbody id="bank-accounts-body"><tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr></tbody></table></div></div>
        </div>
      </section>

      <!-- Crypto Wallets -->
      <section id="crypto-wallets-section" class="mb-5">
        <div class="section-title"><i class="bi bi-currency-bitcoin"></i> Manage Crypto Wallets</div>
        <div class="card mb-3">
          <div class="card-header"><div><i class="bi bi-plus-circle header-icon"></i>Add New Crypto Wallet</div></div>
          <div class="card-body">
            <form id="wallet-form" class="row g-3">
              <div class="col-md-6"><label for="crypto-currency" class="form-label">Currency</label><select id="crypto-currency" class="form-select" required><option value="">Select Currency</option><option value="BTC">Bitcoin (BTC)</option><option value="ETH">Ethereum (ETH)</option><option value="USDT">Tether (USDT)</option><option value="BCH">Bitcoin Cash (BCH)</option><option value="LTC">Litecoin (LTC)</option></select></div>
              <div class="col-md-6"><label for="crypto-address" class="form-label">Wallet Address</label><input type="text" id="crypto-address" class="form-control" placeholder="e.g. 1BoatSLRHtKNngkdXEeobR76b53LETtpyT" required /></div>
              <div class="col-12 text-end"><button type="submit" class="btn btn-primary" id="add-wallet-btn"><span id="wallet-btn-text">Add Wallet</span><span id="wallet-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div><i class="bi bi-wallet-fill header-icon"></i>Your Saved Crypto Wallets</div></div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle text-center mb-0"><thead><tr><th>Currency</th><th>Wallet Address</th><th>Action</th></tr></thead><tbody id="wallets-body"><tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr></tbody></table></div></div>
        </div>
      </section>

      <!-- Currency Converter -->
      <section id="currency-converter-section" class="mb-5">
        <div class="section-title"><i class="bi bi-currency-exchange"></i> Currency Converter</div>
        <div class="card">
          <div class="card-header"><div><i class="bi bi-arrow-left-right header-icon"></i>Convert Between Currencies</div></div>
          <div class="card-body">
            <form id="converter-form" class="row g-3 align-items-end">
              <div class="col-md-3"><label for="convert-from" class="form-label">From</label><select id="convert-from" class="form-select"><option value="USD" selected>USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="NGN">NGN</option><option value="BTC">BTC</option></select></div>
              <div class="col-md-3"><label for="convert-to" class="form-label">To</label><select id="convert-to" class="form-select"><option value="NGN" selected>NGN</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="BTC">BTC</option></select></div>
              <div class="col-md-3"><label for="convert-amount" class="form-label">Amount</label><input type="number" id="convert-amount" class="form-control" value="1" min="0" /></div>
              <div class="col-md-3 text-end"><button type="submit" class="btn btn-primary" id="convert-btn"><span id="convert-text">Convert</span><span id="convert-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
              <div class="col-12 text-center mt-3"><h5 id="convert-result">--</h5></div>
            </form>
          </div>
        </div>
      </section>

      <!-- Withdrawals / Payout Requests -->
      <section id="withdrawals-section" class="mb-5">
        <div class="section-title"><i class="bi bi-cash-stack"></i> Payout Requests</div>
        <div class="withdraw-card mb-3">
          <div class="mb-2" style="font-size: 0.95rem; color: var(--text-light);">You earn <strong>$5</strong> per referral. Request in USD, NGN or receive via crypto.</div>
          <div class="row g-3">
            <div class="col-md-4"><label for="withdraw-amount" class="form-label">Request Amount (USD)</label><input type="number" id="withdraw-amount" class="form-control" placeholder="e.g. 100.00" min="1" step="0.01" /></div>
            <div class="col-md-4"><label for="withdraw-method" class="form-label">Payout Method</label><select id="withdraw-method" class="form-select"><option value="">Select Method</option><option value="bank">Bank Transfer</option><option value="crypto">Crypto Wallet</option><option value="ngn">Naira (NGN Bank)</option></select></div>
            <div class="col-md-4 align-self-end text-end"><button id="request-withdraw-btn" class="btn btn-primary"><span id="withdraw-btn-text">Request Payout</span><span id="withdraw-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
          </div>
        </div>
        <div class="withdraw-card">
          <div class="section-title"><i class="bi bi-list-check"></i> Past Payouts</div>
          <ul class="withdraw-list" id="withdrawals-list">
            <li class="text-center text-muted">Loading payout history…</li>
          </ul>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile-section" class="mb-5">
        <div class="section-title"><i class="bi bi-person-circle"></i> Your Profile</div>
        <div class="card">
          <div class="card-body">
            <p><strong>Email:</strong> <span id="user-email">Loading…</span></p>
            <p><strong>Joined On:</strong> <span id="joined-date">--</span></p>
            <p><strong>Total Referrals:</strong> <span id="total-referrals">0</span></p>
            <p><strong>Est. Earnings (USD):</strong> <span id="overview-est-earn-usd-inline">$0.00</span></p>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body" style="color: var(--text);"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Theme Toggle Button -->
  <div class="theme-toggle-btn" id="theme-toggle-btn">
    <i class="bi bi-sun-fill" id="theme-icon"></i>
  </div>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- JavaScript: Affiliate Dashboard Logic -->
  <script>
    // Initialize Supabase client
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Check if user is logged in (via local storage)
    const affiliateId = localStorage.getItem('affiliateId');
    const affiliateEmail = localStorage.getItem('affiliateEmail');
    if (!affiliateId || !affiliateEmail) {
      window.location.replace('affiliate_login.html');
      return;
    }

    // Set profile email from local storage
    document.getElementById('user-email').textContent = affiliateEmail;

    // Global variables
    let referralChart = null;
    let chartDataAllTime = { labels: [], counts: [] };
    let chartData30Days = { labels: [], counts: [] };

    // Utility functions
    function showToast(message) {
      const toastEl = document.getElementById('liveToast');
      document.getElementById('toast-body').textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    function copyTextToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showToast('Copied to clipboard'))
        .catch(() => showToast('Copy failed'));
    }

    function toUSD(value) {
      return parseFloat(value).toLocaleString(undefined, {
        style: 'currency',
        currency: 'USD',
      });
    }

    function toCurrency(value, curr) {
      if (curr === 'BTC') {
        return parseFloat(value).toFixed(8) + ' BTC';
      }
      return parseFloat(value).toLocaleString(undefined, {
        style: 'currency',
        currency: curr,
      });
    }

    function varGet(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name);
    }

    function getDateNDaysAgo(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return d;
    }

    // Fetch referral code and joined date
    async function fetchReferralCode() {
      const refSpanMain = document.getElementById('referral-code');
      const linkInputMain = document.getElementById('referral-link');
      const refSpanSide = document.getElementById('referral-code-sidebar');
      const linkInputSide = document.getElementById('referral-link-sidebar');
      refSpanMain.textContent = 'Loading…';
      refSpanSide.textContent = 'Loading…';
      const { data, error } = await supabase
        .from('affiliate_accounts')
        .select('referral_code, created_at')
        .eq('id', affiliateId)
        .single();
      if (error) {
        console.error('Failed to load affiliate data:', error);
        refSpanMain.textContent = '—';
        refSpanSide.textContent = '—';
        return;
      }
      const code = data.referral_code;
      const joinedDate = new Date(data.created_at).toLocaleDateString();
      refSpanMain.textContent = code;
      refSpanSide.textContent = code;
      const fullLink = `${window.location.origin}/CBE_apply.html?ref=${code}`;
      linkInputMain.value = fullLink;
      linkInputSide.value = fullLink;
      document.getElementById('joined-date').textContent = joinedDate;
      const qr = document.createElement('img');
      qr.src = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${encodeURIComponent(fullLink)}`;
      qr.alt = 'Referral QR Code';
      document.getElementById('qr-code-container').innerHTML = '';
      document.getElementById('qr-code-container').appendChild(qr);
    }

    // Fetch total referrals
    async function fetchTotalReferrals() {
      const { count, error } = await supabase
        .from('referrals')
        .select('*', { count: 'exact', head: true })
        .eq('affiliate_id', affiliateId);
      if (error) {
        console.error('Failed to fetch total referrals:', error);
        document.getElementById('total-referrals').textContent = '—';
        document.getElementById('overview-total-referrals').textContent = '—';
      } else {
        const total = count || 0;
        document.getElementById('total-referrals').textContent = total;
        document.getElementById('overview-total-referrals').textContent = total;
      }
    }

    // Calculate and display earnings
    async function calculateAndDisplayEarnings() {
      const totalRefs = parseInt(document.getElementById('overview-total-referrals').textContent) || 0;
      const usdEarnings = totalRefs * 5;
      document.getElementById('overview-est-earn-usd').textContent = toUSD(usdEarnings);
      document.getElementById('overview-est-earn-usd-inline').textContent = toUSD(usdEarnings);
      window.currentEarningsUSD = usdEarnings;
      document.getElementById('alltime-earnings').textContent = toUSD(usdEarnings);

      const { count: wCount } = await supabase
        .from('referrals')
        .select('*', { count: 'exact', head: true })
        .eq('affiliate_id', affiliateId)
        .gt('created_at', getDateNDaysAgo(7).toISOString());
      document.getElementById('weekly-earnings').textContent = toUSD((wCount || 0) * 5);

      const { count: mCount } = await supabase
        .from('referrals')
        .select('*', { count: 'exact', head: true })
        .eq('affiliate_id', affiliateId)
        .gt('created_at', getDateNDaysAgo(30).toISOString());
      document.getElementById('monthly-earnings').textContent = toUSD((mCount || 0) * 5);
    }

    // Load referral chart data
    async function loadReferralChartData() {
      const { data: referrals, error } = await supabase
        .from('referrals')
        .select('created_at')
        .eq('affiliate_id', affiliateId);
      if (error) return console.error('Referral chart fetch error:', error);

      const allMap = {}, last30Map = {};
      referrals.forEach(r => {
        const key = new Date(r.created_at).toISOString().split('T')[0];
        allMap[key] = (allMap[key] || 0) + 1;
        if (new Date(r.created_at) >= getDateNDaysAgo(30)) {
          last30Map[key] = (last30Map[key] || 0) + 1;
        }
      });
      const allDates = Object.keys(allMap).sort((a, b) => new Date(a) - new Date(b));
      chartDataAllTime.labels = allDates;
      chartDataAllTime.counts = allDates.map(d => allMap[d]);
      const last30Labels = [], last30Counts = [];
      for (let i = 29; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = d.toISOString().split('T')[0];
        last30Labels.push(k);
        last30Counts.push(last30Map[k] || 0);
      }
      chartData30Days.labels = last30Labels;
      chartData30Days.counts = last30Counts;
    }

    // Render referral chart
    async function renderReferralChart(range) {
      const ctx = document.getElementById('referralChart').getContext('2d');
      if (referralChart) referralChart.destroy();
      const src = range === 'alltime' ? chartDataAllTime : chartData30Days;
      referralChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: src.labels,
          datasets: [{
            label: 'New Referrals',
            data: src.counts,
            backgroundColor: 'rgba(255,215,0,0.3)',
            borderColor: 'rgba(255,215,0,1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          scales: {
            x: { ticks: { color: varGet('--text') }, grid: { color: varGet('--shadow') } },
            y: { ticks: { color: varGet('--text') }, grid: { color: varGet('--shadow') } }
          },
          plugins: { legend: { labels: { color: varGet('--text') } } },
          maintainAspectRatio: false
        }
      });
    }

    // Load leaderboard
    async function loadLeaderboard() {
      const listEl = document.getElementById('leaderboard-list');
      listEl.innerHTML = `<li class="text-center text-muted">Loading leaderboard…</li>`;
      const { data: allReferrals, error } = await supabase
        .from('referrals')
        .select('affiliate_id');
      if (error) {
        console.error('Leaderboard grouping error:', error);
        listEl.innerHTML = `<li style="color: var(--gold);">Failed to load leaderboard.</li>`;
        return;
      }
      const map = {};
      allReferrals.forEach(r => {
        map[r.affiliate_id] = (map[r.affiliate_id] || 0) + 1;
      });
      const arr = Object.entries(map).map(([affiliateId, cnt]) => ({ affiliateId, cnt }));
      arr.sort((a, b) => b.cnt - a.cnt);
      const top5 = arr.slice(0, 5);
      if (!top5.length) {
        listEl.innerHTML = `<li style="color: var(--text);">No referrals yet.</li>`;
        return;
      }
      listEl.innerHTML = '';
      for (const item of top5) {
        const { data: affData } = await supabase
          .from('affiliate_accounts')
          .select('email, referral_code')
          .eq('id', item.affiliateId)
          .single();
        if (affData) {
          const li = document.createElement('li');
          li.className = 'leaderboard-item';
          li.innerHTML = `<div class="leader-name">${affData.email} <small style="color: var(--text-light);">(${affData.referral_code})</small></div><div class="leader-count">${item.cnt}</div>`;
          listEl.appendChild(li);
        }
      }
    }

    // Load bank accounts
    async function loadBankAccounts() {
      const tbody = document.getElementById('bank-accounts-body');
      tbody.innerHTML = `<tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr>`;
      const { data, error } = await supabase
        .from('affiliate_bank_accounts')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .order('created_at', { ascending: false });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--gold);">Failed to load bank accounts.</td></tr>`;
        return;
      }
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--text);">No bank accounts added yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      data.forEach(acct => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${acct.bank_name}</td>
          <td>${acct.bank_code}</td>
          <td>${acct.account_number}</td>
          <td>${acct.account_name}</td>
          <td><button class="btn btn-outline-danger btn-sm" onclick="deleteBankAccount('${acct.id}')"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Delete bank account
    async function deleteBankAccount(id) {
      if (!confirm('Delete this bank account?')) return;
      const { error } = await supabase
        .from('affiliate_bank_accounts')
        .delete()
        .eq('id', id);
      if (error) return showToast('Failed to delete bank account.');
      showToast('Bank account deleted.');
      await loadBankAccounts();
    }

    // Load crypto wallets
    async function loadWallets() {
      const tbody = document.getElementById('wallets-body');
      tbody.innerHTML = `<tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr>`;
      const { data, error } = await supabase
        .from('affiliate_wallets')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .order('created_at', { ascending: false });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--gold);">Failed to load wallets.</td></tr>`;
        return;
      }
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--text);">No wallets added yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      data.forEach(w => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${w.currency}</td>
          <td>${w.address}</td>
          <td><button class="btn btn-outline-danger btn-sm" onclick="deleteWallet('${w.id}')"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Delete wallet
    async function deleteWallet(id) {
      if (!confirm('Delete this wallet?')) return;
      const { error } = await supabase
        .from('affiliate_wallets')
        .delete()
        .eq('id', id);
      if (error) return showToast('Failed to delete wallet.');
      showToast('Wallet deleted.');
      await loadWallets();
    }

    // Load payouts
    async function loadPayouts() {
      const listEl = document.getElementById('withdrawals-list');
      listEl.innerHTML = `<li class="text-center"><div class="spinner-border"></div></li>`;
      const { data, error } = await supabase
        .from('affiliate_payouts')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .order('requested_at', { ascending: false });
      if (error) {
        listEl.innerHTML = `<li style="color: var(--gold);">Failed to load payouts.</li>`;
        return;
      }
      if (!data.length) {
        listEl.innerHTML = `<li style="color: var(--text);">No payout history.</li>`;
        return;
      }
      listEl.innerHTML = '';
      data.forEach(p => {
        const li = document.createElement('li');
        const date = new Date(p.requested_at).toLocaleDateString();
        li.className = 'withdraw-item';
        li.innerHTML = `
          <div>
            <strong>${toUSD(p.amount)}</strong> via <em>${p.method.toUpperCase()}</em><br/>
            <small>${date}</small>
          </div>
          <div class="withdraw-status ${p.status==='completed'?'text-success':'text-warning'}">${p.status.charAt(0).toUpperCase()+p.status.slice(1)}</div>
        `;
        listEl.appendChild(li);
      });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', async () => {
      await fetchReferralCode();
      await fetchTotalReferrals();
      await calculateAndDisplayEarnings();
      await loadReferralChartData();
      await renderReferralChart('30days');
      await loadLeaderboard();
      await loadBankAccounts();
      await loadWallets();
      await loadPayouts();

      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('affiliateId');
        localStorage.removeItem('affiliateEmail');
        window.location.href = 'affiliate_login.html';
      });

      document.getElementById('copy-referral').addEventListener('click', () => {
        const code = document.getElementById('referral-code').textContent;
        if (code && code !== '—') copyTextToClipboard(code);
      });
      document.getElementById('copy-link').addEventListener('click', () => {
        const link = document.getElementById('referral-link').value;
        if (link) copyTextToClipboard(link);
      });
      document.getElementById('copy-referral-sidebar').addEventListener('click', () => {
        const code = document.getElementById('referral-code-sidebar').textContent;
        if (code && code !== '—') copyTextToClipboard(code);
      });
      document.getElementById('copy-link-sidebar').addEventListener('click', () => {
        const link = document.getElementById('referral-link-sidebar').value;
        if (link) copyTextToClipboard(link);
      });

      document.getElementById('bank-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bankName = document.getElementById('bank-name').value.trim();
        const bankCode = document.getElementById('bank-code').value.trim();
        const accountNumber = document.getElementById('account-number').value.trim();
        const accountName = document.getElementById('account-name').value.trim();
        if (!bankName || !bankCode || !accountNumber || !accountName) {
          showToast('Please fill in all bank fields.');
          return;
        }
        const bankBtn = document.getElementById('add-bank-btn');
        const bankText = document.getElementById('bank-btn-text');
        const bankSpinner = document.getElementById('bank-spinner');
        bankBtn.setAttribute('disabled', true);
        bankText.textContent = 'Adding…';
        bankSpinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_bank_accounts')
            .insert([{ affiliate_id: affiliateId, bank_name: bankName, bank_code: bankCode, account_number: accountNumber, account_name: accountName }]);
          if (error) throw error;
          showToast('Bank account added!');
          document.getElementById('bank-form').reset();
          await loadBankAccounts();
        } catch (err) {
          console.error('Bank insert error:', err);
          showToast('Failed to add bank account.');
        } finally {
          bankBtn.removeAttribute('disabled');
          bankText.textContent = 'Add Account';
          bankSpinner.style.display = 'none';
        }
      });

      document.getElementById('wallet-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currency = document.getElementById('crypto-currency').value;
        const address = document.getElementById('crypto-address').value.trim();
        if (!currency || !address) {
          showToast('Please select currency and enter address.');
          return;
        }
        const walletBtn = document.getElementById('add-wallet-btn');
        const walletText = document.getElementById('wallet-btn-text');
        const walletSpinner = document.getElementById('wallet-spinner');
        walletBtn.setAttribute('disabled', true);
        walletText.textContent = 'Adding…';
        walletSpinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_wallets')
            .insert([{ affiliate_id: affiliateId, currency, address }]);
          if (error) throw error;
          showToast('Wallet added!');
          document.getElementById('wallet-form').reset();
          await loadWallets();
        } catch (err) {
          console.error('Wallet insert error:', err);
          showToast('Failed to add wallet.');
        } finally {
          walletBtn.removeAttribute('disabled');
          walletText.textContent = 'Add Wallet';
          walletSpinner.style.display = 'none';
        }
      });

      document.getElementById('converter-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const from = document.getElementById('convert-from').value;
        const to = document.getElementById('convert-to').value;
        const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
        const convertText = document.getElementById('convert-text');
        const convertSpinner = document.getElementById('convert-spinner');
        convertText.textContent = 'Converting…';
        convertSpinner.style.display = 'inline-block';
        try {
          const response = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/${from}`);
          const data = await response.json();
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          const rate = data.conversion_rates[to];
          if (!rate) {
            showToast(`Rate ${from}→${to} not available.`);
            document.getElementById('convert-result').textContent = '--';
          } else {
            const converted = (amount * rate).toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 8
            });
            document.getElementById('convert-result').textContent = `${amount} ${from} = ${converted} ${to}`;
          }
        } catch (err) {
          console.error('Conversion error:', err);
          showToast('Currency conversion failed.');
          document.getElementById('convert-result').textContent = '--';
        } finally {
          convertText.textContent = 'Convert';
          convertSpinner.style.display = 'none';
        }
      });

      document.getElementById('request-withdraw-btn').addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const method = document.getElementById('withdraw-method').value;
        if (!amount || amount <= 0) {
          showToast('Enter a valid withdrawal amount.');
          return;
        }
        if (!method) {
          showToast('Select payout method.');
          return;
        }
        const btnText = document.getElementById('withdraw-btn-text');
        const spinner = document.getElementById('withdraw-spinner');
        btnText.textContent = 'Requesting…';
        spinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_payouts')
            .insert([{ affiliate_id: affiliateId, amount, method, status: 'pending', requested_at: new Date() }]);
          if (error) throw error;
          showToast('Payout requested successfully.');
          document.getElementById('withdraw-amount').value = '';
          document.getElementById('withdraw-method').value = '';
          await loadPayouts();
        } catch (err) {
          console.error('Payout request error:', err);
          showToast('Failed to request payout.');
        } finally {
          btnText.textContent = 'Request Payout';
          spinner.style.display = 'none';
        }
      });

      document.getElementById('toggle-referral-range').addEventListener('click', () => {
        const btn = document.getElementById('toggle-referral-range');
        if (btn.textContent.includes('All Time')) {
          renderReferralChart('alltime');
          btn.textContent = 'Show Last 30 Days';
        } else {
          renderReferralChart('30days');
          btn.textContent = 'Show All Time';
        }
      });

      document.getElementById('convert-earn-btn').addEventListener('click', async () => {
        const targetCurr = document.getElementById('convert-target-currency').value;
        const usdAmount = window.currentEarningsUSD || 0;
        if (usdAmount <= 0) {
          showToast('You have no earnings to convert.');
          return;
        }
        const resultEl = document.getElementById('convert-earn-result');
        resultEl.textContent = 'Converting…';
        try {
          if (targetCurr === 'USD') {
            resultEl.textContent = toUSD(usdAmount);
            return;
          }
          const resp = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/USD`);
          const d = await resp.json();
          if (d.result !== 'success') throw new Error('Failed to fetch rates');
          const r = d.conversion_rates[targetCurr];
          if (!r) {
            showToast(`Rate USD→${targetCurr} not available.`);
            resultEl.textContent = '--';
          } else {
            resultEl.textContent = toCurrency(usdAmount * r, targetCurr);
          }
        } catch (err) {
          console.error('Convert earnings error:', err);
          showToast('Conversion failed.');
          resultEl.textContent = '--';
        }
      });

      setupThemeToggle();
      setupSidebarToggle();
    });

    // Theme toggle
    function setupThemeToggle() {
      const btn = document.getElementById('theme-toggle-btn');
      const icon = document.getElementById('theme-icon');
      const saved = localStorage.getItem('dashboardTheme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      icon.className = saved === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
      btn.addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('dashboardTheme', next);
        icon.className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
      });
    }

    // Sidebar toggle
    function setupSidebarToggle() {
      document.getElementById('sidebar-toggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('expanded');
      });
    }
  </script>
</body>
</html>
