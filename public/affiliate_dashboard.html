<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Your Affiliate Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-dark text-light">
  <div class="container py-5">
    <h1 class="mb-4">Welcome, <span id="user-email">…</span></h1>
    <div class="card bg-secondary mb-3">
      <div class="card-body">
        <h5>Your Referral Code</h5>
        <p class="display-6"><code id="referral-code">…</code></p>
        <h6>Referral Link</h6>
        <input id="referral-link" class="form-control mb-2" readonly/>
        <button id="copy-link" class="btn btn-sm btn-warning">Copy Link</button>
      </div>
    </div>
    <div class="card bg-secondary">
      <div class="card-body">
        <h5>Total Referrals</h5>
        <p class="display-6" id="total-referrals">0</p>
        <h6>All-Time Earnings</h6>
        <p class="h4 text-warning" id="alltime-earnings">$0.00</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'YOUR_ANON_KEY';
    const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    // must have been set on login
    const affiliateId = localStorage.getItem('affiliateId');
    const affiliateEmail = localStorage.getItem('affiliateEmail');
    if (!affiliateId) return location.replace('affiliate_login.html');
    document.getElementById('user-email').textContent = affiliateEmail;

    // fetch code + link
    supabase
      .from('affiliate_accounts')
      .select('referral_code')
      .eq('id', affiliateId)
      .single()
      .then(({ data, error }) => {
        if (error) return console.error(error);
        document.getElementById('referral-code').textContent = data.referral_code;
        const link = `${location.origin}/CBE_apply.html?ref=${data.referral_code}`;
        document.getElementById('referral-link').value = link;
      });

    // fetch count
    supabase
      .from('referrals')
      .select('*', { count: 'exact', head: true })
      .eq('affiliate_id', affiliateId)
      .then(({ count, error }) => {
        if (error) return console.error(error);
        document.getElementById('total-referrals').textContent = count;
        document.getElementById('alltime-earnings').textContent = `$${(count*5).toFixed(2)}`;
      });

    // copy link
    document.getElementById('copy-link').onclick = () => {
      navigator.clipboard.writeText(document.getElementById('referral-link').value);
      alert('Link copied!');
    };
  </script>
</body>
</html>
