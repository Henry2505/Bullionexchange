<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard ‚Ä¢ Apex Income Options</title>

  <!-- ===================== DEPENDENCIES ===================== -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <!-- ===================== CUSTOM STYLES ===================== -->
  <style>
    :root {
      --black: #1a1a1a;
      --gold: #d4af37;
      --gold-light: #e6c874;
      --gold-dark: #b8972e;
      --text: #ffffff;
      --text-light: #b0b0b0;
      --accent: #2c2c2c;
      --shadow: rgba(0, 0, 0, 0.5);
      --gradient: linear-gradient(135deg, #1a1a1a, #2c2c2c);
    }

    [data-theme="light"] {
      --black: #ffffff;
      --gold: #b8972e;
      --gold-light: #e6c874;
      --gold-dark: #8b6914;
      --text: #1a1a1a;
      --text-light: #4a4a4a;
      --accent: #f5f5f5;
      --shadow: rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #ffffff, #f5f5f5);
    }

    body {
      background: var(--gradient);
      color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      transition: all 0.3s ease;
    }

    .sidebar {
      background: var(--black);
      border-right: 1px solid var(--gold-dark);
      box-shadow: 2px 0 10px var(--shadow);
      transition: transform 0.3s ease;
    }

    .sidebar-title {
      color: var(--gold);
      font-weight: 600;
      letter-spacing: 1px;
      margin-bottom: 1.5rem;
    }

    .nav-link {
      color: var(--text-light);
      font-weight: 500;
      transition: color 0.2s, background 0.2s;
    }

    .nav-link:hover, .nav-link.active {
      color: var(--gold);
      background: var(--accent);
      border-radius: 5px;
    }

    .main-content {
      background: transparent;
      padding: 2rem;
    }

    .card {
      background: var(--black);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--shadow);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      background: var(--gradient);
      color: var(--gold);
      font-weight: 600;
      border-bottom: 1px solid var(--gold-dark);
    }

    .section-title {
      color: var(--gold);
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: var(--gold);
      border-color: var(--gold-dark);
      color: var(--black);
      font-weight: 600;
      transition: background 0.2s, transform 0.2s;
    }

    .btn-primary:hover {
      background: var(--gold-light);
      transform: scale(1.05);
    }

    .btn-outline-danger {
      border-color: var(--gold-dark);
      color: var(--gold);
    }

    .btn-outline-danger:hover {
      background: var(--gold-dark);
      color: var(--black);
    }

    .copy-btn {
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      color: var(--gold);
      transition: background 0.2s;
    }

    .copy-btn:hover {
      background: var(--gold-dark);
      color: var(--black);
    }

    .form-control, .form-select {
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      color: var(--text);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--gold);
      box-shadow: 0 0 5px var(--gold-light);
    }

    .overview-card {
      background: var(--black);
      border: 1px solid var(--gold-dark);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.2s;
    }

    .overview-card:hover {
      transform: translateY(-3px);
    }

    .overview-card .title {
      color: var(--gold-light);
      font-weight: 500;
    }

    .overview-card .value {
      color: var(--gold);
      font-size: 1.8rem;
      font-weight: 700;
    }

    .leaderboard-item {
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      border-radius: 5px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .leader-name {
      color: var(--gold);
    }

    .leader-count {
      color: var(--gold-light);
      font-weight: 600;
    }

    .withdraw-item {
      background: var(--accent);
      border: 1px solid var(--gold-dark);
      border-radius: 5px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .withdraw-status {
      font-weight: 600;
    }

    .earn-banner {
      background: var(--gold-dark);
      color: var(--black);
      padding: 0.5rem;
      border-radius: 5px;
      font-weight: 600;
    }

    .chart-container {
      background: var(--black);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      padding: 1rem;
    }

    .toast-container .toast {
      background: var(--black);
      border: 1px solid var(--gold-dark);
      color: var(--gold);
    }

    .theme-toggle-btn {
      background: var(--gold);
      color: var(--black);
      border: 1px solid var(--gold-dark);
      border-radius: 50%;
      padding: 0.5rem;
      transition: transform 0.2s;
    }

    .theme-toggle-btn:hover {
      transform: rotate(360deg);
    }

    .time-date {
      color: var(--gold-light);
      font-size: 0.9rem;
      text-align: center;
      margin: 1rem 0;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.expanded {
        transform: translateX(0);
      }

      .main-content {
        padding: 1rem;
      }

      .overview-cards {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- ===================== AUTH GUARD ===================== -->
  <script>
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabaseClient = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // ‚ñ∂Ô∏è Grab our affiliate‚Äôs ID from login
    const affiliateId = localStorage.getItem('affiliateId');
    if (!affiliateId) {
      // not logged in ‚Üí back to login page
      window.location.replace('affiliate_login.html');
      throw new Error('No affiliateId in localStorage');
    }
  </script>

  <!-- ===================== SIDEBAR TOGGLE ===================== -->
  <div id="sidebar-toggle" title="Toggle Menu">
    <i class="bi bi-list"></i>
  </div>

  <!-- ===================== SIDEBAR ===================== -->
  <div class="sidebar" id="sidebar">
    <div class="px-3 pb-3">
      <h4 class="sidebar-title">Affiliate Dashboard</h4>
      <!-- Time and Date Display -->
      <div class="time-date" id="time-date">Loading time...</div>
      <!-- Referral Code (mobile) -->
      <div id="referral-section-sidebar" class="card mb-3">
        <div class="card-header">
          <div><i class="bi bi-people-fill header-icon"></i>Referral Code</div>
        </div>
        <div class="card-body text-center">
          <span id="referral-code-sidebar" class="h5">Loading‚Ä¶</span>
          <button id="copy-referral-sidebar" class="copy-btn ms-2"><i class="bi bi-clipboard"></i></button>
          <div class="mt-2">
            <small>Share your link:</small><br />
            <input type="text" id="referral-link-sidebar" readonly class="form-control form-control-sm text-center" style="background: var(--accent); color: var(--text);" />
            <button id="copy-link-sidebar" class="copy-btn mt-1"><i class="bi bi-link-45deg"></i> Copy</button>
          </div>
          <div class="earn-banner">üéâ Earn <strong>$5</strong> for each successful referral!</div>
        </div>
      </div>
    </div>

    <nav class="nav flex-column px-3 pb-3">
      <a class="nav-link active" href="#overview-section">üè† Overview</a>
      <a class="nav-link" href="#referral-section-main">üóÇÔ∏è Referral Dashboard</a>
      <a class="nav-link" href="#referral-activity-section">üìà Referral Activity</a>
      <a class="nav-link" href="#leaderboard-section">üèÜ Leaderboard</a>
      <a class="nav-link" href="#bank-accounts-section">üè¶ Bank Accounts</a>
      <a class="nav-link" href="#crypto-wallets-section">üí∞ Crypto Wallets</a>
      <a class="nav-link" href="#currency-converter-section">üí± Converter</a>
      <a class="nav-link" href="#withdrawals-section">üíµ Payouts</a>
      <a class="nav-link" href="#profile-section">üë§ Profile</a>
      <button id="logout-btn" class="btn btn-outline-danger mt-3 w-100">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </nav>
  </div>

  <!-- ===================== MAIN CONTENT ===================== -->
  <div class="main-content" id="main-content">
    <div class="container-fluid">
      <!-- [All existing sections remain unchanged, only styled with new CSS] -->
      <!-- Referral Section -->
      <section id="referral-section-main" class="mb-5">
        <div class="section-title"><i class="bi bi-people-fill"></i> Your Referral Dashboard</div>
        <div class="row g-3">
          <div class="col-lg-4 col-md-6">
            <div class="card text-center">
              <div class="card-header"><div><i class="bi bi-people-fill header-icon"></i>Referral Code</div></div>
              <div class="card-body">
                <h5 id="referral-code" class="mb-2">Loading‚Ä¶</h5>
                <button id="copy-referral" class="copy-btn mb-2"><i class="bi bi-clipboard"></i> Copy Code</button>
                <div class="mt-2">
                  <small>Share your link:</small><br />
                  <input type="text" id="referral-link" readonly class="form-control form-control-sm text-center" style="background: var(--accent); color: var(--text);" />
                  <button id="copy-link" class="copy-btn mt-1"><i class="bi bi-link-45deg"></i> Copy Link</button>
                </div>
                <div class="earn-banner mt-3">üéâ Earn <strong>$5</strong> for each successful referral!</div>
                <div class="qr-code mt-3" id="qr-code-container"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <div class="card">
              <div class="card-header"><div><i class="bi bi-cash-stack header-icon"></i>Earnings Summary</div></div>
              <div class="card-body">
                <div class="mb-3"><div class="title">Weekly Earnings</div><div class="value" id="weekly-earnings">$0.00</div></div>
                <div class="mb-3"><div class="title">Monthly Earnings</div><div class="value" id="monthly-earnings">$0.00</div></div>
                <div class="mb-3"><div class="title">All‚ÄëTime Earnings</div><div class="value" id="alltime-earnings">$0.00</div></div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-12">
            <div class="card text-center">
              <div class="card-header"><div><i class="bi bi-arrow-repeat header-icon"></i>Convert Earnings</div></div>
              <div class="card-body">
                <div class="mb-2">
                  <select id="convert-target-currency" class="form-select form-select-sm">
                    <option value="NGN" selected>NGN</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="BTC">BTC</option>
                    <option value="USD">USD</option>
                  </select>
                </div>
                <button id="convert-earn-btn" class="btn btn-primary btn-sm mb-2">Convert</button>
                <div><span id="convert-earn-result" class="text-light">--</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Overview Section -->
      <section id="overview-section" class="mb-5">
        <div class="section-title"><i class="bi bi-speedometer2"></i> Overview</div>
        <div class="overview-cards d-flex gap-3 flex-wrap">
          <div class="overview-card" id="card-total-referrals"><div class="title">Total Referrals</div><div class="value" id="overview-total-referrals">0</div></div>
          <div class="overview-card" id="card-estimated-earnings-usd"><div class="title">Est. Earnings (USD)</div><div class="value" id="overview-est-earn-usd">$0.00</div></div>
          <div class="overview-card" id="card-conversion-rate"><div class="title">Conversion Rate</div><div class="value" id="overview-conversion-rate">0%</div></div>
        </div>
      </section>

      <!-- Referral Activity Section -->
      <section id="referral-activity-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="section-title"><i class="bi bi-graph-up"></i> Referral Activity</div>
          <button id="toggle-referral-range" class="btn btn-outline-secondary btn-sm">Show All Time</button>
        </div>
        <div class="chart-container"><canvas id="referralChart" height="100"></canvas></div>
      </section>

      <!-- Leaderboard Section -->
      <section id="leaderboard-section" class="mb-5">
        <div class="section-title"><i class="bi bi-trophy-fill"></i> Leaderboard: Top Affiliates</div>
        <ul class="leaderboard-list" id="leaderboard-list">
          <li class="text-center text-muted">Loading leaderboard‚Ä¶</li>
        </ul>
      </section>

      <!-- Bank Accounts Section -->
      <section id="bank-accounts-section" class="mb-5">
        <div class="section-title"><i class="bi bi-bank2"></i> Manage Bank Accounts</div>
        <div class="card mb-3">
          <div class="card-header"><div><i class="bi bi-plus-circle header-icon"></i>Add New Bank Account</div></div>
          <div class="card-body">
            <form id="bank-form" class="row g-3">
              <div class="col-md-6"><label for="bank-name" class="form-label">Bank Name</label><input type="text" id="bank-name" class="form-control" placeholder="e.g. First Bank" required /></div>
              <div class="col-md-6"><label for="bank-code" class="form-label">Bank Code/Branch</label><input type="text" id="bank-code" class="form-control" placeholder="e.g. 011" required /></div>
              <div class="col-md-6"><label for="account-number" class="form-label">Account Number</label><input type="text" id="account-number" class="form-control" placeholder="e.g. 0123456789" required /></div>
              <div class="col-md-6"><label for="account-name" class="form-label">Account Name</label><input type="text" id="account-name" class="form-control" placeholder="e.g. John Doe" required /></div>
              <div class="col-12 text-end"><button type="submit" class="btn btn-primary" id="add-bank-btn"><span id="bank-btn-text">Add Account</span><span id="bank-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div><i class="bi bi-file-earmark-text header-icon"></i>Your Saved Bank Accounts</div></div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle text-center mb-0"><thead><tr><th>Bank Name</th><th>Bank Code</th><th>Account Number</th><th>Account Name</th><th>Action</th></tr></thead><tbody id="bank-accounts-body"><tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr></tbody></table></div></div>
        </div>
      </section>

      <!-- Crypto Wallets Section -->
      <section id="crypto-wallets-section" class="mb-5">
        <div class="section-title"><i class="bi bi-currency-bitcoin"></i> Manage Crypto Wallets</div>
        <div class="card mb-3">
          <div class="card-header"><div><i class="bi bi-plus-circle header-icon"></i>Add New Crypto Wallet</div></div>
          <div class="card-body">
            <form id="wallet-form" class="row g-3">
              <div class="col-md-6"><label for="crypto-currency" class="form-label">Currency</label><select id="crypto-currency" class="form-select" required><option value="">Select Currency</option><option value="BTC">Bitcoin (BTC)</option><option value="ETH">Ethereum (ETH)</option><option value="USDT">Tether (USDT)</option><option value="BCH">Bitcoin Cash (BCH)</option><option value="LTC">Litecoin (LTC)</option></select></div>
              <div class="col-md-6"><label for="crypto-address" class="form-label">Wallet Address</label><input type="text" id="crypto-address" class="form-control" placeholder="e.g. 1BoatSLRHtKNngkdXEeobR76b53LETtpyT" required /></div>
              <div class="col-12 text-end"><button type="submit" class="btn btn-primary" id="add-wallet-btn"><span id="wallet-btn-text">Add Wallet</span><span id="wallet-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div><i class="bi bi-wallet-fill header-icon"></i>Your Saved Crypto Wallets</div></div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle text-center mb-0"><thead><tr><th>Currency</th><th>Wallet Address</th><th>Action</th></tr></thead><tbody id="wallets-body"><tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr></tbody></table></div></div>
        </div>
      </section>

      <!-- Currency Converter Section -->
      <section id="currency-converter-section" class="mb-5">
        <div class="section-title"><i class="bi bi-currency-exchange"></i> Currency Converter</div>
        <div class="card">
          <div class="card-header"><div><i class="bi bi-arrow-left-right header-icon"></i>Convert Between Currencies</div></div>
          <div class="card-body">
            <form id="converter-form" class="row g-3 align-items-end">
              <div class="col-md-3"><label for="convert-from" class="form-label">From</label><select id="convert-from" class="form-select"><option value="USD" selected>USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="NGN">NGN</option><option value="BTC">BTC</option></select></div>
              <div class="col-md-3"><label for="convert-to" class="form-label">To</label><select id="convert-to" class="form-select"><option value="NGN" selected>NGN</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="BTC">BTC</option></select></div>
              <div class="col-md-3"><label for="convert-amount" class="form-label">Amount</label><input type="number" id="convert-amount" class="form-control" value="1" min="0" /></div>
              <div class="col-md-3 text-end"><button type="submit" class="btn btn-primary" id="convert-btn"><span id="convert-text">Convert</span><span id="convert-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
              <div class="col-12 text-center mt-3"><h5 id="convert-result">--</h5></div>
            </form>
          </div>
        </div>
      </section>

      <!-- Withdrawals Section -->
      <section id="withdrawals-section" class="mb-5">
        <div class="section-title"><i class="bi bi-cash-stack"></i> Payout Requests</div>
        <div class="withdraw-card mb-3">
          <div class="mb-2" style="font-size: 0.95rem; color: var(--text-light);">You earn <strong>$5</strong> per referral. Request in USD, NGN or receive via crypto.</div>
          <div class="row g-3">
            <div class="col-md-4"><label for="withdraw-amount" class="form-label">Request Amount (USD)</label><input type="number" id="withdraw-amount" class="form-control" placeholder="e.g. 100.00" min="1" step="0.01" /></div>
            <div class="col-md-4"><label for="withdraw-method" class="form-label">Payout Method</label><select id="withdraw-method" class="form-select"><option value="">Select Method</option><option value="bank">Bank Transfer</option><option value="crypto">Crypto Wallet</option><option value="ngn">Naira (NGN Bank)</option></select></div>
            <div class="col-md-4 align-self-end text-end"><button id="request-withdraw-btn" class="btn btn-primary"><span id="withdraw-btn-text">Request Payout</span><span id="withdraw-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span></button></div>
          </div>
        </div>
        <div class="withdraw-card">
          <div class="section-title"><i class="bi bi-list-check"></i> Past Payouts</div>
          <ul class="withdraw-list" id="withdrawals-list">
            <li class="text-center text-muted">Loading payout history‚Ä¶</li>
          </ul>
        </div>
      </section>

      <!-- Profile Section -->
      <section id="profile-section" class="mb-5">
        <div class="section-title"><i class="bi bi-person-circle"></i> Your Profile</div>
        <div class="card">
          <div class="card-body">
            <p><strong>Email:</strong> <span id="user-email">Loading‚Ä¶</span></p>
            <p><strong>Joined On:</strong> <span id="joined-date">--</span></p>
            <p><strong>Total Referrals:</strong> <span id="total-referrals">0</span></p>
            <p><strong>Est. Earnings (USD):</strong> <span id="overview-est-earn-usd-inline">$0.00</span></p>
            <p><strong>Conversion Rate:</strong> <span id="overview-conversion-rate-inline">0%</span></p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body" style="color: var(--text);"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- THEME TOGGLE BUTTON -->
  <div class="theme-toggle-btn" id="theme-toggle-btn">
    <i class="bi bi-sun-fill" id="theme-icon"></i>
  </div>

  <!-- BOOTSTRAP JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- JAVASCRIPT -->
  <script>
    let referralChart = null;
    let chartDataAllTime = { labels: [], counts: [] };
    let chartData30Days = { labels: [], counts: [] };
    const supabase = supabaseClient;

    // Time and Date Update Function
    function updateTimeDate() {
      const now = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };
      const timeDateString = now.toLocaleString('en-US', options);
      document.getElementById('time-date').textContent = timeDateString;
    }

    // Update time every second
    setInterval(updateTimeDate, 1000);
    updateTimeDate(); // Initial call

    function showToast(message) {
      const toastEl = document.getElementById('liveToast');
      document.getElementById('toast-body').textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    function copyTextToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showToast('Copied to clipboard'))
        .catch(() => showToast('Copy failed'));
    }

    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function toUSD(value) {
      return parseFloat(value).toLocaleString(undefined, {
        style: 'currency',
        currency: 'USD',
      });
    }

    function toNGN(value) {
      return parseFloat(value).toLocaleString('en-NG', {
        style: 'currency',
        currency: 'NGN',
      });
    }

    function toCurrency(value, curr) {
      if (curr === 'BTC') {
        return parseFloat(value).toFixed(8) + ' BTC';
      }
      return parseFloat(value).toLocaleString(undefined, {
        style: 'currency',
        currency: curr,
      });
    }

    function varGet(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name);
    }

    function getDateNDaysAgo(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return d;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Fetch affiliate data to set email and joined date
      const { data: affiliate, error: affError } = await supabase
        .from('affiliate_accounts')
        .select('email, created_at')
        .eq('id', affiliateId)
        .single();
      if (affError || !affiliate) {
        window.location.replace('affiliate_login.html');
        return;
      }
      document.getElementById('user-email').textContent = affiliate.email;
      document.getElementById('joined-date').textContent = new Date(affiliate.created_at).toLocaleDateString();

      await fetchReferralCode();
      await fetchTotalReferrals();
      await calculateAndDisplayEarnings();
      await fetchConversionRate();

      document.getElementById('logout-btn').addEventListener('click', async () => {
        localStorage.removeItem('affiliateId');
        window.location.href = 'affiliate_login.html';
      });
      document.getElementById('copy-referral').addEventListener('click', () => {
        const code = document.getElementById('referral-code').textContent;
        if (code && code !== '‚Äî') copyTextToClipboard(code);
      });
      document.getElementById('copy-link').addEventListener('click', () => {
        const link = document.getElementById('referral-link').value;
        if (link) copyTextToClipboard(link);
      });
      document.getElementById
