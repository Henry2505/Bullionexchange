<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard ‚Ä¢ CBE Global</title>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       1) DEPENDENCIES: Bootstrap CSS & Icons, and Supabase JS
  -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    /* ---------------------------------------------------------
       Dark Theme Variables
       --------------------------------------------------------- */
    :root[data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --accent: #1e1e1e;
      --gold: #ffd700;
      --gold-dark: #cca300;
      --glass: rgba(30, 30, 30, 0.7);
      --shadow: rgba(0, 0, 0, 0.5);
    }
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: var(--bg);
      color: var(--text);
      height: 100%;
      font-family: 'Poppins', sans-serif;
    }
    a { color: var(--gold); text-decoration: none; }
    a:hover { color: var(--gold-dark); }

    /* Layout */
    .sidebar {
      background: var(--accent);
      min-height: 100vh;
      padding-top: 1rem;
      border-right: 1px solid var(--gold-dark);
    }
    .sidebar .nav-link {
      color: var(--text) !important;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      transition: background 0.3s ease;
    }
    .sidebar .nav-link.active,
    .sidebar .nav-link:hover {
      background: var(--gold-dark);
      color: #000 !important;
    }
    .main-content {
      padding: 1rem;
      overflow-y: auto;
      height: 100vh;
    }

    /* Cards & Sections */
    .card {
      background: var(--glass);
      border: 1px solid var(--gold-dark);
      border-radius: 10px;
      box-shadow: 0 2px 8px var(--shadow);
      margin-bottom: 1.5rem;
    }
    .card-header {
      background: var(--accent);
      border-bottom: 1px solid var(--gold-dark);
      font-weight: 600;
      color: var(--gold);
    }
    .card-body {
      padding: 1rem;
    }

    /* Form Controls */
    .form-control,
    .form-select {
      background: var(--accent) !important;
      color: var(--text) !important;
      border: 1px solid var(--gold-dark) !important;
    }
    .form-control:focus,
    .form-select:focus {
      background: var(--accent) !important;
      color: var(--text) !important;
      border: 1px solid var(--gold) !important;
      box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25) !important;
    }
    .btn-primary {
      background: linear-gradient(45deg, var(--gold), var(--gold-dark));
      border: none;
      transition: background 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(45deg, var(--gold-dark), var(--gold));
    }
    .btn-outline-danger {
      border-color: var(--gold-dark) !important;
      color: var(--gold) !important;
    }
    .btn-outline-danger:hover {
      background: var(--gold-dark);
      color: #000 !important;
      border-color: var(--gold-dark) !important;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }
    th {
      background: linear-gradient(45deg, var(--gold-dark), var(--gold));
      color: #000 !important;
      padding: 0.8rem;
      border-radius: 6px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    td {
      background: var(--accent);
      padding: 0.8rem;
      border-radius: 6px;
      text-align: center;
    }
    .spinner-border {
      color: var(--gold);
    }

    /* Utility */
    .copy-btn {
      background: var(--gold);
      color: #000 !important;
      border: none;
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    .copy-btn:hover {
      background: var(--gold-dark);
      color: #000 !important;
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 2000;
    }
  </style>
</head>
<body>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       2) AUTH GUARD: Redirect if not logged in
  -->
  <script>
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.'
      + 'eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3Zu'
      + 'ZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOj'
      + 'E3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.'
      + 'ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabaseClient = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // We'll store user info in globals
    let currentUser = null;
    let currentUserId = null;

    // Immediately get the user; if none, redirect to login
    supabaseClient.auth.getUser().then(({ data: { user }, error }) => {
      if (error || !user) {
        window.location.replace('affiliate_login.html');
      } else {
        currentUser = user;
        currentUserId = user.id;
      }
    });
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       3) PAGE LAYOUT:
       ‚Ä¢ Sidebar (Referral Info, Navigation, Logout)
       ‚Ä¢ Main Content (Bank Accounts, Wallets, Converter, Profile)
  -->
  <div class="row g-0">
    <!-- Sidebar -->
    <div class="col-12 col-md-3 sidebar d-flex flex-column">
      <div class="px-3 pb-3">
        <h4 class="text-center">Affiliate Info</h4>
        <div id="referral-section" class="card">
          <div class="card-header">Referral Code</div>
          <div class="card-body text-center">
            <span id="referral-code" class="h5">Loading‚Ä¶</span>
            <button id="copy-referral" class="copy-btn ms-2"><i class="bi bi-clipboard"></i></button>
            <div class="mt-2">
              <small>Share this link:</small><br/>
              <input type="text" id="referral-link" readonly class="form-control form-control-sm text-center" style="background: var(--accent); color: var(--text);" />
              <button id="copy-link" class="copy-btn mt-1"><i class="bi bi-link-45deg"></i> Copy Link</button>
            </div>
          </div>
        </div>
      </div>
      <nav class="nav flex-column px-3 pb-3">
        <a class="nav-link active" href="#bank-accounts-section">üè¶ Bank Accounts</a>
        <a class="nav-link" href="#crypto-wallets-section">üí∞ Crypto Wallets</a>
        <a class="nav-link" href="#currency-converter-section">üí± Converter</a>
        <a class="nav-link" href="#profile-section">üë§ Profile</a>
        <button id="logout-btn" class="btn btn-outline-danger mt-3 w-100">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="col-12 col-md-9 main-content">
      <div class="container-fluid">
        <!-- Bank Accounts Section -->
        <section id="bank-accounts-section" class="mb-5">
          <div class="section-title">üè¶ Manage Bank Accounts</div>
          <!-- Add Bank Account Card -->
          <div class="card mb-3">
            <div class="card-header">Add New Bank Account</div>
            <div class="card-body">
              <form id="bank-form" class="row g-3">
                <div class="col-md-6">
                  <label for="bank-name" class="form-label">Bank Name</label>
                  <input type="text" id="bank-name" class="form-control" placeholder="e.g. First Bank" required />
                </div>
                <div class="col-md-6">
                  <label for="bank-code" class="form-label">Bank Code/Branch</label>
                  <input type="text" id="bank-code" class="form-control" placeholder="e.g. 011" required />
                </div>
                <div class="col-md-6">
                  <label for="account-number" class="form-label">Account Number</label>
                  <input type="text" id="account-number" class="form-control" placeholder="e.g. 0123456789" required />
                </div>
                <div class="col-md-6">
                  <label for="account-name" class="form-label">Account Name</label>
                  <input type="text" id="account-name" class="form-control" placeholder="e.g. John Doe" required />
                </div>
                <div class="col-12 text-end">
                  <button type="submit" class="btn btn-primary" id="add-bank-btn">
                    <span id="bank-btn-text">Add Account</span>
                    <span id="bank-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Existing Bank Accounts Table -->
          <div class="card">
            <div class="card-header">Your Saved Bank Accounts</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table align-middle text-center mb-0">
                  <thead>
                    <tr>
                      <th>Bank Name</th>
                      <th>Bank Code</th>
                      <th>Account Number</th>
                      <th>Account Name</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="bank-accounts-body">
                    <tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Crypto Wallets Section -->
        <section id="crypto-wallets-section" class="mb-5">
          <div class="section-title">üí∞ Manage Crypto Wallets</div>
          <!-- Add Crypto Wallet Card -->
          <div class="card mb-3">
            <div class="card-header">Add New Crypto Wallet</div>
            <div class="card-body">
              <form id="wallet-form" class="row g-3">
                <div class="col-md-6">
                  <label for="crypto-currency" class="form-label">Currency</label>
                  <select id="crypto-currency" class="form-select" required>
                    <option value="">Select Currency</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="USDT">Tether (USDT)</option>
                    <option value="BCH">Bitcoin Cash (BCH)</option>
                    <option value="LTC">Litecoin (LTC)</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="crypto-address" class="form-label">Wallet Address</label>
                  <input type="text" id="crypto-address" class="form-control" placeholder="e.g. 1BoatSLRHtKNngkdXEeobR76b53LETtpyT" required />
                </div>
                <div class="col-12 text-end">
                  <button type="submit" class="btn btn-primary" id="add-wallet-btn">
                    <span id="wallet-btn-text">Add Wallet</span>
                    <span id="wallet-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Existing Crypto Wallets Table -->
          <div class="card">
            <div class="card-header">Your Saved Crypto Wallets</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table align-middle text-center mb-0">
                  <thead>
                    <tr>
                      <th>Currency</th>
                      <th>Wallet Address</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="wallets-body">
                    <tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Currency Converter Section -->
        <section id="currency-converter-section" class="mb-5">
          <div class="section-title">üí± Currency Converter</div>
          <div class="card">
            <div class="card-header">Convert Between Currencies</div>
            <div class="card-body">
              <form id="converter-form" class="row g-3 align-items-end">
                <div class="col-md-3">
                  <label for="convert-from" class="form-label">From</label>
                  <select id="convert-from" class="form-select">
                    <option value="USD" selected>USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="NGN">NGN</option>
                    <option value="BTC">BTC</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="convert-to" class="form-label">To</label>
                  <select id="convert-to" class="form-select">
                    <option value="NGN" selected>NGN</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="BTC">BTC</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="convert-amount" class="form-label">Amount</label>
                  <input type="number" id="convert-amount" class="form-control" value="1" min="0" />
                </div>
                <div class="col-md-3 text-end">
                  <button type="submit" class="btn btn-primary" id="convert-btn">
                    <span id="convert-text">Convert</span>
                    <span id="convert-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                  </button>
                </div>
                <div class="col-12 text-center mt-3">
                  <h5 id="convert-result">--</h5>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="mb-5">
          <div class="section-title">üë§ Your Profile</div>
          <div class="card">
            <div class="card-body">
              <p><strong>Email:</strong> <span id="user-email">Loading‚Ä¶</span></p>
              <p><strong>Joined On:</strong> <span id="joined-date">--</span></p>
              <p>
                <strong>Total Referrals:</strong>
                <span id="total-referrals">0</span> 
                <small class="text-muted">(coming soon)</small>
              </p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body">Hello, world! This is a toast message.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 4) GLOBAL VARIABLES & UTILITY FUNCTIONS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentUser = null;
    let currentUserId = null;
    const supabase = supabaseClient;

    // Show a Bootstrap Toast message
    function showToast(message) {
      const toastEl = document.getElementById('liveToast');
      document.getElementById('toast-body').textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    // Copy text to clipboard with feedback
    function copyTextToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showToast('Copied to clipboard'))
        .catch(() => showToast('Copy failed'));
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 5) ON DOM CONTENT LOADED: Fetch user, then initialize all sections
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', async () => {
      // 5.1) FETCH CURRENT USER & IDs
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr || !user) {
        window.location.replace('affiliate_login.html');
        return;
      }
      currentUser = user;
      currentUserId = user.id;

      // 5.2) DISPLAY USER PROFILE (email, joined date)
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('joined-date').textContent = new Date(user.created_at).toLocaleDateString();

      // 5.3) FETCH & DISPLAY REFERRAL CODE + LINK
      await fetchReferralCode();

      // 5.4) SETUP LOGOUT BUTTON
      document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'affiliate_login.html';
      });

      // 5.5) COPY REFERRAL CODE & LINK
      document.getElementById('copy-referral').addEventListener('click', () => {
        const code = document.getElementById('referral-code').textContent;
        if (code && code !== '‚Äî') copyTextToClipboard(code);
      });
      document.getElementById('copy-link').addEventListener('click', () => {
        const link = document.getElementById('referral-link').value;
        if (link) copyTextToClipboard(link);
      });

      // 5.6) LOAD BANK ACCOUNTS
      await loadBankAccounts();

      // 5.7) LOAD CRYPTO WALLETS
      await loadWallets();

      // 5.8) SETUP ADD BANK ACCOUNT FORM HANDLER
      document.getElementById('bank-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bankName = document.getElementById('bank-name').value.trim();
        const bankCode = document.getElementById('bank-code').value.trim();
        const accountNumber = document.getElementById('account-number').value.trim();
        const accountName = document.getElementById('account-name').value.trim();
        if (!bankName || !bankCode || !accountNumber || !accountName) {
          showToast('Please fill in all bank fields.');
          return;
        }
        const bankBtn = document.getElementById('add-bank-btn');
        const bankText = document.getElementById('bank-btn-text');
        const bankSpinner = document.getElementById('bank-spinner');
        bankBtn.setAttribute('disabled', true);
        bankText.textContent = 'Adding‚Ä¶';
        bankSpinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_bank_accounts')
            .insert([{ user_id: currentUserId, bank_name: bankName, bank_code: bankCode, account_number: accountNumber, account_name: accountName }]);
          if (error) throw error;
          showToast('Bank account added!');
          document.getElementById('bank-form').reset();
          await loadBankAccounts();
        } catch (err) {
          console.error('Bank insert error:', err);
          showToast('Failed to add bank account.');
        } finally {
          bankBtn.removeAttribute('disabled');
          bankText.textContent = 'Add Account';
          bankSpinner.style.display = 'none';
        }
      });

      // 5.9) SETUP ADD WALLET FORM HANDLER
      document.getElementById('wallet-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currency = document.getElementById('crypto-currency').value;
        const address = document.getElementById('crypto-address').value.trim();
        if (!currency || !address) {
          showToast('Please select currency and enter address.');
          return;
        }
        const walletBtn = document.getElementById('add-wallet-btn');
        const walletText = document.getElementById('wallet-btn-text');
        const walletSpinner = document.getElementById('wallet-spinner');
        walletBtn.setAttribute('disabled', true);
        walletText.textContent = 'Adding‚Ä¶';
        walletSpinner.style.display = 'inline-block';
        try {
          const { error } = await supabase
            .from('affiliate_wallets')
            .insert([{ user_id: currentUserId, currency: currency, address: address }]);
          if (error) throw error;
          showToast('Wallet added!');
          document.getElementById('wallet-form').reset();
          await loadWallets();
        } catch (err) {
          console.error('Wallet insert error:', err);
          showToast('Failed to add wallet.');
        } finally {
          walletBtn.removeAttribute('disabled');
          walletText.textContent = 'Add Wallet';
          walletSpinner.style.display = 'none';
        }
      });

      // 5.10) SETUP CONVERTER FORM HANDLER
      document.getElementById('converter-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const from = document.getElementById('convert-from').value;
        const to = document.getElementById('convert-to').value;
        const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
        document.getElementById('convert-text').textContent = 'Converting‚Ä¶';
        document.getElementById('convert-spinner').style.display = 'inline-block';
        try {
          // Replace YOUR_API_KEY with your real key
          const response = await fetch(`https://v6.exchangerate-api.com/v6/YOUR_API_KEY/latest/${from}`);
          const data = await response.json();
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          const rate = data.conversion_rates[to];
          if (!rate) {
            showToast(`Conversion rate ${from}‚Üí${to} not available.`);
            document.getElementById('convert-result').textContent = '--';
          } else {
            const converted = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 });
            document.getElementById('convert-result').textContent = `${amount} ${from} = ${converted} ${to}`;
          }
        } catch (err) {
          console.error('Conversion error:', err);
          showToast('Currency conversion failed.');
          document.getElementById('convert-result').textContent = '--';
        } finally {
          document.getElementById('convert-text').textContent = 'Convert';
          document.getElementById('convert-spinner').style.display = 'none';
        }
      });
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 6) FETCH REFERRAL CODE & SET LINK
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function fetchReferralCode() {
      const refSpan = document.getElementById('referral-code');
      const linkInput = document.getElementById('referral-link');
      refSpan.textContent = 'Loading‚Ä¶';

      const { data, error } = await supabase
        .from('affiliates')
        .select('referral_code')
        .eq('user_id', currentUserId)
        .single();

      if (error || !data) {
        console.error('Failed to load affiliate data:', error);
        refSpan.textContent = '‚Äî';
      } else {
        const code = data.referral_code;
        refSpan.textContent = code;
        linkInput.value = `${window.location.origin}/?ref=${code}`;
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 7) LOAD BANK ACCOUNTS: Fetch & Render
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadBankAccounts() {
      const tbody = document.getElementById('bank-accounts-body');
      tbody.innerHTML = `<tr><td colspan="5"><div class="text-center spinner-border"></div></td></tr>`;

      const { data, error } = await supabase
        .from('affiliate_bank_accounts')
        .select('*')
        .eq('user_id', currentUserId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Fetch bank accounts error:', error);
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--gold);">Failed to load bank accounts.</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="color: var(--text);">No bank accounts added yet.</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      data.forEach((acct) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${acct.bank_name}</td>
          <td>${acct.bank_code}</td>
          <td>${acct.account_number}</td>
          <td>${acct.account_name}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteBankAccount('${acct.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 8) DELETE BANK ACCOUNT
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function deleteBankAccount(id) {
      if (!confirm('Delete this bank account?')) return;
      const { error } = await supabase
        .from('affiliate_bank_accounts')
        .delete()
        .eq('id', id);
      if (error) {
        console.error('Delete bank error:', error);
        showToast('Failed to delete bank account.');
      } else {
        showToast('Bank account deleted.');
        await loadBankAccounts();
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 9) LOAD CRYPTO WALLETS: Fetch & Render
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadWallets() {
      const tbody = document.getElementById('wallets-body');
      tbody.innerHTML = `<tr><td colspan="3"><div class="text-center spinner-border"></div></td></tr>`;

      const { data, error } = await supabase
        .from('affiliate_wallets')
        .select('*')
        .eq('user_id', currentUserId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Fetch wallets error:', error);
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--gold);">Failed to load wallets.</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="color: var(--text);">No wallets added yet.</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      data.forEach((w) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${w.currency}</td>
          <td>${w.address}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteWallet('${w.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 10) DELETE WALLET
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function deleteWallet(id) {
      if (!confirm('Delete this wallet?')) return;
      const { error } = await supabase
        .from('affiliate_wallets')
        .delete()
        .eq('id', id);
      if (error) {
        console.error('Delete wallet error:', error);
        showToast('Failed to delete wallet.');
      } else {
        showToast('Wallet deleted.');
        await loadWallets();
      }
    }
  </script>
</body>
</html>
