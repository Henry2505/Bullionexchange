<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Dashboard â€¢ Apex Income Options</title>
  <meta name="description" content="Track your referrals, earnings, and manage your affiliate account with Apex Income Options">

  <!-- Dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <!-- Custom Styles -->
  <style>
    :root {
      --background: #121212; /* Dark background */
      --card-bg: #1e1e1e; /* Card background */
      --accent: #FFD700; /* Gold accent */
      --text: #FFFFFF; /* White text */
      --text-secondary: #E0E0E0; /* Light grey for secondary text */
      --border: #333333; /* Border color */
      --shadow: rgba(255, 215, 0, 0.15); /* Subtle gold shadow */
    }

    body {
      background-color: var(--background);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
    }

    h1, h2, h3, h4, h5, h6 {
      color: var(--accent);
    }

    .sidebar {
      background-color: var(--card-bg);
      color: var(--text);
      height: 100vh;
      position: fixed;
      width: 250px;
      transition: transform 0.3s ease;
      z-index: 1000;
      box-shadow: 3px 0 10px rgba(0,0,0,0.3);
    }

    .main-content {
      background-color: var(--background);
      margin-left: 250px;
      padding: 20px;
    }

    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(255,215,0,0.2);
    }

    .card-header {
      background-color: rgba(255, 215, 0, 0.15);
      color: var(--accent);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      padding: 15px 20px;
    }

    .btn-primary {
      background-color: var(--accent);
      border-color: var(--accent);
      color: #000;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background-color: #e6c200;
      border-color: #e6c200;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255,215,0,0.3);
    }

    .btn-outline-secondary {
      color: var(--accent);
      border-color: var(--accent);
    }

    .btn-outline-secondary:hover {
      background-color: rgba(255, 215, 0, 0.1);
    }

    .nav-link {
      color: var(--text);
      padding: 12px 20px;
      margin: 5px 0;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 215, 0, 0.1);
      color: var(--accent);
    }

    .section-title {
      color: var(--accent);
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
      display: inline-block;
    }

    .overview-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      padding: 1.5rem;
      text-align: center;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .overview-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }

    .overview-card .title {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .overview-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }

    .earn-banner {
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
      color: var(--accent);
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      margin-top: 15px;
      border: 1px solid rgba(255,215,0,0.3);
    }

    .chart-container {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: 10px;
    }

    .table {
      color: var(--text);
      border-color: var(--border);
    }

    .table thead th {
      background-color: rgba(255, 215, 0, 0.1);
      color: var(--accent);
      border-color: var(--border);
    }

    .table tbody tr {
      transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: rgba(255, 215, 0, 0.05);
    }

    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text);
      border-color: var(--accent);
      box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
    }

    .text-muted {
      color: var(--text-secondary) !important;
    }

    .spinner-border {
      color: var(--accent);
    }

    .toast {
      background-color: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--accent);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .theme-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--accent);
      color: #000;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 100;
      transition: all 0.3s ease;
    }

    .theme-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(255,215,0,0.4);
    }

    #sidebar-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      color: var(--accent);
      cursor: pointer;
      z-index: 1050;
      background: rgba(30, 30, 30, 0.8);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    #date-time {
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 50px;
      border: 1px solid var(--border);
      margin-bottom: 25px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .leaderboard-list {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 0;
      overflow: hidden;
    }

    .leaderboard-list li {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .leaderboard-list li:last-child {
      border-bottom: none;
    }

    .leaderboard-list li:nth-child(1) {
      background: rgba(255, 215, 0, 0.1);
    }

    .leaderboard-list li:nth-child(2) {
      background: rgba(255, 215, 0, 0.07);
    }

    .leaderboard-list li:nth-child(3) {
      background: rgba(255, 215, 0, 0.04);
    }

    .qr-code-container {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }

    .qr-code-container img {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 5px;
      background: white;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-250px);
      }
      .sidebar.expanded {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Guard -->
  <script>
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabaseClient = window.supabase.createClient(SUPA_URL, SUPA_KEY);
    const affiliateId = localStorage.getItem('affiliateId');
    if (!affiliateId) {
      window.location.replace('affiliate_login.html');
      throw new Error('No affiliateId in localStorage');
    }
  </script>

  <!-- Sidebar Toggle -->
  <div id="sidebar-toggle" title="Toggle Menu">
    <i class="bi bi-list" style="font-size: 1.5rem;"></i>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="px-3 pb-3 pt-4">
      <h4 class="sidebar-title text-center mb-4" style="color: var(--accent);">Affiliate Dashboard</h4>
    </div>
    <nav class="nav flex-column px-3 pb-3">
      <a class="nav-link active" href="#overview-section"><i class="bi bi-house-door me-2"></i> Overview</a>
      <a class="nav-link" href="#referral-section-main"><i class="bi bi-people me-2"></i> Referral Dashboard</a>
      <a class="nav-link" href="#referral-activity-section"><i class="bi bi-graph-up me-2"></i> Referral Activity</a>
      <a class="nav-link" href="#leaderboard-section"><i class="bi bi-trophy me-2"></i> Leaderboard</a>
      <a class="nav-link" href="#bank-accounts-section"><i class="bi bi-bank me-2"></i> Bank Accounts</a>
      <a class="nav-link" href="#crypto-wallets-section"><i class="bi bi-wallet me-2"></i> Crypto Wallets</a>
      <a class="nav-link" href="#currency-converter-section"><i class="bi bi-currency-exchange me-2"></i> Converter</a>
      <a class="nav-link" href="#withdrawals-section"><i class="bi bi-cash-coin me-2"></i> Payouts</a>
      <a class="nav-link" href="#profile-section"><i class="bi bi-person-circle me-2"></i> Profile</a>
      <button id="logout-btn" class="btn btn-outline-danger mt-4 w-100">
        <i class="bi bi-box-arrow-right me-2"></i> Logout
      </button>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <div class="container-fluid">
      <!-- Date and Time -->
      <div id="date-time" class="text-center mb-4"></div>

      <!-- Overview -->
      <section id="overview-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-speedometer2 me-2"></i> Overview</h2>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="overview-card">
              <div class="title">Total Referrals</div>
              <div class="value" id="overview-total-referrals">0</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="overview-card">
              <div class="title">Est. Earnings (USD)</div>
              <div class="value" id="overview-est-earn-usd">$0.00</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="overview-card">
              <div class="title">Conversion Rate</div>
              <div class="value" id="overview-conversion-rate">0%</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Referral Dashboard -->
      <section id="referral-section-main" class="mb-5">
        <h2 class="section-title"><i class="bi bi-people-fill me-2"></i> Your Referral Dashboard</h2>
        <div class="row g-4">
          <div class="col-lg-4 col-md-6">
            <div class="card h-100">
              <div class="card-header"><i class="bi bi-people-fill me-2"></i> Referral Code</div>
              <div class="card-body">
                <h5 id="referral-code" class="mb-3 text-center fw-bold" style="font-size: 1.8rem; letter-spacing: 2px;">Loadingâ€¦</h5>
                <button id="copy-referral" class="btn btn-primary w-100 mb-3"><i class="bi bi-clipboard me-2"></i> Copy Code</button>
                <div class="mt-4">
                  <label class="form-label">Share your referral link:</label>
                  <div class="input-group">
                    <input type="text" id="referral-link" readonly class="form-control" />
                    <button id="copy-link" class="btn btn-primary"><i class="bi bi-link-45deg"></i></button>
                  </div>
                </div>
                <div class="earn-banner mt-4 text-center">
                  <i class="bi bi-gift-fill me-2"></i> Earn <strong>$5</strong> per successful referral!
                </div>
                <div class="qr-code mt-4 text-center">
                  <div class="mb-2">Scan QR Code:</div>
                  <div class="qr-code-container" id="qr-code-container"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <div class="card h-100">
              <div class="card-header"><i class="bi bi-cash-stack me-2"></i> Earnings Summary</div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4 p-3 rounded" style="background: rgba(255,215,0,0.05);">
                  <div>
                    <div class="title" style="color: var(--text-secondary);">Weekly Earnings</div>
                    <div class="value fw-bold" id="weekly-earnings">$0.00</div>
                  </div>
                  <i class="bi bi-calendar-week" style="font-size: 1.8rem; color: var(--accent);"></i>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-4 p-3 rounded" style="background: rgba(255,215,0,0.05);">
                  <div>
                    <div class="title" style="color: var(--text-secondary);">Monthly Earnings</div>
                    <div class="value fw-bold" id="monthly-earnings">$0.00</div>
                  </div>
                  <i class="bi bi-calendar-month" style="font-size: 1.8rem; color: var(--accent);"></i>
                </div>
                
                <div class="d-flex justify-content-between align-items-center p-3 rounded" style="background: rgba(255,215,0,0.05);">
                  <div>
                    <div class="title" style="color: var(--text-secondary);">All-Time Earnings</div>
                    <div class="value fw-bold" id="alltime-earnings">$0.00</div>
                  </div>
                  <i class="bi bi-graph-up-arrow" style="font-size: 1.8rem; color: var(--accent);"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-12">
            <div class="card h-100">
              <div class="card-header"><i class="bi bi-arrow-repeat me-2"></i> Convert Earnings</div>
              <div class="card-body d-flex flex-column">
                <div class="mb-4">
                  <label class="form-label">Select target currency:</label>
                  <select id="convert-target-currency" class="form-select">
                    <option value="NGN" selected>Nigerian Naira (NGN)</option>
                    <option value="EUR">Euro (EUR)</option>
                    <option value="GBP">British Pound (GBP)</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="USD">US Dollar (USD)</option>
                  </select>
                </div>
                
                <div class="mt-auto">
                  <button id="convert-earn-btn" class="btn btn-primary w-100 mb-3">Convert Now</button>
                  <div class="text-center p-3 rounded" style="background: rgba(255,215,0,0.05);">
                    <div class="text-muted mb-1">Converted Amount</div>
                    <div id="convert-earn-result" class="fw-bold" style="font-size: 1.5rem; color: var(--accent);">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Referral Activity -->
      <section id="referral-activity-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="section-title"><i class="bi bi-graph-up me-2"></i> Referral Activity</h2>
          <button id="toggle-referral-range" class="btn btn-outline-secondary">Show All Time</button>
        </div>
        <div class="chart-container">
          <canvas id="referralChart" height="120"></canvas>
        </div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboard-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-trophy-fill me-2"></i> Leaderboard: Top Affiliates</h2>
        <ul class="leaderboard-list" id="leaderboard-list">
          <li class="text-center text-muted py-4">Loading leaderboardâ€¦</li>
        </ul>
      </section>

      <!-- Bank Accounts -->
      <section id="bank-accounts-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-bank2 me-2"></i> Manage Bank Accounts</h2>
        <div class="card mb-4">
          <div class="card-header"><i class="bi bi-plus-circle me-2"></i> Add New Bank Account</div>
          <div class="card-body">
            <form id="bank-form" class="row g-3">
              <div class="col-md-6">
                <label for="bank-name" class="form-label">Bank Name</label>
                <input type="text" id="bank-name" class="form-control" placeholder="e.g. First Bank" required />
              </div>
              <div class="col-md-6">
                <label for="bank-code" class="form-label">Bank Code/Branch</label>
                <input type="text" id="bank-code" class="form-control" placeholder="e.g. 011" required />
              </div>
              <div class="col-md-6">
                <label for="account-number" class="form-label">Account Number</label>
                <input type="text" id="account-number" class="form-control" placeholder="e.g. 0123456789" required />
              </div>
              <div class="col-md-6">
                <label for="account-name" class="form-label">Account Name</label>
                <input type="text" id="account-name" class="form-control" placeholder="e.g. John Doe" required />
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary px-4" id="add-bank-btn">
                  <span id="bank-btn-text">Add Account</span>
                  <span id="bank-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><i class="bi bi-file-earmark-text me-2"></i> Your Saved Bank Accounts</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Bank Name</th>
                    <th>Bank Code</th>
                    <th>Account Number</th>
                    <th>Account Name</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="bank-accounts-body">
                  <tr>
                    <td colspan="5">
                      <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Crypto Wallets -->
      <section id="crypto-wallets-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-currency-bitcoin me-2"></i> Manage Crypto Wallets</h2>
        <div class="card mb-4">
          <div class="card-header"><i class="bi bi-plus-circle me-2"></i> Add New Crypto Wallet</div>
          <div class="card-body">
            <form id="wallet-form" class="row g-3">
              <div class="col-md-6">
                <label for="crypto-currency" class="form-label">Currency</label>
                <select id="crypto-currency" class="form-select" required>
                  <option value="">Select Currency</option>
                  <option value="BTC">Bitcoin (BTC)</option>
                  <option value="ETH">Ethereum (ETH)</option>
                  <option value="USDT">Tether (USDT)</option>
                  <option value="BCH">Bitcoin Cash (BCH)</option>
                  <option value="LTC">Litecoin (LTC)</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="crypto-address" class="form-label">Wallet Address</label>
                <input type="text" id="crypto-address" class="form-control" placeholder="e.g. 1BoatSLRHtKNngkdXEeobR76b53LETtpyT" required />
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary px-4" id="add-wallet-btn">
                  <span id="wallet-btn-text">Add Wallet</span>
                  <span id="wallet-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><i class="bi bi-wallet-fill me-2"></i> Your Saved Crypto Wallets</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Currency</th>
                    <th>Wallet Address</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="wallets-body">
                  <tr>
                    <td colspan="3">
                      <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Currency Converter -->
      <section id="currency-converter-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-currency-exchange me-2"></i> Currency Converter</h2>
        <div class="card">
          <div class="card-header"><i class="bi bi-arrow-left-right me-2"></i> Convert Between Currencies</div>
          <div class="card-body">
            <form id="converter-form" class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="convert-from" class="form-label">From</label>
                <select id="convert-from" class="form-select">
                  <option value="USD" selected>USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="NGN">NGN</option>
                  <option value="BTC">BTC</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="convert-to" class="form-label">To</label>
                <select id="convert-to" class="form-select">
                  <option value="NGN" selected>NGN</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="BTC">BTC</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="convert-amount" class="form-label">Amount</label>
                <input type="number" id="convert-amount" class="form-control" value="1" min="0" step="0.01" />
              </div>
              <div class="col-md-3 text-end">
                <button type="submit" class="btn btn-primary px-4" id="convert-btn">
                  <span id="convert-text">Convert</span>
                  <span id="convert-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
              <div class="col-12 mt-4">
                <div class="text-center p-4 rounded" style="background: rgba(255,215,0,0.05);">
                  <div class="text-muted mb-2">Conversion Result</div>
                  <h3 id="convert-result" class="fw-bold" style="color: var(--accent);">--</h3>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Payout Requests -->
      <section id="withdrawals-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-cash-stack me-2"></i> Payout Requests</h2>
        <div class="card mb-4">
          <div class="card-body">
            <div class="alert alert-warning bg-transparent border-warning mb-4">
              <i class="bi bi-info-circle me-2"></i> You earn <strong>$5</strong> per referral. Request in USD, NGN, or crypto.
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="withdraw-amount" class="form-label">Request Amount (USD)</label>
                <input type="number" id="withdraw-amount" class="form-control" placeholder="e.g. 100.00" min="1" step="0.01" />
              </div>
              <div class="col-md-4">
                <label for="withdraw-method" class="form-label">Payout Method</label>
                <select id="withdraw-method" class="form-select">
                  <option value="">Select Method</option>
                  <option value="bank">Bank Transfer</option>
                  <option value="crypto">Crypto Wallet</option>
                  <option value="ngn">Naira (NGN Bank)</option>
                </select>
              </div>
              <div class="col-md-4 align-self-end text-end">
                <button id="request-withdraw-btn" class="btn btn-primary px-4">
                  <span id="withdraw-btn-text">Request Payout</span>
                  <span id="withdraw-spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><i class="bi bi-list-check me-2"></i> Past Payouts</div>
          <div class="card-body">
            <ul class="list-unstyled mb-0" id="withdrawals-list">
              <li class="text-center text-muted py-4">Loading payout historyâ€¦</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile-section" class="mb-5">
        <h2 class="section-title"><i class="bi bi-person-circle me-2"></i> Your Profile</h2>
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-4">
                  <div class="text-muted">Email:</div>
                  <div class="fw-bold" id="user-email">Loadingâ€¦</div>
                </div>
                <div class="mb-4">
                  <div class="text-muted">Joined On:</div>
                  <div class="fw-bold" id="joined-date">--</div>
                </div>
                <div>
                  <div class="text-muted">Conversion Rate:</div>
                  <div class="fw-bold" id="overview-conversion-rate-inline">0%</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-4">
                  <div class="text-muted">Total Referrals:</div>
                  <div class="fw-bold" id="total-referrals">0</div>
                </div>
                <div>
                  <div class="text-muted">Est. Earnings (USD):</div>
                  <div class="fw-bold" id="overview-est-earn-usd-inline">$0.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Theme Toggle Button -->
  <div class="theme-toggle-btn" id="theme-toggle-btn">
    <i class="bi bi-sun-fill" id="theme-icon"></i>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- JavaScript -->
  <script>
    const supabase = supabaseClient;
    let referralChart = null;
    let chartDataAllTime = { labels: [], counts: [] };
    let chartData30Days = { labels: [], counts: [] };

    function showToast(message, isError = false) {
      const toastEl = document.getElementById('liveToast');
      const toastBody = document.getElementById('toast-body');
      
      toastBody.textContent = message;
      
      if (isError) {
        toastEl.style.borderColor = '#dc3545';
      } else {
        toastEl.style.borderColor = '#FFD700';
      }
      
      new bootstrap.Toast(toastEl).show();
    }

    function copyTextToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!');
      }).catch(() => {
        showToast('Copy failed. Please try again.', true);
      });
    }

    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }

    function toUSD(value) {
      return parseFloat(value).toLocaleString(undefined, { 
        style: 'currency', 
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function toCurrency(value, curr) {
      if (curr === 'BTC') return parseFloat(value).toFixed(8) + ' BTC';
      return parseFloat(value).toLocaleString(undefined, { 
        style: 'currency', 
        currency: curr,
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function getDateNDaysAgo(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return d;
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('date-time').textContent = now.toLocaleString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
        hour: 'numeric', minute: 'numeric', second: 'numeric'
      });
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: affiliate, error } = await supabase.from('affiliate_accounts').select('email, created_at').eq('id', affiliateId).single();
      if (error || !affiliate) {
        window.location.replace('affiliate_login.html');
        return;
      }
      document.getElementById('user-email').textContent = affiliate.email;
      document.getElementById('joined-date').textContent = new Date(affiliate.created_at).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      await fetchReferralCode();
      await fetchTotalReferrals();
      await calculateAndDisplayEarnings();
      await fetchConversionRate();
      await loadBankAccounts();
      await loadWallets();
      await loadPayouts();
      await loadReferralChartData();
      await renderReferralChart('30days');
      await loadLeaderboard();

      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('affiliateId');
        window.location.href = 'affiliate_login.html';
      });

      document.getElementById('copy-referral').addEventListener('click', () => copyTextToClipboard(document.getElementById('referral-code').textContent));
      document.getElementById('copy-link').addEventListener('click', () => copyTextToClipboard(document.getElementById('referral-link').value));

      document.getElementById('bank-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bankName = document.getElementById('bank-name').value.trim();
        const bankCode = document.getElementById('bank-code').value.trim();
        const accountNumber = document.getElementById('account-number').value.trim();
        const accountName = document.getElementById('account-name').value.trim();
        if (!bankName || !bankCode || !accountNumber || !accountName) return showToast('Please fill in all bank fields.', true);
        
        const btn = document.getElementById('add-bank-btn');
        btn.disabled = true;
        document.getElementById('bank-btn-text').textContent = 'Addingâ€¦';
        document.getElementById('bank-spinner').style.display = 'inline-block';
        
        try {
          const { error } = await supabase.from('affiliate_bank_accounts').insert([{ 
            affiliate_id: affiliateId, 
            bank_name: bankName, 
            bank_code: bankCode, 
            account_number: accountNumber, 
            account_name: accountName 
          }]);
          
          if (error) throw error;
          showToast('Bank account added successfully!');
          document.getElementById('bank-form').reset();
          await loadBankAccounts();
        } catch (err) {
          showToast('Failed to add bank account. Please try again.', true);
        } finally {
          btn.disabled = false;
          document.getElementById('bank-btn-text').textContent = 'Add Account';
          document.getElementById('bank-spinner').style.display = 'none';
        }
      });

      document.getElementById('wallet-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currency = document.getElementById('crypto-currency').value;
        const address = document.getElementById('crypto-address').value.trim();
        if (!currency || !address) return showToast('Please select currency and enter address.', true);
        
        const btn = document.getElementById('add-wallet-btn');
        btn.disabled = true;
        document.getElementById('wallet-btn-text').textContent = 'Addingâ€¦';
        document.getElementById('wallet-spinner').style.display = 'inline-block';
        
        try {
          const { error } = await supabase.from('affiliate_wallets').insert([{ 
            affiliate_id: affiliateId, 
            currency, 
            address 
          }]);
          
          if (error) throw error;
          showToast('Wallet added successfully!');
          document.getElementById('wallet-form').reset();
          await loadWallets();
        } catch (err) {
          showToast('Failed to add wallet. Please try again.', true);
        } finally {
          btn.disabled = false;
          document.getElementById('wallet-btn-text').textContent = 'Add Wallet';
          document.getElementById('wallet-spinner').style.display = 'none';
        }
      });

      document.getElementById('converter-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const from = document.getElementById('convert-from').value;
        const to = document.getElementById('convert-to').value;
        const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
        
        if (amount <= 0) return showToast('Please enter a valid amount.', true);
        
        document.getElementById('convert-text').textContent = 'Convertingâ€¦';
        document.getElementById('convert-spinner').style.display = 'inline-block';
        
        try {
          const response = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/${from}`);
          const data = await response.json();
          
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          
          const rate = data.conversion_rates[to];
          if (!rate) {
            showToast(`Conversion rate for ${from} to ${to} not available.`, true);
            document.getElementById('convert-result').textContent = '--';
          } else {
            const converted = (amount * rate).toLocaleString(undefined, { 
              minimumFractionDigits: 2, 
              maximumFractionDigits: 8 
            });
            document.getElementById('convert-result').textContent = `${amount} ${from} = ${converted} ${to}`;
          }
        } catch (err) {
          showToast('Currency conversion failed. Please try again.', true);
          document.getElementById('convert-result').textContent = '--';
        } finally {
          document.getElementById('convert-text').textContent = 'Convert';
          document.getElementById('convert-spinner').style.display = 'none';
        }
      });

      document.getElementById('request-withdraw-btn').addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const method = document.getElementById('withdraw-method').value;
        
        if (!amount || amount <= 0) return showToast('Enter a valid withdrawal amount.', true);
        if (!method) return showToast('Select a payout method.', true);
        
        document.getElementById('withdraw-btn-text').textContent = 'Requestingâ€¦';
        document.getElementById('withdraw-spinner').style.display = 'inline-block';
        
        try {
          const { error } = await supabase.from('affiliate_payouts').insert([{ 
            affiliate_id: affiliateId, 
            amount, 
            method, 
            status: 'pending', 
            requested_at: new Date().toISOString()
          }]);
          
          if (error) throw error;
          showToast('Payout requested successfully!');
          document.getElementById('withdraw-amount').value = '';
          document.getElementById('withdraw-method').value = '';
          await loadPayouts();
        } catch (err) {
          showToast('Failed to request payout. Please try again.', true);
        } finally {
          document.getElementById('withdraw-btn-text').textContent = 'Request Payout';
          document.getElementById('withdraw-spinner').style.display = 'none';
        }
      });

      document.getElementById('toggle-referral-range').addEventListener('click', () => {
        const btn = document.getElementById('toggle-referral-range');
        if (btn.textContent.includes('All Time')) {
          renderReferralChart('alltime');
          btn.textContent = 'Show Last 30 Days';
        } else {
          renderReferralChart('30days');
          btn.textContent = 'Show All Time';
        }
      });

      document.getElementById('convert-earn-btn').addEventListener('click', async () => {
        const targetCurr = document.getElementById('convert-target-currency').value;
        const usdAmount = window.currentEarningsUSD || 0;
        
        if (usdAmount <= 0) return showToast('No earnings to convert.', true);
        
        const resultEl = document.getElementById('convert-earn-result');
        resultEl.textContent = 'Convertingâ€¦';
        
        try {
          if (targetCurr === 'USD') {
            resultEl.textContent = toUSD(usdAmount);
            return;
          }
          
          const resp = await fetch(`https://v6.exchangerate-api.com/v6/4e4307b2bf8daac15365a410/latest/USD`);
          const data = await resp.json();
          
          if (data.result !== 'success') throw new Error('Failed to fetch rates');
          
          const rate = data.conversion_rates[targetCurr];
          if (!rate) {
            showToast(`Conversion rate for USD to ${targetCurr} not available.`, true);
            resultEl.textContent = '--';
          } else {
            resultEl.textContent = toCurrency(usdAmount * rate, targetCurr);
          }
        } catch (err) {
          showToast('Earnings conversion failed. Please try again.', true);
          resultEl.textContent = '--';
        }
      });

      setupThemeToggle();
      setupSidebarToggle();
    });

    async function fetchReferralCode() {
      const refSpan = document.getElementById('referral-code');
      const linkInput = document.getElementById('referral-link');
      refSpan.textContent = 'Loadingâ€¦';
      
      const { data, error } = await supabase.from('affiliate_accounts').select('referral_code').eq('id', affiliateId).single();
      
      if (error) {
        refSpan.textContent = 'â€”';
        return;
      }
      
      let code = data?.referral_code;
      if (!code) {
        code = generateReferralCode();
        const { error: updateErr } = await supabase.from('affiliate_accounts').update({ referral_code: code }).eq('id', affiliateId);
        if (updateErr) {
          refSpan.textContent = 'â€”';
          return;
        }
      }
      
      refSpan.textContent = code;
      const fullLink = `${window.location.origin}/CBE_apply.html?ref=${code}`;
      linkInput.value = fullLink;
      
      const qrContainer = document.getElementById('qr-code-container');
      qrContainer.innerHTML = '';
      const qr = document.createElement('img');
      qr.src = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${encodeURIComponent(fullLink)}`;
      qr.alt = 'Referral QR Code';
      qr.classList.add('img-fluid');
      qrContainer.appendChild(qr);
    }

    async function fetchTotalReferrals() {
      const { count, error } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId);
      
      if (error) {
        document.getElementById('total-referrals').textContent = 'â€”';
        document.getElementById('overview-total-referrals').textContent = 'â€”';
      } else {
        const total = count || 0;
        document.getElementById('total-referrals').textContent = total;
        document.getElementById('overview-total-referrals').textContent = total;
      }
    }

    async function calculateAndDisplayEarnings() {
      const totalRefs = parseInt(document.getElementById('overview-total-referrals').textContent) || 0;
      const usdEarnings = totalRefs * 5;
      
      document.getElementById('overview-est-earn-usd').textContent = toUSD(usdEarnings);
      document.getElementById('overview-est-earn-usd-inline').textContent = toUSD(usdEarnings);
      window.currentEarningsUSD = usdEarnings;
      document.getElementById('alltime-earnings').textContent = toUSD(usdEarnings);

      const { count: wCount } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId).gt('created_at', getDateNDaysAgo(7).toISOString());
      document.getElementById('weekly-earnings').textContent = toUSD((wCount || 0) * 5);

      const { count: mCount } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId).gt('created_at', getDateNDaysAgo(30).toISOString());
      document.getElementById('monthly-earnings').textContent = toUSD((mCount || 0) * 5);
    }

    async function fetchConversionRate() {
      const { count: totalRefCount } = await supabase.from('referrals').select('*', { count: 'exact', head: true }).eq('affiliate_id', affiliateId);
      const { count: convertedCount } = await supabase.from('referrals').select('converted', { count: 'exact', head: true }).eq('affiliate_id', affiliateId).eq('converted', true);
      
      const rateText = totalRefCount > 0 ? `${((convertedCount / totalRefCount) * 100).toFixed(2)}%` : '0%';
      document.getElementById('overview-conversion-rate').textContent = rateText;
      document.getElementById('overview-conversion-rate-inline').textContent = rateText;
    }

    async function loadReferralChartData() {
      const { data: rawReferrals, error } = await supabase.from('referrals').select('created_at').eq('affiliate_id', affiliateId);
      if (error) return;
      
      const allMap = {}, last30Map = {};
      
      rawReferrals.forEach(r => {
        const key = new Date(r.created_at).toISOString().split('T')[0];
        allMap[key] = (allMap[key] || 0) + 1;
        if (new Date(r.created_at) >= getDateNDaysAgo(30)) last30Map[key] = (last30Map[key] || 0) + 1;
      });
      
      chartDataAllTime.labels = Object.keys(allMap).sort((a, b) => new Date(a) - new Date(b));
      chartDataAllTime.counts = chartDataAllTime.labels.map(d => allMap[d]);
      
      chartData30Days.labels = Array.from({ length: 30 }, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (29 - i));
        return d.toISOString().split('T')[0];
      });
      
      chartData30Days.counts = chartData30Days.labels.map(k => last30Map[k] || 0);
    }

    async function renderReferralChart(range) {
      const ctx = document.getElementById('referralChart').getContext('2d');
      if (referralChart) referralChart.destroy();
      
      const src = range === 'alltime' ? chartDataAllTime : chartData30Days;
      
      referralChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: src.labels,
          datasets: [{
            label: 'New Referrals',
            data: src.counts,
            backgroundColor: 'rgba(255, 215, 0, 0.2)',
            borderColor: '#FFD700',
            borderWidth: 3,
            pointBackgroundColor: '#FFD700',
            pointBorderColor: '#000',
            pointBorderWidth: 1,
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#E0E0E0',
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#E0E0E0',
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#E0E0E0',
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#FFD700',
              bodyColor: '#FFFFFF',
              borderColor: '#FFD700',
              borderWidth: 1,
              padding: 10,
              cornerRadius: 6
            }
          }
        }
      });
    }

    async function loadLeaderboard() {
      const listEl = document.getElementById('leaderboard-list');
      const { data: allReferred, error } = await supabase.from('referrals').select('affiliate_id');
      
      if (error) {
        listEl.innerHTML = `<li class="py-4 text-center" style="color: var(--accent);">Failed to load leaderboard.</li>`;
        return;
      }
      
      const map = {};
      allReferred.forEach(r => { 
        if (r.affiliate_id) map[r.affiliate_id] = (map[r.affiliate_id] || 0) + 1; 
      });
      
      const arr = Object.entries(map).map(([affiliateId, cnt]) => ({ affiliateId, cnt })).sort((a, b) => b.cnt - a.cnt).slice(0, 5);
      
      if (!arr.length) {
        listEl.innerHTML = `<li class="py-4 text-center" style="color: var(--text);">No referrals yet.</li>`;
        return;
      }
      
      listEl.innerHTML = '';
      
      for (let i = 0; i < arr.length; i++) {
        const item = arr[i];
        const { data: aData } = await supabase.from('affiliate_accounts').select('email, referral_code').eq('id', item.affiliateId).single();
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="me-3 fw-bold" style="color: var(--accent);">${i+1}.</div>
            <div>
              <div class="fw-bold">${aData?.email || '(unknown)'}</div>
              <div class="small" style="color: var(--text-secondary);">Ref: ${aData?.referral_code || '(unknown)'}</div>
            </div>
          </div>
          <div class="badge bg-warning text-dark">${item.cnt} referrals</div>
        `;
        listEl.appendChild(li);
      }
    }

    async function loadBankAccounts() {
      const tbody = document.getElementById('bank-accounts-body');
      const { data, error } = await supabase.from('affiliate_bank_accounts').select('*').eq('affiliate_id', affiliateId).order('created_at', { ascending: false });
      
      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4" style="color: var(--accent);">Failed to load bank accounts.</td></tr>`;
        return;
      }
      
      tbody.innerHTML = data.length ? data.map(acct => `
        <tr>
          <td>${acct.bank_name}</td>
          <td>${acct.bank_code}</td>
          <td>${acct.account_number}</td>
          <td>${acct.account_name}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteBankAccount('${acct.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('') : `
        <tr>
          <td colspan="5" class="text-center py-4" style="color: var(--text);">
            <i class="bi bi-info-circle me-2"></i> No bank accounts added yet.
          </td>
        </tr>
      `;
    }

    window.deleteBankAccount = async function(id) {
      if (!confirm('Are you sure you want to delete this bank account?')) return;
      
      const { error } = await supabase.from('affiliate_bank_accounts').delete().eq('id', id);
      
      if (error) {
        showToast('Failed to delete bank account. Please try again.', true);
        return;
      }
      
      showToast('Bank account deleted successfully!');
      await loadBankAccounts();
    }

    async function loadWallets() {
      const tbody = document.getElementById('wallets-body');
      const { data, error } = await supabase.from('affiliate_wallets').select('*').eq('affiliate_id', affiliateId).order('created_at', { ascending: false });
      
      if (error) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4" style="color: var(--accent);">Failed to load wallets.</td></tr>`;
        return;
      }
      
      tbody.innerHTML = data.length ? data.map(w => `
        <tr>
          <td>
            <span class="badge bg-warning text-dark">${w.currency}</span>
          </td>
          <td class="text-truncate" style="max-width: 250px;">${w.address}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteWallet('${w.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('') : `
        <tr>
          <td colspan="3" class="text-center py-4" style="color: var(--text);">
            <i class="bi bi-info-circle me-2"></i> No wallets added yet.
          </td>
        </tr>
      `;
    }

    window.deleteWallet = async function(id) {
      if (!confirm('Are you sure you want to delete this wallet?')) return;
      
      const { error } = await supabase.from('affiliate_wallets').delete().eq('id', id);
      
      if (error) {
        showToast('Failed to delete wallet. Please try again.', true);
        return;
      }
      
      showToast('Wallet deleted successfully!');
      await loadWallets();
    }

    async function loadPayouts() {
      const listEl = document.getElementById('withdrawals-list');
      const { data, error } = await supabase.from('affiliate_payouts').select('*').eq('affiliate_id', affiliateId).order('requested_at', { ascending: false });
      
      if (error) {
        listEl.innerHTML = `<li class="py-4 text-center" style="color: var(--accent);">Failed to load payouts.</li>`;
        return;
      }
      
      listEl.innerHTML = data.length ? data.map(p => `
        <li class="d-flex justify-content-between align-items-center py-3 px-3 border-bottom" style="border-color: var(--border);">
          <div>
            <div class="fw-bold">${toUSD(p.amount)}</div>
            <div class="small text-muted">Via ${p.method.toUpperCase()} â€¢ ${new Date(p.requested_at).toLocaleDateString()}</div>
          </div>
          <span class="badge ${p.status === 'completed' ? 'bg-success' : p.status === 'pending' ? 'bg-warning text-dark' : 'bg-danger'}">
            ${p.status.charAt(0).toUpperCase() + p.status.slice(1)}
          </span>
        </li>
      `).join('') : `
        <li class="py-4 text-center" style="color: var(--text);">
          <i class="bi bi-info-circle me-2"></i> No payout history found.
        </li>
      `;
    }

    function setupThemeToggle() {
      const btn = document.getElementById('theme-toggle-btn');
      const icon = document.getElementById('theme-icon');
      const saved = localStorage.getItem('dashboardTheme') || 'dark';
      
      document.documentElement.setAttribute('data-theme', saved);
      icon.className = saved === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
      
      btn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('dashboardTheme', next);
        icon.className = next === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
      });
    }

    function setupSidebarToggle() {
      document.getElementById('sidebar-toggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('expanded');
      });
    }
  </script>
</body>
</html>
