<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CBE Admin – Payment Methods</title>
  <!-- Bootstrap & DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <style>
    body { font-family:sans-serif; }
    nav { min-height:100vh; background:#111; }
    nav a { color:#ddd; text-decoration:none; display:block; padding:1rem; }
    nav a:hover, nav a.active { background:#222; color:#fff; }
    .content { padding:2rem; }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="col-2">
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="admin-settings-payments.html" class="active">Payment Methods</a>
      <a href="admin-payments.html">User Payments</a>
      <a href="admin-settings.html">Settings</a>
    </nav>

    <div class="content flex-grow-1">
      <h2 class="mb-4">Manage Payment Methods</h2>

      <!-- Form -->
      <div class="card mb-4 p-4">
        <h5 id="form-title">Add New Method</h5>
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input id="pm-name" class="form-control" placeholder="e.g. Bitcoin (BTC)"/>
          </div>
          <div class="col-md-3">
            <label class="form-label">Type</label>
            <select id="pm-type" class="form-select">
              <option value="">-- Select --</option>
              <option value="card">Card/Bank</option>
              <option value="crypto">Crypto</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Details</label>
            <input id="pm-details" class="form-control"
              placeholder='card → link, crypto → code:address'/>
          </div>
          <div class="col-md-1 d-grid">
            <button id="save-pm" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>

      <!-- Table -->
      <table id="methods-table" class="table table-striped">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Type</th><th>Details</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    // Supabase init
    const URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co',
          KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(URL, KEY);

    let editId = null;
    const table = $('#methods-table').DataTable({
      columns: [
        { data: 'id' },
        { data: 'name' },
        { data: 'type' },
        { data: d => JSON.stringify(d.details) },
        { data: null,
          render: (_,__,row) =>
            `<button class="btn btn-sm btn-warning me-1" onclick="onEdit(${row.id})">Edit</button>
             <button class="btn btn-sm btn-danger" onclick="onDelete(${row.id})">Delete</button>`
        }
      ]
    });

    async function loadMethods() {
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*')
        .order('id');
      if (error) return alert(error.message);
      table.clear().rows.add(data).draw();
    }

    async function onDelete(id) {
      if (!confirm('Delete this method?')) return;
      const { error } = await supabase.from('payment_methods').delete().eq('id',id);
      if (error) alert(error.message);
      else loadMethods();
    }

    window.onEdit = async id => {
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*').eq('id',id).single();
      if (error) return alert(error.message);
      editId = id;
      $('#form-title').text(`Edit #${id}`);
      $('#pm-name').val(data.name);
      $('#pm-type').val(data.type);
      const det = data.details;
      if (data.type === 'card')
        $('#pm-details').val(det.link);
      else
        $('#pm-details').val(`${det.code}:${det.address}`);
      $('#save-pm').text('Update');
    };

    $('#save-pm').click(async () => {
      const name = $('#pm-name').val().trim();
      const type = $('#pm-type').val();
      const raw = $('#pm-details').val().trim();
      if (!name || !type || !raw) return alert('All fields are required');
      let details = {};
      if (type === 'card') {
        details.link = raw;
      } else {
        const [code,address] = raw.split(':');
        if (!code||!address) return alert('crypto details must be code:address');
        details = { code, address };
      }

      let res;
      if (editId) {
        res = await supabase
          .from('payment_methods')
          .update({ name, type, details }).eq('id',editId);
      } else {
        res = await supabase
          .from('payment_methods')
          .insert([{ name, type, details }]);
      }
      if (res.error) return alert(res.error.message);
      // reset form
      editId = null;
      $('#form-title').text('Add New Method');
      $('#save-pm').text('Save');
      $('#pm-name,#pm-type,#pm-details').val('');
      loadMethods();
    });

    $(document).ready(loadMethods);
  </script>
</body>
</html>
