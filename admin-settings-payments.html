<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CBE Admin â€“ Payment Methods</title>

  <!-- AUTH GUARD -->
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.replace(
        'admin-login.html?redirect=' + encodeURIComponent(window.location.pathname)
      );
    }
  </script>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root {
      --bg:#000;--text:#fff;--gold:#ffd700;
      --glass-bg:rgba(255,255,255,0.05);
      --overlay:rgba(0,0,0,0.6);
    }
    [data-theme="light"] {
      --bg:#f5f5f5;--text:#333;--gold:#cca300;
      --glass-bg:rgba(0,0,0,0.05);
      --overlay:rgba(255,255,255,0.15);
    }
    body{margin:0;padding:0;box-sizing:border-box;
      font-family:Poppins,sans-serif;
      background:var(--bg);color:var(--text);
    }
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;
      background:var(--overlay);z-index:-1;
    }
    .glass{background:var(--glass-bg);backdrop-filter:blur(10px);
      border:1px solid rgba(255,215,0,0.2);border-radius:8px;
    }
    header{display:flex;align-items:center;justify-content:space-between;
      padding:1rem 2rem;position:sticky;top:0;z-index:10;
      background:rgba(0,0,0,0.6);border-bottom:1px solid var(--gold);
    }
    header .logo img{height:40px;cursor:pointer;}
    #theme-toggle{background:none;border:none;font-size:1.25rem;
      cursor:pointer;color:var(--text);
    }
    main{padding:2rem 1rem;}
    #section-title{text-align:center;color:var(--gold);
      margin-bottom:1.5rem;
    }
    form.glass{padding:1.5rem;margin-bottom:2rem;}
    .list-group-item{background:var(--glass-bg);
      border:1px solid rgba(255,215,0,0.2);
      color:var(--text);margin-bottom:.5rem;
      display:flex;justify-content:space-between;
      align-items:center;border-radius:4px;
    }
    .method-info{flex-grow:1;}
    .method-actions button{margin-left:.5rem;}
    .toast{z-index:99999!important;}
  </style>
</head>
<body>
  <div class="overlay"></div>

  <header class="glass">
    <div class="logo" id="logo">
      <img src="CBE_logo.PNG" alt="CBE Logo"/>
    </div>
    <button id="theme-toggle">ðŸŒž</button>
  </header>

  <main>
    <h2 id="section-title">Payment Methods</h2>

    <form id="method-form" class="glass">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Name</label>
          <input type="text" id="pm-name" class="form-control" placeholder="e.g. Pay â‚¦ via Card/Bank" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Type</label>
          <select id="pm-type" class="form-select" required>
            <option value="">-- Select --</option>
            <option value="card">Card/Bank</option>
            <option value="crypto">Crypto</option>
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label">Details</label>
          <input type="text" id="pm-details" class="form-control"
            placeholder="card â†’ https://â€¦   |   crypto â†’ BTC:1A2bâ€¦" required>
        </div>
        <div class="col-12 text-end">
          <button type="submit" id="save-btn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </form>

    <ul class="list-group" id="methods-list"></ul>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM refs
      const form       = document.getElementById('method-form');
      const nameInp    = document.getElementById('pm-name');
      const typeInp    = document.getElementById('pm-type');
      const detailsInp = document.getElementById('pm-details');
      const listGroup  = document.getElementById('methods-list');
      const saveBtn    = document.getElementById('save-btn');
      const logo       = document.getElementById('logo');
      const themeBtn   = document.getElementById('theme-toggle');
      let editId = null;

      // Supabase client
      const supabase = supabase.createClient(
        'https://dapwpgvnfjcfqqhrpxla.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhZ3Nl...'
        + 'ZHM1Njg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ'
      );

      // Helpers
      function showToast(msg, ok=true) {
        const t = document.createElement('div');
        t.className = `toast align-items-center text-white ${ok?'bg-success':'bg-danger'} border-0 position-fixed top-0 end-0 m-3`;
        t.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${msg}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>`;
        document.body.append(t);
        new bootstrap.Toast(t,{delay:3000}).show();
      }

      // Logo click
      logo.onclick = () => location.href = 'admin-dashboard.html';

      // Theme toggle
      const applyTheme = t => {
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        themeBtn.textContent = t==='dark'?'ðŸŒž':'ðŸŒœ';
      };
      themeBtn.onclick = () => applyTheme(
        document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'
      );
      applyTheme(localStorage.getItem('theme')||'dark');

      // Load methods
      async function loadMethods() {
        console.log('[loadMethods] fetching...');
        const { data, error } = await supabase
          .from('payment_methods')
          .select('*')
          .order('id', { ascending:true });
        if (error) {
          console.error('[loadMethods] error', error);
          return showToast('Load failed: '+error.message,false);
        }
        console.log('[loadMethods] got', data.length, 'methods');
        listGroup.innerHTML = '';
        data.forEach(m => {
          const li = document.createElement('li');
          li.className = 'list-group-item';

          const info = document.createElement('div');
          info.className = 'method-info';
          const det = m.type==='card'
            ? m.details.link
            : m.details.code+' â†’ '+m.details.address;
          info.innerHTML = `<strong>${m.name}</strong> <em>(${m.type})</em><br><small>${det}</small>`;

          const actions = document.createElement('div');
          actions.className = 'method-actions';
          actions.innerHTML = `
            <button class="btn btn-sm btn-warning" onclick="onEdit(${m.id})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="onDelete(${m.id})">
              <i class="bi bi-trash"></i>
            </button>`;

          li.append(info,actions);
          listGroup.append(li);
        });
      }

      // Edit
      window.onEdit = async (id) => {
        console.log('[onEdit]', id);
        const { data, error } = await supabase
          .from('payment_methods').select('*').eq('id',id).single();
        if (error) {
          console.error('[onEdit] error', error);
          return showToast('Fetch failed: '+error.message,false);
        }
        editId = id;
        nameInp.value = data.name;
        typeInp.value = data.type;
        detailsInp.value = data.type==='card'
          ? data.details.link
          : `${data.details.code}:${data.details.address}`;
        saveBtn.textContent = 'Update';
      };

      // Delete
      window.onDelete = async (id) => {
        console.log('[onDelete]', id);
        if (!confirm('Delete this method?')) return;
        const { error } = await supabase
          .from('payment_methods').delete().eq('id',id);
        if (error) {
          console.error('[onDelete] error', error);
          return showToast('Delete failed: '+error.message,false);
        }
        showToast('Deleted');
        if (editId===id) {
          editId=null;
          form.reset();
          saveBtn.textContent='Save';
        }
        loadMethods();
      };

      // Save handler
      form.addEventListener('submit', async e => {
        e.preventDefault();
        console.log('[save] begin', { editId });
        saveBtn.disabled=true;

        try {
          const name = nameInp.value.trim();
          const type = typeInp.value;
          const raw  = detailsInp.value.trim();
          if (!name||!type||!raw) {
            throw new Error('All fields required');
          }

          let details = {};
          if (type==='card') details = { link: raw };
          else {
            const [code,address] = raw.split(':');
            if (!code||!address) throw new Error('Crypto must be code:address');
            details={code,address};
          }

          let res;
          if (editId) {
            res = await supabase
              .from('payment_methods')
              .update({ name,type,details })
              .eq('id',editId);
          } else {
            res = await supabase
              .from('payment_methods')
              .insert([{ name,type,details }]);
          }

          if (res.error) throw res.error;
          showToast(editId?'Updated':'Added');
          form.reset();
          editId=null;
          saveBtn.textContent='Save';
          loadMethods();

        } catch(err) {
          console.error('[save] error', err);
          showToast(err.message,false);
        } finally {
          saveBtn.disabled = false;
        }
      });

      // Initial load
      loadMethods();
    });
  </script>
</body>
</html>
