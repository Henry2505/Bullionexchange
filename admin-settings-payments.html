<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBE Admin – Payment Methods</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter:blur(10px); }
    a, button { cursor:pointer; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="text-gold mb-4">Manage Payment Methods</h2>

    <!-- Add/Edit Form -->
    <div class="card glass mb-4 p-3">
      <h5 id="form-title">Add New Method</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" id="pm-name" class="form-control" placeholder="Name (e.g. Pay ₦ via Card/Bank)" />
        </div>
        <div class="col-md-2">
          <select id="pm-type" class="form-select">
            <option value="">Select Type…</option>
            <option value="card">Card/Bank</option>
            <option value="crypto">Crypto</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="text" id="pm-detail-key" class="form-control" placeholder="Detail Key (e.g. link or address)" />
        </div>
        <div class="col-md-2 d-grid">
          <button id="save-pm" class="btn btn-gold">Save</button>
        </div>
      </div>
    </div>

    <!-- DataTable -->
    <table id="methods-table" class="table table-dark table-striped">
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>Type</th><th>Details</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_KEY = 'YOUR_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let editId = null;
    const table = $('#methods-table').DataTable({
      columns: [
        { data: 'id' },
        { data: 'name' },
        { data: 'type' },
        { data: d => JSON.stringify(d.details) },
        { data: null, render: (_,__,row) =>
            `<button class="btn btn-sm btn-primary me-1" onclick="onEdit(${row.id})">Edit</button>
             <button class="btn btn-sm btn-danger" onclick="onDelete(${row.id})">Delete</button>`
        }
      ]
    });

    async function loadMethods() {
      const { data, error } = await supabase
        .from('payment_methods')
        .select('*')
        .order('id');
      if (error) return alert(error.message);
      table.clear().rows.add(data).draw();
    }

    async function onDelete(id) {
      if (!confirm('Delete this method?')) return;
      const { error } = await supabase.from('payment_methods').delete().eq('id', id);
      if (error) return alert(error.message);
      loadMethods();
    }

    window.onEdit = async (id) => {
      const { data } = await supabase.from('payment_methods').select('*').eq('id',id).single();
      editId = id;
      $('#form-title').text('Edit Method #' + id);
      $('#pm-name').val(data.name);
      $('#pm-type').val(data.type);
      // assume single key JSON for simplicity
      const key = Object.keys(data.details)[0];
      $('#pm-detail-key').val(key + ':' + data.details[key]);
      $('#save-pm').text('Update');
    };

    $('#save-pm').click(async () => {
      const name = $('#pm-name').val().trim();
      const type = $('#pm-type').val();
      const kv = $('#pm-detail-key').val().split(':');
      if (!name || !type || kv.length<2) return alert('Fill all fields: key:value');
      const details = { [kv[0]]: kv.slice(1).join(':') };

      let res;
      if (editId) {
        res = await supabase
          .from('payment_methods')
          .update({ name, type, details })
          .eq('id', editId);
      } else {
        res = await supabase
          .from('payment_methods')
          .insert([{ name, type, details }]);
      }
      if (res.error) return alert(res.error.message);

      // reset form
      editId = null;
      $('#form-title').text('Add New Method');
      $('#save-pm').text('Save');
      $('#pm-name,#pm-type,#pm-detail-key').val('');
      loadMethods();
    });

    $(document).ready(loadMethods);
  </script>
</body>
</html>
