<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apply • CBE Global FX</title>
  <style>
    :root[data-theme="dark"] {
      --bg: #121212; --text: #f0f0f0; --gold: #d4af37; --glass-bg: rgba(30,30,30,0.6);
      --error-color: #e74c3c; --success-color: #2ecc71; --warning-color: #f39c12;
    }
    :root[data-theme="light"] {
      --bg: #fafafa; --text: #222222; --gold: #d4af37; --glass-bg: rgba(255,255,255,0.6);
      --error-color: #e74c3c; --success-color: #2ecc71; --warning-color: #f39c12;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Roboto", sans-serif; background: var(--bg); color: var(--text); }
    .apply-card {
      width: 100%; max-width: 480px; margin: 60px auto; background: var(--glass-bg);
      backdrop-filter: blur(8px); padding: 30px; border-radius: 12px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    }
    .apply-card h1 { color: var(--gold); text-align: center; margin-bottom: 20px; }
    form { display: flex; flex-direction: column; gap: 12px; }
    input, textarea {
      padding: 10px; border: none; border-radius: 6px;
      background: #1c1c1c; color: var(--text); font-size: 1rem;
    }
    input:focus, textarea:focus { outline: none; box-shadow: 0 0 6px var(--gold); }
    .terms-container { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .terms-container input { width: 18px; height: 18px; }
    button {
      padding: 12px; border: none; border-radius: 6px; background: var(--gold);
      color: #000; font-weight: 600; cursor: pointer; opacity: 0.6; pointer-events: none;
      transition: background 0.3s, box-shadow 0.3s;
    }
    button.enabled { opacity: 1; pointer-events: auto; }
    button.enabled:hover { background: var(--gold-dark); box-shadow: 0 0 10px var(--gold); }
    #apply-alert {
      margin-top: 12px; white-space: pre-wrap; font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="apply-card">
    <h1>Apply to Join CBE</h1>
    <form id="apply-form">
      <input type="text"     id="apply-name"     placeholder="Full Name" required/>
      <input type="email"    id="apply-email"    placeholder="Email Address" required/>
      <input type="password" id="apply-password" placeholder="Password" required/>
      <input type="tel"      id="apply-phone"    placeholder="Phone Number" required/>
      <textarea id="apply-message" placeholder="Tell us about your trading experience" rows="4" required></textarea>
      <div class="terms-container">
        <input type="checkbox" id="agree-terms"/>
        <label for="agree-terms">I agree to Privacy &amp; Terms</label>
      </div>
      <button type="submit" id="submit-btn" disabled>Submit Application</button>
    </form>
    <div id="apply-alert"></div>
  </div>

  <script>
    // ───── Grab DOM elements ─────
    const form      = document.getElementById("apply-form");
    const agree     = document.getElementById("agree-terms");
    const submitBtn = document.getElementById("submit-btn");
    const alertDiv  = document.getElementById("apply-alert");

    // Enable/disable submit button when “I agree” changes
    agree.addEventListener("change", () => {
      submitBtn.disabled = !agree.checked;
      if (agree.checked) submitBtn.classList.add("enabled");
      else submitBtn.classList.remove("enabled");
    });

    form.addEventListener("submit", async (evt) => {
      evt.preventDefault();
      alertDiv.textContent = "";
      alertDiv.style.color = "";

      // Read all form fields
      const name = document.getElementById("apply-name").value.trim();
      const email = document.getElementById("apply-email").value.trim().toLowerCase();
      const password = document.getElementById("apply-password").value;
      const phone = document.getElementById("apply-phone").value.trim();
      const experience = document.getElementById("apply-message").value.trim();

      // Basic validation
      if (!name || !email || !password || !phone || !experience) {
        alertDiv.style.color = "var(--error-color)";
        alertDiv.textContent = "Please complete all fields.";
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alertDiv.style.color = "var(--error-color)";
        alertDiv.textContent = "Please enter a valid email address.";
        return;
      }

      // Disable button and show “Submitting…”
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";

      try {
        // Replace with your **exact** Supabase Function URL (no < >)
        const edgeUrl = "https://dapwpgvnfjcfqqhrpxla.functions.supabase.co/send-welcome-email";

        const response = await fetch(edgeUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name, email, phone, password, experience })
        });

        // Parse JSON (or fallback if invalid JSON)
        const result = await response.json().catch(() => ({ error: "Invalid JSON from function" }));
        console.log("Function response:", response.status, result);

        if (response.status === 409 && result.error === "Email already registered") {
          alertDiv.style.color = "var(--warning-color)";
          alertDiv.textContent = "This email is already registered—please use another.";
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Application";
        }
        else if (response.status === 201 && /welcome email sent successfully/i.test(result.message)) {
          alertDiv.style.color = "var(--success-color)";
          alertDiv.textContent = "Application submitted and welcome email sent!";
          form.reset();
          agree.checked = false;
          submitBtn.disabled = true;
          submitBtn.textContent = "Submit Application";
        }
        else if (response.status === 201 && result.message.includes("but failed to send welcome email")) {
          alertDiv.style.color = "var(--warning-color)";
          alertDiv.textContent =
            "Application saved, but email failed:\n" +
            JSON.stringify(result.brevoError || result, null, 2);
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Application";
        }
        else {
          alertDiv.style.color = "var(--error-color)";
          alertDiv.textContent = "Error: " + JSON.stringify(result, null, 2);
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Application";
        }
      } catch (err) {
        console.error("Fetch error:", err);
        alertDiv.style.color = "var(--error-color)";
        alertDiv.textContent = `Unexpected error: ${err.message}`;
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Application";
      }
    });
  </script>
</body>
</html>
