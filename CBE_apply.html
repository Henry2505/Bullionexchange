<script>
// Initialize Supabase client
const supabaseClient = supabase.createClient(
  'https://dapwpgvnfjcfqqhrpxla.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ'
);

// â”€â”€â”€ 1) SLIDE-IN ANIMATION â”€â”€â”€
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("apply-card").classList.add("visible");
});

// â”€â”€â”€ 2) THEME TOGGLE (DARK / LIGHT) â”€â”€â”€
const toggleBtn = document.getElementById("theme-toggle");
function applyTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
  toggleBtn.textContent = theme === "dark" ? "ðŸŒž" : "ðŸŒœ";
}
toggleBtn.addEventListener("click", () => {
  const current = document.documentElement.getAttribute("data-theme");
  const next = current === "dark" ? "light" : "dark";
  applyTheme(next);
});
// Restore saved theme or default to dark
applyTheme(localStorage.getItem("theme") || "dark");

// â”€â”€â”€ 3) CLIENTâ€SIDE â€œDATABASEâ€ (localStorage) â”€â”€â”€
function getRegisteredEmails() {
  try {
    const raw = localStorage.getItem("registeredEmails");
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}
function saveRegisteredEmails(arr) {
  localStorage.setItem("registeredEmails", JSON.stringify(arr));
}

// â”€â”€â”€ 4) FORM HANDLING â”€â”€â”€
const form      = document.getElementById("apply-form");
const agree     = document.getElementById("agree-terms");
const submitBtn = document.getElementById("submit-btn");
const alertDiv  = document.getElementById("apply-alert");

// Enable/disable submit button based on â€œI agreeâ€
agree.addEventListener("change", () => {
  if (agree.checked) {
    submitBtn.disabled = false;
    submitBtn.classList.add("enabled");
  } else {
    submitBtn.disabled = true;
    submitBtn.classList.remove("enabled");
  }
});

form.addEventListener("submit", async (evt) => {
  evt.preventDefault();
  alertDiv.textContent = "";
  alertDiv.style.color = "";

  // 4.a) Read form fields
  const name       = document.getElementById("apply-name").value.trim();
  const email      = document.getElementById("apply-email").value.trim().toLowerCase();
  const password   = document.getElementById("apply-password").value;
  const phone      = document.getElementById("apply-phone").value.trim();
  const experience = document.getElementById("apply-message").value.trim();

  // 4.b) Basic validation
  if (!name || !email || !password || !phone || !experience) {
    alertDiv.style.color = "var(--error-color)";
    alertDiv.textContent = "Please complete all fields.";
    return;
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    alertDiv.style.color = "var(--error-color)";
    alertDiv.textContent = "Please enter a valid email address.";
    return;
  }

  // 4.c) Duplicate prevention (perâ€browser)
  const existing = getRegisteredEmails();
  if (existing.includes(email)) {
    alertDiv.style.color = "var(--warning-color)";
    alertDiv.textContent = "This email has already been used in this browser.";
    return;
  }

  // 4.d) Disable button & show â€œSubmittingâ€¦â€
  submitBtn.disabled = true;
  submitBtn.textContent = "Submittingâ€¦";

  // 4.e) Prepare data for Supabase
  const data = { name, email, password, phone, experience };

  // 4.f) Insert into Supabase
  const { data: insertedData, error: supabaseError } = await supabaseClient
    .from('applications')
    .insert([data]);

  if (supabaseError) {
    console.error('Supabase error:', supabaseError);
    alertDiv.style.color = "var(--error-color)";
    alertDiv.textContent = `Failed to submit application: ${supabaseError.message}`;
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Application";
    return;
  }

  // 4.g) Mark email as used in localStorage
  existing.push(email);
  saveRegisteredEmails(existing);

  // 4.h) Build Brevo payload (hard-coded API key!)
  const BREVO_API_KEY    = "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";
  const BREVO_TEMPLATE_ID = 1; // your template ID
  const brevoPayload = {
    sender: {
      name: "Chukwuemeka Bullion Exchange",
      email: "noreply@apexincomeoptions.com.ng"
    },
    to: [
      {
        email: email,
        name: name
      }
    ],
    templateId: BREVO_TEMPLATE_ID,
    params: {
      contact: {
        FIRSTNAME: name,
        EMAIL: email
      },
      PHONE: phone,
      EXPERIENCE: experience
    }
  };

  // 4.i) Call Brevoâ€™s SMTP Email API via fetch()
  try {
    const brevoRes = await fetch("https://api.brevo.com/v3/smtp/email", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "api-key": BREVO_API_KEY
      },
      body: JSON.stringify(brevoPayload)
    });

    const brevoJson = await brevoRes.json().catch(() => ({
      error: "Invalid JSON from Brevo"
    }));
    console.log("Brevo response:", brevoRes.status, brevoJson);

    if (!brevoRes.ok) {
      // 502: Brevo returned an error
      alertDiv.style.color = "var(--warning-color)";
      alertDiv.textContent =
        "Application submitted to database, but Brevo API returned an error:\n" +
        JSON.stringify(brevoJson, null, 2);
    } else {
      // 200: Success
      alertDiv.style.color = "var(--success-color)";
      alertDiv.textContent = 
        "Application submitted and welcome email sent!";
    }
  } catch (err) {
    console.error("Fetch error to Brevo:", err);
    alertDiv.style.color = "var(--warning-color)";
    alertDiv.textContent = `Application submitted to database, but failed to send welcome email: ${err.message}`;
  }

  // 4.j) Reset form & button
  form.reset();
  agree.checked = false;
  submitBtn.disabled = true;
  submitBtn.textContent = "Submit Application";
});
</script>
