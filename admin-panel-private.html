<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBE Admin Panel</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Sortable.js -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* Theme variables */
    :root {
      --bg: #000000; /* Pure black for dark mode */
      --fg: #f5f5f5; /* Light gray text for contrast */
      --glass: #000000; /* Solid black for content areas in dark mode */
    }
    [data-theme="light"] {
      --bg: #f0f0f0; /* Light gray for light mode */
      --fg: #333; /* Dark text for light mode */
      --glass: rgba(255,255,255,0.6); /* Semi-transparent white for glass effect in light mode */
    }
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: Poppins, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    a { color: inherit; text-decoration: none; }
    @keyframes fadeIn { to { opacity: 1; } }
    .glass {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      opacity: 0;
      animation: fadeIn 0.8s forwards;
    }
    #sidebar {
      width: 250px;
      background: rgba(0,0,0,0.3);
      transition: .3s;
    }
    #sidebar.collapsed { margin-left: -250px; }
    #sidebar .nav-link { color: #ddd; }
    #sidebar .nav-link.active, #sidebar .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    #content { flex: 1; padding: 1.5rem; }
    #toggle-btn { cursor: pointer; font-size: 1.5rem; }
    .card-stat { cursor: grab; color: #fff; border: none; }
    .card-stat.bg-warning { background: rgba(255,193,7,0.8); }
    .form-control, .form-select {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
    }
    .form-control:focus, .form-select:focus {
      background: rgba(255,255,255,0.15);
      box-shadow: none;
    }
    .btn-primary { background: #ffd700; color: #000; border: none; }
    .btn-success { background: #1cc88a; border: none; }
    .btn-outline-secondary { color: #fff; border-color: rgba(255,255,255,0.4); }
    .btn-outline-secondary:hover { background: rgba(255,255,255,0.1); }
    h4 { color: #ffd700; }
    #toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1050; }
    /* DataTables header override */
    table.dataTable thead th { background: rgba(255,255,255,0.1); }
  </style>
</head>
<body data-theme="dark">

  <!-- Overlay & Toasts -->
  <div class="overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: -1;"></div>
  <div id="toast-container"></div>

  <div class="d-flex glass" style="min-height:100vh;">
    <!-- Sidebar -->
    <nav id="sidebar" class="d-flex flex-column p-3">
      <h4 class="text-center">CBE Admin</h4>
      <ul class="nav nav-pills flex-column mb-auto mt-4" id="menu">
        <li><a class="nav-link active" data-section="dashboard" href="#">Dashboard</a></li>
        <li><a class="nav-link" data-section="users" href="#">Users</a></li>
        <li><a class="nav-link" data-section="payments" href="#">Payments</a></li>
        <li><a class="nav-link" data-section="messages" href="#">Messages</a></li>
        <li><a class="nav-link" data-section="settings-payment" href="#">Payment Settings</a></li>
        <li><a class="nav-link" data-section="trade-history" href="#">Trade History</a></li>
        <li><a class="nav-link" data-section="trade-insights" href="#">Trade Insights</a></li>
        <li><a class="nav-link" data-section="signals" href="#">Signals</a></li>
        <li><a class="nav-link" data-section="testimonials" href="#">Testimonials</a></li>
        <li class="mt-auto"><a class="nav-link text-danger" href="#">Logout</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div id="content" class="d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <span id="toggle-btn">⋮</span>
          <button id="theme-toggle" class="btn btn-sm btn-outline-secondary ms-2">Light Mode</button>
        </div>
        <div class="d-flex align-items-baseline">
          <h2 id="section-title">Dashboard</h2>
          <small id="current-datetime" class="text-white ms-3"></small>
        </div>
      </div>

      <div id="sections">
        <!-- Dashboard -->
        <div class="section" data-section="dashboard">
          <div class="row g-4" id="stats-container">
            <div class="col-md-3">
              <div class="card card-stat p-3 glass bg-primary" draggable="true" data-key="users">
                <h5>Total Users</h5><h2 id="stat-users">0</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card card-stat p-3 glass bg-success" draggable="true" data-key="payments">
                <h5>Pending Payments</h5><h2 id="stat-payments">0</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card card-stat p-3 glass bg-info" draggable="true" data-key="trades">
                <h5>Trades This Month</h5><h2 id="stat-trades">0</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card card-stat p-3 glass bg-secondary" draggable="true" data-key="signals">
                <h5>Signals Published</h5><h2 id="stat-signals">0</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card card-stat p-3 glass bg-warning" draggable="true" data-key="winrate">
                <h5>Win Rate (%)</h5><h2 id="stat-winrate">0</h2>
              </div>
            </div>
          </div>
          <div class="row g-4 mt-4">
            <div class="col-md-6"><canvas id="chart-pnl" height="200"></canvas></div>
            <div class="col-md-6"><canvas id="chart-winrate" height="200"></canvas></div>
          </div>
          <div class="row g-4 mt-4">
            <div class="col-md-6 glass p-3">
              <h4>User Status Distribution</h4>
              <canvas id="chart-user-status" height="200"></canvas>
            </div>
            <div class="col-md-6 glass p-3">
              <h4>Payment Trends</h4>
              <canvas id="chart-payments-trend" height="200"></canvas>
            </div>
          </div>
        </div>

        <!-- Users -->
        <div class="section d-none p-4 mb-4 glass" data-section="users">
          <h4>Users Verification</h4>
          <input id="user-search" class="form-control mb-3" placeholder="Search users…" />
          <table id="users-table" class="table table-hover text-white" style="width:100%">
            <thead><tr><th>#</th><th>Email</th><th>Name</th><th>Registration Date</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Payments -->
        <div class="section d-none p-4 mb-4 glass" data-section="payments">
          <h4>Payment Approval</h4>
          <button id="export-payments" class="btn btn-outline-secondary btn-sm mb-3">Export CSV/XLSX</button>
          <table id="payments-table" class="table table-hover text-white" style="width:100%">
            <thead>
              <tr>
                <th>#</th><th>User</th><th>Email</th><th>Amount</th>
                <th>Payment Method</th><th>Date</th><th>Screenshot</th><th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Messages -->
        <div class="section d-none p-4 mb-4 glass" data-section="messages">
          <h4>Contact Messages</h4>
          <input id="msg-search" class="form-control mb-3" placeholder="Search messages…" />
          <table id="messages-table" class="table table-hover text-white" style="width:100%">
            <thead><tr><th>#</th><th>From</th><th>Message</th><th>Date</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Payment Settings -->
        <div class="section d-none p-4 mb-4 glass" data-section="settings-payment">
          <h4>Payment Settings</h4>
          <ul class="nav nav-pills mb-3">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#paystack-tab">Paystack</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#crypto-tab">Crypto</button></li>
          </ul>
          <div class="tab-content">
            <div id="paystack-tab" class="tab-pane fade show active">
              <form id="form-paystack">
                <div class="mb-3"><label>Paystack Public Key</label><input type="text" class="form-control" id="ps-public" required/></div>
                <div class="mb-3"><label>Paystack Secret Key</label><input type="text" class="form-control" id="ps-secret" required/></div>
                <div class="mb-3"><label>Paystack Link</label><input type="url" class="form-control" id="ps-link" placeholder="https://paystack.com/..." required/></div>
                <button class="btn btn-primary">Save Paystack</button>
              </form>
            </div>
            <div id="crypto-tab" class="tab-pane fade">
              <form id="form-crypto">
                <div class="mb-3"><label>BTC Wallet</label><input type="text" class="form-control" id="addr-btc" required/></div>
                <div class="mb-3"><label>ETH Wallet</label><input type="text" class="form-control" id="addr-eth" required/></div>
                <div class="mb-3"><label>TRX Wallet</label><input type="text" class="form-control" id="addr-trx" required/></div>
                <div class="mb-3"><label>USDT (TRC20)</label><input type="text" class="form-control" id="addr-usdt" required/></div>
                <button class="btn btn-primary">Save Crypto</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Trade History -->
        <div class="section d-none p-4 mb-4 glass" data-section="trade-history">
          <h4>Trade History</h4>
          <div class="row g-2 mb-3 align-items-end">
            <div class="col-md-3">...<!-- same as before --></div>
          </div>
          <form id="trade-upload-form" class="border p-3 mb-4 glass">...<!-- same as before --></form>
          <table id="history-table" class="table table-striped text-white" style="width:100%">...<!-- same --></table>
        </div>

        <!-- Trade Insights -->
        <div class="section d-none p-4 mb-4 glass" data-section="trade-insights">...<!-- same --></div>

        <!-- Signals -->
        <div class="section d-none p-4 mb-4 glass" data-section="signals">...<!-- same --></div>

        <!-- Testimonials (NEW) -->
        <div class="section d-none p-4 mb-4 glass" data-section="testimonials">
          <h4>User Testimonials (Pending)</h4>
          <table id="testimonials-table" class="table table-hover text-white" style="width:100%">
            <thead>
              <tr>
                <th>#</th><th>Name</th><th>Testimonial</th>
                <th>Screenshot</th><th>Submitted At</th><th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Reply Modal -->
  <div class="modal fade" id="replyModal"><div class="modal-dialog">
    <form class="modal-content glass p-4" id="reply-form">
      <div class="modal-header">
        <h5 class="modal-title">Reply to Message</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="reply-email"/>
        <div class="mb-3"><label>To</label><input id="reply-to" class="form-control" readonly/></div>
        <div class="mb-3"><label>Message</label><textarea id="reply-body" class="form-control" rows="4" required></textarea></div>
      </div>
      <div class="modal-footer"><button class="btn btn-success">Send Reply</button></div>
    </form>
  </div></div>

  <!-- Screenshot Modal -->
  <div class="modal fade" id="screenshotModal"><div class="modal-dialog modal-lg">
    <div class="modal-content glass p-4">
      <div class="modal-header">
        <h5 class="modal-title">Payment Screenshot</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <img id="screenshot-img" src="" class="img-fluid" />
      </div>
    </div>
  </div></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    // Initialize Supabase client
    const SUPABASE_URL     = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    function showToast(msg, ok=true){
      const id='t'+Date.now();
      document.getElementById('toast-container').insertAdjacentHTML('beforeend',`
        <div id="${id}" class="toast align-items-center text-white ${ok?'bg-success':'bg-danger'} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">${msg}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`);
      new bootstrap.Toast(document.getElementById(id),{delay:3000}).show();
    }

    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn.onclick = () => {
      const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      themeBtn.textContent = next === 'dark' ? 'Light Mode' : 'Dark Mode';
    };

    // Sidebar & nav
    document.getElementById('toggle-btn').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
    document.querySelectorAll('#menu .nav-link').forEach(link => {
      link.onclick = e => {
        e.preventDefault();
        document.querySelectorAll('#menu .nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.getElementById('section-title').textContent = link.textContent;
        document.querySelectorAll('.section').forEach(sec =>
          sec.classList.toggle('d-none', sec.dataset.section !== link.dataset.section)
        );
        const sec = link.dataset.section;
        if (sec==='dashboard')      loadDashboard();
        else if (sec==='users')     loadUsers();
        else if (sec==='payments')  loadPayments();
        else if (sec==='messages')  loadMessages();
        else if (sec==='trade-history') loadTradeHistory();
        else if (sec==='testimonials')  loadTestimonials();
      };
    });

    // Drag & drop stats
    new Sortable(document.getElementById('stats-container'), { animation: 150 });

    // Reply modal
    function openReply(email){
      document.getElementById('reply-email').value = email;
      document.getElementById('reply-to').value = email;
      new bootstrap.Modal(document.getElementById('replyModal')).show();
    }

    // View payment screenshot
    function viewScreenshot(url){
      document.getElementById('screenshot-img').src = url;
      new bootstrap.Modal(document.getElementById('screenshotModal')).show();
    }

    // Load Users
    async function loadUsers(){
      const { data, error } = await supabase.from('users').select('*');
      if(error){ showToast('Error fetching users',false); return; }
      $('#users-table').DataTable().clear().rows.add(data).draw();
    }

    // Load Payments
    async function loadPayments(){
      const { data, error } = await supabase.from('payments').select('*');
      if(error){ showToast('Error fetching payments',false); return; }
      $('#payments-table').DataTable().clear().rows.add(data).draw();
    }

    // Approve Payment
    async function approvePayment(id){
      const { error } = await supabase.from('payments').update({ status:'approved' }).eq('id',id);
      if(error) showToast('Error approving payment',false);
      else { showToast('Payment approved'); loadPayments(); }
    }

    // Load Messages
    async function loadMessages(){
      const { data, error } = await supabase.from('messages').select('*');
      if(error){ showToast('Error fetching messages',false); return; }
      $('#messages-table').DataTable().clear().rows.add(data).draw();
    }

    // Load Trade History
    async function loadTradeHistory(){
      const { data, error } = await supabase.from('trades').select('*');
      if(error){ showToast('Error fetching trades',false); return; }
      $('#history-table').DataTable().clear().rows.add(data).draw();
    }

    // Load Testimonials (NEW)
    async function loadTestimonials(){
      const { data, error } = await supabase.from('testimonials').select('*').eq('status','pending').order('created_at',{ascending:false});
      if(error){ showToast('Error fetching testimonials',false); return; }
      const table = $('#testimonials-table').DataTable();
      table.clear();
      data.forEach(r=>{
        table.row.add({
          id: r.id,
          name: r.name,
          testimonial: r.testimonial.length>100?r.testimonial.slice(0,100)+'…':r.testimonial,
          screenshot: r.screenshot_url?`<a href="${r.screenshot_url}" target="_blank">View</a>`:'—',
          created_at: new Date(r.created_at).toLocaleString(),
          action: `<button class="btn btn-sm btn-primary" onclick="approveTestimonial(${r.id})">Approve</button>`
        });
      });
      table.draw();
    }

    // Approve Testimonial (NEW)
    async function approveTestimonial(id){
      const { error } = await supabase.from('testimonials').update({ status:'approved' }).eq('id',id);
      if(error) showToast('Error approving testimonial',false);
      else { showToast('Testimonial approved'); loadTestimonials(); }
    }

    // Initialize DataTables
    $(document).ready(()=>{
      $('#users-table').DataTable({ columns:[
        { data:'id'},{ data:'email'},{ data:'name'},{ data:'registered'},{ data:'status'},
        { data:null, render:(_,r)=>`<button class="btn btn-sm btn-success" onclick="alert('Approve ${r.name}')">Approve</button>` }
      ]});
      $('#payments-table').DataTable({ columns:[
        { data:'id'},{ data:'user'},{ data:'email'},{ data:'amount'},{ data:'method'},{ data:'date'},
        { data:'screenshot', render:src=>src?`<button class="btn btn-sm btn-info" onclick="viewScreenshot('${src}')">View Screenshot</button>`:'No Screenshot' },
        { data:null, render:(_,r)=>`<button class="btn btn-sm btn-primary" onclick="approvePayment(${r.id})">Approve</button>` }
      ]});
      $('#messages-table').DataTable({ columns:[
        { data:'id'},{ data:'from'},{ data:'text'},{ data:'date'},
        { data:null, render:(_,r)=>`<button class="btn btn-sm btn-success" onclick="openReply('${r.email}')">Reply</button>` }
      ]});
      $('#history-table').DataTable({ columns:[
        { data:'date'},{ data:'asset'},{ data:'notes'},
        { data:'screenshot', render:src=>src?`<img src="${src}" style="height:40px;object-fit:cover"/>`:'—' }
      ]});
      $('#testimonials-table').DataTable({ columns:[
        { data:'id'},{ data:'name'},{ data:'testimonial'},{ data:'screenshot'},{ data:'created_at'},{ data:'action' }
      ]});
      // initial load
      loadDashboard();
    });

    // Dashboard stats & charts
    async function loadDashboard(){
      const [{ data: uData },{ data: pData },{ data: tData }] = await Promise.all([
        supabase.from('users').select('id',{count:'exact'}),
        supabase.from('payments').select('id',{count:'exact'}).eq('status','pending'),
        supabase.from('trades').select('id',{count:'exact'}),
      ]);
      document.getElementById('stat-users').textContent   = uData.length;
      document.getElementById('stat-payments').textContent= pData.length;
      document.getElementById('stat-trades').textContent  = tData.length;
      document.getElementById('stat-signals').textContent = 0;
      // Insights placeholder...
      // Charts initialization...
    }

    // Real-time clock
    function updateClock(){
      document.getElementById('current-datetime').textContent = new Date().toLocaleString();
    }
    updateClock(); setInterval(updateClock,60000);
  </script>
</body>
</html>
