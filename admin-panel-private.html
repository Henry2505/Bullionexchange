<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CBE Admin Panel</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Sortable.js -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* your existing CSS exactly as before… */
  </style>
</head>
<body data-theme="dark">
  <!-- overlay, sidebar, content… all your original HTML unchanged except Payments table header adds a Screenshot column -->
  <!-- (I’m omitting the static HTML here to save space—you’ll use your original markup with the extra <th>Screenshot</th>) -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // 1) Supabase init
    const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ5...';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2) Toast helper
    function showToast(msg, ok = true) {
      const id = 't' + Date.now();
      $('#toast-container').append(`
        <div id="${id}" class="toast align-items-center text-white ${ok?'bg-success':'bg-danger'} border-0">
          <div class="d-flex">
            <div class="toast-body">${msg}</div>
            <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`);
      new bootstrap.Toast(document.getElementById(id), { delay: 3000 }).show();
    }

    // 3) Common functions
    function openReply(email) {
      $('#reply-email').val(email);
      $('#reply-to').val(email);
      new bootstrap.Modal($('#replyModal')).show();
    }
    async function approveUser(id) {
      const { error } = await supabase.from('users').update({ status: 'Active' }).eq('id', id);
      showToast(error ? 'User approval failed' : 'User approved', !error);
      $('#users-table').DataTable().ajax.reload(null, false);
    }
    async function approvePayment(id) {
      const { error } = await supabase.from('payments').update({ approved: true }).eq('id', id);
      showToast(error ? 'Payment approval failed' : 'Payment approved', !error);
      $('#payments-table').DataTable().ajax.reload(null, false);
    }

    // 4) Document ready
    $(function() {
      // Sidebar toggles & theme (unchanged)…
      $('#toggle-btn').click(() => $('#sidebar').toggleClass('collapsed'));
      $('#theme-toggle').click(() => {
        const next = $('body').attr('data-theme') === 'dark' ? 'light' : 'dark';
        $('body').attr('data-theme', next);
        $('#theme-toggle').text(next === 'dark' ? 'Light Mode' : 'Dark Mode');
      });
      $('#menu .nav-link').click(function(e) {
        e.preventDefault();
        $('#menu .nav-link').removeClass('active');
        $(this).addClass('active');
        $('#section-title').text($(this).text());
        $('.section').addClass('d-none');
        $(`.section[data-section="${$(this).data('section')}"]`).removeClass('d-none');
      });
      new Sortable($('#stats-container')[0], { animation: 150 });

      // USERS table
      $('#users-table').DataTable({
        ajax: async (_, cb) => {
          const { data, error } = await supabase.from('users').select('*').order('id');
          cb({ data: error ? [] : data });
        },
        columns: [
          { data: 'id' }, { data: 'email' }, { data: 'name' },
          { data: 'registered' }, { data: 'status' },
          { data: null, orderable: false, render: (_,__,r) =>
            r.status === 'Active'
              ? '<span class="badge bg-success">Active</span>'
              : `<button class="btn btn-sm btn-success" onclick="approveUser(${r.id})">Approve</button>`
          }
        ]
      });

      // PAYMENTS table
      $('#payments-table').DataTable({
        ajax: async (_, cb) => {
          const { data, error } = await supabase.from('payments').select('*').order('date', { ascending: false });
          cb({ data: error ? [] : data });
        },
        columns: [
          { data: 'id' }, { data: 'user' }, { data: 'email' },
          { data: 'amount' }, { data: 'method' }, { data: 'date' },
          { data: 'screenshot_url', render: url =>
            url
              ? `<a href="${url}" target="_blank"><img src="${url}" style="height:40px;object-fit:cover;border-radius:4px"/></a>`
              : '—'
          },
          { data: null, orderable: false, render: (_,__,r) =>
            r.approved
              ? '<span class="badge bg-success">Approved</span>'
              : `<button class="btn btn-sm btn-primary" onclick="approvePayment(${r.id})">Verify & Approve</button>`
          }
        ]
      });
      $('#export-payments').click(() => $('#payments-table').DataTable().buttons().trigger());

      // MESSAGES table
      $('#messages-table').DataTable({
        ajax: async (_, cb) => {
          const { data, error } = await supabase.from('messages').select('*').order('date', { ascending: false });
          cb({ data: error ? [] : data });
        },
        columns: [
          { data: 'id' }, { data: 'from' }, { data: 'text' }, { data: 'date' },
          { data: null, orderable: false, render: (_,__,r) =>
            `<button class="btn btn-sm btn-success" onclick="openReply('${r.email}')">Reply</button>`
          }
        ]
      });

      // TRADE HISTORY upload & table
      $('#trade-upload-form').submit(async e => {
        e.preventDefault();
        const file = $('#trade-file')[0].files[0];
        const date = $('#trade-date').val();
        const asset= $('#trade-pair').val();
        const notes= $('#trade-notes').val();
        // upload to storage
        const { data:up, error:upErr } = await supabase
          .storage.from('screenshots')
          .upload(`screenshots/${Date.now()}_${file.name}`, file);
        if (upErr) return showToast('Upload failed', false);
        const url = `${SUPABASE_URL}/storage/v1/object/public/screenshots/${up.path}`;
        // insert trade
        const { error } = await supabase.from('trades').insert({ date, asset, notes, screenshot_url: url });
        showToast(error ? 'Trade add failed' : 'Trade added', !error);
        $('#history-table').DataTable().ajax.reload(null, false);
        e.target.reset();
      });
      $('#history-table').DataTable({
        ajax: async (_, cb) => {
          const { data, error } = await supabase.from('trades').select('*').order('date', { ascending: false });
          cb({ data: error ? [] : data });
        },
        columns: [
          { data: 'date' }, { data: 'asset' }, { data: 'notes' },
          { data: 'screenshot_url', render: url =>
            url
              ? `<a href="${url}" target="_blank"><img src="${url}" style="height:40px;object-fit:cover"/></a>`
              : '—'
          }
        ]
      });

      // INSIGHTS form & list
      async function loadInsights() {
        const { data, error } = await supabase.from('insights').select('*').order('week');
        const $list = $('#insights-list').empty();
        if (!error) data.forEach(i => {
          $list.append(`
            <li class="list-group-item">
              <strong>Week:</strong> ${i.week} | <strong>Pips:</strong> ${i.pips}<br>${i.note||''}
            </li>`);
        });
      }
      $('#insights-form').submit(async e => {
        e.preventDefault();
        const week = $('#insight-week').val();
        const pips = +$('#insight-pips').val();
        const note = $('#insight-note').val();
        const { error } = await supabase.from('insights').insert({ week, pips, note });
        showToast(error ? 'Insight failed' : 'Insight added', !error);
        loadInsights();
        e.target.reset();
      });
      loadInsights();

      // SIGNALS form & list
      async function loadSignals() {
        const { data, error } = await supabase.from('signals').select('*').order('date_posted', { ascending: false });
        const $list = $('#signals-list').empty();
        if (!error) data.forEach(s => {
          $list.append(`
            <li class="list-group-item">
              <strong>${s.asset} (${s.type})</strong><br>
              SL: ${s.sl} | TP1: ${s.tp1}${s.tp2 ? ' | TP2: '+s.tp2 : ''}<br>
              ${s.note||''}<br>
              <small>${new Date(s.date_posted).toLocaleDateString()}</small>
            </li>`);
        });
      }
      $('#signals-form').submit(async e => {
        e.preventDefault();
        const vals = {
          asset: $('#signal-asset').val(),
          type:  $('#signal-type').val(),
          sl:    $('#signal-sl').val(),
          tp1:   $('#signal-tp1').val(),
          tp2:   $('#signal-tp2').val(),
          note:  $('#signal-note').val(),
          date_posted: new Date().toISOString()
        };
        const { error } = await supabase.from('signals').insert(vals);
        showToast(error ? 'Signal failed' : 'Signal published', !error);
        loadSignals();
        e.target.reset();
      });
      loadSignals();

      // DASHBOARD stats & charts (counts + dummy charts)
      async function loadDashboard() {
        // counts
        const [{ count: uCnt }] = await supabase.from('users').select('id', { count: 'exact' });
        const [{ count: pCnt }] = await supabase.from('payments').select('id', { count: 'exact' }).eq('approved', false);
        const thisMonth = new Date().toISOString().slice(0,7);
        const [{ count: tCnt }] = await supabase.from('trades').select('id', { count: 'exact' }).like('date', thisMonth+'%');
        const [{ count: sCnt }] = await supabase.from('signals').select('id', { count: 'exact' });
        $('#stat-users').text(uCnt);
        $('#stat-payments').text(pCnt);
        $('#stat-trades').text(tCnt);
        $('#stat-signals').text(sCnt);
        // win rate
        const { data:ins } = await supabase.from('insights').select('pips');
        const wins = ins.filter(i => i.pips>0).length;
        $('#stat-winrate').text(ins.length ? Math.round(wins/ins.length*100) : 0);
        // keep your original chart code here (it uses dummyData arrays),
        // or swap in real data from `ins`, etc., as you prefer
      }
      loadDashboard();

      // clock
      function updateClock() {
        $('#current-datetime').text(new Date().toLocaleString());
      }
      updateClock();
      setInterval(updateClock, 60000);
    });
  </script>
</body>
</html>
