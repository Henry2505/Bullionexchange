<script>
  // 1) Supabase client
  const SUPABASE_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 2) Toast helper
  function showToast(msg, ok = true) {
    const id = 't' + Date.now();
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', `
      <div id="${id}" class="toast align-items-center text-white ${ok?'bg-success':'bg-danger'} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`);
    new bootstrap.Toast(document.getElementById(id), { delay: 3000 }).show();
  }

  // 3) Reply modal
  function openReply(email) {
    document.getElementById('reply-email').value = email;
    document.getElementById('reply-to').value = email;
    new bootstrap.Modal(document.getElementById('replyModal')).show();
  }

  // 4) Approve payments
  async function approvePayment(id) {
    let { error } = await supabase.from('payments').update({ approved: true }).eq('id', id);
    if (error) return showToast('Approval failed', false);
    showToast('Payment approved');
    $('#payments-table').DataTable().ajax.reload(null, false);
  }

  // 5) Approve user
  async function approveUser(id) {
    let { error } = await supabase.from('users').update({ status: 'Active' }).eq('id', id);
    if (error) return showToast('User approval failed', false);
    showToast('User approved');
    $('#users-table').DataTable().ajax.reload(null, false);
  }

  // 6) Initialize DataTables & Forms
  $(document).ready(async () => {
    // Sidebar nav toggles & theme toggle unchanged...
    document.getElementById('toggle-btn').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('theme-toggle').onclick = () => {
      const next = document.body.getAttribute('data-theme')==='dark'?'light':'dark';
      document.body.setAttribute('data-theme', next);
      document.getElementById('theme-toggle').textContent = next==='dark'?'Light Mode':'Dark Mode';
    };
    document.querySelectorAll('#menu .nav-link').forEach(l => l.onclick = e => {
      e.preventDefault();
      document.querySelectorAll('#menu .nav-link').forEach(x=>x.classList.remove('active'));
      l.classList.add('active');
      document.getElementById('section-title').textContent = l.textContent;
      document.querySelectorAll('.section').forEach(sec=>sec.classList.toggle('d-none', sec.dataset.section!==l.dataset.section));
    });
    new Sortable(document.getElementById('stats-container'), { animation: 150 });

    // USERS table
    $('#users-table').DataTable({
      ajax: async (_, cb) => {
        const { data, error } = await supabase.from('users').select('*').order('id', { ascending: true });
        if (error) return cb({ data: [] });
        cb({ data });
      },
      columns: [
        { data: 'id' },
        { data: 'email' },
        { data: 'name' },
        { data: 'registered' },
        { data: 'status' },
        { data: null, orderable: false, render: (_, __, row) =>
          row.status==='Active'
            ? `<span class="badge bg-success">Active</span>`
            : `<button class="btn btn-sm btn-success" onclick="approveUser(${row.id})">Approve</button>`
        }
      ]
    });

    // PAYMENTS table
    $('#payments-table').DataTable({
      ajax: async (_, cb) => {
        const { data, error } = await supabase.from('payments').select('*').order('date',{ascending:false});
        if (error) return cb({ data: [] });
        cb({ data });
      },
      columns: [
        { data: 'id' },
        { data: 'user' },
        { data: 'email' },
        { data: 'amount' },
        { data: 'method' },
        { data: 'date' },
        {
          data: 'screenshot_url',
          render: url => url
            ? `<a href="${url}" target="_blank"><img src="${url}" style="height:40px;object-fit:cover;border-radius:4px"/></a>`
            : '—'
        },
        { data: null, orderable: false, render: (_,__,r) =>
          r.approved
            ? `<span class="badge bg-success">Approved</span>`
            : `<button class="btn btn-sm btn-primary" onclick="approvePayment(${r.id})">Verify & Approve</button>`
        }
      ]
    });
    $('#export-payments').on('click', () => $('#payments-table').DataTable().buttons().trigger());

    // MESSAGES table
    $('#messages-table').DataTable({
      ajax: async (_, cb) => {
        const { data, error } = await supabase.from('messages').select('*').order('date',{ascending:false});
        if (error) return cb({ data: [] });
        cb({ data });
      },
      columns: [
        { data: 'id' },
        { data: 'from' },
        { data: 'text' },
        { data: 'date' },
        { data: null, orderable: false, render: (_,__,r) =>
          `<button class="btn btn-sm btn-success" onclick="openReply('${r.email}')">Reply</button>`
        }
      ]
    });

    // PAYMENT SETTINGS forms
    // Load Paystack settings
    let { data:ps } = await supabase.from('paystack_settings').select('*').eq('id',1).single();
    if(ps){
      document.getElementById('ps-public').value = ps.public_key;
      document.getElementById('ps-secret').value = ps.secret_key;
      document.getElementById('ps-link').value   = ps.link;
    }
    document.getElementById('form-paystack').onsubmit = async e => {
      e.preventDefault();
      const upd = {
        public_key: document.getElementById('ps-public').value,
        secret_key: document.getElementById('ps-secret').value,
        link:       document.getElementById('ps-link').value
      };
      const { error } = await supabase.from('paystack_settings').upsert({ id:1, ...upd });
      showToast(error?'Failed to save Paystack':'Paystack saved', !error);
    };

    // Load Crypto settings
    let { data:cr } = await supabase.from('crypto_settings').select('*').eq('id',1).single();
    if(cr){
      document.getElementById('addr-btc').value  = cr.btc_wallet;
      document.getElementById('addr-eth').value  = cr.eth_wallet;
      document.getElementById('addr-trx').value  = cr.trx_wallet;
      document.getElementById('addr-usdt').value = cr.usdt_wallet;
    }
    document.getElementById('form-crypto').onsubmit = async e => {
      e.preventDefault();
      const upd = {
        btc_wallet:  document.getElementById('addr-btc').value,
        eth_wallet:  document.getElementById('addr-eth').value,
        trx_wallet:  document.getElementById('addr-trx').value,
        usdt_wallet: document.getElementById('addr-usdt').value
      };
      const { error } = await supabase.from('crypto_settings').upsert({ id:1, ...upd });
      showToast(error?'Failed to save Crypto':'Crypto saved', !error);
    };

    // TRADE HISTORY upload form
    $('#trade-upload-form').on('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('trade-file').files[0];
      const date = document.getElementById('trade-date').value;
      const asset= document.getElementById('trade-pair').value;
      const notes= document.getElementById('trade-notes').value;
      // upload file
      const { data:up, error:upErr } = await supabase
        .storage.from('screenshots')
        .upload(`screenshots/${Date.now()}_${file.name}`, file);
      if(upErr) return showToast('File upload failed', false);
      const url = `${SUPABASE_URL}/storage/v1/object/public/screenshots/${up.path}`;
      // insert trade
      let { error } = await supabase.from('trades').insert({ date, asset, notes, screenshot_url: url });
      if(error) return showToast('Add trade failed', false);
      showToast('Trade added');
      $('#history-table').DataTable().ajax.reload(null, false);
      e.target.reset();
    });

    // TRADE HISTORY table
    $('#history-table').DataTable({
      ajax: async (_,cb) => {
        const { data, error } = await supabase.from('trades').select('*').order('date',{ascending:false});
        if (error) return cb({ data: [] });
        cb({ data });
      },
      columns: [
        { data: 'date' },
        { data: 'asset' },
        { data: 'notes' },
        {
          data: 'screenshot_url',
          render: url => url
            ? `<a href="${url}" target="_blank"><img src="${url}" style="height:40px;object-fit:cover"/></a>`
            : '—'
        }
      ]
    });

    // INSIGHTS form & list
    async function loadInsights() {
      const { data, error } = await supabase.from('insights').select('*').order('week',{ascending:true});
      if(error) return showToast('Failed to load insights', false);
      const list = document.getElementById('insights-list');
      list.innerHTML = '';
      data.forEach(i => {
        const el = document.createElement('li');
        el.className = 'list-group-item d-flex justify-content-between align-items-start';
        el.innerHTML = `
          <div>
            <div><strong>Week:</strong> ${i.week}</div>
            <div><strong>Pips:</strong> ${i.pips}</div>
            <div>${i.note||''}</div>
          </div>
          <small>${i.id}</small>`;
        list.append(el);
      });
    }
    document.getElementById('insights-form').onsubmit = async e => {
      e.preventDefault();
      const week = document.getElementById('insight-week').value;
      const pips = +document.getElementById('insight-pips').value;
      const note = document.getElementById('insight-note').value;
      let { error } = await supabase.from('insights').insert({ week, pips, note });
      showToast(error?'Insight failed': 'Insight posted', !error);
      if(!error) loadInsights();
      e.target.reset();
    };
    loadInsights();

    // SIGNALS form & list
    async function loadSignals() {
      const { data, error } = await supabase.from('signals').select('*').order('date_posted',{ascending:false});
      if(error) return showToast('Failed to load signals', false);
      const list = document.getElementById('signals-list');
      list.innerHTML = '';
      data.forEach(s => {
        const el = document.createElement('li');
        el.className = 'list-group-item';
        el.innerHTML = `
          <div><strong>${s.asset} (${s.type})</strong></div>
          <div>SL: ${s.sl} | TP1: ${s.tp1} ${s.tp2? '| TP2: '+s.tp2 : ''}</div>
          <div>${s.note||''}</div>
          <small>${new Date(s.date_posted).toLocaleDateString()}</small>`;
        list.append(el);
      });
    }
    document.getElementById('signals-form').onsubmit = async e => {
      e.preventDefault();
      const asset = document.getElementById('signal-asset').value;
      const type  = document.getElementById('signal-type').value;
      const sl    = document.getElementById('signal-sl').value;
      const tp1   = document.getElementById('signal-tp1').value;
      const tp2   = document.getElementById('signal-tp2').value;
      const note  = document.getElementById('signal-note').value;
      let { error } = await supabase.from('signals')
        .insert({ asset, type, sl, tp1, tp2, note, date_posted: new Date() });
      showToast(error?'Signal failed':'Signal published',!error);
      if(!error) loadSignals();
      e.target.reset();
    };
    loadSignals();

    // DASHBOARD stats & charts
    async function loadDashboard() {
      // fetch counts
      const [{ count: usersCount }] = await supabase.from('users').select('id',{ count:'exact' });
      const [{ count: pendingCount }] = await supabase.from('payments').select('id',{ count:'exact' }).eq('approved', false);
      const thisMonth = new Date().toISOString().slice(0,7);
      const [{ count: tradesCount }] = await supabase.from('trades')
        .select('id',{ count:'exact' })
        .like('date', thisMonth+'%');
      const [{ count: signalsCount }] = await supabase.from('signals').select('id',{ count:'exact' });
      document.getElementById('stat-users').textContent    = usersCount;
      document.getElementById('stat-payments').textContent = pendingCount;
      document.getElementById('stat-trades').textContent   = tradesCount;
      document.getElementById('stat-signals').textContent  = signalsCount;

      // win rate from insights
      const { data:ins } = await supabase.from('insights').select('pips');
      const wins = ins.filter(i=>i.pips>0).length;
      const winRate = ins.length? Math.round(wins/ins.length*100):0;
      document.getElementById('stat-winrate').textContent = winRate;

      // charts (as before)
      new Chart(document.getElementById('chart-pnl'), {
        type:'line',
        data:{ labels: ins.map((_,i)=>`W${i+1}`), datasets:[{ data:ins.map(i=>i.pips), tension:0.4 }]},
        options:{responsive:true, plugins:{legend:{display:false}}}
      });
      new Chart(document.getElementById('chart-winrate'), {
        type:'bar',
        data:{ labels: ins.map((_,i)=>`W${i+1}`), datasets:[{ data:ins.map(i=>i.pips>0?100:0) }]},
        options:{responsive:true, plugins:{legend:{display:false}}}
      });

      // user status distribution
      const { data:statusData } = await supabase.rpc('count_by_status'); 
      // RPC should return [{ status, count },…]
      new Chart(document.getElementById('chart-user-status'), {
        type:'pie',
        data:{
          labels:statusData.map(r=>r.status),
          datasets:[{ data: statusData.map(r=>r.count) }]
        },
        options:{responsive:true}
      });

      // payment trends by week: assume payments table has week column, else use dummy
      const { data:pt } = await supabase.from('payments').select('week,amount');
      new Chart(document.getElementById('chart-payments-trend'), {
        type:'line',
        data:{
          labels: pt.map(r=>r.week),
          datasets:[{ data: pt.map(r=>r.amount), tension:0.4 }]
        },
        options:{responsive:true, plugins:{legend:{display:false}}}
      });
    }
    loadDashboard();

    // 7) Real-time clock
    function updateClock() {
      document.getElementById('current-datetime').textContent = new Date().toLocaleString();
    }
    updateClock();
    setInterval(updateClock, 60000);
  });
</script>
