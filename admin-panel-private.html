<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBE Admin Panel</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Sortable.js -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* Theme variables */
    :root { --bg:#000; --fg:#f5f5f5; --glass:rgba(0,0,0,0.3); }
    [data-theme="light"] { --bg:#f0f0f0; --fg:#333; --glass:rgba(255,255,255,0.6); }
    body { margin:0; padding:0; overflow-x:hidden; font-family:Poppins,sans-serif; background:var(--bg); color:var(--fg); }
    a { color:inherit; text-decoration:none; }
    .glass { background:var(--glass); backdrop-filter:blur(12px); border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.4); opacity:0; animation:fadeIn .8s forwards; }
    @keyframes fadeIn { to { opacity:1; } }
    #sidebar { width:250px; transition:.3s; }
    #sidebar.collapsed { margin-left:-250px; }
    #sidebar .nav-link { color:#ddd; }
    #sidebar .nav-link.active, #sidebar .nav-link:hover { background:rgba(255,255,255,0.1); color:#fff; }
    #content { flex:1; padding:1.5rem; }
    #toggle-btn { cursor:pointer; font-size:1.5rem; }
    .card-stat { border:none; cursor:grab; color:#fff; }
    .form-control, .form-select { background:rgba(255,255,255,0.1); border:none; color:#fff; }
    .form-control:focus, .form-select:focus { background:rgba(255,255,255,0.15); box-shadow:none; }
    .btn-primary { background:#ffd700; color:#000; border:none; }
    .btn-success { background:#1cc88a; border:none; }
    .btn-outline-secondary { color:#fff; border-color:rgba(255,255,255,0.4); }
    .btn-outline-secondary:hover { background:rgba(255,255,255,0.1); }
    h4 { color:#ffd700; }
    #toast-container { position:fixed; bottom:1rem; right:1rem; z-index:1050; }
    table.dataTable thead th { background:rgba(255,255,255,0.1); }
  </style>
</head>
<body data-theme="dark">

  <div class="overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:-1;"></div>
  <div id="toast-container"></div>

  <div class="d-flex glass" style="min-height:100vh;">
    <nav id="sidebar" class="d-flex flex-column p-3">
      <h4 class="text-center">CBE Admin</h4>
      <ul class="nav nav-pills flex-column mb-auto mt-4" id="menu">
        <li><a class="nav-link active" data-section="dashboard" href="#">Dashboard</a></li>
        <li><a class="nav-link" data-section="users" href="#">Users</a></li>
        <li><a class="nav-link" data-section="payments" href="#">Payments</a></li>
        <li><a class="nav-link" data-section="messages" href="#">Messages</a></li>
        <li><a class="nav-link" data-section="settings-payment" href="#">Payment Settings</a></li>
        <li><a class="nav-link" data-section="trade-history" href="#">Trade History</a></li>
        <li><a class="nav-link" data-section="trade-insights" href="#">Trade Insights</a></li>
        <li><a class="nav-link" data-section="signals" href="#">Signals</a></li>
        <li><a class="nav-link" data-section="testimonials" href="#">Testimonials</a></li>
        <li class="mt-auto"><a class="nav-link text-danger" href="#">Logout</a></li>
      </ul>
    </nav>

    <div id="content" class="d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <span id="toggle-btn">⋮</span>
          <button id="theme-toggle" class="btn btn-sm btn-outline-secondary ms-2">Light Mode</button>
        </div>
        <div class="d-flex align-items-baseline">
          <h2 id="section-title">Dashboard</h2>
          <small id="current-datetime" class="text-white ms-3"></small>
        </div>
      </div>

      <div id="sections">
        <!-- Dashboard -->
        <div class="section" data-section="dashboard">
          <!-- stats cards & charts same as original -->
        </div>

        <!-- Users -->
        <div class="section d-none p-4 mb-4 glass" data-section="users">
          <!-- users table -->
        </div>

        <!-- Payments -->
        <div class="section d-none p-4 mb-4 glass" data-section="payments">
          <!-- payments table -->
        </div>

        <!-- Messages -->
        <div class="section d-none p-4 mb-4 glass" data-section="messages">
          <!-- messages table -->
        </div>

        <!-- Payment Settings -->
        <div class="section d-none p-4 mb-4 glass" data-section="settings-payment">
          <!-- settings forms -->
        </div>

        <!-- Trade History -->
        <div class="section d-none p-4 mb-4 glass" data-section="trade-history">
          <!-- history table & form -->
        </div>

        <!-- Trade Insights -->
        <div class="section d-none p-4 mb-4 glass" data-section="trade-insights">
          <!-- insights list & form -->
        </div>

        <!-- Signals -->
        <div class="section d-none p-4 mb-4 glass" data-section="signals">
          <!-- signals list & form -->
        </div>

        <!-- Testimonials -->
        <div class="section d-none p-4 mb-4 glass" data-section="testimonials">
          <h4>Testimonials (Pending)</h4>
          <table id="testimonials-table" class="table table-hover text-white" style="width:100%">
            <thead>
              <tr>
                <th>#</th><th>Name</th><th>Testimonial</th>
                <th>Screenshot</th><th>Submitted At</th><th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals (reply & screenshot) -->
  <!-- ... exactly as your original script ... -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    // Supabase init
    const SUPABASE_URL     = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helper showToast, theme toggle, sidebar nav (exactly as your first script)...

    // loadDashboard(), loadUsers(), loadPayments(), approvePayment(),
    // loadMessages(), loadTradeHistory(), loadTestimonials(), approveTestimonial()
    // DataTables init for all 5 tables, Sortable for stats, charts via Chart.js,
    // real-time clock—all unchanged.

    // *** I’m preserving **every** function from your original script,
    // just slotting in `loadTestimonials()` and DataTable for it, plus the
    // Supabase calls for CRUD on `testimonials` table.

  </script>
</body>
</html>
<script>
  // Initialize Supabase client
  const SUPABASE_URL     = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Helper: show toast notifications
  function showToast(msg, ok = true) {
    const id = 't' + Date.now();
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', `
      <div id="${id}" class="toast align-items-center text-white ${ok ? 'bg-success' : 'bg-danger'} border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`);
    new bootstrap.Toast(document.getElementById(id), { delay: 3000 }).show();
  }

  // Theme toggle
  const themeBtn = document.getElementById('theme-toggle');
  themeBtn.onclick = () => {
    const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', next);
    themeBtn.textContent = next === 'dark' ? 'Light Mode' : 'Dark Mode';
  };

  // Sidebar collapse & navigation
  document.getElementById('toggle-btn').onclick = () =>
    document.getElementById('sidebar').classList.toggle('collapsed');

  document.querySelectorAll('#menu .nav-link').forEach(link => {
    link.onclick = async e => {
      e.preventDefault();
      document.querySelectorAll('#menu .nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      const section = link.dataset.section;
      document.getElementById('section-title').textContent = link.textContent;
      document.querySelectorAll('.section').forEach(sec =>
        sec.classList.toggle('d-none', sec.dataset.section !== section)
      );

      // On section show, load its data
      switch (section) {
        case 'dashboard': loadDashboard(); break;
        case 'users':      loadUsers();      break;
        case 'payments':   loadPayments();   break;
        case 'messages':   loadMessages();   break;
        case 'trade-history': loadTradeHistory(); break;
        case 'trade-insights': loadInsights();    break;
        case 'signals':    loadSignals();    break;
        case 'testimonials': loadTestimonials();  break;
      }
    };
  });

  // Drag & drop stats cards
  new Sortable(document.getElementById('stats-container'), { animation: 150 });

  // Open reply modal
  function openReply(email) {
    document.getElementById('reply-email').value = email;
    document.getElementById('reply-to').value    = email;
    new bootstrap.Modal(document.getElementById('replyModal')).show();
  }

  // View payment screenshot
  function viewScreenshot(url) {
    document.getElementById('screenshot-img').src = url;
    new bootstrap.Modal(document.getElementById('screenshotModal')).show();
  }

  // -------------------
  // Section Loaders
  // -------------------

  // Dashboard: fetch counts & charts
  async function loadDashboard() {
    // fetch counts
    const [{ count: uCount }, { count: pCount }] = await Promise.all([
      supabase.from('users').select('id', { count: 'exact' }),
      supabase.from('payments').select('id', { count: 'exact' }).eq('status', 'pending')
    ]).then(res => res.map(r => r.data));
    const tCount = (await supabase.from('trades').select('id', { count: 'exact' })).data.length;
    document.getElementById('stat-users').textContent    = uCount;
    document.getElementById('stat-payments').textContent = pCount;
    document.getElementById('stat-trades').textContent   = tCount;
    document.getElementById('stat-signals').textContent  = (await supabase.from('signals').select('id', { count: 'exact' })).data.length;
    // insights & win rate
    const insights = await supabase.from('insights').select('*').order('week');
    const weeks    = insights.data.map(i => i.week);
    const pips     = insights.data.map(i => i.pips);
    const wins     = insights.data.filter(i => i.pips > 0).length;
    const winRate  = Math.round((wins / insights.data.length) * 100);
    document.getElementById('stat-winrate').textContent = winRate;

    // Charts
    new Chart(document.getElementById('chart-pnl'), {
      type: 'line',
      data: { labels: weeks, datasets: [{ data: pips, tension: 0.4 }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
    new Chart(document.getElementById('chart-winrate'), {
      type: 'bar',
      data: { labels: weeks, datasets: [{ data: pips.map(v => v > 0 ? 100 : 0) }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
    const statDist = (await supabase.from('users').select('status', { count: 'exact', group: 'status' })).data;
    new Chart(document.getElementById('chart-user-status'), {
      type: 'pie',
      data: { labels: statDist.map(s => s.status), datasets: [{ data: statDist.map(s => s.count) }] },
      options: { responsive: true }
    });
    const trends = (await supabase.from('payments').select('week,amount')).data;
    new Chart(document.getElementById('chart-payments-trend'), {
      type: 'line',
      data: {
        labels: trends.map(t => t.week),
        datasets: [{ data: trends.map(t => t.amount), tension: 0.4 }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  // Users table
  async function loadUsers() {
    const { data, error } = await supabase.from('users').select('*');
    if (error) return showToast('Error fetching users', false);
    $('#users-table').DataTable().clear().rows.add(data).draw();
  }

  // Payments table & approve
  async function loadPayments() {
    const { data, error } = await supabase.from('payments').select('*');
    if (error) return showToast('Error fetching payments', false);
    $('#payments-table').DataTable().clear().rows.add(data).draw();
  }
  async function approvePayment(id) {
    const { error } = await supabase.from('payments').update({ status: 'approved' }).eq('id', id);
    if (error) return showToast('Error approving payment', false);
    showToast('Payment approved');
    loadPayments();
  }

  // Messages table & reply
  async function loadMessages() {
    const { data, error } = await supabase.from('messages').select('*');
    if (error) return showToast('Error fetching messages', false);
    $('#messages-table').DataTable().clear().rows.add(data).draw();
  }

  // Trade history & upload
  async function loadTradeHistory() {
    const { data, error } = await supabase.from('trades').select('*');
    if (error) return showToast('Error fetching trades', false);
    $('#history-table').DataTable().clear().rows.add(data).draw();
  }

  // Trade insights
  async function loadInsights() {
    const { data, error } = await supabase.from('insights').select('*').order('week');
    if (error) return showToast('Error fetching insights', false);
    const list = document.getElementById('insights-list');
    list.innerHTML = '';
    data.forEach(i => {
      const li = document.createElement('li');
      li.className = 'list-group-item glass text-white';
      li.textContent = `${i.week}: ${i.pips} pips — ${i.note || ''}`;
      list.append(li);
    });
  }

  // Signals
  async function loadSignals() {
    const { data, error } = await supabase.from('signals').select('*').order('id', { ascending: false });
    if (error) return showToast('Error fetching signals', false);
    const list = document.getElementById('signals-list');
    list.innerHTML = '';
    data.forEach(s => {
      const li = document.createElement('li');
      li.className = 'list-group-item glass text-white';
      li.innerHTML = `<b>${s.asset}</b> ${s.type} SL:${s.sl} TP1:${s.tp1}${s.tp2?` TP2:${s.tp2}`:''}
                      <br/><small>${s.note||''}</small>`;
      list.append(li);
    });
  }

  // Testimonials table & approve
  async function loadTestimonials() {
    const { data, error } = await supabase.from('testimonials').select('*').eq('status','pending');
    if (error) return showToast('Error fetching testimonials', false);
    $('#testimonials-table').DataTable().clear().rows.add(data).draw();
  }
  async function approveTestimonial(id) {
    const { error } = await supabase.from('testimonials').update({ status: 'approved' }).eq('id', id);
    if (error) return showToast('Error approving testimonial', false);
    showToast('Testimonial approved');
    loadTestimonials();
  }

  // DataTables initialization
  $(document).ready(() => {
    $('#users-table').DataTable({
      columns: [
        { data:'id' },{ data:'email' },{ data:'full_name' },{ data:'joined_at' },
        { data:'status' },
        { data:null, render: (_,r) => `<button class="btn btn-sm btn-success" onclick="supabase.from('users').update({status:'approved'}).eq('id',${r.id})&&loadUsers()">Approve</button>` }
      ]
    });
    $('#payments-table').DataTable({
      columns: [
        { data:'id' },{ data:'user' },{ data:'email' },{ data:'amount' },{ data:'method' },{ data:'date' },
        { data:'screenshot', render: d=> d ? `<button class="btn btn-sm btn-info" onclick="viewScreenshot('${d}')">View</button>` : '—' },
        { data:null, render: (_,r) => `<button class="btn btn-sm btn-primary" onclick="approvePayment(${r.id})">Approve</button>` }
      ]
    });
    $('#messages-table').DataTable({
      columns: [
        { data:'id' },{ data:'from' },{ data:'text' },{ data:'date' },
        { data:null, render: (_,r) => `<button class="btn btn-sm btn-success" onclick="openReply('${r.email}')">Reply</button>` }
      ]
    });
    $('#history-table').DataTable({
      columns: [
        { data:'date' },{ data:'asset' },{ data:'notes' },
        { data:'screenshot', render: s => s? `<img src="${s}" style="height:40px;object-fit:cover"/>`: '—' }
      ]
    });
    $('#testimonials-table').DataTable({
      columns: [
        { data:'id' },{ data:'name' },{ data:'testimonial' },
        { data:'screenshot', render: d=> d? `<button class="btn btn-sm btn-info" onclick="viewScreenshot('${d}')">View</button>` : '—' },
        { data:'submitted_at' },
        { data:null, render: (_,r) => `<button class="btn btn-sm btn-primary" onclick="approveTestimonial(${r.id})">Approve</button>` }
      ]
    });

    // Kick off dashboard on load
    loadDashboard();
  });

  // Real-time clock
  function updateClock() {
    document.getElementById('current-datetime').textContent = new Date().toLocaleString();
  }
  updateClock();
  setInterval(updateClock, 60000);
</script>
