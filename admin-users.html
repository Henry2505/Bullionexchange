<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CBE Admin – User Management</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>

  <style>
    :root[data-theme="dark"] {
      --bg: #0f2027; --text: #fff; --glass: rgba(255,255,255,0.05);
    }
    :root[data-theme="light"] {
      --bg: #fafafa; --text: #222; --glass: rgba(0,0,0,0.05);
    }
    body {
      background: var(--bg); color: var(--text);
      font-family: 'Poppins', sans-serif; margin:0; min-height:100vh;
    }
    header {
      background: var(--bg); padding:1rem;
      display:flex; justify-content:space-between; align-items:center;
    }
    #theme-toggle {
      border:1px solid var(--text); background:none; color:var(--text);
    }
    main { padding:2rem; }
    .glass {
      background: var(--glass); backdrop-filter:blur(10px);
      border-radius:10px; padding:2rem;
    }
    .table td, .table th { color:var(--text); }
  </style>
</head>
<body>

  <header>
    <h1 class="h4 mb-0">CBE Admin – Users</h1>
    <button id="theme-toggle" class="btn btn-sm">Toggle Theme</button>
  </header>

  <main class="container">
    <div class="glass">
      <h3 class="mb-4">User Applications</h3>
      <div class="table-responsive">
        <table id="users-table" class="table table-hover" style="width:100%">
          <thead class="table-secondary" style="color:inherit;">
            <tr>
              <th>#</th>
              <th>Email</th>
              <th>Name</th>
              <th>Password</th>
              <th>Phone</th>
              <th>Experience</th>
              <th>Registered At</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <script>
  (async function() {
    // Initialize theme toggle
    const html = document.documentElement;
    const tbtn = document.getElementById('theme-toggle');
    let theme = localStorage.getItem('theme') || 'dark';
    html.setAttribute('data-theme', theme);
    tbtn.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
    tbtn.onclick = () => {
      theme = theme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      tbtn.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
    };

    // Supabase client
    const SUPABASE_URL     = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DataTable setup
    const table = $('#users-table').DataTable({
      paging: true,
      searching: true,
      columnDefs: [{ orderable: false, targets: 8 }]
    });

    // CRUD actions exposed globally
    window.approve = async id => {
      await sb.from('users').update({ status: 'Approved' }).eq('id', id);
      loadUsers();
    };
    window.reject = async id => {
      await sb.from('users').update({ status: 'Rejected' }).eq('id', id);
      loadUsers();
    };
    window.remove = async id => {
      if (!confirm('Delete this user?')) return;
      await sb.from('users').delete().eq('id', id);
      loadUsers();
    };
    window.edit = async id => {
      const { data, error } = await sb.from('users').select('*').eq('id', id).single();
      if (error) return alert('Error fetching user');
      const name  = prompt('New name:', data.name);
      const email = prompt('New email:', data.email);
      const phone = prompt('New phone:', data.phone);
      const exp   = prompt('New experience:', data.experience);
      if (!name || !email) return;
      await sb.from('users')
        .update({ name: name.trim(), email: email.trim().toLowerCase(), phone: phone.trim(), experience: exp.trim() })
        .eq('id', id);
      loadUsers();
    };

    // Load and render users
    async function loadUsers() {
      const { data, error } = await sb
        .from('users')
        .select('id,email,name,password,phone,experience,created_at,status')
        .order('created_at', { ascending: false });
      if (error) return console.error(error);

      table.clear();
      data.forEach((u, i) => {
        table.row.add([
          i + 1,
          u.email,
          u.name,
          u.password,
          u.phone,
          u.experience,
          new Date(u.created_at).toLocaleDateString(),
          u.status,
          `
            ${u.status === 'Pending' ? `<button class="btn btn-sm btn-success me-1" onclick="approve('${u.id}')">Approve</button>` : ''}
            <button class="btn btn-sm btn-warning me-1" onclick="reject('${u.id}')">Reject</button>
            <button class="btn btn-sm btn-danger me-1" onclick="remove('${u.id}')">Delete</button>
            <button class="btn btn-sm btn-primary" onclick="edit('${u.id}')">Edit</button>
          `
        ]);
      });
      table.draw();
    }

    // Initial fetch
    await loadUsers();
  })();
  </script>
</body>
</html>
