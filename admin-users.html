<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBE Admin – User Management</title>

  <!-- Bootstrap & DataTables CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>

  <style>
    body { font-family:sans-serif; margin:0; }
    header { background:#222; color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    main { padding:1rem; }
    .warning { background: #ffdddd; color: #900; padding:0.75rem; border:1px solid #900; margin-bottom:1rem; }
    #debug { font-family:monospace; white-space:pre-wrap; background:#f5f5f5; color:#000; padding:0.5rem; height:8rem; overflow:auto; border:1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <h1>CBE Admin – Users</h1>
    <button id="theme-toggle" class="btn btn-light btn-sm">Toggle Theme</button>
  </header>
  <main>
    <div id="banner" class="warning" style="display:none;"></div>
    <table id="users-table" class="table table-striped">
      <thead>
        <tr>
          <th>#</th><th>Email</th><th>Name</th><th>Password</th><th>Phone</th>
          <th>Experience</th><th>Registered At</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h5>Debug Panel</h5>
    <div>Origin: <code id="dbg-origin"></code></div>
    <div>Request URL: <code id="dbg-url"></code></div>
    <div id="debug"></div>
  </main>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <script>
    (async () => {
      // Auth guard
      if (localStorage.getItem('isLoggedIn') !== 'true') {
        location.href = `admin-login.html?redirect=${location.pathname.split('/').pop()}`;
        return;
      }

      // Theme toggle
      const html = document.documentElement;
      const btn = document.getElementById('theme-toggle');
      const t = localStorage.getItem('theme') || 'dark';
      html.setAttribute('data-theme', t);
      btn.textContent = t==='dark'?'Light Mode':'Dark Mode';
      btn.onclick = () => {
        const next = html.getAttribute('data-theme')==='dark'?'light':'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        btn.textContent = next==='dark'?'Light Mode':'Dark Mode';
      };

      // Diagnostics elements
      const dbgOrigin = document.getElementById('dbg-origin');
      const dbgUrl    = document.getElementById('dbg-url');
      const debugDiv  = document.getElementById('debug');
      const banner    = document.getElementById('banner');
      dbgOrigin.textContent = location.origin;

      // Supabase client
      const URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
      const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
      const sb = supabase.createClient(URL, KEY);

      // DataTable init
      const table = $('#users-table').DataTable({ paging:true, searching:true, columnDefs:[{ orderable:false, targets:8 }] });

      // Load users
      const rqUrl = `${URL}/rest/v1/users?select=id,email,name,password,phone,experience,created_at,status&order=created_at.desc`;
      dbgUrl.textContent = rqUrl;

      try {
        debugDiv.textContent += `→ Fetching users...\n`;
        // Low-level fetch so we see CORS or 4xx:
        const resp = await fetch(rqUrl, {
          headers: { apikey: KEY, Authorization: 'Bearer '+KEY }
        });
        debugDiv.textContent += `→ HTTP ${resp.status} ${resp.statusText}\n`;
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        debugDiv.textContent += `→ Received ${data.length} rows\n${JSON.stringify(data, null, 2)}\n`;

        if (!data.length) {
          banner.textContent = 'No users returned. Check your Allowed Origins and that RLS is disabled.';
          banner.style.display = 'block';
        }

        // Populate DataTable
        table.clear();
        data.forEach((u,i) => {
          table.row.add([
            i+1, u.email, u.name, u.password, u.phone,
            u.experience, new Date(u.created_at).toLocaleDateString(),
            u.status,
            `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button>`
          ]);
        });
        table.draw();

      } catch (err) {
        debugDiv.textContent += `‼️ Error: ${err.message}\n`;
        banner.textContent = `Error loading users: ${err.message}`;
        banner.style.display = 'block';
      }

      // Simple delete for testing
      window.deleteUser = async id => {
        if (!confirm('Delete?')) return;
        await sb.from('users').delete().eq('id', id);
        location.reload();
      };
    })();
  </script>
</body>
</html>
