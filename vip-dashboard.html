<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- Auth Guard -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- Bootstrap, Icons, Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Supabase, TradingView, Smartsupp -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d) {
      var s, c, o = smartsupp = function() { o._.push(arguments) }; o._ = [];
      s = d.getElementsByTagName('script')[0]; c = d.createElement('script');
      c.async = true; c.src = 'https://www.smartsuppchat.com/loader.js?';
      s.parentNode.insertBefore(c, s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #1a1a1a;
      --panel: rgba(30, 30, 30, 0.95);
      --gold: #d4af37;
      --text: #e0e0e0;
      --muted: #888;
      --green: #00cc66;
      --red: #ff4444;
    }
    [data-theme="light"] {
      --bg: #f0f2f5;
      --panel: rgba(255, 255, 255, 0.95);
      --text: #333;
      --gold: #b8860b;
      --green: #00b359;
      --red: #cc0000;
    }
    body {
      background: linear-gradient(135deg, var(--bg), #222);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      overflow-x: hidden;
    }
    .bg-panel {
      background: var(--panel);
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    .card {
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
    }
    .text-gold { color: var(--gold); }
    .btn-gold {
      background: var(--gold);
      color: #000;
      border: none;
      border-radius: 5px;
      transition: transform 0.2s;
    }
    .btn-gold:hover { transform: scale(1.05); }
    .blink-nav a {
      animation: blink 1.5s infinite;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .fade-in { animation: fadeIn 0.8s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #tv_chart { height: 600px; }
    .gauge-bar {
      width: 100%;
      height: 10px;
      background: var(--muted);
      position: relative;
      border-radius: 5px;
    }
    .gauge-indicator {
      height: 100%;
      background: var(--gold);
      position: absolute;
      transition: left 0.5s;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start bg-panel" id="sidebar">
    <div class="offcanvas-body">
      <div class="text-center mb-4">
        <img src="CBE_logo.PNG" alt="CBE Logo" style="width: 120px; cursor: pointer;" onclick="location.href='index.html'">
      </div>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item"><a class="nav-link active text-light" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="signals.html"><i class="bi-lightning me-2"></i>Signals</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_insights_vip.html"><i class="bi-graph-up me-2"></i>Insights</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_history_vip.html"><i class="bi-clock-history me-2"></i>Trade History</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="#" id="chat-launch"><i class="bi-chat-dots me-2"></i>Support</a></li>
      </ul>
    </div>
  </div>

  <div class="d-flex">
    <div class="flex-fill">
      <!-- Header with Live Price Ticker -->
      <header class="d-flex justify-content-between align-items-center bg-panel p-3 sticky-top fade-in">
        <div class="d-flex align-items-center">
          <button class="btn btn-link text-light d-md-none me-2" data-bs-toggle="offcanvas" data-bs-target="#sidebar">
            <i class="bi-list"></i>
          </button>
          <div>
            <h5 class="mb-1 text-gold">Welcome, <span id="userName">Trader</span>!</h5>
            <small id="currentTime" class="text-muted"></small>
            <div id="price-ticker" class="text-gold mt-2">
              XAUUSD: <span id="current-price">1800.00</span> |
              H: <span id="daily-high">1810.00</span> |
              L: <span id="daily-low">1790.00</span> |
              Chg: <span id="daily-change">+0.5%</span>
            </div>
          </div>
        </div>
        <div>
          <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
          <button id="notif-btn" class="btn btn-link text-light position-relative">
            <i class="bi-bell-fill"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge bg-danger" id="notif-count">0</span>
          </button>
        </div>
      </header>

      <!-- Blinking Navigation -->
      <div class="blink-nav text-center py-3 fade-in">
        <a class="btn btn-gold mx-2" href="signals.html">Signals</a>
        <a class="btn btn-gold mx-2" href="CBE_trade_insights_vip.html">Insights</a>
        <a class="btn btn-gold mx-2" href="CBE_trade_history_vip.html">Trade History</a>
      </div>

      <!-- Main Content -->
      <div class="container-fluid p-4">
        <!-- Stats Cards -->
        <div class="row g-4 mb-4 fade-in">
          <div class="col-md-3 col-6">
            <div class="card bg-panel p-3 text-center">
              <h6 class="text-gold"><i class="bi-lightning me-2"></i>Signals Today</h6>
              <p id="stat-signals" class="fs-3 mb-0 text-gold">0</p>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card bg-panel p-3 text-center">
              <h6 class="text-gold"><i class="bi-lightbulb me-2"></i>Insights</h6>
              <p id="stat-insights" class="fs-3 mb-0 text-gold">0</p>
            </div>
          </div>
        </div>

        <!-- Signal Card -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Latest Signal</h2>
          <div id="signal-body" class="text-center text-muted">Loading latest signal...</div>
        </div>

        <!-- TradingView Chart -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">XAUUSD Chart</h2>
          <div id="tv_chart"></div>
        </div>

        <!-- New Feature 1: Smart Trade Predictor -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Smart Trade Predictor</h2>
          <div id="trade-predictor" class="text-center">
            <p>Next Move: <span id="predictor-text" class="text-gold">Calculating...</span></p>
            <button id="predict-now" class="btn btn-gold mt-2">Predict Now</button>
          </div>
        </div>

        <!-- New Feature 2: Custom Alert System -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Price Alerts</h2>
          <div class="d-flex gap-2 mb-3">
            <input type="number" id="alert-price" class="form-control" placeholder="Price level">
            <select id="alert-condition" class="form-select">
              <option value="above">Above</option>
              <option value="below">Below</option>
            </select>
            <button id="add-alert" class="btn btn-gold">Add Alert</button>
          </div>
          <ul id="alert-list" class="list-group"></ul>
        </div>

        <!-- New Feature 3: Performance Analytics -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Performance Analytics</h2>
          <div class="row text-center">
            <div class="col-md-3">
              <p>Total Pips: <span id="total-pips" class="text-gold">0</span></p>
            </div>
            <div class="col-md-3">
              <p>Win Rate: <span id="win-rate" class="text-gold">0%</span></p>
            </div>
            <div class="col-md-3">
              <p>Avg Pips: <span id="avg-pips" class="text-gold">0</span></p>
            </div>
            <div class="col-md-3">
              <p>Trades: <span id="total-trades" class="text-gold">0</span></p>
            </div>
          </div>
        </div>

        <!-- Market Sentiment -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Market Sentiment (4H)</h2>
          <div class="gauge-bar">
            <div class="gauge-indicator" id="sentiment-indicator" style="width: 50%;"></div>
          </div>
          <p id="sentiment-text" class="text-center mt-2 text-gold">Neutral</p>
        </div>

        <!-- Trade History -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Trade History</h2>
          <div id="trade-history-feed" class="text-muted">Loading trade history...</div>
        </div>

        <footer class="text-center py-3 text-muted fade-in">
          © 2025 CBE Global FX – All Rights Reserved
        </footer>
      </div>
    </div>
  </div>

  <!-- Chat Bubble -->
  <div class="position-fixed bottom-0 end-0 m-4" style="z-index: 1000;">
    <button class="btn btn-gold rounded-circle p-3" onclick="smartsupp('chat:open')">
      <i class="bi-chat-dots"></i>
    </button>
  </div>

  <audio id="notif-sound" src="ding.mp3" preload="auto"></audio>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Initial Setup
    document.body.style.visibility = 'visible';
    const userName = sessionStorage.getItem('cbeUserName') || 'Trader';
    document.getElementById('userName').textContent = userName;

    // Clock
    const timeEl = document.getElementById('currentTime');
    function updateClock() {
      timeEl.textContent = new Date().toLocaleString();
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Theme Toggle
    const themeBtn = document.getElementById('theme-toggle');
    let theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    themeBtn.innerHTML = theme === 'dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
    themeBtn.onclick = () => {
      theme = theme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeBtn.innerHTML = theme === 'dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
      loadChart();
    };

    // Supabase
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Chart
    function loadChart() {
      new TradingView.widget({
        container_id: 'tv_chart',
        width: '100%',
        height: '100%',
        symbol: 'OANDA:XAUUSD',
        interval: '240',
        theme: document.documentElement.getAttribute('data-theme') || 'dark',
        style: '1',
        locale: 'en',
        toolbar_bg: '#000',
        hide_side_toolbar: false,
        allow_symbol_change: false
      });
    }
    loadChart();

    // Live Price Ticker (Simulated)
    let currentPrice = 1800;
    function updatePrice() {
      currentPrice += (Math.random() - 0.5) * 2;
      document.getElementById('current-price').textContent = currentPrice.toFixed(2);
      document.getElementById('daily-high').textContent = (currentPrice + 10).toFixed(2);
      document.getElementById('daily-low').textContent = (currentPrice - 10).toFixed(2);
      document.getElementById('daily-change').textContent = ((Math.random() - 0.5) * 1).toFixed(2) + '%';
    }
    updatePrice();
    setInterval(updatePrice, 1000);

    // Feature 1: Smart Trade Predictor (Simulated)
    document.getElementById('predict-now').onclick = () => {
      const predictorText = document.getElementById('predictor-text');
      const rand = Math.random();
      predictorText.textContent = rand > 0.6 ? 'Buy' : rand < 0.4 ? 'Sell' : 'Hold';
      predictorText.style.color = rand > 0.6 ? 'var(--green)' : rand < 0.4 ? 'var(--red)' : 'var(--gold)';
    };

    // Feature 2: Custom Alert System
    let alerts = JSON.parse(localStorage.getItem('alerts')) || [];
    function renderAlerts() {
      document.getElementById('alert-list').innerHTML = alerts.map((a, i) => `
        <li class="list-group-item d-flex justify-content-between">
          ${a.condition} ${a.price}
          <button class="btn btn-sm btn-danger" onclick="removeAlert(${i})">X</button>
        </li>
      `).join('');
    }
    document.getElementById('add-alert').onclick = () => {
      const price = parseFloat(document.getElementById('alert-price').value);
      const condition = document.getElementById('alert-condition').value;
      if (price) {
        alerts.push({ price, condition });
        localStorage.setItem('alerts', JSON.stringify(alerts));
        renderAlerts();
      }
    };
    window.removeAlert = (i) => {
      alerts.splice(i, 1);
      localStorage.setItem('alerts', JSON.stringify(alerts));
      renderAlerts();
    };
    renderAlerts();
    function checkAlerts() {
      const price = parseFloat(document.getElementById('current-price').textContent);
      alerts.forEach((a, i) => {
        if ((a.condition === 'above' && price >= a.price) || (a.condition === 'below' && price <= a.price)) {
          if (Notification.permission === 'granted') new Notification(`XAUUSD ${a.condition} ${a.price}`);
          document.getElementById('notif-sound').play();
          alerts.splice(i, 1);
          localStorage.setItem('alerts', JSON.stringify(alerts));
          renderAlerts();
        }
      });
    }
    setInterval(checkAlerts, 1000);
    if (Notification.permission !== 'granted') Notification.requestPermission();

    // Feature 3: Performance Analytics
    async function loadPerformance() {
      const userId = sessionStorage.getItem('cbeUserId') || 'default';
      const { data, error } = await supabase.from('trades').select('pips, result').eq('user_id', userId);
      if (error) return console.error(error);
      const totalPips = data.reduce((sum, t) => sum + t.pips, 0);
      const wins = data.filter(t => t.result === 'win').length;
      const totalTrades = data.length;
      const winRate = totalTrades ? (wins / totalTrades * 100).toFixed(2) + '%' : '0%';
      const avgPips = totalTrades ? (totalPips / totalTrades).toFixed(2) : '0';
      document.getElementById('total-pips').textContent = totalPips;
      document.getElementById('win-rate').textContent = winRate;
      document.getElementById('avg-pips').textContent = avgPips;
      document.getElementById('total-trades').textContent = totalTrades;
    }
    loadPerformance();

    // Signal (Placeholder)
    async function loadSignal() {
      document.getElementById('signal-body').innerHTML = 'Latest signal details...';
    }
    loadSignal();

    // Trade History (Placeholder)
    async function loadHistory() {
      document.getElementById('trade-history-feed').innerHTML = 'Recent trades...';
    }
    loadHistory();

    // Sentiment (Simulated)
    function updateSentiment() {
      const val = Math.random() * 100;
      document.getElementById('sentiment-indicator').style.width = `${val}%`;
      document.getElementById('sentiment-text').textContent = val > 60 ? 'Bullish' : val < 40 ? 'Bearish' : 'Neutral';
      document.getElementById('sentiment-text').style.color = val > 60 ? 'var(--green)' : val < 40 ? 'var(--red)' : 'var(--gold)';
    }
    updateSentiment();
    setInterval(updateSentiment, 10000);

    // Support Chat
    document.getElementById('chat-launch').onclick = (e) => { e.preventDefault(); smartsupp('chat:open'); };
  </script>
</body>
</html>
