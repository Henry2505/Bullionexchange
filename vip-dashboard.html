<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- BOOTSTRAP & ICONS & FONTS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d) {
      var s, c, o = smartsupp = function() { o._.push(arguments) }; o._ = [];
      s = d.getElementsByTagName('script')[0]; c = d.createElement('script');
      c.async = true; c.src = 'https://www.smartsuppchat.com/loader.js?';
      s.parentNode.insertBefore(c, s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #111;
      --panel: rgba(20, 20, 20, 0.9);
      --gold: #bfa057;
      --text: #f0f0f0;
      --muted: #aaa;
      --green: #28a745;
      --red: #dc3545;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      overflow-x: hidden;
    }
    .bg-panel {
      background: var(--panel) !important;
      border-radius: 8px;
      backdrop-filter: blur(8px);
    }
    .text-gold { color: var(--gold) !important; }
    .btn-gold {
      background: var(--gold);
      border: none;
      color: #000;
      transition: transform 0.2s;
    }
    .btn-gold:hover {
      background: #e6c65d;
      transform: scale(1.05);
    }
    #chart-container {
      width: 100%;
      height: 50vh;
      position: relative;
      background: var(--bg);
      animation: fadeIn 1s ease-in;
    }
    @media (min-width: 768px) {
      #chart-container { height: 80vh; }
    }
    #tv_chart { position: absolute; top:0; left:0; width:100%; height:100%; }
    #gauge { width:100%; height:16px; background:var(--muted); border-radius:8px; overflow:hidden; }
    #gauge-bar { height:100%; width:0; background:var(--gold); transition: width 0.5s; }
    #news-feed { max-height:200px; overflow-y:auto; background:#000; padding-right:8px; }
    .trend-up { color: var(--green); }
    .trend-down { color: var(--red); }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @keyframes blink { 0%{opacity:1;}50%{opacity:0.5;}100%{opacity:1;} }
    .fade-in { animation: fadeIn 1s ease-in; }
    .blink { animation: blink 1.5s infinite; }
    .nav-center { display:flex; justify-content:center; flex-grow:1; }
    #chat-bubble button {
      animation: pulse 2s infinite;
      width:60px; height:60px; font-size:1.5rem;
    }
    @keyframes pulse { 0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);} }
    body::before {
      content:""; position:fixed; inset:0;
      background:url('https://raw.githubusercontent.com/joshbuchea/atom/master/svgs/stars.svg')center/cover no-repeat;
      opacity:0.05; z-index:-1;
    }
  </style>
</head>

<body style="visibility:hidden;">

<div class="d-flex">
  <!-- SIDEBAR -->
  <nav class="bg-panel vh-100 p-3 d-none d-md-block" style="width:220px;">
    <div class="text-center mb-4">
      <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px;cursor:pointer" onclick="location.href='index.html'">
    </div>
    <ul class="nav nav-pills flex-column nav-center">
      <li class="nav-item"><a class="nav-link active text-light blink" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link text-light blink" href="signals.html"><i class="bi-lightning me-2"></i>Signals</a></li>
      <li class="nav-item"><a class="nav-link text-light blink" href="CBE_trade_insights_vip.html"><i class="bi-graph-up me-2"></i>Insights</a></li>
      <li class="nav-item"><a class="nav-link text-light blink" href="CBE_trade_history_vip.html"><i class="bi-clock-history me-2"></i>History</a></li>
      <li class="nav-item"><a class="nav-link text-light blink" href="#" id="chat-launch"><i class="bi-chat-dots me-2"></i>Support</a></li>
    </ul>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="flex-fill">
    <!-- HEADER -->
    <header class="bg-panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top fade-in">
      <div>
        <img src="CBE_logo.PNG" alt="CBE Logo" style="height:40px; cursor:pointer" onclick="location.href='index.html'">
        <h5 class="mb-0 text-gold">Welcome back, <span id="userName" class="fw-bold text-gold">Trader</span>!</h5>
        <small id="currentTime" class="text-muted"></small>
      </div>
      <div class="nav-center d-flex gap-2">
        <button class="btn btn-gold blink" onclick="location.href='signals.html'">Signals</button>
        <button class="btn btn-gold blink" onclick="location.href='CBE_trade_insights_vip.html'">Insights</button>
        <button class="btn btn-gold blink" onclick="location.href='CBE_trade_history_vip.html'">History</button>
      </div>
      <div>
        <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
        <button id="notif-btn" class="btn btn-link text-light position-relative">
          <i class="bi-bell-fill"></i>
          <span class="notif-badge position-absolute top-0 start-100 translate-middle badge bg-danger" id="notif-count">0</span>
        </button>
      </div>
    </header>

    <!-- STATS & LATEST SIGNAL -->
    <div class="container-fluid p-4 fade-in">
      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <h6 class="text-gold">Signals Today</h6>
            <p id="stat-signals" class="fs-2 mb-0 text-gold">0</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <h6 class="text-gold">Insights</h6>
            <p id="stat-insights" class="fs-2 mb-0 text-gold">0</p>
          </div>
        </div>
        <div class="col-12">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Latest Signal</h6>
            <p id="signal-text" class="mb-0 text-gold">Loading…</p>
          </div>
        </div>
      </div>
    </div>

    <!-- UNIQUE FEATURES -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="row g-3">
        <!-- Live Gold Price -->
        <div class="col-md-4">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Live Gold Price (XAU/USD)</h6>
            <p id="gold-price" class="fs-2 mb-0 text-gold">Loading…</p>
          </div>
        </div>
        <!-- Gold Sentiment Gauge -->
        <div class="col-md-4">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Gold Sentiment</h6>
            <div id="gauge" class="mt-2"><div id="gauge-bar"></div></div>
            <p id="sentiment-text" class="text-center mt-2 text-gold">Neutral</p>
          </div>
        </div>
        <!-- Gold News Feed -->
        <div class="col-md-4">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Latest Gold News</h6>
            <div id="news-feed" class="mt-2"><p>Loading news…</p></div>
          </div>
        </div>
      </div>
      <!-- Prediction & New Signal -->
      <div class="row g-3 mt-4">
        <div class="col-md-6">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Gold Price Prediction</h6>
            <p id="prediction-text" class="mb-0 text-gold">Predicted Price: $1800.00 (Confidence: 85%)</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Latest Gold Trading Signal</h6>
            <p id="signal-text-new" class="mb-0 text-gold">Buy at $1795.00 (Reason: RSI Oversold)</p>
          </div>
        </div>
      </div>
      <!-- Economic Calendar -->
      <div class="row g-3 mt-4">
        <div class="col-12">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Economic Events Impacting Gold</h6>
            <div id="economic-calendar" class="mt-2"></div>
          </div>
        </div>
      </div>
      <!-- Recent Trade History -->
      <div class="row g-3 mt-4">
        <div class="col-12">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Recent Trade History</h6>
            <div id="trade-history" class="mt-2"><p>Loading history…</p></div>
          </div>
        </div>
      </div>
    </div>

    <!-- FULL-SCREEN CHART -->
    <div id="chart-container" class="fade-in">
      <div id="tv_chart"></div>
      <div id="chart-error" class="text-danger text-center" style="display:none;">Chart failed to load.</div>
    </div>

    <footer class="text-center py-3 text-muted fade-in">© 2025 CBE Global FX</footer>
  </div>
</div>

<!-- CHAT BUBBLE -->
<div id="chat-bubble" class="position-fixed bottom-0 end-0 m-3" style="z-index:1000;">
  <button class="btn btn-gold rounded-circle p-3" onclick="smartsupp('chat:open')">
    <i class="bi-chat-dots"></i>
  </button>
</div>

<!-- NOTIF SOUND -->
<audio id="notif-sound" src="ding.mp3" preload="auto"></audio>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async></script>

<script>
  // Show UI & Set User
  document.body.style.visibility = 'visible';
  const userName = sessionStorage.getItem('cbeUserName') || 'Trader';
  document.getElementById('userName').textContent = userName;

  // Live Clock
  const timeEl = document.getElementById('currentTime');
  function updateClock() {
    timeEl.textContent = new Date().toLocaleString();
  }
  updateClock(); setInterval(updateClock,60000);

  // Theme Toggle
  const themeBtn = document.getElementById('theme-toggle');
  let theme = localStorage.getItem('theme')||'dark';
  document.documentElement.setAttribute('data-theme',theme);
  themeBtn.innerHTML = theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
  themeBtn.onclick = ()=>{
    theme = theme==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',theme);
    localStorage.setItem('theme',theme);
    themeBtn.innerHTML = theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
  };

  // Chat Launcher
  document.getElementById('chat-launch').onclick = e=>{e.preventDefault(); smartsupp('chat:open');};

  // Supabase Init
  const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVC...ABpEMsQ';
  const supabase = window.supabase.createClient(SUPA_URL,SUPA_KEY);

  // ① Stats
  async function initStats(){
    const today = new Date().toISOString().split('T')[0];
    try {
      const [{count:sigs}, {count:ins}] = await Promise.all([
        supabase.from('signals').select('*',{count:'exact'}).gte('created_at',today),
        supabase.from('trade_insights').select('*',{count:'exact'})
      ]);
      document.getElementById('stat-signals').textContent = sigs;
      document.getElementById('stat-insights').textContent = ins;
    } catch(e){ console.error(e); }
  }

  // ② Latest Live Signal
  async function fetchLatestSignal(){
    const el = document.getElementById('signal-text');
    el.textContent = 'Loading…';
    try {
      let {data, error} = await supabase.from('signals')
        .select('details, created_at').order('created_at',{ascending:false}).limit(1);
      if(error) throw error;
      if(!data.length) return el.textContent = 'No signals available';
      el.textContent = `${data[0].details} (${new Date(data[0].created_at).toLocaleString()})`;
    } catch(e){
      console.error(e); el.textContent = 'Error loading signal';
    }
  }

  // ③ Real-Time Gold Price (simulated)
  let last = 1800;
  function updateGoldPrice(){
    const ch = (Math.random()-0.5)*2;
    last += ch;
    const p = document.getElementById('gold-price');
    p.textContent = last.toFixed(2);
    p.className = ch>0?'trend-up':'trend-down';
  }

  // ④ Gold Sentiment from DB
  async function updateSentimentFromDB(){
    try {
      let {data,error} = await supabase.from('gold_sentiment')
        .select('score').order('recorded_at',{ascending:false}).limit(1);
      if(error) throw error;
      const score = data.length?data[0].score:Math.random()*100;
      const bar = document.getElementById('gauge-bar');
      const txt = document.getElementById('sentiment-text');
      bar.style.width = score+'%';
      if(score>60){
        txt.textContent='Bullish'; txt.className='text-center mt-2 trend-up';
      } else if(score<40){
        txt.textContent='Bearish'; txt.className='text-center mt-2 trend-down';
      } else {
        txt.textContent='Neutral'; txt.className='text-center mt-2 text-gold';
      }
    } catch(e){console.error(e);}
  }

  // ⑤ Load Gold News
  async function loadGoldNews(){
    const feed = document.getElementById('news-feed');
    feed.innerHTML = '<p>Loading news…</p>';
    try {
      let {data, error} = await supabase.from('gold_news')
        .select('headline,url,published_at').order('published_at',{ascending:false}).limit(5);
      if(error) throw error;
      if(!data.length) return feed.innerHTML='<p class="text-muted">No news.</p>';
      feed.innerHTML = data.map(n=>`
        <p class="mb-1">
          <a href="${n.url}" target="_blank" class="text-gold">${n.headline}</a><br>
          <small class="text-muted">${new Date(n.published_at).toLocaleDateString()}</small>
        </p>
      `).join('');
    } catch(e){
      console.error(e); feed.innerHTML='<p class="text-danger">Failed to load news.</p>';
    }
  }

  // ⑥ Recent Trade History
  async function loadTradeHistory(){
    const c = document.getElementById('trade-history');
    c.innerHTML = '<p>Loading history…</p>';
    try {
      let {data,error} = await supabase.from('trade_insights')
        .select('entry,sl,tp1,tp2,note,created_at')
        .order('created_at',{ascending:false}).limit(5);
      if(error) throw error;
      if(!data.length) return c.innerHTML='<p class="text-muted">No history.</p>';
      c.innerHTML = data.map(sig=>{
        const dt = new Date(sig.created_at);
        return `
        <div class="signal-card mb-3 fade-in">
          <div class="signal-header">
            <h2>${dt.toLocaleDateString()}</h2>
            <div class="time">${dt.toLocaleTimeString()}</div>
          </div>
          <div class="signal-body">
            <div class="detail" data-type="entry">Entry: <span>${sig.entry}</span></div>
            <div class="detail">SL: <span>${sig.sl}</span></div>
            <div class="detail">TP1: <span>${sig.tp1}</span></div>
            <div class="detail">TP2: <span>${sig.tp2}</span></div>
          </div>
          <div class="admin-note">${sig.note||'—'}</div>
        </div>`;
      }).join('');
    } catch(e){
      console.error(e); c.innerHTML='<p class="text-danger">Failed to load history.</p>';
    }
  }

  // ⑦ TradingView Chart
  try {
    new TradingView.widget({
      container_id: 'tv_chart', width:'100%', height:'100%',
      symbol:'OANDA:XAUUSD', interval:'60',
      theme:document.documentElement.getAttribute('data-theme')||'dark',
      style:'1', locale:'en', toolbar_bg:'#000',
      hide_side_toolbar:false, enable_publishing:false, allow_symbol_change:false
    });
  } catch(e){
    console.error(e); document.getElementById('chart-error').style.display='block';
  }

  // ⑧ Economic Calendar
  new TradingView.widget({
    container_id: "economic-calendar", width:"100%", height:400,
    colorTheme:"dark", isTransparent:true, locale:"en", importanceFilter:"-1,0,1"
  });

  // ⑨ Real-time subscriptions & notifications
  const notifCnt = document.getElementById('notif-count');
  const notifList = document.createElement('ul');
  notifList.className = 'dropdown-menu';
  document.body.append(notifList);

  function updateNotifs(type,txt){
    const li = document.createElement('li');
    li.className='dropdown-item'; li.textContent=`${type}: ${txt}`;
    notifList.prepend(li);
    if(notifList.children.length>10) notifList.removeChild(notifList.lastChild);
    notifCnt.textContent = parseInt(notifCnt.textContent)+1;
    document.getElementById('notif-sound').play();
  }
  document.getElementById('notif-btn').onclick = e=>{
    e.stopPropagation();
    notifList.style.display = notifList.style.display==='block'?'none':'block';
  };
  document.addEventListener('click',()=>notifList.style.display='none');

  // ⑩ Supabase Realtime listeners
  const today = new Date().toISOString().split('T')[0];
  supabase.channel('signals')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'signals'},payload=>{
      const day = new Date(payload.new.created_at).toISOString().split('T')[0];
      if(day===today){
        document.getElementById('stat-signals').textContent =
          parseInt(document.getElementById('stat-signals').textContent)+1;
      }
      updateNotifs('Signal', new Date(payload.new.created_at).toLocaleString());
      fetchLatestSignal();
    }).subscribe();

  supabase.channel('trade_insights')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'trade_insights'},payload=>{
      document.getElementById('stat-insights').textContent =
        parseInt(document.getElementById('stat-insights').textContent)+1;
      updateNotifs('Insight', new Date(payload.new.created_at).toLocaleString());
      loadTradeHistory();
    }).subscribe();

  // ⑪ Kick everything off
  document.addEventListener('DOMContentLoaded', ()=>{
    initStats();
    fetchLatestSignal();
    updateGoldPrice(); setInterval(updateGoldPrice,1000);
    updateSentimentFromDB(); setInterval(updateSentimentFromDB,15000);
    loadGoldNews(); setInterval(loadGoldNews,60000);
    loadTradeHistory(); setInterval(loadTradeHistory,60000);
  });
</script>
</body>
</html>
