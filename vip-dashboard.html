<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VIP Dashboard â€“ CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- BOOTSTRAP, ICONS & FONTS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- CHART.JS, SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d) {
      var s, c, o = smartsupp = function() { o._.push(arguments); }; o._ = [];
      s = d.getElementsByTagName('script')[0]; c = d.createElement('script');
      c.type = 'text/javascript'; c.charset = 'utf-8'; c.async = true;
      c.src = 'https://www.smartsuppchat.com/loader.js?'; s.parentNode.insertBefore(c, s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #111;
      --panel: rgba(20,20,20,0.9);
      --gold: #bfa057;
      --text: #f0f0f0;
      --muted: #666;
      --glass-bg: rgba(255,255,255,0.05);
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Poppins', sans-serif;
    }
    .panel {
      background: var(--panel);
      border-radius: 8px;
    }
    .card-stat {
      background: var(--glass-bg);
      border: 1px solid var(--gold);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      backdrop-filter: blur(8px);
    }
    h1, h2, h3, h4, h5 {
      color: var(--gold);
    }
    .btn-gold {
      background: var(--gold);
      border-color: var(--gold);
      color: #000;
    }
    .btn-gold:hover {
      background: #e6c65d;
    }
    #chart-container {
      position: relative;
      height: 100vh;
      width: 100%;
    }
    #tv_chart {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://raw.githubusercontent.com/joshbuchea/atom/master/svgs/stars.svg') center/cover no-repeat;
      opacity: 0.05;
      z-index: -1;
    }
    .notif-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--gold);
      color: #000;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: .7rem;
    }
    .notif-dropdown {
      position: absolute;
      right: 10px;
      background: var(--panel);
      border: 1px solid var(--gold);
      padding: 10px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <div class="d-flex">
    <!-- SIDEBAR -->
    <nav class="panel vh-100 p-3 d-none d-md-block" style="width:220px;">
      <div class="text-center mb-4">
        <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px; cursor:pointer;" onclick="location.href='index.html'">
      </div>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item"><a class="nav-link active text-light" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="signals.html"><i class="bi-lightning"></i> Signals</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_insights_vip.html"><i class="bi-graph-up"></i> Insights</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_history_vip.html"><i class="bi-clock-history"></i> History</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="#" id="chat-launch"><i class="bi-chat-dots"></i> Support</a></li>
      </ul>
    </nav>

    <!-- MAIN -->
    <div class="flex-fill">
      <!-- HEADER -->
      <header class="panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top">
        <div>
          <h5 class="mb-0">Welcome back, <span id="userName" class="fw-bold">Trader</span>!</h5>
          <small id="currentTime" class="text-muted"></small>
        </div>
        <div>
          <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
          <button id="notif-btn" class="btn btn-link text-light position-relative">
            <i class="bi-bell-fill"></i>
            <span class="notif-badge" id="notif-count">0</span>
          </button>
        </div>
      </header>

      <!-- STATS CARDS (Styled like Admin Dashboard) -->
      <div class="row g-3 p-4">
        <div class="col-md-4">
          <div class="card-stat">
            <h4>Signals Today</h4>
            <h2 id="stat-signals" class="mb-0">0</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card-stat">
            <h4>Insights</h4>
            <h2 id="stat-insights" class="mb-0">0</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card-stat">
            <h4>History Logs</h4>
            <h2 id="stat-history" class="mb-0">0</h2>
          </div>
        </div>
      </div>

      <!-- SIGNALS PERFORMANCE CHART -->
      <div class="panel mx-4 p-3 mb-4">
        <h5>Recent Signals Performance</h5>
        <canvas id="signals-chart" height="200"></canvas>
      </div>

      <!-- MARKET SENTIMENT -->
      <div class="panel mx-4 p-3 mb-4">
        <h5>Market Sentiment</h5>
        <div id="sentiment" class="bg-dark rounded" style="height:60px; position:relative;">
          <div id="sent-bar" style="height:100%; width:50%; transition: all 0.5s;"></div>
        </div>
      </div>

      <!-- SESSION VOLUME HEATMAP -->
      <div class="panel mx-4 p-3 mb-4">
        <h5>Session Volume Heatmap</h5>
        <div class="d-flex">
          <div class="flex-fill p-2 me-1" id="tokyo" style="height:20px;"></div>
          <div class="flex-fill p-2 me-1" id="london" style="height:20px;"></div>
          <div class="flex-fill p-2" id="ny" style="height:20px;"></div>
        </div>
      </div>

      <!-- MINI NEWS FEED -->
      <div class="panel mx-4 p-3 mb-4">
        <h5>Forex News</h5>
        <ul id="news-list" class="list-unstyled"></ul>
      </div>

      <!-- CURRENCY STRENGTH METER (New Feature) -->
      <div class="panel mx-4 p-3 mb-4">
        <h5>Currency Strength Meter</h5>
        <div id="strength-meter" class="d-flex flex-wrap"></div>
      </div>

      <!-- QUICK ACCESS -->
      <div class="row g-3 mx-4 mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="panel p-3 text-center">
            <i class="bi-lightning fs-1 text-gold"></i>
            <h6 class="mt-2">Signals</h6>
            <a href="signals.html" class="btn btn-gold btn-sm mt-2">Go</a>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="panel p-3 text-center">
            <i class="bi-graph-up fs-1 text-gold"></i>
            <h6 class="mt-2">Insights</h6>
            <a href="CBE_trade_insights_vip.html" class="btn btn-gold btn-sm mt-2">Go</a>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="panel p-3 text-center">
            <i class="bi-clock-history fs-1 text-gold"></i>
            <h6 class="mt-2">History</h6>
            <a href="CBE_trade_history_vip.html" class="btn btn-gold btn-sm mt-2">Go</a>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="panel p-3 text-center">
            <i class="bi-bar-chart-line fs-1 text-gold"></i>
            <h6 class="mt-2">Live Chart</h6>
            <a href="#chart-container" class="btn btn-gold btn-sm mt-2">View</a>
          </div>
        </div>
      </div>

      <!-- FULLSCREEN CHART -->
      <div id="chart-container">
        <div id="tv_chart"></div>
      </div>

      <footer class="text-center py-3 text-muted">Â© 2025 CBE Global FX</footer>
    </div>
  </div>

  <!-- SOUND -->
  <audio id="notif-sound" src="ding.mp3" preload="auto"></audio>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Show UI & set user
    document.body.style.visibility = 'visible';
    document.getElementById('userName').textContent = sessionStorage.getItem('cbeUserName') || 'Trader';

    // Clock
    const timeEl = document.getElementById('currentTime');
    function refreshTime() {
      timeEl.textContent = new Date().toLocaleString();
    }
    refreshTime();
    setInterval(refreshTime, 60000);

    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    let theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    themeBtn.innerText = theme === 'dark' ? 'ðŸŒž' : 'ðŸŒœ';
    themeBtn.onclick = () => {
      theme = theme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeBtn.innerText = theme === 'dark' ? 'ðŸŒž' : 'ðŸŒœ';
    };

    // Chat launcher
    document.getElementById('chat-launch').onclick = e => {
      e.preventDefault();
      smartsupp('chat:open');
    };

    // Supabase init
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // TradingView Chart
    new TradingView.widget({
      container_id: 'tv_chart',
      width: '100%',
      height: '100%',
      symbol: 'OANDA:XAUUSD',
      interval: '60',
      theme: 'dark',
      style: '1',
      locale: 'en',
      toolbar_bg: '#000',
      hide_side_toolbar: false,
      enable_publishing: false,
      allow_symbol_change: true
    });

    // Notifications & Stats
    const notifBtn = document.getElementById('notif-btn'),
          notifCnt = document.getElementById('notif-count'),
          notifList = document.createElement('ul'),
          notifSound = document.getElementById('notif-sound'),
          counts = { signals: 0, insights: 0, history: 0 },
          items = [];
    notifList.className = 'notif-dropdown';
    document.body.append(notifList);
    function renderNotifs() {
      notifList.innerHTML = items.length
        ? items.map(i => `<li class="notif-item">${i}</li>`).join('')
        : `<li class="notif-item">No notifications</li>`;
    }
    function pushNotif(type, text) {
      items.unshift(`${type}: ${text}`);
      if (items.length > 10) items.pop();
      renderNotifs();
      notifCnt.textContent = counts.signals + counts.insights + counts.history;
      notifSound.play();
    }
    notifBtn.onclick = e => {
      e.stopPropagation();
      notifList.style.display = notifList.style.display === 'block' ? 'none' : 'block';
    };
    document.addEventListener('click', () => notifList.style.display = 'none');

    // Real-time subscriptions
    function subscribeTable(tbl) {
      const channel = supabase.channel(tbl).on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: tbl
      }, payload => {
        const key = tbl === 'signals' ? 'signals' : tbl === 'trade_insights' ? 'insights' : 'history';
        counts[key]++;
        document.getElementById(`stat-${key}`).textContent = counts[key];
        pushNotif(tbl === 'signals' ? 'Signal' : tbl === 'trade_insights' ? 'Insight' : 'History',
          new Date((payload.new.created_at || payload.new.timestamp)).toLocaleString());
      }).subscribe();
      channel.on('subscription_error', () => channel.subscribe());
    }
    ['signals', 'trade_insights', 'trade_history'].forEach(subscribeTable);

    // Initialize counts
    (async () => {
      const [{ count: cs }, { count: ci }, { count: ch }] = await Promise.all([
        supabase.from('signals').select('*', { count: 'exact' }),
        supabase.from('trade_insights').select('*', { count: 'exact' }),
        supabase.from('trade_history').select('*', { count: 'exact' })
      ]);
      counts.signals = cs;
      counts.insights = ci;
      counts.history = ch;
      ['signals', 'insights', 'history'].forEach(k => {
        document.getElementById(`stat-${k}`).textContent = counts[k];
      });
      notifCnt.textContent = cs + ci + ch;
      renderNotifs();
    })();

    // Market Sentiment
    function getSentimentColor(pct) {
      if (pct < 30) return '#ff0000'; // Red
      if (pct <= 70) return '#ffff00'; // Yellow
      if (pct <= 85) return '#00ff00'; // Light Green
      return '#008000'; // Dark Green
    }
    setInterval(() => {
      const pct = Math.random() * 100; // Replace with real data later
      const bar = document.getElementById('sent-bar');
      bar.style.width = pct + '%';
      bar.style.backgroundColor = getSentimentColor(pct);
    }, 15000);
    const initialPct = Math.random() * 100;
    const bar = document.getElementById('sent-bar');
    bar.style.width = initialPct + '%';
    bar.style.backgroundColor = getSentimentColor(initialPct);

    // Session Volume Heatmap
    function getActiveSessions() {
      const now = new Date();
      const hours = now.getUTCHours();
      const active = [];
      if (hours >= 0 && hours < 9) active.push('tokyo');
      if (hours >= 8 && hours < 17) active.push('london');
      if (hours >= 13 && hours < 22) active.push('ny');
      return active;
    }
    function updateSessionHeatmap() {
      const active = getActiveSessions();
      ['tokyo', 'london', 'ny'].forEach(session => {
        const el = document.getElementById(session);
        el.style.backgroundColor = active.includes(session) ? 'var(--gold)' : 'var(--muted)';
      });
    }
    updateSessionHeatmap();
    setInterval(updateSessionHeatmap, 60000);

    // Signals Performance Chart
    async function loadSignalsChart() {
      const { data: signals, error } = await supabase
        .from('signals')
        .select('created_at, result')
        .order('created_at', { ascending: false })
        .limit(5);
      if (error) {
        console.error('Error fetching signals:', error);
        return;
      }
      const chartData = signals.map(s => ({
        date: new Date(s.created_at).toLocaleDateString(),
        pips: s.result || Math.random() * 100 - 50 // Fallback if no result
      }));
      new Chart(document.getElementById('signals-chart'), {
        type: 'bar',
        data: {
          labels: chartData.map(s => s.date),
          datasets: [{
            label: 'Pips',
            data: chartData.map(s => s.pips),
            backgroundColor: chartData.map(s => s.pips > 0 ? '#00ff00' : '#ff0000'),
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    loadSignalsChart();

    // Mini News Feed (Mocked)
    const mockNews = [
      { title: 'USD strengthens against EUR', date: '2023-04-05' },
      { title: 'BOE raises interest rates', date: '2023-04-04' },
      { title: 'Oil prices surge', date: '2023-04-03' },
    ];
    const newsList = document.getElementById('news-list');
    mockNews.forEach(news => {
      const li = document.createElement('li');
      li.innerHTML = `<small>${news.date}</small> - ${news.title}`;
      newsList.appendChild(li);
    });

    // Currency Strength Meter (New Feature)
    const currencies = ['USD', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'NZD'];
    function updateCurrencyStrength() {
      const meter = document.getElementById('strength-meter');
      meter.innerHTML = '';
      currencies.forEach(currency => {
        const strength = Math.random() * 100; // Replace with real data
        const div = document.createElement('div');
        div.className = 'p-2';
        div.style.width = '12.5%';
        div.innerHTML = `
          <small>${currency}</small>
          <div class="bg-dark rounded" style="height:20px;">
            <div style="width:${strength}%; height:100%; background:${strength > 50 ? '#00ff00' : '#ff0000'};"></div>
          </div>
        `;
        meter.appendChild(div);
      });
    }
    updateCurrencyStrength();
    setInterval(updateCurrencyStrength, 30000);
  </script>
</body>
</html>
