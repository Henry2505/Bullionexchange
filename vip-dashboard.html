<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- Auth Guard -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- CSS + Icons + Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- TradingView + Chart.js -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #1a1a1a;
      --panel: rgba(30, 30, 30, 0.95);
      --gold: #d4af37;
      --text: var(--gold);
      --muted: #888;
      --green: #00cc66;
      --red: #ff4444;
    }
    [data-theme="light"] {
      --bg: #f0f2f5;
      --panel: rgba(255, 255, 255, 0.95);
      --text: #b8860b;
      --gold: #b8860b;
    }
    body {
      background: linear-gradient(135deg, var(--bg), #222);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      overflow-x: hidden;
    }
    .bg-panel {
      background: var(--panel);
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }
    .card {
      transition: transform 0.3s, box-shadow 0.3s;
      border: none;
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
    }
    .text-gold {
      color: var(--gold) !important;
    }
    .btn-gold {
      background: var(--gold);
      color: #1a1a1a;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: 500;
    }
    .btn-gold:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.6);
    }
    .fade-in {
      animation: fadeIn 0.8s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #tv_chart_4h, #news-widget, #calendar-widget {
      width: 100%;
      height: 600px;
      border-radius: 10px;
      overflow: hidden;
    }
    .circle {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin: 0 2px;
    }
    .circle.win {
      background: var(--green);
    }
    .circle.loss {
      background: var(--red);
    }
    /* Signal card styling */
    .signal-card {
      border-left: 5px solid var(--gold);
    }
    .signal-detail {
      background: rgba(40, 40, 40, 0.6);
      border-radius: 8px;
      padding: 10px;
    }
    .signal-value {
      font-weight: 700;
      font-size: 1.2rem;
    }
    .signal-label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .notification-item {
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      padding: 10px 0;
    }
    .notification-item:last-child {
      border-bottom: none;
    }
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      #tv_chart_4h, #news-widget, #calendar-widget {
        height: 400px;
      }
      .stats-card {
        margin-bottom: 15px;
      }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start bg-panel" id="sidebar">
    <div class="offcanvas-body">
      <div class="text-center mb-4">
        <img src="CBE_logo.PNG" alt="CBE Logo" style="width: 120px; cursor: pointer;" onclick="location.href='index.html'">
      </div>
      <ul class="nav nav-pills flex-column text-gold">
        <li class="nav-item"><a class="nav-link active text-gold" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link text-gold" href="signals.html"><i class="bi-lightning me-2"></i>Signals</a></li>
        <li class="nav-item"><a class="nav-link text-gold" href="CBE_trade_insights_vip.html"><i class="bi-graph-up me-2"></i>Insights</a></li>
        <li class="nav-item"><a class="nav-link text-gold" href="CBE_trade_history_vip.html"><i class="bi-clock-history me-2"></i>History</a></li>
      </ul>
    </div>
  </div>

  <div class="d-flex">
    <div class="flex-fill">
      <!-- Header -->
      <header class="d-flex justify-content-between align-items-center bg-panel p-3 sticky-top fade-in">
        <div class="d-flex align-items-center">
          <button class="btn btn-link text-gold d-md-none me-2" data-bs-toggle="offcanvas" data-bs-target="#sidebar"><i class="bi-list"></i></button>
          <div>
            <h5 class="mb-1 text-gold">Welcome, <span id="userName">VIP Trader</span>!</h5>
            <small id="currentTime" class="text-gold"></small>
          </div>
        </div>
        <div class="position-relative">
          <button id="notif-btn" class="btn btn-link text-gold position-relative">
            <i class="bi-bell-fill"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge bg-danger" id="notif-count">0</span>
          </button>
          <div id="notif-menu" class="dropdown-menu dropdown-menu-end p-2 bg-panel" style="min-width: 300px;">
            <h6 class="dropdown-header text-gold">Notifications</h6>
            <div id="notif-list" class="text-gold">
              <div class="notification-item">No new notifications</div>
            </div>
          </div>
        </div>
        <button id="theme-toggle" class="btn btn-link text-gold"><i class="bi-sun-fill"></i></button>
      </header>

      <!-- Main Content -->
      <div class="container-fluid p-4">
        <!-- Latest Signal Card -->
        <div class="card bg-panel p-4 mb-4 fade-in signal-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="text-gold">Latest Signal</h2>
            <div>
              <button id="refresh-signal" class="btn btn-sm btn-gold me-2"><i class="bi-arrow-clockwise"></i></button>
              <small id="signal-time" class="text-gold">Just now</small>
            </div>
          </div>
          <div id="signal-body" class="text-gold">
            <div class="row">
              <div class="col-md-3 mb-3">
                <div class="signal-detail">
                  <div class="signal-label">Asset</div>
                  <div class="signal-value" id="signal-asset">XAU/USD</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="signal-detail">
                  <div class="signal-label">Entry</div>
                  <div class="signal-value" id="signal-entry">2,345.67</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="signal-detail">
                  <div class="signal-label">Stop Loss</div>
                  <div class="signal-value" id="signal-sl">2,340.50</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="signal-detail">
                  <div class="signal-label">Take Profit</div>
                  <div class="signal-value" id="signal-tp">2,360.80</div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <div class="signal-label">Note</div>
              <div id="signal-note">Enter trade on pullback to 2345.50-2346.00 area with tight stop</div>
            </div>
          </div>
        </div>

        <!-- Stats Row + 24h Change -->
        <div class="row g-4 mb-4 fade-in">
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center stats-card">
              <h6 class="text-gold"><i class="bi-lightning me-2"></i>Signals Today</h6>
              <p id="stat-signals" class="fs-3 mb-2 text-gold">0</p>
              <a href="signals.html" class="btn btn-gold">Latest Signals</a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center stats-card">
              <h6 class="text-gold"><i class="bi-graph-up me-2"></i>Insights</h6>
              <p id="stat-insights" class="fs-3 mb-2 text-gold">0</p>
              <a href="CBE_trade_insights_vip.html" class="btn btn-gold">Trade Insights</a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center stats-card">
              <h6 class="text-gold"><i class="bi-clock-history me-2"></i>Recent Trades</h6>
              <p id="stat-trades" class="fs-3 mb-2 text-gold">0</p>
              <a href="CBE_trade_history_vip.html" class="btn btn-gold">Trade History</a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center stats-card">
              <h6 class="text-gold"><i class="bi-currency-exchange me-2"></i>24h Gold Δ</h6>
              <p id="stat-gold-change" class="fs-3 mb-0 text-gold">+1.25%</p>
              <div class="d-flex justify-content-center mt-2">
                <span class="circle win"></span>
                <span class="circle win"></span>
                <span class="circle win"></span>
                <span class="circle win"></span>
                <span class="circle loss"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- 4H XAU/USD Chart -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="text-gold mb-0">XAU/USD (4H)</h2>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-gold active">4H</button>
              <button class="btn btn-sm btn-outline-gold">1D</button>
              <button class="btn btn-sm btn-outline-gold">1W</button>
            </div>
          </div>
          <div id="tv_chart_4h"></div>
        </div>

        <!-- Stats Charts -->
        <div class="row g-4 mb-4 fade-in">
          <div class="col-md-6">
            <div class="card bg-panel p-4">
              <h2 class="text-gold mb-3">Win Rate</h2>
              <canvas id="win-rate-chart" height="250"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-panel p-4">
              <h2 class="text-gold mb-3">Monthly Performance</h2>
              <canvas id="performance-chart" height="250"></canvas>
            </div>
          </div>
        </div>

        <!-- Gold News -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Gold Market News</h2>
          <div id="news-container">
            <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
              <div class="spinner-border text-gold" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Economic Calendar -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">Economic Calendar</h2>
          <div id="calendar-container">
            <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
              <div class="spinner-border text-gold" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center py-3 text-gold fade-in">© 2025 CBE Global FX</footer>
    </div>
  </div>

  <audio id="notif-sound" src="data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" preload="auto"></audio>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Supabase Initialization
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Format time function
    const fmtTime = ts => {
      const date = new Date(ts);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + 
             ' • ' + date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    };

    // Load Latest Signal
    async function loadLatestSignal() {
      try {
        // Simulated signal data (replace with actual Supabase call)
        const signalData = {
          asset: "XAU/USD",
          entry: "2345.67",
          sl: "2335.50",
          tp: "2360.80",
          note: "Enter trade on pullback to 2345.50-2346.00 area with tight stop loss",
          time: new Date()
        };

        // Update the UI with signal data
        document.getElementById('signal-asset').textContent = signalData.asset;
        document.getElementById('signal-entry').textContent = signalData.entry;
        document.getElementById('signal-sl').textContent = signalData.sl;
        document.getElementById('signal-tp').textContent = signalData.tp;
        document.getElementById('signal-note').textContent = signalData.note;
        document.getElementById('signal-time').textContent = fmtTime(signalData.time);
        
        // Add notification for new signal
        addNotification('New trading signal received', 'signal');
        
      } catch (err) {
        console.error('Error loading signal:', err);
        document.getElementById('signal-body').innerHTML = `
          <div class="alert alert-danger">
            Error loading latest signal. Please try again.
          </div>`;
      }
    }

    // Load Dashboard Stats
    async function loadDashboard() {
      // Simulated stats data (replace with actual Supabase calls)
      document.getElementById('stat-signals').textContent = '12';
      document.getElementById('stat-insights').textContent = '24';
      document.getElementById('stat-trades').textContent = '38';
      document.getElementById('stat-gold-change').textContent = '+1.25%';
    }

    // Initialize TradingView Chart
    function initTradingView() {
      new TradingView.widget({
        container_id: 'tv_chart_4h',
        width: '100%',
        height: '600',
        symbol: 'OANDA:XAUUSD',
        interval: '240',
        timezone: 'Etc/UTC',
        theme: localStorage.getItem('theme') || 'dark',
        toolbar_bg: '#1a1a1a',
        allow_symbol_change: true,
        withdateranges: true,
        studies: ['MASimple@tv-basicstudies', 'RSI@tv-basicstudies'],
        style: '1',
        locale: 'en'
      });
    }

    // Initialize Charts
    function initCharts() {
      // Win Rate Chart
      const winRateCtx = document.getElementById('win-rate-chart').getContext('2d');
      new Chart(winRateCtx, {
        type: 'doughnut',
        data: {
          labels: ['Wins', 'Losses'],
          datasets: [{
            data: [78, 22],
            backgroundColor: ['#00cc66', '#ff4444'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#d4af37',
                font: {
                  size: 14
                }
              }
            },
            title: {
              display: false
            }
          },
          cutout: '70%'
        }
      });

      // Performance Chart
      const perfCtx = document.getElementById('performance-chart').getContext('2d');
      new Chart(perfCtx, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Profit (Pips)',
            data: [320, 450, 280, 510, 390, 620],
            backgroundColor: '#d4af37',
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#d4af37'
              },
              grid: {
                color: 'rgba(212, 175, 55, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#d4af37'
              },
              grid: {
                color: 'rgba(212, 175, 55, 0.1)'
              }
            }
          }
        }
      });
    }

    // Load news data
    async function loadNews() {
      const newsContainer = document.getElementById('news-container');
      newsContainer.innerHTML = `
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action bg-transparent text-gold border-gold">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">Gold Prices Surge as Fed Hints at Rate Cuts</h6>
              <small>3 hours ago</small>
            </div>
            <p class="mb-1">Gold prices climbed to a two-week high after Fed Chair Powell signaled potential rate cuts later this year.</p>
          </a>
          <a href="#" class="list-group-item list-group-item-action bg-transparent text-gold border-gold">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">Geopolitical Tensions Boost Safe-Haven Demand</h6>
              <small>5 hours ago</small>
            </div>
            <p class="mb-1">Ongoing tensions in the Middle East are driving investors toward gold as a safe-haven asset.</p>
          </a>
          <a href="#" class="list-group-item list-group-item-action bg-transparent text-gold border-gold">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">Central Banks Continue Gold Buying Spree</h6>
              <small>Yesterday</small>
            </div>
            <p class="mb-1">Global central banks added 28 tonnes of gold to reserves in May, continuing the strong buying trend.</p>
          </a>
        </div>
      `;
    }

    // Load economic calendar
    async function loadCalendar() {
      const calendarContainer = document.getElementById('calendar-container');
      calendarContainer.innerHTML = `
        <table class="table table-borderless text-gold">
          <thead>
            <tr>
              <th>Time</th>
              <th>Event</th>
              <th>Currency</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>14:30</td>
              <td>US Core CPI m/m</td>
              <td>USD</td>
              <td><span class="badge bg-danger">High</span></td>
            </tr>
            <tr>
              <td>15:00</td>
              <td>Fed Interest Rate Decision</td>
              <td>USD</td>
              <td><span class="badge bg-danger">High</span></td>
            </tr>
            <tr>
              <td>12:00</td>
              <td>UK GDP m/m</td>
              <td>GBP</td>
              <td><span class="badge bg-warning">Medium</span></td>
            </tr>
            <tr>
              <td>09:30</td>
              <td>Eurozone Industrial Production</td>
              <td>EUR</td>
              <td><span class="badge bg-warning">Medium</span></td>
            </tr>
          </tbody>
        </table>
      `;
    }

    // Add notification
    function addNotification(message, type = 'info') {
      const notifList = document.getElementById('notif-list');
      const notifCount = document.getElementById('notif-count');
      
      // Create notification element
      const notifItem = document.createElement('div');
      notifItem.className = 'notification-item';
      
      // Set icon based on type
      let icon = 'bi-info-circle';
      if (type === 'signal') icon = 'bi-lightning';
      if (type === 'alert') icon = 'bi-exclamation-triangle';
      
      notifItem.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi ${icon} me-2"></i>
          <div>${message}</div>
        </div>
        <small class="text-muted">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
      `;
      
      // Add to top of list
      if (notifList.firstChild.textContent === 'No new notifications') {
        notifList.innerHTML = '';
      }
      notifList.insertBefore(notifItem, notifList.firstChild);
      
      // Update count
      const count = parseInt(notifCount.textContent) + 1;
      notifCount.textContent = count;
      
      // Play notification sound
      document.getElementById('notif-sound').play();
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Set username
      const username = sessionStorage.getItem('cbeUserName') || 'VIP Trader';
      document.getElementById('userName').textContent = username;
      
      // Load data
      loadLatestSignal();
      loadDashboard();
      initTradingView();
      initCharts();
      loadNews();
      loadCalendar();
      
      // Set up refresh button
      document.getElementById('refresh-signal').addEventListener('click', loadLatestSignal);
      
      // Set up real-time notifications for signals (simulated)
      setInterval(() => {
        // Simulate receiving a new signal every 2-5 minutes
        if (Math.random() > 0.7) {
          const assets = ['XAU/USD', 'EUR/USD', 'GBP/USD', 'USD/JPY'];
          const asset = assets[Math.floor(Math.random() * assets.length)];
          addNotification(`New signal for ${asset}`, 'signal');
        }
      }, 120000); // Every 2 minutes
      
      // Set up clock
      setInterval(() => {
        document.getElementById('currentTime').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }, 1000);
      
      // Theme Toggle
      const themeBtn = document.getElementById('theme-toggle');
      let theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      themeBtn.innerHTML = theme === 'dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
      
      themeBtn.addEventListener('click', () => {
        theme = theme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        themeBtn.innerHTML = theme === 'dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
        initTradingView(); // Re-initialize chart with new theme
      });
      
      // Notification dropdown
      document.getElementById('notif-btn').addEventListener('click', function() {
        // Reset count when notifications are viewed
        document.getElementById('notif-count').textContent = '0';
      });
    });
  </script>
</body>
</html>
