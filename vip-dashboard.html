<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- BOOTSTRAP & ICONS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d) {
      var s, c, o = smartsupp = function() { o._.push(arguments) }; o._ = [];
      s = d.getElementsByTagName('script')[0]; c = d.createElement('script');
      c.async = true; c.src = 'https://www.smartsuppchat.com/loader.js?';
      s.parentNode.insertBefore(c, s);
    })(document);
  </script>

  <style>
    /* Your existing styles… */
    :root { --bg:#111; --panel:rgba(20,20,20,0.9); --gold:#bfa057; --text:#f0f0f0; --muted:#666; --green:#28a745; --red:#dc3545; }
    body { background:var(--bg); color:var(--text); font-family:'Poppins',sans-serif; overflow-x:hidden; visibility:hidden; }
    .bg-panel { background:var(--panel)!important; border-radius:8px; backdrop-filter:blur(8px); }
    .text-gold{color:var(--gold)!important;}
    .btn-gold{background:var(--gold);border:none;color:#000;transition:transform .2s;}
    .btn-gold:hover{background:#e6c65d;transform:scale(1.05);}
    /* Chart Container */
    #chart-container{width:100%;height:300px;position:relative;background:var(--bg);animation:fadeIn 1s;}
    @media(min-width:768px){#chart-container{height:500px;}}
    #tv_chart{position:absolute;top:0;left:0;width:100%;height:100%;}
    #chart-error{display:none;}
    /* Sentiment Gauge… News Feed… etc. (unchanged) */
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
  </style>
</head>
<body>

<div class="d-flex">
  <!-- SIDEBAR -->
  <nav class="bg-panel vh-100 p-3 d-none d-md-block" style="width:220px;">
    <div class="text-center mb-4">
      <!-- LOGO → homepage -->
      <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px;cursor:pointer;" onclick="location.href='index.html'">
    </div>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a class="nav-link active text-light" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="signals.html"><i class="bi-lightning"></i> Signals</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_insights_vip.html"><i class="bi-graph-up"></i> Insights</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_history_vip.html"><i class="bi-clock-history"></i> History</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="#" id="chat-launch"><i class="bi-chat-dots"></i> Support</a></li>
    </ul>
  </nav>

  <!-- MAIN -->
  <div class="flex-fill">
    <!-- HEADER -->
    <header class="bg-panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top fade-in">
      <div class="d-flex align-items-center">
        <!-- Logo in header too -->
        <img src="CBE_logo.PNG" alt="CBE Logo" style="height:32px;cursor:pointer;margin-right:8px;" onclick="location.href='index.html'">
        <div>
          <h5 class="mb-0 text-gold">Welcome back, <span id="userName" class="fw-bold text-gold">Trader</span>!</h5>
          <small id="currentTime" class="text-muted"></small>
        </div>
      </div>
      <div>
        <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
        <button id="notif-btn" class="btn btn-link text-light position-relative">
          <i class="bi-bell-fill"></i>
          <span class="notif-badge" id="notif-count">0</span>
        </button>
      </div>
    </header>

    <!-- STATS CARDS (Supabase‐powered) -->
    <div class="container-fluid p-4 fade-in">
      <div class="row g-3" id="stats-row">
        <!-- each card keeps its original ID for JS binding -->
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Signals Today</h6><p id="stat-signals" class="fs-2 mb-0 text-gold">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Insights</h6><p id="stat-insights" class="fs-2 mb-0 text-gold">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Trade Logs</h6><p id="stat-history" class="fs-2 mb-0 text-gold">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Pips Today</h6><p id="stat-pips" class="fs-2 mb-0 text-gold">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Win Rate (%)</h6><p id="stat-winrate" class="fs-2 mb-0 text-gold">0</p></div></div>
        <div class="col-12"><div class="card bg-panel p-3"><h6 class="text-gold">Latest Signal</h6><p id="signal-text" class="mb-0 text-gold">Loading...</p></div></div>
      </div>
    </div>

    <!-- UNIQUE FEATURES + NEW ONES -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="row g-3">
        <!-- Live Gold Price -->
        <div class="col-md-4"><div class="card bg-panel p-3"><h6 class="text-gold">Live Gold Price (XAUUSD)</h6><p id="gold-price" class="fs-2 mb-0 text-gold">Loading...</p></div></div>
        <!-- Sentiment Gauge -->
        <div class="col-md-4"><div class="card bg-panel p-3"><h6 class="text-gold">Gold Sentiment</h6><div id="gauge" class="mt-2"><div id="gauge-bar"></div></div><p id="sentiment-text" class="text-center mt-2 text-gold">Neutral</p></div></div>
        <!-- News Feed -->
        <div class="col-md-4"><div class="card bg-panel p-3"><h6 class="text-gold">Latest Gold News</h6><div id="news-feed" class="mt-2"><p>Loading news...</p></div></div></div>

        <!-- NEW: Price Alert Manager -->
        <div class="col-md-6"><div class="card bg-panel p-3">
          <h6 class="text-gold">Price Alert Manager</h6>
          <div class="input-group mt-2">
            <span class="input-group-text text-gold">Alert @</span>
            <input type="number" id="alert-price" class="form-control bg-dark text-gold" placeholder="e.g. 1850.00" step="0.01"/>
            <button id="set-alert" class="btn btn-gold">Set Alert</button>
          </div>
          <small id="alert-status" class="text-muted">No alerts set.</small>
        </div></div>

        <!-- NEW: Auto Fibonacci Retracement -->
        <div class="col-md-6"><div class="card bg-panel p-3">
          <h6 class="text-gold">Auto Fibonacci Retracement</h6>
          <p class="small text-muted">Based on last 7 days range</p>
          <button id="draw-fib" class="btn btn-gold">Draw Fib Levels</button>
        </div></div>
      </div>
    </div>

    <!-- MT5-style CHART -->
    <div id="chart-container" class="fade-in">
      <div id="tv_chart"></div>
      <div id="chart-error" class="text-danger text-center">Chart failed to load. Please check your connection.</div>
    </div>

    <footer class="text-center py-3 text-muted fade-in">© 2025 CBE Global FX</footer>
  </div>
</div>

<!-- SOUND -->
<audio id="notif-sound" src="ding.mp3" preload="auto"></audio>

<!-- BOOTSTRAP BUNDLE -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // → SHOW BODY
  document.body.style.visibility = 'visible';

  // USER name & clock
  document.getElementById('userName').textContent = sessionStorage.getItem('cbeUserName') || 'Trader';
  function updateClock() { document.getElementById('currentTime').textContent = new Date().toLocaleString(); }
  updateClock(); setInterval(updateClock, 60000);

  // Theme toggle & Chat
  // … (same as before) …

  // SUPABASE INIT
  const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPA_KEY = 'your-anon-key-here';
  const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

  // TradingView widget (MT5 style)
  try {
    new TradingView.widget({
      container_id: 'tv_chart',
      autosize: true,
      symbol: 'OANDA:XAUUSD',
      interval: '60',
      theme: 'dark',
      style: '1',
      locale: 'en',
      toolbar_bg: '#000',
      hide_side_toolbar: false,
      allow_symbol_change: false,
      timeScale: {
        rightOffset: 12,   // pull chart left, as MT5 default
        barSpacing: 15,    // wider bars like MT5 default
        minBarSpacing: 5
      },
      overrides: {
        'paneProperties.background': '#111',
        'paneProperties.vertGridProperties.color': '#222',
        'paneProperties.horzGridProperties.color': '#222'
      },
      studies: [{   // for Fib overlays later
        id: 'FibonacciRetracement@tv-basicstudies'
      }]
    });
  } catch (err) {
    console.error(err);
    document.getElementById('chart-error').style.display = 'block';
  }

  // REAL-TIME GOLD PRICE & SENTIMENT (as before) …

  // NEWS FEED (mock or integrate real API) …

  // SUPABASE STATS & REAL-TIME UPDATES
  const counts = { signals:0, insights:0, history:0 };
  const userId = sessionStorage.getItem('cbeUserId') || 'unknown';
  async function loadStats() {
    const [{ count: cs },{ count: ci },{ data: trades }] = await Promise.all([
      supabase.from('signals').select('*', { count: 'exact' }),
      supabase.from('trade_insights').select('*', { count: 'exact' }),
      supabase.from('trade_history').select('pips,created_at').eq('user_id', userId)
    ]);
    counts.signals = cs; counts.insights = ci; counts.history = trades.length;
    document.getElementById('stat-signals').textContent = cs;
    document.getElementById('stat-insights').textContent = ci;
    document.getElementById('stat-history').textContent = trades.length;
    // Win rate & Pips today
    const wins = trades.filter(t=>t.pips>0).length;
    const winrate = trades.length ? Math.round(wins/trades.length*100) : 0;
    document.getElementById('stat-winrate').textContent = winrate;
    const today = new Date().toISOString().slice(0,10);
    const pipsToday = trades.filter(t=>t.created_at.slice(0,10)===today).reduce((s,t)=>s+t.pips,0);
    const pipsEl = document.getElementById('stat-pips');
    pipsEl.textContent = pipsToday;
    pipsEl.className = pipsToday>0 ? 'fs-2 mb-0 trend-up' : 'fs-2 mb-0 trend-down';
  }
  loadStats();

  // REAL-TIME SUBSCRIPTIONS (signals, insights, history)… (as before) …

  // Latest Signal Fetch
  // … (as before) …

  // — NEW: Price Alert Manager —
  let targetAlert = null;
  document.getElementById('set-alert').onclick = () => {
    const val = parseFloat(document.getElementById('alert-price').value);
    if (!isNaN(val)) {
      targetAlert = val;
      document.getElementById('alert-status').textContent = `Alert set at ${val.toFixed(2)}`;
    }
  };
  // check every sec against gold-price
  setInterval(()=>{
    if (targetAlert !== null) {
      const current = parseFloat(document.getElementById('gold-price').textContent);
      if ((current >= targetAlert && !document.getElementById('alert-status').classList.contains('trend-up'))) {
        new Notification('Gold Alert', { body: `XAUUSD reached ${current}` });
        document.getElementById('notif-sound').play();
        document.getElementById('alert-status').classList.add('trend-up');
      }
    }
  },1000);

  // — NEW: Auto Fibonacci Retracement —
  document.getElementById('draw-fib').onclick = () => {
    // TradingView API: fetching the widget and drawing Fib
    const widget = TradingView.widget.activeWidget();
    if (widget) {
      const chart = widget.chart();
      chart.createStudy('FibonacciRetracement', false, false, [0,100], null, { color: '#bfa057' });
    }
  };
</script>
</body>
</html>
