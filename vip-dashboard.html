<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VIP Dashboard â€“ CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- BOOTSTRAP & ICONS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d) {
      var s, c, o = smartsupp = function() { o._.push(arguments) }; o._ = [];
      s = d.getElementsByTagName('script')[0]; c = d.createElement('script');
      c.async = true; c.src = 'https://www.smartsuppchat.com/loader.js?';
      s.parentNode.insertBefore(c, s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #111;
      --panel: rgba(20, 20, 20, 0.9);
      --gold: #bfa057;
      --text: #f0f0f0;
      --muted: #666;
      --gradient: linear-gradient(135deg, #bfa057, #e6c65d);
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      overflow-x: hidden;
    }
    .bg-panel {
      background: var(--panel) !important;
      border-radius: 8px;
      backdrop-filter: blur(8px);
    }
    .text-gold { color: var(--gold) !important; }
    .btn-gold {
      background: var(--gradient);
      border: none;
      color: #000;
      transition: transform 0.2s;
    }
    .btn-gold:hover {
      background: #e6c65d;
      transform: scale(1.05);
    }
    /* Chart */
    #chart-container {
      width: 100%;
      height: 60vh;
      position: relative;
      background: var(--bg);
      animation: fadeIn 1s ease-in;
    }
    @media (max-width: 768px) {
      #chart-container { height: 40vh; }
    }
    #tv_chart {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
    }
    /* Sentiment Gauge */
    #gauge {
      width: 100%;
      height: 16px;
      background: var(--muted);
      border-radius: 8px;
      overflow: hidden;
    }
    #gauge-bar {
      height: 100%;
      width: 0;
      background: var(--gradient);
      transition: width 0.5s;
    }
    /* Heatmap */
    .heat-cell {
      flex: 1;
      height: 12px;
      margin: 0 4px;
      background: var(--muted);
      border-radius: 4px;
      transition: background 0.5s;
    }
    /* Currency Strength */
    .strength-bar {
      height: 12px;
      background: var(--gradient);
      border-radius: 4px;
      transition: width 0.5s;
    }
    /* Notification Badge */
    .notif-badge {
      position: absolute;
      top: 0; right: 0;
      background: var(--gold);
      color: #000;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: .7rem;
    }
    /* Star Background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://raw.githubusercontent.com/joshbuchea/atom/master/svgs/stars.svg') center/cover no-repeat;
      opacity: 0.05;
      z-index: -1;
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in { animation: fadeIn 1s ease-in; }
  </style>
</head>
<body>

<div class="d-flex">
  <!-- SIDEBAR -->
  <nav class="bg-panel vh-100 p-3 d-none d-md-block" style="width:220px;">
    <div class="text-center mb-4">
      <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px;cursor:pointer;" onclick="location.href='index.html'">
    </div>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a class="nav-link active text-light" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="signals.html"><i class="bi-lightning"></i> Signals</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_insights_vip.html"><i class="bi-graph-up"></i> Insights</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_history_vip.html"><i class="bi-clock-history"></i> History</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="#" id="chat-launch"><i class="bi-chat-dots"></i> Support</a></li>
    </ul>
  </nav>

  <!-- MAIN -->
  <div class="flex-fill">
    <!-- HEADER -->
    <header class="bg-panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top fade-in">
      <div>
        <h5 class="mb-0">Welcome back, <span id="userName" class="fw-bold text-gold">Trader</span>!</h5>
        <small id="currentTime" class="text-muted"></small>
      </div>
      <div>
        <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
        <button id="notif-btn" class="btn btn-link text-light position-relative">
          <i class="bi-bell-fill"></i>
          <span class="notif-badge" id="notif-count">0</span>
        </button>
      </div>
    </header>

    <!-- CHART -->
    <div id="chart-container">
      <div id="tv_chart"></div>
      <div id="chart-error" class="text-danger text-center" style="display:none;">Chart failed to load. Please check your connection.</div>
    </div>

    <!-- STATS CARDS -->
    <div class="container-fluid p-4 fade-in">
      <div class="row g-3">
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Signals Today</h6><p id="stat-signals" class="fs-2 mb-0">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Insights</h6><p id="stat-insights" class="fs-2 mb-0">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Trade Logs</h6><p id="stat-history" class="fs-2 mb-0">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Pips Today</h6><p id="stat-pips" class="fs-2 mb-0">0</p></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Win Rate (%)</h6><p id="stat-winrate" class="fs-2 mb-0">0</p></div></div>
        <div class="col-12"><div class="card bg-panel p-3"><h6 class="text-gold">Latest Signal</h6><p id="signal-text" class="mb-0">Loading...</p></div></div>
      </div>
    </div>

    <!-- MARKET SENTIMENT & HEATMAP -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="row g-3">
        <div class="col-md-6"><div class="card bg-panel p-3"><h6 class="text-gold">Market Sentiment</h6><div id="gauge" class="mt-2"><div id="gauge-bar"></div></div></div></div>
        <div class="col-md-6"><div class="card bg-panel p-3"><h6 class="text-gold">Session Volume Heatmap</h6><div class="d-flex mt-2"><div class="heat-cell" id="tokyo"></div><div class="heat-cell" id="london"></div><div class="heat-cell" id="ny"></div></div><div class="d-flex justify-content-between small text-muted mt-1"><span>Tokyo</span><span>London</span><span>New York</span></div></div></div>
      </div>
    </div>

    <!-- MAGICAL FEATURES -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Currency Strength Meter</h6>
            <div id="strength-meter" class="mt-2">
              <div class="mb-2">USD: <div class="strength-bar" style="width:80%;"></div></div>
              <div class="mb-2">EUR: <div class="strength-bar" style="width:60%;"></div></div>
              <div class="mb-2">GBP: <div class="strength-bar" style="width:40%;"></div></div>
              <div class="mb-2">JPY: <div class="strength-bar" style="width:20%;"></div></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-panel p-3">
            <h6 class="text-gold">Economic Event Alerts</h6>
            <div id="event-alerts" class="mt-2">
              <p class="mb-1">US Non-Farm Payrolls in <span id="event-timer">Loading...</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- INTELLIGENT FEATURE: TRADE STREAK MOTIVATOR -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="card bg-panel p-3">
        <h6 class="text-gold">Trade Streak Motivator ðŸ”¥</h6>
        <p id="streak-message" class="mb-0">Loading your streak...</p>
      </div>
    </div>

    <!-- QUICK ACCESS CARDS -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="row g-3">
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><i class="bi-lightning fs-1 text-gold"></i><h6 class="mt-2">Signals</h6><a href="signals.html" class="btn btn-gold btn-sm mt-2">Go</a></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><i class="bi-graph-up fs-1 text-gold"></i><h6 class="mt-2">Insights</h6><a href="CBE_trade_insights_vip.html" class="btn btn-gold btn-sm mt-2">Go</a></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><i class="bi-clock-history fs-1 text-gold"></i><h6 class="mt-2">History</h6><a href="CBE_trade_history_vip.html" class="btn btn-gold btn-sm mt-2">Go</a></div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3"><i class="bi-bar-chart-line fs-1 text-gold"></i><h6 class="mt-2">Live Chart</h6><a href="#chart-container" class="btn btn-gold btn-sm mt-2">View</a></div></div>
      </div>
    </div>

    <footer class="text-center py-3 text-muted fade-in">Â© 2025 CBE Global FX</footer>
  </div>
</div>

<!-- SOUND -->
<audio id="notif-sound" src="ding.mp3" preload="auto"></audio>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Show UI & Set User
  document.body.style.visibility = 'visible';
  const userName = sessionStorage.getItem('cbeUserName') || 'Trader';
  document.getElementById('userName').textContent = userName;

  // Clock
  const timeEl = document.getElementById('currentTime');
  function updateClock() { timeEl.textContent = new Date().toLocaleString(); }
  updateClock(); setInterval(updateClock, 60000);

  // Theme Toggle with Auto-Detect
  const themeBtn = document.getElementById('theme-toggle');
  let theme = localStorage.getItem('theme');
  if (!theme) theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', theme);
  themeBtn.innerHTML = theme === 'dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
  themeBtn.onclick = () => {
    theme = theme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    themeBtn.innerHTML = theme === 'dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
  };

  // Chat Launcher
  document.getElementById('chat-launch').onclick = e => { e.preventDefault(); smartsupp('chat:open'); };

  // Supabase Init
  const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
  const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

  // TradingView Chart
  try {
    new TradingView.widget({
      container_id: 'tv_chart',
      width: '100%',
      height: '100%',
      symbol: 'OANDA:XAUUSD',
      interval: '60',
      theme: 'dark',
      style: '1',
      locale: 'en',
      toolbar_bg: '#000',
      hide_side_toolbar: false,
      enable_publishing: false,
      allow_symbol_change: true
    });
  } catch (err) {
    console.error('TradingView widget failed to load:', err);
    document.getElementById('chart-error').style.display = 'block';
  }

  // Notifications
  const userId = sessionStorage.getItem('cbeUserId') || 'unknown';
  const counts = { signals: 0, insights: 0, history: 0 };
  const notifCnt = document.getElementById('notif-count');
  const notifList = document.createElement('ul');
  notifList.className = 'dropdown-menu';
  document.body.append(notifList);

  function updateNotifs(type, text) {
    const li = document.createElement('li');
    li.className = 'dropdown-item';
    li.textContent = `${type}: ${text}`;
    notifList.prepend(li);
    if (notifList.children.length > 10) notifList.removeChild(notifList.lastChild);
    notifCnt.textContent = parseInt(notifCnt.textContent) + 1;
    document.getElementById('notif-sound').play();
  }

  document.getElementById('notif-btn').onclick = e => {
    e.stopPropagation();
    notifList.style.display = notifList.style.display === 'block' ? 'none' : 'block';
  };
  document.addEventListener('click', () => notifList.style.display = 'none');

  // Real-Time Subscriptions
  function subscribeTable(tbl, filter = null) {
    const channel = supabase.channel(tbl).on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: tbl,
      filter: filter ? filter : null
    }, payload => {
      const key = tbl === 'signals' ? 'signals' : tbl === 'trade_insights' ? 'insights' : 'history';
      counts[key]++;
      document.getElementById(`stat-${key}`).textContent = counts[key];
      updateNotifs(tbl, new Date(payload.new.created_at || payload.new.timestamp).toLocaleString());
    }).subscribe((status, err) => {
      if (err) console.error(`Subscription error for ${tbl}:`, err);
    });
  }
  subscribeTable('signals');
  subscribeTable('trade_insights');
  if (userId !== 'unknown') subscribeTable('trade_history', `user_id=eq.${userId}`);

  // Initial Data Fetch
  (async () => {
    try {
      const [{ count: cs }, { count: ci }, { data: trades }] = await Promise.all([
        supabase.from('signals').select('*', { count: 'exact' }),
        supabase.from('trade_insights').select('*', { count: 'exact' }),
        supabase.from('trade_history').select('pips, created_at').eq('user_id', userId)
      ]);
      counts.signals = cs;
      counts.insights = ci;
      counts.history = trades.length;
      document.getElementById('stat-signals').textContent = cs;
      document.getElementById('stat-insights').textContent = ci;
      document.getElementById('stat-history').textContent = trades.length;

      // Win Rate
      const wins = trades.filter(t => t.pips > 0).length;
      const winrate = trades.length ? Math.round((wins / trades.length) * 100) : 0;
      document.getElementById('stat-winrate').textContent = winrate;

      // Pips Today
      const today = new Date().toISOString().slice(0, 10);
      const pipsToday = trades.filter(t => t.created_at.slice(0, 10) === today).reduce((sum, t) => sum + t.pips, 0);
      document.getElementById('stat-pips').textContent = pipsToday;

      // Trade Streak Motivator
      const dailyPips = {};
      trades.forEach(t => {
        const date = t.created_at.slice(0, 10);
        dailyPips[date] = (dailyPips[date] || 0) + t.pips;
      });
      const sortedDates = Object.keys(dailyPips).sort((a, b) => new Date(b) - new Date(a));
      let streak = 0;
      for (let i = 0; i < sortedDates.length; i++) {
        if (dailyPips[sortedDates[i]] > 0) streak++;
        else break;
      }
      const streakMsg = streak > 0 ? 
        `Wow, ${userName}! You're on a ${streak}-day winning streak! Keep it up for exclusive rewards! ðŸ”¥` : 
        `Start a winning streak today, ${userName}! Every win brings you closer to greatness!`;
      document.getElementById('streak-message').textContent = streakMsg;

      notifCnt.textContent = cs + ci + trades.length;
    } catch (err) {
      console.error('Error fetching initial counts:', err);
    }
  })();

  // Latest Signal
  async function fetchLatestSignal() {
    const { data, error } = await supabase.from('signals')
      .select('details, created_at')
      .order('created_at', { ascending: false })
      .limit(1);
    if (error) {
      console.error('Error fetching latest signal:', error);
      document.getElementById('signal-text').textContent = 'No signals available';
    } else if (data.length) {
      document.getElementById('signal-text').textContent = `${data[0].details} (${new Date(data[0].created_at).toLocaleString()})`;
    }
  }
  fetchLatestSignal();

  // Market Sentiment (Simulated)
  setInterval(() => {
    const pct = Math.random() * 100;
    document.getElementById('gauge-bar').style.width = pct + '%';
  }, 15000);

  // Heatmap (Simulated)
  setInterval(() => {
    ['tokyo', 'london', 'ny'].forEach(id => {
      const intensity = Math.random();
      document.getElementById(id).style.backgroundColor = `rgba(255, 215, 0, ${intensity})`;
    });
  }, 10000);

  // Currency Strength (Simulated)
  setInterval(() => {
    const strengths = [80, 60, 40, 20].map(s => s + (Math.random() * 20 - 10));
    const bars = document.querySelectorAll('.strength-bar');
    bars.forEach((bar, i) => bar.style.width = `${Math.max(0, Math.min(100, strengths[i]))}%`);
  }, 20000);

  // Economic Event Alert (Mock)
  const eventTime = new Date(Date.now() + 3600000); // 1 hour from now
  function updateEventTimer() {
    const diff = eventTime - Date.now();
    if (diff > 0) {
      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      document.getElementById('event-timer').textContent = `${minutes}m ${seconds}s`;
    } else {
      document.getElementById('event-timer').textContent = 'Now!';
    }
  }
  updateEventTimer();
  setInterval(updateEventTimer, 1000);
</script>
</body>
</html>
