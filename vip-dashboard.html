<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn')!=='true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- BOOTSTRAP & ICONS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp=_smartsupp||{};_smartsupp.key='018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];
    s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.async=true;
    c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #111;
      --panel: rgba(20,20,20,0.9);
      --gold: #bfa057;
      --text: #f0f0f0;
      --muted: #666;
    }
    body {
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    .bg-panel {
      background: var(--panel) !important;
    }
    .text-gold {
      color: var(--gold) !important;
    }
    .btn-gold {
      background-color: var(--gold);
      border-color: var(--gold);
      color: #000;
    }
    .btn-gold:hover {
      background-color: #e6c65d;
    }
    /* Fullscreen chart */
    #chart-container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    #tv_chart {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
    }
    /* Sentiment gauge */
    #gauge {
      width: 100%;
      height: 16px;
      background: var(--muted);
      border-radius: 8px;
      overflow: hidden;
    }
    #gauge-bar {
      height: 100%;
      width: 0;
    }
    /* Heatmap */
    .heat-cell {
      flex: 1;
      height: 12px;
      margin: 0 4px;
      background: var(--muted);
    }
    /* Notification badge */
    .notif-badge {
      position: absolute;
      top: 0; right: 0;
      background: var(--gold);
      color: #000;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: .7rem;
    }
    /* Star background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://raw.githubusercontent.com/joshbuchea/atom/master/svgs/stars.svg') center/cover no-repeat;
      opacity: .05;
      z-index: -1;
    }
  </style>
</head>
<body>

<div class="d-flex">

  <!-- SIDEBAR -->
  <nav class="bg-panel vh-100 p-3 d-none d-md-block" style="width:220px;">
    <div class="text-center mb-4">
      <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px;cursor:pointer" onclick="location.href='index.html'">
    </div>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a class="nav-link active text-light" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="signals.html"><i class="bi-lightning"></i> Signals</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_insights_vip.html"><i class="bi-graph-up"></i> Insights</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_history_vip.html"><i class="bi-clock-history"></i> History</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="#" id="chat-launch"><i class="bi-chat-dots"></i> Support</a></li>
    </ul>
  </nav>

  <!-- MAIN -->
  <div class="flex-fill">

    <!-- HEADER -->
    <header class="bg-panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top">
      <div>
        <h5 class="mb-0">Welcome back, <span id="userName" class="fw-bold text-gold">Trader</span>!</h5>
        <small id="currentTime" class="text-muted"></small>
      </div>
      <div>
        <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
        <button id="notif-btn" class="btn btn-link text-light position-relative">
          <i class="bi-bell-fill"></i>
          <span class="notif-badge" id="notif-count">0</span>
        </button>
      </div>
    </header>

    <!-- STATS CARDS -->
    <div class="container-fluid p-4">
      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <h6 class="text-gold">Signals Today</h6>
            <p id="stat-signals" class="fs-2 mb-0">0</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <h6 class="text-gold">Insights</h6>
            <p id="stat-insights" class="fs-2 mb-0">0</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <h6 class="text-gold">History Logs</h6>
            <p id="stat-history" class="fs-2 mb-0">0</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <h6 class="text-gold">Pips Today</h6>
            <p id="stat-pips" class="fs-2 mb-0">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- MARKET SENTIMENT -->
    <div class="container-fluid px-4 mb-4">
      <div class="card bg-panel p-3">
        <h6 class="text-gold">Market Sentiment</h6>
        <div id="gauge" class="mt-2"><div id="gauge-bar"></div></div>
      </div>
    </div>

    <!-- SESSION VOLUME HEATMAP -->
    <div class="container-fluid px-4 mb-4">
      <div class="card bg-panel p-3">
        <h6 class="text-gold">Session Volume Heatmap</h6>
        <div class="d-flex mt-2">
          <div class="heat-cell" id="tokyo"></div>
          <div class="heat-cell" id="london"></div>
          <div class="heat-cell" id="ny"></div>
        </div>
        <div class="d-flex justify-content-between small text-muted mt-1">
          <span>Tokyo</span><span>London</span><span>New York</span>
        </div>
      </div>
    </div>

    <!-- QUICK ACCESS CARDS -->
    <div class="container-fluid px-4 mb-4">
      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <i class="bi-lightning fs-1 text-gold"></i>
            <h6 class="mt-2">Signals</h6>
            <a href="signals.html" class="btn btn-gold btn-sm mt-2">Go</a>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <i class="bi-graph-up fs-1 text-gold"></i>
            <h6 class="mt-2">Insights</h6>
            <a href="CBE_trade_insights_vip.html" class="btn btn-gold btn-sm mt-2">Go</a>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <i class="bi-clock-history fs-1 text-gold"></i>
            <h6 class="mt-2">History</h6>
            <a href="CBE_trade_history_vip.html" class="btn btn-gold btn-sm mt-2">Go</a>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card bg-panel text-center p-3">
            <i class="bi-bar-chart-line fs-1 text-gold"></i>
            <h6 class="mt-2">Live Chart</h6>
            <a href="#chart-container" class="btn btn-gold btn-sm mt-2">View</a>
          </div>
        </div>
      </div>
    </div>

    <!-- FULLSCREEN TRADINGVIEW CHART -->
    <div id="chart-container"><div id="tv_chart"></div></div>

    <footer class="text-center py-3 text-muted">© 2025 CBE Global FX</footer>
  </div>
</div>

<!-- SOUND -->
<audio id="notif-sound" src="ding.mp3" preload="auto"></audio>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Show UI & set user
  document.body.style.visibility='visible';
  document.getElementById('userName').textContent = sessionStorage.getItem('cbeUserName')||'Trader';

  // Clock
  const timeEl = document.getElementById('currentTime');
  function updateClock() {
    timeEl.textContent = new Date().toLocaleString();
  }
  updateClock();
  setInterval(updateClock, 60000);

  // Theme toggle
  const tb = document.getElementById('theme-toggle');
  let theme = localStorage.getItem('theme')||'dark';
  document.documentElement.setAttribute('data-theme', theme);
  tb.innerHTML = theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
  tb.onclick = () => {
    theme = theme==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    tb.innerHTML = theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
  };

  // Chat launcher
  document.getElementById('chat-launch').onclick = e => {
    e.preventDefault();
    smartsupp('chat:open');
  };

  // Supabase init
  const URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co',
        KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
  const supabase = window.supabase.createClient(URL, KEY);

  // TradingView chart
  new TradingView.widget({
    container_id: 'tv_chart',
    width: '100%', height: '100vh',
    symbol: 'OANDA:XAUUSD', interval: '60',
    theme: 'dark', style: '1', locale: 'en',
    toolbar_bg: '#000', hide_side_toolbar: false,
    enable_publishing: false, allow_symbol_change: true
  });

  // Notifications & stats
  const nb = document.getElementById('notif-count'),
        nl = document.createElement('ul'),
        ns = document.getElementById('notif-sound'),
        cnt = {signals:0, insights:0, history:0}, items = [];
  nl.className = 'notif-dropdown';
  document.body.append(nl);
  function renderNotifs() {
    nl.innerHTML = items.length
      ? items.map(i => `<li class="notif-item">${i}</li>`).join('')
      : '<li class="notif-item">No notifications</li>';
  }
  function pushNotif(type, text) {
    items.unshift(`${type}: ${text}`);
    if (items.length > 10) items.pop();
    renderNotifs();
    nb.textContent = cnt.signals+cnt.insights+cnt.history;
    ns.play();
  }
  document.getElementById('notif-btn').onclick = e => {
    e.stopPropagation();
    nl.style.display = nl.style.display==='block'?'none':'block';
  };
  document.addEventListener('click', () => nl.style.display='none');

  // Real-time + auto-reconnect
  function subscribe(tbl) {
    const channel = supabase.channel(tbl)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:tbl},payload=>{
        const key = tbl==='signals'?'signals': tbl==='trade_insights'?'insights':'history';
        cnt[key]++; document.getElementById(`stat-${key}`).textContent = cnt[key];
        pushNotif(key.charAt(0).toUpperCase()+key.slice(1),
          new Date(payload.new.created_at || payload.new.timestamp).toLocaleString());
      })
      .subscribe();
    channel.on('subscription_error',()=>channel.subscribe());
  }
  ['signals','trade_insights','trade_history'].forEach(subscribe);

  // Initialize counts & extra features
  (async ()=>{
    const [{count:cs},{count:ci},{count:ch}] = await Promise.all([
      supabase.from('signals').select('*',{count:'exact'}),
      supabase.from('trade_insights').select('*',{count:'exact'}),
      supabase.from('trade_history').select('*',{count:'exact'})
    ]);
    cnt.signals=cs; cnt.insights=ci; cnt.history=ch;
    document.getElementById('stat-signals').textContent=cs;
    document.getElementById('stat-insights').textContent=ci;
    document.getElementById('stat-history').textContent=ch;
    nb.textContent = cs+ci+ch;
    renderNotifs();

    // Pips Today
    let { data } = await supabase.from('trade_insights').select('pips,created_at');
    const today = new Date().toISOString().slice(0,10);
    const pips = data.filter(d=>d.created_at.slice(0,10)===today).reduce((a,b)=>a+b.pips,0);
    document.getElementById('stat-pips').textContent = pips;

    // Sentiment Gauge (Red/Yellow/Green)
    const last20 = data.slice(-20).map(d=>d.pips);
    const avg = last20.reduce((a,b)=>a+b,0)/ (last20.length||1);
    let color='red', pct=Math.min(100,Math.max(0,avg+50));
    if(pct>40 && pct<60) color='yellow';
    if(pct>=60) color='lightgreen';
    const bar = document.getElementById('gauge-bar');
    bar.style.width = pct+'%';
    bar.style.background = color;

    // Heatmap mock
    ['tokyo','london','ny'].forEach(id=>{
      document.getElementById(id).style.background = `rgba(255,215,0,${Math.random()})`;
    });
  })();
</script>
</body>
</html>
