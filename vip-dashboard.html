<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- STYLES & FONTS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d) {
      var s, c, o = smartsupp = function() { o._.push(arguments) }; o._ = [];
      s = d.getElementsByTagName('script')[0]; c = d.createElement('script');
      c.async = true; c.src = 'https://www.smartsuppchat.com/loader.js?';
      s.parentNode.insertBefore(c, s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #111;
      --panel: rgba(20, 20, 20, 0.9);
      --gold: #bfa057;
      --text: #f0f0f0;
      --muted: #666;
      --green: #28a745;
      --red: #dc3545;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      overflow-x: hidden;
      visibility: hidden;
    }
    .bg-panel {
      background: var(--panel) !important;
      border-radius: 8px;
      backdrop-filter: blur(8px);
    }
    .text-gold { color: var(--gold) !important; }
    .btn-gold {
      background: var(--gold);
      border: none;
      color: #000;
      transition: transform .2s;
    }
    .btn-gold:hover { transform: scale(1.05); }

    /* MT5-style chart container */
    #chart-container { width: 100%; height: 300px; position: relative; background: var(--bg); animation: fadeIn 1s; }
    @media (min-width: 768px) { #chart-container { height: 500px; } }
    #tv_chart { position: absolute; top:0; left:0; width:100%; height:100%; }
    #chart-error { display: none; }

    /* Gauge, News Feed, etc – unchanged… */

    /* Fade-in */
    @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
    .fade-in { animation: fadeIn 1s ease-in; }

    /* Starry background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://raw.githubusercontent.com/joshbuchea/atom/master/svgs/stars.svg') center/cover no-repeat;
      opacity: 0.05;
      z-index: -1;
    }

    /* Smartsupp chat styling */
    #smartsupp-iframe { border-radius: 12px !important; }
  </style>
</head>

<body>
<div class="d-flex">

  <!-- SIDEBAR -->
  <nav class="bg-panel vh-100 p-3 d-none d-md-block" style="width:220px;">
    <div class="text-center mb-4">
      <img src="CBE_logo.PNG" alt="CBE Logo"
           style="width:120px;cursor:pointer;"
           onclick="location.href='index.html'">
    </div>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a class="nav-link active text-light" href="#"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="signals.html"><i class="bi-lightning"></i> Signals</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_insights_vip.html"><i class="bi-graph-up"></i> Insights</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="CBE_trade_history_vip.html"><i class="bi-clock-history"></i> History</a></li>
      <li class="nav-item"><a class="nav-link text-light" href="#" id="chat-launch"><i class="bi-chat-dots"></i> Support</a></li>
    </ul>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="flex-fill">
    <!-- HEADER -->
    <header class="bg-panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top fade-in">
      <div class="d-flex align-items-center">
        <img src="CBE_logo.PNG" alt="CBE Logo"
             style="height:32px;cursor:pointer;margin-right:8px;"
             onclick="location.href='index.html'">
        <div>
          <h5 class="mb-0 text-gold">Welcome back, <span id="userName" class="fw-bold">Trader</span>!</h5>
          <small id="currentTime" class="text-muted"></small>
        </div>
      </div>
      <div>
        <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
        <button id="notif-btn" class="btn btn-link text-light position-relative">
          <i class="bi-bell-fill"></i>
          <span class="notif-badge" id="notif-count">0</span>
        </button>
      </div>
    </header>
        <!-- STATS CARDS -->
    <div class="container-fluid p-4 fade-in">
      <div class="row g-3" id="stats-row">
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3">
          <h6 class="text-gold">Signals Today</h6>
          <p id="stat-signals" class="fs-2 mb-0 text-gold">0</p>
        </div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3">
          <h6 class="text-gold">Insights</h6>
          <p id="stat-insights" class="fs-2 mb-0 text-gold">0</p>
        </div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3">
          <h6 class="text-gold">Trade Logs</h6>
          <p id="stat-history" class="fs-2 mb-0 text-gold">0</p>
        </div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3">
          <h6 class="text-gold">Pips Today</h6>
          <p id="stat-pips" class="fs-2 mb-0 text-gold">0</p>
        </div></div>
        <div class="col-sm-6 col-lg-3"><div class="card bg-panel text-center p-3">
          <h6 class="text-gold">Win Rate (%)</h6>
          <p id="stat-winrate" class="fs-2 mb-0 text-gold">0</p>
        </div></div>
        <div class="col-12"><div class="card bg-panel p-3">
          <h6 class="text-gold">Latest Signal</h6>
          <p id="signal-text" class="mb-0 text-gold">Loading...</p>
        </div></div>
      </div>
    </div>

    <!-- FEATURES -->
    <div class="container-fluid px-4 mb-4 fade-in">
      <div class="row g-3">
        <!-- Live Price -->
        <div class="col-md-4"><div class="card bg-panel p-3">
          <h6 class="text-gold">Live Gold Price (XAUUSD)</h6>
          <p id="gold-price" class="fs-2 mb-0 text-gold">Loading...</p>
        </div></div>
        <!-- Sentiment -->
        <div class="col-md-4"><div class="card bg-panel p-3">
          <h6 class="text-gold">Gold Sentiment</h6>
          <div id="gauge" class="mt-2"><div id="gauge-bar"></div></div>
          <p id="sentiment-text" class="text-center mt-2 text-gold">Neutral</p>
        </div></div>
        <!-- News Feed -->
        <div class="col-md-4"><div class="card bg-panel p-3">
          <h6 class="text-gold">Latest Gold News</h6>
          <div id="news-feed" class="mt-2"><p>Loading news...</p></div>
        </div></div>
        <!-- Price Alert Manager -->
        <div class="col-md-6"><div class="card bg-panel p-3">
          <h6 class="text-gold">Price Alert Manager</h6>
          <div class="input-group mt-2">
            <span class="input-group-text text-gold">Alert @</span>
            <input type="number" id="alert-price" class="form-control bg-dark text-gold"
                   placeholder="e.g. 1850.00" step="0.01"/>
            <button id="set-alert" class="btn btn-gold">Set Alert</button>
          </div>
          <small id="alert-status" class="text-muted">No alerts set.</small>
        </div></div>
        <!-- Auto Fibonacci -->
        <div class="col-md-6"><div class="card bg-panel p-3">
          <h6 class="text-gold">Auto Fibonacci Retracement</h6>
          <p class="small text-muted">Last 7-day range</p>
          <button id="draw-fib" class="btn btn-gold">Draw Fib Levels</button>
        </div></div>
      </div>
    </div>

    <!-- MT5-style CHART -->
    <div id="chart-container" class="fade-in">
      <div id="tv_chart"></div>
      <div id="chart-error" class="text-danger text-center">Chart failed to load.</div>
    </div>

    <footer class="text-center py-3 text-muted fade-in">© 2025 CBE Global FX</footer>
  </div>
</div>

<audio id="notif-sound" src="ding.mp3" preload="auto"></audio>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Show body
  document.body.style.visibility = 'visible';

  // User & localized clock
  document.getElementById('userName').textContent = sessionStorage.getItem('cbeUserName') || 'Trader';
  function updateClock() {
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById('currentTime').textContent =
      new Date().toLocaleString(navigator.language, { timeZone: tz });
  }
  updateClock(); setInterval(updateClock, 60000);

  // Theme toggle
  const themeBtn = document.getElementById('theme-toggle');
  let theme = localStorage.getItem('theme') || 'dark';
  function applyTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    themeBtn.innerHTML = t==='dark' ? '<i class="bi-sun-fill"></i>' : '<i class="bi-moon-fill"></i>';
    localStorage.setItem('theme', t);
  }
  themeBtn.onclick = () => applyTheme(theme==='dark'?'light':'dark');
  applyTheme(theme);

  // Chat launcher
  document.getElementById('chat-launch').onclick = e => {
    e.preventDefault();
    smartsupp('chat:open');
    // bump iframe styling
    setTimeout(() => {
      const iframe = document.querySelector('#smartsupp-iframe');
      if (iframe) iframe.style.height = '600px';
    }, 500);
  };

  // Supabase init
  const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
  const SUPA_KEY = 'your-anon-key-here';
  const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

  // TradingView — MT5 style
  try {
    new TradingView.widget({
      container_id: 'tv_chart',
      autosize: true,
      symbol: 'OANDA:XAUUSD',
      interval: '60',
      theme: 'dark',
      style: '1',
      locale: 'en',
      toolbar_bg: '#000',
      hide_side_toolbar: false,
      allow_symbol_change: false,
      timeScale: {
        rightOffset: 12,
        barSpacing: 15,
        minBarSpacing: 5
      },
      overrides: {
        'paneProperties.background': '#111',
        'paneProperties.vertGridProperties.color': '#222',
        'paneProperties.horzGridProperties.color': '#222'
      },
      studies: [{ id: 'FibonacciRetracement@tv-basicstudies' }]
    });
  } catch (err) {
    console.error(err);
    document.getElementById('chart-error').style.display = 'block';
  }

  // Real-time price & sentiment (as before)…
  // News feed (mock or real)…

  // Supabase Stats & realtime
  async function loadStats() {
    const userId = sessionStorage.getItem('cbeUserId') || 'unknown';
    const [{ count: s },{ count: i },{ data: th }] = await Promise.all([
      supabase.from('signals').select('*',{ count:'exact' }),
      supabase.from('trade_insights').select('*',{ count:'exact' }),
      supabase.from('trade_history').select('pips,created_at').eq('user_id', userId)
    ]);
    document.getElementById('stat-signals').textContent = s;
    document.getElementById('stat-insights').textContent = i;
    document.getElementById('stat-history').textContent = th.length;
    const wins = th.filter(t=>t.pips>0).length;
    const rate = th.length ? Math.round(wins/th.length*100) : 0;
    document.getElementById('stat-winrate').textContent = rate;
    const today = new Date().toISOString().slice(0,10);
    const pipsToday = th.filter(t=>t.created_at.slice(0,10)===today).reduce((a,t)=>a+t.pips,0);
    const el = document.getElementById('stat-pips');
    el.textContent = pipsToday;
    el.className = pipsToday>0 ? 'fs-2 mb-0 trend-up' : 'fs-2 mb-0 trend-down';
  }
  loadStats();

  // Realtime SUBSCRIBE → same as before…

  // Latest signal fetch → same

  // Price Alert Manager
  let alertTarget = null;
  document.getElementById('set-alert').onclick = () => {
    const v = parseFloat(document.getElementById('alert-price').value);
    if (!isNaN(v)) {
      alertTarget = v;
      document.getElementById('alert-status').textContent = `Alert set @ ${v.toFixed(2)}`;
    }
  };
  setInterval(() => {
    if (alertTarget !== null) {
      const cur = parseFloat(document.getElementById('gold-price').textContent);
      if (cur >= alertTarget) {
        new Notification('Gold Alert', { body: `XAUUSD is now ${cur}` });
        document.getElementById('notif-sound').play();
        alertTarget = null;
      }
    }
  }, 1000);

  // Auto Fibonacci
  document.getElementById('draw-fib').onclick = () => {
    const w = TradingView.widget.activeWidget();
    if (w) w.chart().createStudy('FibonacciRetracement', false, false, [0,100], null, { color:'#bfa057' });
  };
</script>
</body>
</html>
