<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- AUTH GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn')!=='true') {
      location.replace('login.html');
    }
  </script>

  <!-- BOOTSTRAP & ICONS & FONTS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- SUPABASE, TRADINGVIEW, SMARTSUPP -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    var _smartsupp=_smartsupp||{};_smartsupp.key='018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];
      s=d.getElementsByTagName('script')[0];
      c=d.createElement('script');c.async=true;
      c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);
    })(document);
  </script>

  <style>
    :root {
      --bg: #111;
      --panel: rgba(20,20,20,0.9);
      --gold: #bfa057;
      --text: #f0f0f0;
      --muted: #666;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    .bg-panel { background: var(--panel) !important; }
    .text-gold { color: var(--gold) !important; }
    .btn-gold {
      background: var(--gold); border-color: var(--gold); color: #000;
    }
    .btn-gold:hover { background: #e6c65d; }
    /* Tab content padding */
    .tab-pane { padding: 1rem; }
    /* Trimmed chart: 50vh on mobile, 75vh on desktop */
    #chart-container {
      position: relative; width: 100%;
      height: 50vh;
    }
    @media(min-width:768px) { #chart-container { height:75vh; } }
    #tv_chart {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
    }
    /* Gauge */
    #gauge {
      width:100%; height:12px; background:var(--muted);
      border-radius:6px; overflow:hidden; margin-top:.5rem;
    }
    #gauge-bar {
      height:100%; width:0; transition:width .5s, background .5s;
    }
    /* Heatmap */
    .heat-cell {
      flex:1; height:10px; margin:0 2px;
      background: var(--muted); transition:background .5s;
    }
    /* AI Whisper box */
    #ai-whisper {
      background: var(--panel); border-left: 4px solid var(--gold);
      padding:1rem; margin:1rem 0; border-radius:4px;
    }
    /* Mood Matched Theme: dynamic gold */
  </style>
</head>
<body>

<div class="d-flex flex-column flex-md-row vh-100">

  <!-- SIDEBAR -->
  <nav class="bg-panel p-3 d-none d-md-block" style="width:220px;">
    <div class="text-center mb-4">
      <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px;cursor:pointer" onclick="location='vip-dashboard.html'">
    </div>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a class="nav-link active text-light" data-bs-toggle="pill" href="#tab-dashboard"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="pill" href="#tab-signals"><i class="bi-lightning"></i>Signals</a></li>
      <li class="nav-item"><a class="nav-link text-light" id="chat-launch" href="#"><i class="bi-chat-dots"></i>Support</a></li>
    </ul>
  </nav>

  <!-- MAIN -->
  <div class="flex-fill d-flex flex-column">

    <!-- HEADER -->
    <header class="bg-panel d-flex justify-content-between align-items-center px-4 py-2 sticky-top">
      <div>
        <h5 class="mb-0">Welcome back, <span id="userName" class="fw-bold text-gold fs-4">Trader</span>!</h5>
        <small id="currentTime" class="text-light"></small>
      </div>
      <div>
        <button id="theme-toggle" class="btn btn-link text-light"><i class="bi-sun-fill"></i></button>
        <button id="notif-btn" class="btn btn-link text-light position-relative">
          <i class="bi-bell-fill"></i>
          <span class="notif-badge" id="notif-count">0</span>
        </button>
      </div>
    </header>

    <!-- TABS -->
    <div class="tab-content flex-fill overflow-auto">
      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-pane fade show active">

        <!-- Stats Row -->
        <div class="row g-3 p-4">
          <div class="col-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Signals</h6><p id="stat-signals" class="fs-2 mb-0">0</p></div></div>
          <div class="col-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Insights</h6><p id="stat-insights" class="fs-2 mb-0">0</p></div></div>
          <div class="col-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">History</h6><p id="stat-history" class="fs-2 mb-0">0</p></div></div>
          <div class="col-6 col-lg-3"><div class="card bg-panel text-center p-3"><h6 class="text-gold">Win Rate %</h6><p id="stat-winrate" class="fs-2 mb-0">0</p></div></div>
        </div>

        <!-- AI Trade Whisper -->
        <div id="ai-whisper">
          <h6 class="text-gold mb-1">AI Trade Whisper</h6>
          <p id="whisper-text" class="mb-0">Fetching deep-dive…</p>
        </div>

        <!-- Market Sentiment -->
        <div class="card bg-panel px-4 py-3 mb-4">
          <h6 class="text-gold">Market Sentiment</h6>
          <div id="gauge"><div id="gauge-bar"></div></div>
        </div>

        <!-- Session Heatmap -->
        <div class="card bg-panel px-4 py-3 mb-4">
          <h6 class="text-gold">Session Volume Heatmap</h6>
          <div class="d-flex mt-2">
            <div class="heat-cell" id="tokyo"></div>
            <div class="heat-cell" id="london"></div>
            <div class="heat-cell" id="ny"></div>
          </div>
          <div class="d-flex justify-content-between small text-muted mt-1">
            <span>Tokyo</span><span>London</span><span>New York</span>
          </div>
        </div>

        <!-- Quick Access -->
        <div class="row g-3 mb-4">
          <div class="col-6 col-lg-3"><a href="signals.html" class="card bg-panel text-center p-3 text-decoration-none"><i class="bi-lightning fs-1 text-gold"></i><div class="mt-2">Signals</div></a></div>
          <div class="col-6 col-lg-3"><a href="CBE_trade_insights_vip.html" class="card bg-panel text-center p-3 text-decoration-none"><i class="bi-graph-up fs-1 text-gold"></i><div class="mt-2">Insights</div></a></div>
          <div class="col-6 col-lg-3"><a href="CBE_trade_history_vip.html" class="card bg-panel text-center p-3 text-decoration-none"><i class="bi-clock-history fs-1 text-gold"></i><div class="mt-2">History</div></a></div>
          <div class="col-6 col-lg-3"><a href="#chart-container" class="card bg-panel text-center p-3 text-decoration-none"><i class="bi-bar-chart-line fs-1 text-gold"></i><div class="mt-2">Live Chart</div></a></div>
        </div>

        <!-- Chart -->
        <div id="chart-container"><div id="tv_chart"></div></div>

      </div>

      <!-- Signals Tab -->
      <div id="tab-signals" class="tab-pane fade">

        <div class="p-4">
          <h5 class="text-gold mb-3">Latest VIP Signal</h5>
          <div class="card bg-panel p-4 mb-4">
            <p id="signal-text" class="mb-0">Loading latest signal…</p>
          </div>

          <h5 class="text-gold mb-3">Signal Details</h5>
          <ul id="signal-details" class="list-group bg-panel mb-4"></ul>

          <h5 class="text-gold mb-3">Volatility Alert</h5>
          <div id="vol-alert" class="bg-warning text-dark p-3 rounded" style="display:none;">
            <strong>High Volatility Detected!</strong> Gold’s ATR is above your threshold.
          </div>
        </div>

      </div>
    </div>

    <footer class="text-center py-2 text-muted">© 2025 CBE Global FX</footer>
  </div>
</div>

<audio id="notif-sound" src="ding.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=> {
  // User & clock
  const userName = sessionStorage.getItem('cbeUserName')||'Trader';
  document.getElementById('userName').textContent = userName;
  const timeEl = document.getElementById('currentTime');
  function updateClock(){ timeEl.textContent = new Date().toLocaleString(); }
  updateClock(); setInterval(updateClock,60000);

  // Theme toggle
  const tb=document.getElementById('theme-toggle');
  let theme=localStorage.getItem('theme')||'dark';
  document.documentElement.setAttribute('data-theme',theme);
  tb.innerHTML = theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
  tb.onclick=()=>{ theme=(theme==='dark'?'light':'dark'); document.documentElement.setAttribute('data-theme',theme); localStorage.setItem('theme',theme); tb.innerHTML = theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>'; };

  // Chat launcher
  document.getElementById('chat-launch').onclick=e=>{e.preventDefault(); smartsupp('chat:open');};

  // Supabase init
  const URL='https://dapwpgvnfjcfqqhrpxla.supabase.co', KEY='eyJhbGci...EMsQ';
  const supabase = window.supabase.createClient(URL,KEY);

  // TradingView
  new TradingView.widget({
    container_id:'tv_chart', width:'100%', height:'100%',
    symbol:'OANDA:XAUUSD', interval:'60',
    theme:'dark', style:'1', locale:'en',
    toolbar_bg:'#000', hide_side_toolbar:false,
    enable_publishing:false, allow_symbol_change:true
  });

  // Notifications & stats
  const nb=document.getElementById('notif-count'),
        nl=document.createElement('ul'), ns=document.getElementById('notif-sound'),
        cnt={signals:0, insights:0, history:0}, items=[];
  nl.className='notif-dropdown'; document.body.append(nl);
  function renderNotifs(){ nl.innerHTML = items.length ? items.map(i=>`<li class="notif-item">${i}</li>`).join('') : '<li class="notif-item">No notifications</li>'; }
  function pushNotif(t,x){ items.unshift(`${t}: ${x}`); if(items.length>10) items.pop(); renderNotifs(); nb.textContent=cnt.signals+cnt.insights+cnt.history; ns.play(); }
  document.getElementById('notif-btn').onclick=e=>{e.stopPropagation(); nl.style.display=nl.style.display==='block'?'none':'block';};
  document.addEventListener('click',()=>nl.style.display='none');

  // Subscriptions
  function sub(tbl,filter=null){
    const ch=supabase.channel(tbl)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:tbl,filter},p=>{
        const k=tbl==='signals'?'signals':tbl==='trade_insights'?'insights':'history';
        cnt[k]++; document.getElementById(`stat-${k}`).textContent=cnt[k];
        pushNotif(k.charAt(0).toUpperCase()+k.slice(1), new Date(p.new.created_at||p.new.timestamp).toLocaleTimeString());
      }).subscribe();
    ch.on('subscription_error',()=>ch.subscribe());
  }
  ['signals','trade_insights','trade_history'].forEach(tbl=> sub(tbl));

  // Initial counts & extras
  (async()=>{
    const [{count:cs},{count:ci},{count:ch}] = await Promise.all([
      supabase.from('signals').select('*',{count:'exact'}),
      supabase.from('trade_insights').select('*',{count:'exact'}),
      supabase.from('trade_history').select('*',{count:'exact'})
    ]);
    cnt.signals=cs; cnt.insights=ci; cnt.history=ch;
    document.getElementById('stat-signals').textContent=cs;
    document.getElementById('stat-insights').textContent=ci;
    document.getElementById('stat-history').textContent=ch;
    document.getElementById('notif-count').textContent = cs+ci+ch;
    renderNotifs();

    // Pips Today
    let { data } = await supabase.from('trade_insights').select('pips,created_at');
    const today=new Date().toISOString().slice(0,10);
    const pips=data.filter(d=>d.created_at.startsWith(today)).reduce((a,b)=>a+b.pips,0);
    document.getElementById('stat-pips').textContent = pips;

    // AI Whisper (placeholder)
    document.getElementById('whisper-text').textContent = "AI says: ‘Gold's momentum looks strong—watch for pullbacks at key levels.’";

    // Latest Signal Details
    const { data: sigs } = await supabase.from('signals').select('details,created_at,direction,entry,sl,tp').order('created_at',{ascending:false}).limit(1);
    if(sigs.length){
      const s=sigs[0];
      document.getElementById('signal-text').textContent = `${s.direction} ${s.entry} SL ${s.sl} TP ${s.tp} (${new Date(s.created_at).toLocaleTimeString()})`;
      ['details','direction','entry','sl','tp'].forEach(key=>{
        const li=document.createElement('li');
        li.className='list-group-item bg-panel text-light';
        li.textContent = `${key.toUpperCase()}: ${s[key]||''}`;
        document.getElementById('signal-details').append(li);
      });
    }

    // Volatility Alert (ATR placeholder)
    const atr = Math.random()*2; // placeholder ATR
    if(atr>1.2){
      document.getElementById('vol-alert').style.display='block';
    }

    // Sentiment Gauge
    const last20=data.slice(-20).map(d=>d.pips);
    const avg=last20.reduce((a,b)=>a+b,0)/ (last20.length||1);
    let pct=Math.min(100,Math.max(0,avg+50)),
        color=pct<30?'hsl(0,100%,50%)':pct<70?'hsl(60,100%,50%)':'hsl(120,100%,50%)';
    document.getElementById('gauge-bar').style.width=pct+'%';
    document.getElementById('gauge-bar').style.background=color;

    // Heatmap mock
    ['tokyo','london','ny'].forEach(id=>{
      document.getElementById(id).style.background=`rgba(255,215,0,${Math.random()})`;
    });

    // Mood Matched Theme: adjust gold brightness
    const h = pct>50? `hsl(50,100%,${50 + (pct-50)/2}%)` : `hsl(50,100%,${30 + pct/2}%)`;
    document.documentElement.style.setProperty('--gold', h);

  })();

});  
</script>
</body>
</html>
