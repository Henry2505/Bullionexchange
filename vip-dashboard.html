<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VIP Dashboard â€“ CBE Global FX</title>

  <!-- CLIENT-SIDE GUARD -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- Fonts & Supabase & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>

  <style>
    /* RESET & BASE */
    * { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; }
    body, html {
      width:100%; height:100%;
      font-family:'Poppins',sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; overflow:hidden;
    }
    a { text-decoration:none; color:inherit; }

    /* THEME VARIABLES */
    :root {
      --bg:#0A0F27; --text:#E0E6FF;
      --primary:#1E254B; --accent:#FFD700;
      --muted:#4A5578; --overlay:rgba(10,15,39,0.7);
    }
    [data-theme="light"] {
      --bg:#F4F6FC; --text:#1E254B;
      --primary:#FFFFFF; --accent:#CCA300;
      --muted:#A0A8C0; --overlay:rgba(255,255,255,0.7);
    }

    /* SIDEBAR */
    #sidebar {
      width:250px; background:var(--primary);
      display:flex; flex-direction:column;
      padding:2rem 1rem;
    }
    #sidebar .logo { text-align:center; margin-bottom:2rem; }
    #sidebar .logo img { width:140px; }
    #sidebar nav a {
      display:flex; align-items:center; padding:0.75rem 1rem;
      margin-bottom:0.5rem; border-radius:8px;
      color:var(--text); font-weight:500;
      transition:background .2s;
    }
    #sidebar nav a:hover, #sidebar nav a.active { background:var(--muted); }
    #sidebar nav a i { margin-right:0.75rem; }

    /* MAIN AREA */
    #main { flex:1; display:flex; flex-direction:column; overflow-y:auto; }

    /* TOP BAR */
    #topbar {
      display:flex; justify-content:space-between; align-items:center;
      padding:1rem 2rem; background:var(--primary); box-shadow:0 2px 8px var(--overlay);
    }
    #topbar .greeting { font-size:1.25rem; }
    #topbar .actions { display:flex; align-items:center; }
    #topbar button, #topbar .btn-icon {
      background:none; border:none; color:var(--text);
      font-size:1.5rem; margin-left:1rem; position:relative; cursor:pointer;
    }
    #notif-badge {
      position:absolute; top:4px; right:4px;
      background:var(--accent); color:#000;
      font-size:0.65rem; padding:2px 5px; border-radius:50%;
    }

    /* STAT CARDS */
    #stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; padding:1.5rem 2rem; }
    .stat-card {
      background:var(--primary); padding:1.5rem; border-radius:12px;
      box-shadow:0 4px 20px var(--overlay);
    }
    .stat-card h3 { font-size:1rem; color:var(--muted); margin-bottom:0.5rem; }
    .stat-card p { font-size:2rem; font-weight:600; color:var(--accent); }

    /* CONTENT SECTIONS */
    section { padding:1.5rem 2rem; }
    section h2 { font-size:1.5rem; color:var(--accent); margin-bottom:1rem; }
    .cards-grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1rem;
    }
    .card {
      background:var(--primary); border-radius:12px;
      overflow:hidden; box-shadow:0 4px 20px var(--overlay);
    }
    .card .card-header {
      background:var(--accent); color:#000; padding:1rem; font-weight:600;
    }
    .card .card-body { padding:1rem; color:var(--text); }
    .card .card-body p { margin-bottom:1rem; }
    .card .card-body a.btn {
      display:inline-block; padding:.5rem 1rem;
      background:var(--accent); color:#000; border-radius:6px;
      font-weight:600; transition:opacity .2s;
    }
    .card .card-body a.btn:hover { opacity:0.8; }

    /* TRADINGVIEW FULL */
    #gold-chart { margin-top:2rem; border-radius:12px; overflow:hidden; height:500px; }

    /* FOOTER */
    footer { text-align:center; padding:1rem; background:var(--primary); color:var(--muted); }

    /* RESPONSIVE */
    @media(max-width:768px){
      #sidebar { display:none; }
      body { flex-direction:column; }
      #topbar, #stats, section { padding:1rem; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="logo"><img src="CBE_logo.png" alt="CBE Global FX Logo"></div>
    <nav>
      <a href="vip-dashboard.html" class="active"><i class="fas fa-chart-line"></i>Dashboard</a>
      <a href="signals.html"><i class="fas fa-bolt"></i>Signals</a>
      <a href="CBE_trade_insights_vip.html"><i class="fas fa-lightbulb"></i>Trade Insights</a>
      <a href="CBE_trade_history_vip.html"><i class="fas fa-history"></i>Trade History</a>
      <a href="mailto:apexincomeoptions@gmail.com"><i class="fas fa-headset"></i>Support</a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <div id="main">
    <!-- TOP BAR -->
    <div id="topbar">
      <div class="greeting">Welcome back, <strong><span id="userName">Trader</span></strong>!</div>
      <div class="actions">
        <button id="theme-toggle" aria-label="Toggle theme">ðŸŒž</button>
        <button id="notif-button" class="btn-icon" aria-label="Notifications">
          <i class="fas fa-bell"></i><span id="notif-badge">0</span>
        </button>
      </div>
    </div>

    <!-- STATS -->
    <div id="stats">
      <div class="stat-card">
        <h3>Today's Signals</h3><p id="count-signals">0</p>
      </div>
      <div class="stat-card">
        <h3>History Entries</h3><p id="count-history">0</p>
      </div>
      <div class="stat-card">
        <h3>Insights Posted</h3><p id="count-insights">0</p>
      </div>
    </div>

    <!-- DASHBOARD CARDS -->
    <section>
      <h2>Quick Access</h2>
      <div class="cards-grid">
        <div class="card">
          <div class="card-header">Premium Signals</div>
          <div class="card-body">
            <p>Get the latest VIP Forex signals instantly.</p>
            <a href="signals.html" class="btn">View Signals</a>
          </div>
        </div>
        <div class="card">
          <div class="card-header">Trade Insights</div>
          <div class="card-body">
            <p>Deep dive into rationales & analysis.</p>
            <a href="CBE_trade_insights_vip.html" class="btn">View Insights</a>
          </div>
        </div>
        <div class="card">
          <div class="card-header">Trade History</div>
          <div class="card-body">
            <p>Review every trade from Janâ€“Dec.</p>
            <a href="CBE_trade_history_vip.html" class="btn">View History</a>
          </div>
        </div>
        <div class="card">
          <div class="card-header">Live Chart</div>
          <div class="card-body">
            <p>Real-time XAU/USD feed.</p>
            <a href="#gold-chart" class="btn">View Chart</a>
          </div>
        </div>
      </div>
    </section>

    <!-- GOLD CHART -->
    <section id="gold-chart">
      <h2>Gold (XAU/USD) Real-Time Chart</h2>
      <div id="tradingview_chart"></div>
    </section>

    <footer>Â© 2025 CBE Global FX â€¢ All rights reserved.</footer>
  </div>

  <script>
    // Initialize Supabase
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'eyJhbGci...ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    // Show page
    document.body.style.visibility = 'visible';
    // Set user name
    document.getElementById('userName').textContent = sessionStorage.getItem('cbeUserName') || 'Trader';

    // Theme toggle
    const html = document.documentElement, tbtn = document.getElementById('theme-toggle');
    let theme = localStorage.getItem('theme') || 'dark';
    html.setAttribute('data-theme', theme);
    tbtn.textContent = theme==='dark' ? 'ðŸŒž' : 'ðŸŒœ';
    tbtn.onclick = () => {
      theme = theme==='dark'? 'light':'dark';
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      tbtn.textContent = theme==='dark'?'ðŸŒž':'ðŸŒœ';
    };

    // TradingView widget
    new TradingView.widget({
      container_id: "tradingview_chart",
      width: "100%", height: "100%",
      symbol: "OANDA:XAUUSD", interval: "60",
      theme: "dark", style: "1", locale: "en",
      toolbar_bg:"#1f1f1f", enable_publishing:false,
      hide_side_toolbar:false, allow_symbol_change:true
    });

    // Notification Bell & Stats Logic
    const notifBtn = document.getElementById('notif-button'),
          notifBadge = document.getElementById('notif-badge'),
          notifList = document.createElement('ul');
    notifList.className='notif-dropdown';
    document.body.appendChild(notifList);

    let counts = { signals:0, history:0, insights:0 }, notifs=[];
    function updateBadge() {
      const total = counts.signals + counts.history + counts.insights;
      notifBadge.textContent = total;
    }
    function addNotif(section, msg){
      notifs.unshift(`${section}: ${msg}`);
      if(notifs.length>10) notifs.pop();
      renderNotifs();
      updateBadge();
    }
    function renderNotifs(){
      notifList.innerHTML = notifs.length
        ? notifs.map(n=>`<li class="notif-item">${n}</li>`).join('')
        : `<li class="notif-item">No new notifications</li>`;
    }
    notifBtn.addEventListener('click', e=>{
      e.stopPropagation();
      notifList.style.display = notifList.style.display==='block'?'none':'block';
    });
    document.addEventListener('click',()=>notifList.style.display='none');

    // Supabase realtime listeners
    supabase.from('signals').on('INSERT', payload=>{
      counts.signals++; document.getElementById('count-signals').textContent = counts.signals;
      addNotif('Signal', `New signal at ${new Date(payload.new.created_at).toLocaleTimeString()}`);
    }).subscribe();

    supabase.from('trade_history').on('INSERT', payload=>{
      counts.history++; document.getElementById('count-history').textContent = counts.history;
      addNotif('History', `Trade logged on ${new Date(payload.new.timestamp).toLocaleDateString()}`);
    }).subscribe();

    supabase.from('trade_insights').on('INSERT', payload=>{
      counts.insights++; document.getElementById('count-insights').textContent = counts.insights;
      addNotif('Insight', `New insight posted`);
    }).subscribe();

    // Initialize counts on load
    (async ()=> {
      let s = await supabase.from('signals').select('id', { count:'exact' });
      counts.signals = s.count; document.getElementById('count-signals').textContent = counts.signals;
      let h = await supabase.from('trade_history').select('id',{ count:'exact' });
      counts.history = h.count; document.getElementById('count-history').textContent = counts.history;
      let i = await supabase.from('trade_insights').select('id',{ count:'exact' });
      counts.insights = i.count; document.getElementById('count-insights').textContent = counts.insights;
      updateBadge(); renderNotifs();
    })();
  </script>
</body>
</html>
