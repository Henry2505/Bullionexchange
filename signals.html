<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VIP Dashboard – CBE Global FX</title>

  <!-- Auth Guard -->
  <script>
    if (sessionStorage.getItem('cbeLoggedIn') !== 'true') {
      window.location.replace('login.html');
    }
  </script>

  <!-- CSS + Icons + Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Supabase + TradingView + Chart.js + Smartsupp -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    var _smartsupp = _smartsupp||{};
    _smartsupp.key = '018a8bbd868518221e725341a7b2601231ec7ce8';
    (function(d){
      var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];
      s=d.getElementsByTagName('script')[0];
      c=d.createElement('script');c.async=true;
      c.src='https://www.smartsuppchat.com/loader.js?';
      s.parentNode.insertBefore(c,s);
    })(document);
  </script>

  <style>
    :root{--bg:#1a1a1a;--panel:rgba(30,30,30,0.95);--gold:#d4af37;--text:var(--gold)}
    [data-theme="light"]{--bg:#f0f2f5;--panel:rgba(255,255,255,0.95);--text:#b8860b}
    body{background:linear-gradient(135deg,var(--bg),#222);color:var(--text);font-family:'Roboto',sans-serif;overflow-x:hidden}
    .bg-panel{background:var(--panel);border-radius:15px;box-shadow:0 12px 24px rgba(0,0,0,0.5)}
    .card{transition:transform .3s,box-shadow .3s;border:2px solid var(--gold)}
    .card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
    .text-gold{color:var(--gold)!important}
    .btn-gold{background:var(--gold);color:#1a1a1a;border:none;border-radius:8px;padding:12px 24px;transition:transform .2s,box-shadow .2s;font-weight:500;font-size:1.1rem}
    .btn-gold:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(212,175,55,0.6)}
    .fade-in{animation:fadeIn .8s ease-in}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes gentle-blink{0%,100%{opacity:1}50%{opacity:0.3}}.blinking{animation:gentle-blink 1.5s infinite}
    .welcome-banner{font-size:2rem;text-align:center;padding:2rem;margin-bottom:1.5rem}
    #tv_chart_4h,#news-widget,#calendar-widget{width:100%;height:600px;border-radius:10px;overflow:hidden}
    @media(max-width:767px){#tv_chart_4h{height:100vh}#news-widget,#calendar-widget{height:400px}.welcome-banner{font-size:1.5rem;padding:1.5rem}.card{padding:1rem!important}.fs-3{font-size:1.5rem!important}}
    @media(max-width:576px){.btn-gold{padding:6px 12px;font-size:0.9rem}#calendar-widget th,#calendar-widget td{font-size:0.8rem;padding:0.5rem}}

    /* News */
    #news-widget{background:#111;color:#fff;padding:0}
    #news-widget ul{list-style:none;margin:0;padding:0;height:100%;overflow-y:auto}
    #news-widget li{padding:1rem;border-bottom:1px solid rgba(212,175,55,0.2)}
    #news-widget li:nth-child(odd){background:rgba(255,255,255,0.03)}
    #news-widget a{color:var(--gold);font-weight:600;text-decoration:none;font-size:1rem;word-break:break-word}
    #news-widget a:hover{text-decoration:underline}
    #news-widget .update-note{display:block;padding:.5rem 1rem;font-size:.85rem;color:#aaa;background:rgba(0,0,0,0.3)}

    /* Calendar */
    #calendar-widget{background:#111;color:#fff;padding:1rem;overflow:auto}
    #calendar-widget table{width:100%;border-collapse:collapse}
    #calendar-widget th,#calendar-widget td{padding:.75rem;border:1px solid rgba(212,175,55,0.2);text-align:left;font-size:.9rem;word-break:break-word;white-space:normal}
    #calendar-widget th{background:rgba(212,175,55,0.1);color:var(--gold);position:sticky;top:0;z-index:2}
    #calendar-widget tbody tr:nth-child(even){background:rgba(212,175,55,0.05)}
    #calendar-widget .update-note{display:block;padding:.25rem 0;font-size:.85rem;color:#aaa;text-align:right}

    /* Nav & Toggle */
    .nav-link{font-size:1.1rem;font-weight:600}
    @media(max-width:767px){.nav-link{font-size:1.2rem;padding:15px}}
    #theme-toggle{font-size:1.2rem;padding:8px 12px;border:1px solid var(--gold);border-radius:5px}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start bg-panel" id="sidebar">
    <div class="offcanvas-body text-gold">
      <div class="text-center mb-4">
        <img src="CBE_logo.PNG" alt="CBE Logo" style="width:120px;cursor:pointer" onclick="location.href='index.html'">
      </div>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item"><a class="nav-link active text-gold" href="#" onclick="loadDashboard()" data-bs-dismiss="offcanvas"><i class="bi-speedometer2 me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link text-gold" href="signals.html"><i class="bi-lightning me-2"></i>Signals</a></li>
        <li class="nav-item"><a class="nav-link text-gold" href="CBE_trade_history_vip.html"><i class="bi-clock-history me-2"></i>History</a></li>
        <li class="nav-item"><a class="nav-link text-gold" href="CBE_trade_insights_vip.html"><i class="bi-graph-up me-2"></i>Insights</a></li>
      </ul>
    </div>
  </div>

  <div class="d-flex">
    <div class="flex-fill">
      <!-- Header -->
      <header class="d-flex justify-content-between align-items-center bg-panel p-3 sticky-top fade-in">
        <button class="btn btn-link text-gold d-md-none" data-bs-toggle="offcanvas" data-bs-target="#sidebar"><i class="bi-list"></i></button>
        <div class="position-relative">
          <button id="notif-btn" class="btn btn-link text-gold position-relative"><i class="bi-bell-fill"></i><span id="notif-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle">0</span></button>
          <div id="notif-menu" class="dropdown-menu dropdown-menu-end bg-panel p-2">
            <h6 class="dropdown-header text-gold">Notifications</h6>
            <div id="notif-list" class="text-gold">No new notifications</div>
          </div>
        </div>
        <button id="theme-toggle" class="btn btn-link text-gold" title="Toggle Theme"><i class="bi-sun-fill"></i></button>
      </header>

      <!-- Main Content -->
      <div class="container-fluid p-4">
        <div class="welcome-banner bg-panel fade-in"><span class="blinking">Welcome, <strong id="welcomeName"></strong>!</span></div>

        <!-- Stats Row -->
        <div class="row g-4 mb-4 fade-in">
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center">
              <h6 class="text-gold"><i class="bi-lightning me-2"></i>Signals Today</h6>
              <a href="signals.html" class="btn btn-gold">Click to Access Latest Signals</a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center">
              <h6 class="text-gold"><i class="bi-clock-history me-2"></i>Trade History</h6>
              <a href="CBE_trade_history_vip.html" class="btn btn-gold">Click to View Trade History</a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center">
              <h6 class="text-gold"><i class="bi-graph-up me-2"></i>Trade Insights</h6>
              <a href="CBE_trade_insights_vip.html" class="btn btn-gold">Click to View Trade Insights</a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-panel p-4 text-center">
              <h6 class="text-gold"><i class="bi-currency-exchange me-2"></i>24h Gold Δ</h6>
              <p id="stat-gold-change" class="fs-3 mb-0 text-gold">--%</p>
            </div>
          </div>
        </div>

        <!-- 4H XAU/USD Chart -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">XAU/USD (4H)</h2>
          <div id="tv_chart_4h"></div>
        </div>

        <!-- Gold News -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-1">Gold News <small class="update-note">Updated every minute</small></h2>
          <div id="news-widget"><ul id="news-list"></ul></div>
        </div>

        <!-- Economic Calendar -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-1">Economic Calendar <small class="update-note">Updated every minute</small></h2>
          <div id="calendar-widget">
            <table>
              <thead><tr><th>Date</th><th>Time</th><th>Country</th><th>Event</th><th>Forecast</th><th>Actual</th><th>Previous</th></tr></thead>
              <tbody id="calendar-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Watchlist -->
        <div class="card bg-panel p-4 mb-4 fade-in">
          <h2 class="text-gold mb-3">My Watchlist</h2>
          <div class="d-flex mb-3">
            <input id="watch-input" class="form-control me-3" placeholder="Add symbol (e.g., EURUSD)">
            <button id="add-watch" class="btn btn-gold"><i class="bi-plus"></i> Add</button>
          </div>
          <ul id="watch-list" class="list-group text-gold"></ul>
        </div>
      </div>

      <footer class="text-center py-3 text-gold fade-in">© 2025 CBE Global FX</footer>
    </div>
  </div>

  <!-- Smartsupp Chat Bubble -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <audio id="notif-sound" src="ding.mp3" preload="auto"></audio>
  <script>
    // Supabase init
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_KEY = 'YOUR_SUPA_KEY';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Load stats & watchlist
    async function loadDashboard(){
      const today = new Date().toISOString().split('T')[0];
      await supabase.from('signals').select('id',{count:'exact'}).gte('created_at',today);
      document.getElementById('stat-gold-change').textContent = 'N/A';
      const list = JSON.parse(localStorage.getItem('watchlist')||'[]'), ul=document.getElementById('watch-list');
      ul.innerHTML=''; list.forEach(sym=>{
        const li=document.createElement('li'); li.className='list-group-item bg-panel d-flex justify-content-between align-items-center text-gold';
        li.innerHTML=`<span>${sym}</span><button class="btn btn-sm btn-danger">×</button>`;
        li.querySelector('button').onclick=()=>{
          localStorage.setItem('watchlist',JSON.stringify(list.filter(s=>s!==sym)));
          loadDashboard();
        };
        ul.appendChild(li);
      });
      document.getElementById('add-watch').onclick=()=>{
        const input=document.getElementById('watch-input'), sym=input.value.trim().toUpperCase();
        if(sym && !list.includes(sym)){list.push(sym);localStorage.setItem('watchlist',JSON.stringify(list));loadDashboard();input.value='';}
      };
    }

    // TradingView widget
    function initWidgets(){
      new TradingView.widget({
        container_id:"tv_chart_4h",width:"100%",height:"600",
        symbol:"XAUUSD",interval:"240",timezone:"Etc/UTC",
        theme:"dark",style:"1",locale:"en",toolbar_bg:"#f1f3f6",
        enable_publishing:false,allow_symbol_change:false,save_image:false,
        studies:[{study:"MASimple@tv-basicstudies",inputs:{length:50}},{study:"MASimple@tv-basicstudies",inputs:{length:200}}],
        show_popup_button:true,popup_width:"1000",popup_height:"650"
      });
    }

    // Gold News
    async function loadGoldNews(){
      const ul=document.getElementById('news-list'); ul.innerHTML='<li>Loading…</li>';
      try{
        const res=await fetch('https://api.allorigins.win/raw?url=https://www.investing.com/rss/news_285.rss');
        const xml=new DOMParser().parseFromString(await res.text(),'text/xml');
        const items=Array.from(xml.querySelectorAll('item')).slice(0,15); // Increased to 15 for more news
        ul.innerHTML=''; items.forEach(i=>{
          const link=i.querySelector('link').textContent, title=i.querySelector('title').textContent;
          const li=document.createElement('li'); li.innerHTML=`<a href="${link}" target="_blank">${title}</a>`; ul.appendChild(li);
        });
      }catch{
        ul.innerHTML='<li style="color:#f55">Failed to load Gold News.</li>';
      }
    }

    // Economic Calendar Data
    const econData = [
      {title:"Fed Chair Powell Speaks",country:"USD",date:"05-25-2025",time:"6:40pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/717-us-fed-chair-powell-speaks"},
      {title:"Bank Holiday",country:"GBP",date:"05-26-2025",time:"7:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/390-uk-bank-holiday"},
      {title:"Bank Holiday",country:"USD",date:"05-26-2025",time:"12:00pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/370-us-bank-holiday"},
      {title:"ECB President Lagarde Speaks",country:"EUR",date:"05-26-2025",time:"1:20pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/832-ez-ecb-president-lagarde-speaks"},
      {title:"German Buba President Nagel Speaks",country:"EUR",date:"05-26-2025",time:"1:30pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/851-ge-buba-president-nagel-speaks"},
      {title:"BRC Shop Price Index y/y",country:"GBP",date:"05-26-2025",time:"11:01pm",forecast:"-0.1%",actual:"-",previous:"-0.1%",link:"https://www.forexfactory.com/calendar/116-uk-brc-shop-price-index-yy"},
      {title:"SPPI y/y",country:"JPY",date:"05-26-2025",time:"11:50pm",forecast:"3.0%",actual:"-",previous:"3.1%",link:"https://www.forexfactory.com/calendar/176-jn-sppi-yy"},
      {title:"BOJ Gov Ueda Speaks",country:"JPY",date:"05-27-2025",time:"12:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/892-jn-boj-gov-ueda-speaks"},
      {title:"BOJ Core CPI y/y",country:"JPY",date:"05-27-2025",time:"5:02am",forecast:"2.3%",actual:"-",previous:"2.2%",link:"https://www.forexfactory.com/calendar/631-jn-boj-core-cpi-yy"},
      {title:"Trade Balance",country:"CHF",date:"05-27-2025",time:"6:00am",forecast:"5.55B",actual:"-",previous:"6.35B",link:"https://www.forexfactory.com/calendar/124-sz-trade-balance"},
      {title:"German GfK Consumer Climate",country:"EUR",date:"05-27-2025",time:"6:00am",forecast:"-19.9",actual:"-",previous:"-20.6",link:"https://www.forexfactory.com/calendar/335-ge-gfk-consumer-climate"},
      {title:"French Prelim CPI m/m",country:"EUR",date:"05-27-2025",time:"6:45am",forecast:"0.1%",actual:"-",previous:"0.5%",link:"https://www.forexfactory.com/calendar/556-fr-prelim-cpi-mm"},
      {title:"RBA Deputy Gov Hauser Speaks",country:"AUD",date:"05-27-2025",time:"8:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/904-au-rba-deputy-gov-hauser-speaks"},
      {title:"FOMC Member Kashkari Speaks",country:"USD",date:"05-27-2025",time:"8:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/651-us-fomc-member-kashkari-speaks"},
      {title:"CBI Realized Sales",country:"GBP",date:"05-27-2025",time:"10:00am",forecast:"-18",actual:"-",previous:"-8",link:"https://www.forexfactory.com/calendar/329-uk-cbi-realized-sales"},
      {title:"Core Durable Goods Orders m/m",country:"USD",date:"05-27-2025",time:"12:30pm",forecast:"-0.1%",actual:"-",previous:"0.0%",link:"https://www.forexfactory.com/calendar/350-us-core-durable-goods-orders-mm"},
      {title:"Durable Goods Orders m/m",country:"USD",date:"05-27-2025",time:"12:30pm",forecast:"-7.6%",actual:"-",previous:"9.2%",link:"https://www.forexfactory.com/calendar/349-us-durable-goods-orders-mm"},
      {title:"HPI m/m",country:"USD",date:"05-27-2025",time:"1:00pm",forecast:"0.1%",actual:"-",previous:"0.1%",link:"https://www.forexfactory.com/calendar/239-us-hpi-mm"},
      {title:"S&P/CS Composite-20 HPI y/y",country:"USD",date:"05-27-2025",time:"1:00pm",forecast:"4.5%",actual:"-",previous:"4.5%",link:"https://www.forexfactory.com/calendar/240-us-spcs-composite-20-hpi-yy"},
      {title:"CB Consumer Confidence",country:"USD",date:"05-27-2025",time:"2:00pm",forecast:"87.1",actual:"-",previous:"86.0",link:"https://www.forexfactory.com/calendar/208-us-cb-consumer-confidence"},
      {title:"German Buba President Nagel Speaks",country:"EUR",date:"05-27-2025",time:"4:00pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/851-ge-buba-president-nagel-speaks"},
      {title:"SNB Chairman Schlegel Speaks",country:"CHF",date:"05-27-2025",time:"4:20pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/915-sz-snb-chairman-schlegel-speaks"},
      {title:"FOMC Member Williams Speaks",country:"USD",date:"05-28-2025",time:"12:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/518-us-fomc-member-williams-speaks"},
      {title:"CPI y/y",country:"AUD",date:"05-28-2025",time:"1:30am",forecast:"2.3%",actual:"-",previous:"2.4%",link:"https://www.forexfactory.com/calendar/888-au-cpi-yy"},
      {title:"Construction Work Done q/q",country:"AUD",date:"05-28-2025",time:"1:30am",forecast:"0.5%",actual:"-",previous:"0.5%",link:"https://www.forexfactory.com/calendar/213-au-construction-work-done-qq"},
      {title:"Official Cash Rate",country:"NZD",date:"05-28-2025",time:"2:00am",forecast:"3.25%",actual:"-",previous:"3.50%",link:"https://www.forexfactory.com/calendar/23-nz-official-cash-rate"},
      {title:"RBNZ Monetary Policy Statement",country:"NZD",date:"05-28-2025",time:"2:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/416-nz-rbnz-monetary-policy-statement"},
      {title:"RBNZ Rate Statement",country:"NZD",date:"05-28-2025",time:"2:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/24-nz-rbnz-rate-statement"},
      {title:"MPC Member Lombardelli Speaks",country:"GBP",date:"05-28-2025",time:"2:10am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/908-uk-mpc-member-lombardelli-speaks"},
      {title:"FOMC Member Waller Speaks",country:"USD",date:"05-28-2025",time:"2:10am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/839-us-fomc-member-waller-speaks"},
      {title:"RBNZ Press Conference",country:"NZD",date:"05-28-2025",time:"3:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/406-nz-rbnz-press-conference"},
      {title:"German Import Prices m/m",country:"EUR",date:"05-28-2025",time:"6:00am",forecast:"-1.4%",actual:"-",previous:"-1.0%",link:"https://www.forexfactory.com/calendar/257-ge-import-prices-mm"},
      {title:"French Consumer Spending m/m",country:"EUR",date:"05-28-2025",time:"6:45am",forecast:"0.8%",actual:"-",previous:"-1.0%",link:"https://www.forexfactory.com/calendar/357-fr-consumer-spending-mm"},
      {title:"French Final Private Payrolls q/q",country:"EUR",date:"05-28-2025",time:"6:45am",forecast:"0.0%",actual:"-",previous:"0.0%",link:"https://www.forexfactory.com/calendar/71-fr-final-private-payrolls-qq"},
      {title:"French Prelim GDP q/q",country:"EUR",date:"05-28-2025",time:"6:45am",forecast:"0.1%",actual:"-",previous:"0.1%",link:"https://www.forexfactory.com/calendar/39-fr-prelim-gdp-qq"},
      {title:"German Unemployment Change",country:"EUR",date:"05-28-2025",time:"7:55am",forecast:"12K",actual:"-",previous:"4K",link:"https://www.forexfactory.com/calendar/60-ge-unemployment-change"},
      {title:"UBS Economic Expectations",country:"CHF",date:"05-28-2025",time:"8:00am",forecast:"-",actual:"-",previous:"-51.6",link:"https://www.forexfactory.com/calendar/315-sz-ubs-economic-expectations"},
      {title:"FOMC Member Kashkari Speaks",country:"USD",date:"05-28-2025",time:"8:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/651-us-fomc-member-kashkari-speaks"},
      {title:"OPEC-JMMC Meetings",country:"All",date:"05-28-2025",time:"9:15am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/798-opec-jmmc-meetings"},
      {title:"CB Leading Index m/m",country:"CNY",date:"05-28-2025",time:"1:00pm",forecast:"-",actual:"-",previous:"-0.3%",link:"https://www.forexfactory.com/calendar/495-ch-cb-leading-index-mm"},
      {title:"Richmond Manufacturing Index",country:"USD",date:"05-28-2025",time:"1:59pm",forecast:"-9",actual:"-",previous:"-13",link:"https://www.forexfactory.com/calendar/186-us-richmond-manufacturing-index"},
      {title:"FOMC Meeting Minutes",country:"USD",date:"05-28-2025",time:"6:00pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/304-us-fomc-meeting-minutes"},
      {title:"API Weekly Statistical Bulletin",country:"USD",date:"05-28-2025",time:"8:30pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/754-us-api-weekly-statistical-bulletin"},
      {title:"RBNZ Gov Hawkesby Speaks",country:"NZD",date:"05-28-2025",time:"9:10pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/919-nz-rbnz-gov-hawkesby-speaks"},
      {title:"ANZ Business Confidence",country:"NZD",date:"05-29-2025",time:"1:00am",forecast:"-",actual:"-",previous:"49.3",link:"https://www.forexfactory.com/calendar/319-nz-anz-business-confidence"},
      {title:"Private Capital Expenditure q/q",country:"AUD",date:"05-29-2025",time:"1:30am",forecast:"0.5%",actual:"-",previous:"-0.2%",link:"https://www.forexfactory.com/calendar/381-au-private-capital-expenditure-qq"},
      {title:"Consumer Confidence",country:"JPY",date:"05-29-2025",time:"5:00am",forecast:"31.8",actual:"-",previous:"31.2",link:"https://www.forexfactory.com/calendar/212-jn-consumer-confidence"},
      {title:"Bank Holiday",country:"CHF",date:"05-29-2025",time:"5:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/392-sz-bank-holiday"},
      {title:"French Bank Holiday",country:"EUR",date:"05-29-2025",time:"6:01am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/396-fr-bank-holiday"},
      {title:"German Bank Holiday",country:"EUR",date:"05-29-2025",time:"6:02am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/391-ge-bank-holiday"},
      {title:"MPC Member Breeden Speaks",country:"GBP",date:"05-29-2025",time:"9:00am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/899-uk-mpc-member-breeden-speaks"},
      {title:"Italian 10-y Bond Auction",country:"EUR",date:"05-29-2025",time:"9:11am",forecast:"-",actual:"-",previous:"3.62|1.6",link:"https://www.forexfactory.com/calendar/524-it-10-y-bond-auction"},
      {title:"Current Account",country:"CAD",date:"05-29-2025",time:"12:30pm",forecast:"-3.4B",actual:"-",previous:"-5.0B",link:"https://www.forexfactory.com/calendar/196-ca-current-account"},
      {title:"Prelim GDP q/q",country:"USD",date:"05-29-2025",time:"12:30pm",forecast:"-0.3%",actual:"-",previous:"-0.3%",link:"https://www.forexfactory.com/calendar/27-us-prelim-gdp-qq"},
      {title:"Unemployment Claims",country:"USD",date:"05-29-2025",time:"12:30pm",forecast:"229K",actual:"-",previous:"227K",link:"https://www.forexfactory.com/calendar/11-us-unemployment-claims"},
      {title:"Prelim GDP Price Index q/q",country:"USD",date:"05-29-2025",time:"12:30pm",forecast:"3.7%",actual:"-",previous:"3.7%",link:"https://www.forexfactory.com/calendar/45-us-prelim-gdp-price-index-qq"},
      {title:"FOMC Member Barkin Speaks",country:"USD",date:"05-29-2025",time:"12:30pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/728-us-fomc-member-barkin-speaks"},
      {title:"Pending Home Sales m/m",country:"USD",date:"05-29-2025",time:"2:00pm",forecast:"-0.9%",actual:"-",previous:"6.1%",link:"https://www.forexfactory.com/calendar/233-us-pending-home-sales-mm"},
      {title:"Natural Gas Storage",country:"USD",date:"05-29-2025",time:"2:30pm",forecast:"98B",actual:"-",previous:"120B",link:"https://www.forexfactory.com/calendar/26-us-natural-gas-storage"},
      {title:"FOMC Member Goolsbee Speaks",country:"USD",date:"05-29-2025",time:"2:40pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/889-us-fomc-member-goolsbee-speaks"},
      {title:"BOE Gov Bailey Speaks",country:"GBP",date:"05-29-2025",time:"3:00pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/838-uk-boe-gov-bailey-speaks"},
      {title:"Crude Oil Inventories",country:"USD",date:"05-29-2025",time:"4:00pm",forecast:"0.3M",actual:"-",previous:"1.3M",link:"https://www.forexfactory.com/calendar/10-us-crude-oil-inventories"},
      {title:"FOMC Member Kugler Speaks",country:"USD",date:"05-29-2025",time:"6:00pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/901-us-fomc-member-kugler-speaks"},
      {title:"FOMC Member Daly Speaks",country:"USD",date:"05-29-2025",time:"8:00pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/807-us-fomc-member-daly-speaks"},
      {title:"Building Consents m/m",country:"NZD",date:"05-29-2025",time:"10:45pm",forecast:"-",actual:"-",previous:"9.6%",link:"https://www.forexfactory.com/calendar/229-nz-building-consents-mm"},
      {title:"Tokyo Core CPI y/y",country:"JPY",date:"05-29-2025",time:"11:30pm",forecast:"3.5%",actual:"-",previous:"3.4%",link:"https://www.forexfactory.com/calendar/175-jn-tokyo-core-cpi-yy"},
      {title:"Unemployment Rate",country:"JPY",date:"05-29-2025",time:"11:30pm",forecast:"2.5%",actual:"-",previous:"2.5%",link:"https://www.forexfactory.com/calendar/63-jn-unemployment-rate"},
      {title:"Prelim Industrial Production m/m",country:"JPY",date:"05-29-2025",time:"11:50pm",forecast:"-1.4%",actual:"-",previous:"-1.1%",link:"https://www.forexfactory.com/calendar/225-jn-prelim-industrial-production-mm"},
      {title:"Retail Sales y/y",country:"JPY",date:"05-29-2025",time:"11:50pm",forecast:"2.9%",actual:"-",previous:"3.1%",link:"https://www.forexfactory.com/calendar/115-jn-retail-sales-yy"},
      {title:"FOMC Member Logan Speaks",country:"USD",date:"05-30-2025",time:"12:25am",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/890-us-fomc-member-logan-speaks"},
      {title:"Retail Sales m/m",country:"AUD",date:"05-30-2025",time:"1:30am",forecast:"0.3%",actual:"-",previous:"0.3%",link:"https://www.forexfactory.com/calendar/110-au-retail-sales-mm"},
      {title:"Building Approvals m/m",country:"AUD",date:"05-30-2025",time:"1:30am",forecast:"3.1%",actual:"-",previous:"-8.8%",link:"https://www.forexfactory.com/calendar/202-au-building-approvals-mm"},
      {title:"Private Sector Credit m/m",country:"AUD",date:"05-30-2025",time:"1:30am",forecast:"0.5%",actual:"-",previous:"0.5%",link:"https://www.forexfactory.com/calendar/344-au-private-sector-credit-mm"},
      {title:"Housing Starts y/y",country:"JPY",date:"05-30-2025",time:"5:00am",forecast:"-18.2%",actual:"-",previous:"39.1%",link:"https://www.forexfactory.com/calendar/228-jn-housing-starts-yy"},
      {title:"German Retail Sales m/m",country:"EUR",date:"05-30-2025",time:"6:00am",forecast:"0.2%",actual:"-",previous:"-0.2%",link:"https://www.forexfactory.com/calendar/107-ge-retail-sales-mm"},
      {title:"German Prelim CPI m/m",country:"EUR",date:"05-30-2025",time:"6:29am",forecast:"0.1%",actual:"-",previous:"0.4%",link:"https://www.forexfactory.com/calendar/169-ge-prelim-cpi-mm"},
      {title:"KOF Economic Barometer",country:"CHF",date:"05-30-2025",time:"7:00am",forecast:"98.3",actual:"-",previous:"97.1",link:"https://www.forexfactory.com/calendar/301-sz-kof-economic-barometer"},
      {title:"Spanish Flash CPI y/y",country:"EUR",date:"05-30-2025",time:"7:00am",forecast:"2.1%",actual:"-",previous:"2.2%",link:"https://www.forexfactory.com/calendar/592-sp-flash-cpi-yy"},
      {title:"M3 Money Supply y/y",country:"EUR",date:"05-30-2025",time:"8:00am",forecast:"3.7%",actual:"-",previous:"3.6%",link:"https://www.forexfactory.com/calendar/375-ez-m3-money-supply-yy"},
      {title:"Private Loans y/y",country:"EUR",date:"05-30-2025",time:"8:00am",forecast:"1.8%",actual:"-",previous:"1.7%",link:"https://www.forexfactory.com/calendar/365-ez-private-loans-yy"},
      {title:"Italian Prelim CPI m/m",country:"EUR",date:"05-30-2025",time:"9:00am",forecast:"0.1%",actual:"-",previous:"0.2%",link:"https://www.forexfactory.com/calendar/172-it-prelim-cpi-mm"},
      {title:"GDP m/m",country:"CAD",date:"05-30-2025",time:"12:30pm",forecast:"0.1%",actual:"-",previous:"-0.2%",link:"https://www.forexfactory.com/calendar/29-ca-gdp-mm"},
      {title:"Core PCE Price Index m/m",country:"USD",date:"05-30-2025",time:"12:30pm",forecast:"0.1%",actual:"-",previous:"0.0%",link:"https://www.forexfactory.com/calendar/85-us-core-pce-price-index-mm"},
      {title:"Goods Trade Balance",country:"USD",date:"05-30-2025",time:"12:30pm",forecast:"-142.8B",actual:"-",previous:"-162.0B",link:"https://www.forexfactory.com/calendar/625-us-goods-trade-balance"},
      {title:"Personal Income m/m",country:"USD",date:"05-30-2025",time:"12:30pm",forecast:"0.3%",actual:"-",previous:"0.5%",link:"https://www.forexfactory.com/calendar/360-us-personal-income-mm"},
      {title:"Personal Spending m/m",country:"USD",date:"05-30-2025",time:"12:30pm",forecast:"0.2%",actual:"-",previous:"0.7%",link:"https://www.forexfactory.com/calendar/356-us-personal-spending-mm"},
      {title:"Prelim Wholesale Inventories m/m",country:"USD",date:"05-30-2025",time:"12:30pm",forecast:"0.4%",actual:"-",previous:"0.5%",link:"https://www.forexfactory.com/calendar/642-us-prelim-wholesale-inventories-mm"},
      {title:"Chicago PMI",country:"USD",date:"05-30-2025",time:"1:45pm",forecast:"45.1",actual:"-",previous:"44.6",link:"https://www.forexfactory.com/calendar/189-us-chicago-pmi"},
      {title:"Revised UoM Consumer Sentiment",country:"USD",date:"05-30-2025",time:"2:00pm",forecast:"51.1",actual:"-",previous:"50.8",link:"https://www.forexfactory.com/calendar/54-us-revised-uom-consumer-sentiment"},
      {title:"Revised UoM Inflation Expectations",country:"USD",date:"05-30-2025",time:"2:00pm",forecast:"-",actual:"-",previous:"7.3%",link:"https://www.forexfactory.com/calendar/238-us-revised-uom-inflation-expectations"},
      {title:"FOMC Member Bostic Speaks",country:"USD",date:"05-30-2025",time:"4:20pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/725-us-fomc-member-bostic-speaks"},
      {title:"FOMC Member Goolsbee Speaks",country:"USD",date:"05-30-2025",time:"11:30pm",forecast:"-",actual:"-",previous:"-",link:"https://www.forexfactory.com/calendar/889-us-fomc-member-goolsbee-speaks"},
      {title:"Manufacturing PMI",country:"CNY",date:"05-31-2025",time:"1:30am",forecast:"49.5",actual:"-",previous:"49.0",link:"https://www.forexfactory.com/calendar/449-ch-manufacturing-pmi"},
      {title:"Non-Manufacturing PMI",country:"CNY",date:"05-31-2025",time:"1:30am",forecast:"50.6",actual:"-",previous:"50.4",link:"https://www.forexfactory.com/calendar/520-ch-non-manufacturing-pmi"}
    ];

    // Economic Calendar
    function loadEconCalendar(){
      const tbody=document.getElementById('calendar-body');
      tbody.innerHTML='<tr><td colspan="7">Loading…</td></tr>';
      try{
        let events=[...econData].slice(0,50); // Limit to 50 events as before

        // Sort by combined date+time
        events.sort((a,b)=>{
          const da=a.date, ta=a.time;
          const db=b.date, tb=b.time;
          return new Date(`${da} ${ta}`) - new Date(`${db} ${tb}`);
        });

        tbody.innerHTML='';
        events.forEach(ev=>{
          const tr=document.createElement('tr');
          ['date','time','country','title','forecast','actual','previous'].forEach(key=>{
            const td=document.createElement('td');
            td.textContent=ev[key] || '-';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }catch{
        tbody.innerHTML='<tr><td colspan="7" style="color:#f55">Failed to load calendar.</td></tr>';
      }
    }

    // Theme & notifications
    (function(){
      const btn=document.getElementById('theme-toggle');
      let theme=localStorage.getItem('theme')||'dark';
      document.documentElement.setAttribute('data-theme',theme);
      btn.innerHTML=theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
      btn.onclick=()=>{
        theme=theme==='dark'?'light':'dark';
        document.documentElement.setAttribute('data-theme',theme);
        localStorage.setItem('theme',theme);
        btn.innerHTML=theme==='dark'?'<i class="bi-sun-fill"></i>':'<i class="bi-moon-fill"></i>';
      };
      document.getElementById('notif-btn').addEventListener('click',()=>new bootstrap.Dropdown(document.getElementById('notif-btn')).toggle());
    })();

    // On load
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('welcomeName').textContent=sessionStorage.getItem('cbeUserName')||'Trader';
      loadDashboard(); initWidgets(); loadGoldNews(); loadEconCalendar();
      setInterval(loadGoldNews,60000);
      setInterval(loadEconCalendar,60000);
    });
  </script>
</body>
</html>
