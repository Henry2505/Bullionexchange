<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — CBE Dashboard</title>

  <!-- Poppins, Bootstrap & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* --- your existing styles here (omitted for brevity) --- */

    /* Error banner */
    #error-banner {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #dc3545; color: #fff;
      text-align: center;
      padding: .75rem;
      z-index: 9999;
    }
  </style>
</head>
<body>

  <div id="error-banner">Error loading dashboard. Check console for details.</div>
  <div class="overlay"></div>

  <!-- HEADER (unchanged)… -->
  <header class="admin-header glass"> … </header>

  <!-- MAIN CONTENT -->
  <main class="container py-4">
    <div class="stats-row" id="stats-container">
      <div class="card-stat" data-key="users"><h5>Total Users</h5><h2 id="stat-users">0</h2></div>
      <div class="card-stat" data-key="payments"><h5>Pending Payments</h5><h2 id="stat-payments">0</h2></div>
      <div class="card-stat" data-key="trades"><h5>Trades This Month</h5><h2 id="stat-trades">0</h2></div>
      <div class="card-stat" data-key="signals"><h5>Signals Published</h5><h2 id="stat-signals">0</h2></div>
      <div class="card-stat" data-key="winrate"><h5>Win Rate (%)</h5><h2 id="stat-winrate">0</h2></div>
    </div>
    <div class="charts">
      <canvas id="chart-pnl" height="200"></canvas>
      <canvas id="chart-winrate" height="200"></canvas>
      <canvas id="chart-status" height="200"></canvas>
    </div>
  </main>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- UMD Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/umd/supabase.min.js"></script>

  <script>
    // — STEP 1: Initialize Supabase —
    console.log('Initializing Supabase client');
    const SUPA_URL = 'https://dapwpgvnfjcfqqhrpxla.supabase.co';
    const SUPA_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ';
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_ANON_KEY);
    console.log('Supabase initialized.');

    document.addEventListener('DOMContentLoaded', () => {
      // Restore your existing initialization (theme toggle, auth guard, etc.)
      // … your header, theme toggle, auth guard code …

      // — STEP 2: Load stats & charts —
      (async () => {
        try {
          console.log('Fetching stats from Supabase…');
          const [
            { count: usersCount },
            { data: payments },
            { data: trades },
            { data: signals },
            { data: insights }
          ] = await Promise.all([
            supabase.from('users').select('id', { head: true, count: 'exact' }),
            supabase.from('payments').select('id').eq('status','Pending'),
            supabase.from('trade_history').select('id'),
            supabase.from('signals').select('id'),
            supabase.from('trade_insights').select('week_ending,pips').order('week_ending',{ ascending: false }),
          ]);
          console.log('Stats received:', { usersCount, payments: payments.length, trades: trades.length, signals: signals.length, insights: insights.length });

          // Update stat cards
          document.getElementById('stat-users').textContent    = usersCount;
          document.getElementById('stat-payments').textContent = payments.length;
          document.getElementById('stat-trades').textContent   = trades.length;
          document.getElementById('stat-signals').textContent  = signals.length;
          const wins = insights.filter(x => x.pips > 0).length;
          const rate = insights.length ? Math.round(wins / insights.length * 100) : 0;
          document.getElementById('stat-winrate').textContent = rate;

          // Make stats draggable
          new Sortable(document.getElementById('stats-container'), {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            handle: '.card-stat'
          });

          // Build Charts
          console.log('Rendering P&L line chart');
          new Chart(document.getElementById('chart-pnl'), {
            type: 'line',
            data: {
              labels: insights.map(i => new Date(i.week_ending).toLocaleDateString()),
              datasets: [{ data: insights.map(i => i.pips), tension: .4, borderColor: '#ffd700', backgroundColor: 'rgba(255,215,0,0.2)' }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
          });

          console.log('Rendering Win-Rate bar chart');
          new Chart(document.getElementById('chart-winrate'), {
            type: 'bar',
            data: {
              labels: insights.map(i => new Date(i.week_ending).toLocaleDateString()),
              datasets: [{ data: insights.map(i => i.pips > 0 ? 100 : 0) }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
          });

          console.log('Rendering User-Status doughnut chart');
          const { data: allUsers } = await supabase.from('users').select('status');
          const statusCounts = allUsers.reduce((acc, u) => { acc[u.status] = (acc[u.status]||0) + 1; return acc; }, {});
          new Chart(document.getElementById('chart-status'), {
            type: 'doughnut',
            data: {
              labels: ['Active','Expired','Pending','Deleted'],
              datasets: [{ data: ['Active','Expired','Pending','Deleted'].map(l => statusCounts[l] || 0) }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
          });

          console.log('All charts rendered successfully.');
        } 
        catch (err) {
          console.error('Error loading stats or charts:', err);
          // Show visible error banner
          document.getElementById('error-banner').style.display = 'block';
        }
      })();
    });
  </script>

</body>
</html>
