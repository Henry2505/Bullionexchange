<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CBE Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    /* Shared CSS from above */
    .card-stat { color: #fff; border: none; }
    .card-stat.bg-primary { background: rgba(13, 110, 253, 0.8); }
    .card-stat.bg-success { background: rgba(28, 200, 138, 0.8); }
    .card-stat.bg-info { background: rgba(13, 202, 240, 0.8); }
    .card-stat.bg-secondary { background: rgba(108, 117, 125, 0.8); }
    .card-stat.bg-warning { background: rgba(255, 193, 7, 0.8); }
  </style>
</head>
<body data-theme="dark">
  <div class="overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: -1;"></div>
  <div id="toast-container" style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1050;"></div>
  <div class="d-flex glass" style="min-height: 100vh;">
    <!-- Shared Sidebar -->
    <nav id="sidebar" class="d-flex flex-column p-3">...</nav>
    <div id="content" class="d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <span id="toggle-btn" style="cursor: pointer; font-size: 1.5rem;">â‹®</span>
          <button id="theme-toggle" class="btn btn-sm btn-outline-secondary ms-2">Light Mode</button>
        </div>
        <div class="d-flex align-items-baseline">
          <h2 id="section-title">Dashboard</h2>
          <small id="current-datetime" class="text-white ms-3"></small>
        </div>
      </div>
      <div class="row g-4" id="stats-container">
        <div class="col-md-3"><div class="card card-stat p-3 glass bg-primary" draggable="true" data-key="users"><h5>Total Users</h5><h2 id="stat-users">0</h2></div></div>
        <div class="col-md-3"><div class="card card-stat p-3 glass bg-success" draggable="true" data-key="payments"><h5>Pending Payments</h5><h2 id="stat-payments">0</h2></div></div>
        <div class="col-md-3"><div class="card card-stat p-3 glass bg-info" draggable="true" data-key="trades"><h5>Trades This Month</h5><h2 id="stat-trades">0</h2></div></div>
        <div class="col-md-3"><div class="card card-stat p-3 glass bg-secondary" draggable="true" data-key="signals"><h5>Signals Published</h5><h2 id="stat-signals">0</h2></div></div>
        <div class="col-md-3"><div class="card card-stat p-3 glass bg-warning" draggable="true" data-key="winrate"><h5>Win Rate (%)</h5><h2 id="stat-winrate">0</h2></div></div>
      </div>
      <div class="row g-4 mt-4">
        <div class="col-md-6"><canvas id="chart-pnl" height="200"></canvas></div>
        <div class="col-md-6"><canvas id="chart-winrate" height="200"></canvas></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Authentication Check
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      const currentUrl = window.location.pathname.split('/').pop();
      window.location.href = `admin-login.html?redirect=${currentUrl}`;
    }

    // Supabase Initialization
    const supabase = window.supabase.createClient('https://dapwpgvnfjcfqqhrpxla.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcHdwZ3ZuZmpjZnFxaHJweGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDA4ODgsImV4cCI6MjA2MjYxNjg4OH0.ICC0UsLlzJDNre7rFCeD3k6iVzo6jOJgn3PhABpEMsQ');

    // Toast Function
    function showToast(msg, ok = true) {
      const id = 't' + Date.now();
      document.getElementById('toast-container').innerHTML += `
        <div id="${id}" class="toast align-items-center text-white ${ok ? 'bg-success' : 'bg-danger'} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">${msg}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`;
      new bootstrap.Toast(document.getElementById(id), { delay: 3000 }).show();
    }

    // Theme Toggle
    document.getElementById('theme-toggle').onclick = () => {
      const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      document.getElementById('theme-toggle').textContent = next === 'dark' ? 'Light Mode' : 'Dark Mode';
    };

    // Sidebar Toggle
    document.getElementById('toggle-btn').onclick = () => {
      document.getElementById('sidebar').classList.toggle('collapsed');
    };

    // Active Link
    document.querySelectorAll('#menu .nav-link').forEach(link => {
      if (link.href.endsWith('admin-dashboard.html')) link.classList.add('active');
    });

    // Drag & Drop Stats
    new Sortable(document.getElementById('stats-container'), { animation: 150 });

    // Load Dashboard
    async function loadDashboard() {
      try {
        const { data: usersData } = await supabase.from('users').select('id');
        const { data: paymentsData } = await supabase.from('payments').select('id').eq('status', 'Pending');
        const { data: tradesData } = await supabase.from('trade_history').select('id');
        const { data: signalsData } = await supabase.from('signals').select('id');
        const { data: insightsData } = await supabase.from('trade_insights').select('week_ending, pips').order('week_ending', { ascending: false });

        const stats = {
          users: usersData?.length || 0,
          payments: paymentsData?.length || 0,
          trades: tradesData?.length || 0,
          signals: signalsData?.length || 0
        };

        document.getElementById('stat-users').textContent = stats.users;
        document.getElementById('stat-payments').textContent = stats.payments;
        document.getElementById('stat-trades').textContent = stats.trades;
        document.getElementById('stat-signals').textContent = stats.signals;

        const wins = insightsData ? insightsData.filter(i => i.pips > 0).length : 0;
        const totalWeeks = insightsData?.length || 0;
        document.getElementById('stat-winrate').textContent = totalWeeks > 0 ? Math.round((wins / totalWeeks) * 100) : 0;

        new Chart(document.getElementById('chart-pnl'), {
          type: 'line',
          data: {
            labels: insightsData?.map(i => new Date(i.week_ending).toLocaleDateString()) || ['W1', 'W2', 'W3', 'W4'],
            datasets: [{ data: insightsData?.map(i => i.pips) || [0, 0, 0, 0], tension: 0.4, borderColor: '#ffd700', backgroundColor: 'rgba(255, 215, 0, 0.2)' }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('chart-winrate'), {
          type: 'bar',
          data: {
            labels: insightsData?.map(i => new Date(i.week_ending).toLocaleDateString()) || ['W1', 'W2', 'W3', 'W4'],
            datasets: [{ data: insightsData?.map(i => i.pips > 0 ? 100 : 0) || [0, 0, 0, 0], backgroundColor: '#1cc88a' }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Error loading dashboard', false);
      }
    }

    // Clock
    function updateClock() {
      document.getElementById('current-datetime').textContent = new Date().toLocaleString();
    }
    updateClock();
    setInterval(updateClock, 60000);

    loadDashboard();
  </script>
</body>
</html>
